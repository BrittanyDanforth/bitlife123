-- ActivitiesScreen.lua
-- Premium BitLife-style Activities screen
-- Triple AAA polished UI with minigames and crime

local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local UI = require(ReplicatedStorage:WaitForChild("UIComponents"))
local C = UI.Colors
local F = UI.Fonts

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- COLOR SAFETY
-- Ensure ALL colors exist so TextColor3/BackgroundColor3 never get nil.
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- Base colors
C.Pink       = C.Pink       or Color3.fromRGB(236, 72, 153)
C.Green      = C.Green      or Color3.fromRGB(34, 197, 94)
C.Red        = C.Red        or Color3.fromRGB(239, 68, 68)
C.Purple     = C.Purple     or Color3.fromRGB(139, 92, 246)
C.Cyan       = C.Cyan       or Color3.fromRGB(6, 182, 212)
C.Blue       = C.Blue       or Color3.fromRGB(59, 130, 246)
C.Orange     = C.Orange     or Color3.fromRGB(249, 115, 22)
C.Yellow     = C.Yellow     or Color3.fromRGB(234, 179, 8)
C.White      = C.White      or Color3.fromRGB(255, 255, 255)
C.Black      = C.Black      or Color3.fromRGB(0, 0, 0)
C.Amber      = C.Amber      or Color3.fromRGB(245, 158, 11)

-- Dark variants
C.PinkDark   = C.PinkDark   or Color3.fromRGB(190, 24, 93)
C.GreenDark  = C.GreenDark  or Color3.fromRGB(22, 163, 74)
C.RedDark    = C.RedDark    or Color3.fromRGB(185, 28, 28)
C.PurpleDark = C.PurpleDark or Color3.fromRGB(109, 40, 217)
C.CyanDark   = C.CyanDark   or Color3.fromRGB(14, 116, 144)
C.BlueDark   = C.BlueDark   or Color3.fromRGB(29, 78, 216)
C.AmberDark  = C.AmberDark  or Color3.fromRGB(217, 119, 6)

-- Pale variants
C.PinkPale   = C.PinkPale   or Color3.fromRGB(252, 231, 243)
C.GreenPale  = C.GreenPale  or Color3.fromRGB(220, 252, 231)
C.RedPale    = C.RedPale    or Color3.fromRGB(254, 226, 226)
C.BluePale   = C.BluePale   or Color3.fromRGB(219, 234, 254)
C.PurplePale = C.PurplePale or Color3.fromRGB(237, 233, 254)
C.CyanPale   = C.CyanPale   or Color3.fromRGB(224, 242, 254)
C.AmberPale  = C.AmberPale  or Color3.fromRGB(254, 243, 199)

-- Grays
C.Gray100    = C.Gray100    or Color3.fromRGB(243, 244, 246)
C.Gray200    = C.Gray200    or Color3.fromRGB(229, 231, 235)
C.Gray300    = C.Gray300    or Color3.fromRGB(209, 213, 219)
C.Gray400    = C.Gray400    or Color3.fromRGB(156, 163, 175)
C.Gray500    = C.Gray500    or Color3.fromRGB(107, 114, 128)
C.Gray600    = C.Gray600    or Color3.fromRGB(75, 85, 99)
C.Gray700    = C.Gray700    or Color3.fromRGB(55, 65, 81)
C.Gray800    = C.Gray800    or Color3.fromRGB(31, 41, 55)
C.Gray900    = C.Gray900    or Color3.fromRGB(17, 24, 39)

-- Extra safety colors
C.Bg         = C.Bg         or Color3.fromRGB(246, 248, 252)

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- MOBILE RESPONSIVE SYSTEM
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera

-- Device detection (CRITICAL FIX: Added IS_TINY_PHONE for ultra-small phones like iPhone SE)
local IS_MOBILE = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
local IS_TABLET = IS_MOBILE and (Camera.ViewportSize.X >= 768 or Camera.ViewportSize.Y >= 768)
local IS_SMALL_PHONE = IS_MOBILE and not IS_TABLET and (Camera.ViewportSize.X < 400 or Camera.ViewportSize.Y < 700)
local IS_TINY_PHONE = IS_MOBILE and not IS_TABLET and (Camera.ViewportSize.X <= 380 or Camera.ViewportSize.Y <= 680)

local ViewportSize = Camera.ViewportSize

-- CRITICAL UI FIX: More aggressive scaling for small phones
local function getScale()
	local minDim = math.min(ViewportSize.X, ViewportSize.Y)
	if minDim < 350 then return 0.55 end  -- SUPER TINY phones
	if minDim < 380 then return 0.65 end  -- TINY phones like iPhone SE
	if minDim < 400 then return 0.72 end  -- Small phones
	if minDim < 500 then return 0.85 end
	if minDim < 768 then return 0.95 end
	return 1.0
end

local function px(baseValue) return math.floor(baseValue * getScale()) end

-- CRITICAL FIX: Better text sizing for tiny phones - more readable
local function textSize(baseSize) 
	local minSize = IS_TINY_PHONE and 10 or (IS_SMALL_PHONE and 11 or 12)
	return math.max(minSize, math.floor(baseSize * getScale())) 
end

-- CRITICAL FIX: More padding/spacing on small screens to reduce bunching
local function padSize(base) 
	if IS_TINY_PHONE then return math.max(4, math.floor(base * 0.6)) end
	if IS_SMALL_PHONE then return math.max(5, math.floor(base * 0.75)) end
	return math.floor(base * getScale())
end

-- CRITICAL FIX: Card heights that scale properly
local function cardHeight(baseHeight)
	if IS_TINY_PHONE then return math.max(70, math.floor(baseHeight * 0.7)) end
	if IS_SMALL_PHONE then return math.max(80, math.floor(baseHeight * 0.85)) end
	return baseHeight
end

-- CRITICAL FIX: Proper minimum touch target for tiny phones
local function btnHeight(baseHeight) 
	local scaled = math.floor(baseHeight * getScale())
	local minTarget = IS_TINY_PHONE and 36 or (IS_SMALL_PHONE and 40 or 44)
	return IS_MOBILE and math.max(minTarget, scaled) or scaled
end

local function cardWidth()
	if IS_TINY_PHONE then return ViewportSize.X - 8 end
	if IS_SMALL_PHONE then return ViewportSize.X - 12 end
	if IS_MOBILE then return math.min(ViewportSize.X - 20, 350) end
	return 350
end

-- CRITICAL FIX: Icon sizes that scale for small phones
local function iconSize(base)
	if IS_TINY_PHONE then return math.max(36, math.floor(base * 0.62)) end
	if IS_SMALL_PHONE then return math.max(42, math.floor(base * 0.75)) end
	return base
end

local function formatMoneyShort(amount)
	amount = tonumber(amount) or 0
	if amount >= 1000000000 then
		return string.format("$%.1fB", amount / 1000000000)
	elseif amount >= 1000000 then
		return string.format("$%.1fM", amount / 1000000)
	elseif amount >= 1000 then
		return string.format("$%.1fK", amount / 1000)
	end
	return string.format("$%d", amount)
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

local ActivitiesScreen = {}
ActivitiesScreen.__index = ActivitiesScreen

-- Remotes (optimized - fast lookup)
local remotesFolder = ReplicatedStorage:FindFirstChild("LifeRemotes") or ReplicatedStorage:WaitForChild("LifeRemotes", 3)
local function getRemote(name)
	return remotesFolder and (remotesFolder:FindFirstChild(name) or remotesFolder:WaitForChild(name, 1))
end
local DoActivity = getRemote("DoActivity")
local CommitCrime = getRemote("CommitCrime")
local DoPrisonAction = getRemote("DoPrisonAction")

-- Activity Data - Must match server's Activities IDs!
local MindBody = {
	{ id = "read", name = "Read a Book", emoji = "üìñ", effect = "+Smarts +Happiness", minAge = 5, cost = 0 },
	{ id = "study", name = "Study", emoji = "üìö", effect = "+Smarts", minAge = 5, cost = 0, hasMinigame = true, minigameType = "mash" },
	{ id = "meditate", name = "Meditate", emoji = "üßò", effect = "+Happiness +Health", minAge = 8, cost = 0, hasMinigame = true, minigameType = "qte" },
	{ id = "gym", name = "Go to the Gym", emoji = "üí™", effect = "+Health +Looks", minAge = 14, cost = 0, hasMinigame = true, minigameType = "mash" },
	{ id = "run", name = "Go for a Run", emoji = "üèÉ", effect = "+Health +Happiness", minAge = 6, cost = 0 },
	{ id = "yoga", name = "Yoga", emoji = "üßò‚Äç‚ôÄÔ∏è", effect = "+Health +Happiness", minAge = 10, cost = 0 },
	{ id = "spa", name = "Spa Day", emoji = "üíÜ", effect = "+Looks +Happiness", minAge = 16, cost = 200 },
	{ id = "salon", name = "Salon Visit", emoji = "üíá", effect = "+Looks +Happiness", minAge = 12, cost = 80 },
	-- CRITICAL FIX: Driver's license with QTE driving test minigame
	{ id = "drivers_license", name = "Get Driver's License", emoji = "üöó", effect = "License!", minAge = 16, cost = 50, hasMinigame = true, minigameType = "qte" },
	-- NEW: Martial arts with fight minigame
	{ id = "martial_arts", name = "Martial Arts Class", emoji = "ü•ã", effect = "+Health +Looks", minAge = 8, cost = 100, hasMinigame = true, minigameType = "fight" },
}

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- EDUCATION (Like BitLife!) - Go back to school, get GED, etc.
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
local Education = {
	{ id = "get_ged", name = "Get Your GED", emoji = "üìú", effect = "High School Equivalent!", minAge = 16, cost = 150, requiresFlag = "dropped_out_high_school" },
	{ id = "return_high_school", name = "Return to High School", emoji = "üè´", effect = "Back to School!", minAge = 14, cost = 0, requiresFlag = "dropped_out_high_school", maxAge = 21 },
	{ id = "community_college", name = "Community College", emoji = "üéì", effect = "+Smarts +Career", minAge = 18, cost = 2000, requiresFlag = "has_ged_or_diploma" },
	{ id = "university", name = "Apply to University", emoji = "üèõÔ∏è", effect = "4-Year Degree!", minAge = 18, cost = 5000, requiresFlag = "has_ged_or_diploma" },
	{ id = "trade_school", name = "Trade School", emoji = "üîß", effect = "Learn a Trade!", minAge = 18, cost = 3000 },
	{ id = "coding_bootcamp", name = "Coding Bootcamp", emoji = "üíª", effect = "+Tech Skills!", minAge = 18, cost = 8000 },
	{ id = "medical_school", name = "Medical School", emoji = "üè•", effect = "Become a Doctor!", minAge = 22, cost = 50000, requiresFlag = "has_degree" },
	{ id = "law_school", name = "Law School", emoji = "‚öñÔ∏è", effect = "Become a Lawyer!", minAge = 22, cost = 40000, requiresFlag = "has_degree" },
	{ id = "business_school", name = "Business School", emoji = "üíº", effect = "MBA!", minAge = 22, cost = 35000, requiresFlag = "has_degree" },
}

local Social = {
	{ id = "party", name = "Go to a Party", emoji = "üéâ", effect = "+Happiness", minAge = 14, cost = 0 },
	{ id = "hangout", name = "Hang Out", emoji = "üë•", effect = "+Happiness", minAge = 5, cost = 0 },
	{ id = "nightclub", name = "Nightclub", emoji = "üï∫", effect = "+Happiness -Health", minAge = 21, cost = 50, hasMinigame = true, minigameType = "mash" },
	{ id = "host_party", name = "Host a Party", emoji = "üéä", effect = "+Happiness", minAge = 16, cost = 300 },
	-- NEW: Karaoke with debate minigame
	{ id = "karaoke", name = "Karaoke Night", emoji = "üé§", effect = "+Happiness", minAge = 10, cost = 20, hasMinigame = true, minigameType = "debate" },
}

local Entertainment = {
	{ id = "tv", name = "Watch TV", emoji = "üì∫", effect = "+Happiness", minAge = 2, cost = 0 },
	{ id = "games", name = "Play Video Games", emoji = "üéÆ", effect = "+Happiness +Smarts", minAge = 5, cost = 0, hasMinigame = true, minigameType = "qte" },
	{ id = "movies", name = "Go to Movies", emoji = "üé¨", effect = "+Happiness", minAge = 5, cost = 20 },
	{ id = "concert", name = "Concert", emoji = "üé§", effect = "+Happiness", minAge = 12, cost = 150 },
	{ id = "vacation", name = "Vacation", emoji = "‚úàÔ∏è", effect = "+Happiness +Health", minAge = 5, cost = 2000 },
	-- NEW: Arcade with diverse minigames
	{ id = "arcade", name = "Arcade", emoji = "üïπÔ∏è", effect = "+Happiness +Smarts", minAge = 8, cost = 30, hasMinigame = true, minigameType = "mash" },
}

-- Crime IDs MUST match server's Crimes table exactly!
-- CRITICAL FIX: Added diverse minigames for different crimes
local Crimes = {
	-- PETTY CRIMES
	{ id = "porch_pirate", name = "Porch Pirate", emoji = "üì¶", risk = 20, reward = "$10-$200", minAge = 10 },
	{ id = "shoplift", name = "Shoplift", emoji = "üõí", risk = 25, reward = "$20-$150", minAge = 8 },
	{ id = "pickpocket", name = "Pickpocket", emoji = "üëõ", risk = 35, reward = "$30-$300", minAge = 10, hasMinigame = true, minigameType = "qte" },
	-- PROPERTY CRIMES
	{ id = "burglary", name = "Burglary", emoji = "üè†", risk = 50, reward = "$500-$5K", minAge = 16, hasMinigame = true, minigameType = "heist" },
	{ id = "car_theft", name = "Car Theft", emoji = "üöô", risk = 50, reward = "$3K-$15K", minAge = 16 },
	{ id = "gta", name = "Grand Theft Auto", emoji = "üöó", risk = 60, reward = "$2K-$20K", minAge = 16, hasMinigame = true, minigameType = "getaway" },
	-- WHITE COLLAR
	{ id = "tax_fraud", name = "Tax Fraud", emoji = "üìã", risk = 35, reward = "$5K-$50K", minAge = 18 },
	{ id = "identity_theft", name = "Identity Theft", emoji = "üë§", risk = 40, reward = "$1K-$20K", minAge = 16 },
	-- SERIOUS CRIMES
	{ id = "illegal_dealing", name = "Illegal Dealing", emoji = "üíä", risk = 55, reward = "$500-$10K", minAge = 16 },
	{ id = "extortion", name = "Extortion", emoji = "ü§´", risk = 60, reward = "$2K-$30K", minAge = 18 },
	{ id = "arson", name = "Arson", emoji = "üî•", risk = 70, reward = "$0-$1K", minAge = 18 },
	-- MAJOR CRIMES
	{ id = "bank_robbery", name = "Bank Robbery", emoji = "üè¶", risk = 80, reward = "$10K-$500K", minAge = 18, hasMinigame = true, minigameType = "heist" },
	{ id = "kidnapping", name = "Kidnapping", emoji = "üöê", risk = 85, reward = "$10K-$200K", minAge = 18 },
	{ id = "murder", name = "Murder", emoji = "üî™", risk = 90, reward = "$0-$5K", minAge = 18 },
}

-- CRITICAL FIX: Prison activities with appropriate minigames
local PrisonActivities = {
	{ id = "prison_escape", name = "Escape Prison", emoji = "üîì", effect = "Freedom!", minAge = 0, risk = 90, hasMinigame = true, minigameType = "prison_escape" },
	{ id = "prison_workout", name = "Yard Workout", emoji = "üí™", effect = "+Health +Looks", minAge = 0, hasMinigame = true, minigameType = "mash" },
	{ id = "prison_study", name = "Get GED", emoji = "üìö", effect = "+Smarts", minAge = 0 },
	{ id = "prison_crew", name = "Join Prison Crew", emoji = "‚õìÔ∏è", effect = "+Respect -Health", minAge = 0, hasMinigame = true, minigameType = "fight" },
	{ id = "prison_riot", name = "Start Riot", emoji = "üî•", effect = "Dangerous!", minAge = 0, risk = 85, hasMinigame = true, minigameType = "fight" },
	{ id = "prison_snitch", name = "Snitch", emoji = "üêÄ", effect = "-Sentence +Risk", minAge = 0 },
	{ id = "prison_appeal", name = "Appeal Sentence", emoji = "‚öñÔ∏è", effect = "Legal Help", minAge = 0, cost = 5000 },
	{ id = "prison_goodbehavior", name = "Good Behavior", emoji = "üòá", effect = "-Sentence Time", minAge = 0 },
}

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- BABY/TODDLER MISCHIEF (Ages 0-4) - Cause trouble like a little one!
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
local BabyMischief = {
	{ id = "cry_loudly", name = "Cry Really Loud", emoji = "üò≠", effect = "+Attention", minAge = 0, maxAge = 4 },
	{ id = "throw_food", name = "Throw Food", emoji = "üçù", effect = "Messy!", minAge = 0, maxAge = 4 },
	{ id = "break_toy", name = "Break a Toy", emoji = "üß∏", effect = "Oopsie!", minAge = 0, maxAge = 4 },
	{ id = "draw_walls", name = "Draw on the Walls", emoji = "üñçÔ∏è", effect = "Art Time!", minAge = 1, maxAge = 4 },
	{ id = "refuse_nap", name = "Refuse to Nap", emoji = "üò§", effect = "-Sleep +Happiness", minAge = 0, maxAge = 4 },
	{ id = "tantrum", name = "Throw a Tantrum", emoji = "ü§¨", effect = "+Attention -Happiness", minAge = 1, maxAge = 4 },
	{ id = "bite_sibling", name = "Bite Someone", emoji = "ü¶∑", effect = "Mean!", minAge = 1, maxAge = 4 },
	{ id = "hide_mom_keys", name = "Hide Mom's Keys", emoji = "üîë", effect = "Sneaky!", minAge = 2, maxAge = 4 },
}

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- CHILD MISCHIEF (Ages 5-12) - Kid trouble!
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
local ChildMischief = {
	{ id = "skip_chores", name = "Skip Your Chores", emoji = "üßπ", effect = "-Trouble", minAge = 5, maxAge = 12 },
	{ id = "prank_sibling", name = "Prank Your Sibling", emoji = "üòà", effect = "Funny!", minAge = 5, maxAge = 12 },
	{ id = "sneak_candy", name = "Sneak Candy", emoji = "üç¨", effect = "+Happiness +Sugar", minAge = 5, maxAge = 12 },
	{ id = "stay_up_late", name = "Stay Up Late", emoji = "üåô", effect = "No Sleep!", minAge = 5, maxAge = 12 },
	{ id = "cheat_test", name = "Cheat on a Test", emoji = "üìù", effect = "Risky!", minAge = 6, maxAge = 12, risk = 25 },
	{ id = "talk_back", name = "Talk Back to Parents", emoji = "üó£Ô∏è", effect = "Sassy!", minAge = 5, maxAge = 12 },
	{ id = "blame_sibling", name = "Blame Your Sibling", emoji = "üëâ", effect = "Sneaky!", minAge = 5, maxAge = 12 },
	{ id = "fake_sick", name = "Fake Being Sick", emoji = "ü§í", effect = "No School!", minAge = 6, maxAge = 12 },
	{ id = "toilet_paper_house", name = "TP Neighbor's House", emoji = "üßª", effect = "Mischief!", minAge = 8, maxAge = 12, risk = 15 },
	{ id = "ring_doorbell_run", name = "Ding Dong Ditch", emoji = "üö™", effect = "Run!", minAge = 7, maxAge = 12, risk = 10 },
}

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- TEEN MISCHIEF (Ages 13-17) - Rebellious teen stuff
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
local TeenMischief = {
	{ id = "sneak_out", name = "Sneak Out at Night", emoji = "üåÉ", effect = "Adventure!", minAge = 13, maxAge = 17, risk = 20 },
	{ id = "skip_class", name = "Skip Class", emoji = "üè´", effect = "Freedom!", minAge = 13, maxAge = 17, risk = 15 },
	{ id = "party_crash", name = "Crash a Party", emoji = "üéâ", effect = "+Fun +Risk", minAge = 14, maxAge = 17, risk = 25 },
	{ id = "fake_id", name = "Get a Fake ID", emoji = "ü™™", effect = "Illegal!", minAge = 15, maxAge = 17, risk = 40 },
	{ id = "vandalize", name = "Vandalize Something", emoji = "üé®", effect = "Bad!", minAge = 13, maxAge = 17, risk = 35 },
	{ id = "bully", name = "Bully Someone", emoji = "üò†", effect = "Mean!", minAge = 13, maxAge = 17, risk = 20 },
	{ id = "steal_parents_car", name = "Steal Parents' Car", emoji = "üöó", effect = "Joyride!", minAge = 14, maxAge = 17, risk = 50 },
	{ id = "break_curfew", name = "Break Curfew", emoji = "‚è∞", effect = "Late!", minAge = 13, maxAge = 17, risk = 15 },
	{ id = "drink_underage", name = "Underage Drinking", emoji = "üç∫", effect = "Party!", minAge = 14, maxAge = 17, risk = 30 },
	{ id = "smoke", name = "Try Smoking", emoji = "üö¨", effect = "-Health", minAge = 13, maxAge = 17, risk = 10 },
}

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- BABY/TODDLER PLAY ACTIVITIES (Ages 0-4)
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
local BabyFun = {
	{ id = "play_toys", name = "Play with Toys", emoji = "üß∏", effect = "+Happiness", minAge = 0, maxAge = 5, cost = 0 },
	{ id = "watch_cartoons", name = "Watch Cartoons", emoji = "üì∫", effect = "+Happiness", minAge = 0, maxAge = 5, cost = 0 },
	{ id = "play_peekaboo", name = "Play Peek-a-boo", emoji = "üôà", effect = "+Happiness", minAge = 0, maxAge = 2, cost = 0 },
	{ id = "play_blocks", name = "Play with Blocks", emoji = "üß±", effect = "+Smarts +Fun", minAge = 1, maxAge = 5, cost = 0 },
	{ id = "playground", name = "Go to Playground", emoji = "üõù", effect = "+Health +Happiness", minAge = 2, maxAge = 5, cost = 0 },
	{ id = "coloring", name = "Color a Picture", emoji = "üñçÔ∏è", effect = "+Happiness +Creativity", minAge = 2, maxAge = 5, cost = 0 },
	{ id = "play_dolls", name = "Play with Dolls", emoji = "üë∂", effect = "+Happiness", minAge = 1, maxAge = 5, cost = 0 },
	{ id = "bubbles", name = "Blow Bubbles", emoji = "ü´ß", effect = "+Happiness", minAge = 1, maxAge = 5, cost = 0 },
	{ id = "nap_time", name = "Take a Nap", emoji = "üò¥", effect = "+Health +Energy", minAge = 0, maxAge = 5, cost = 0 },
	{ id = "play_outside", name = "Play Outside", emoji = "üå≥", effect = "+Health +Happiness", minAge = 1, maxAge = 5, cost = 0 },
}

-- Debug logging (set to false to reduce log spam)
local DEBUG = false
local function log(...)
	if DEBUG then print("[ActivitiesScreen]", ...) end
end
local function logWarn(...)
	warn("[ActivitiesScreen]", ...)
end

function ActivitiesScreen.new(screenGui, blurOverlay, showBlurFunc, hideBlurFunc, playerState)
	log("=== CREATING ActivitiesScreen ===")
	local self = setmetatable({}, ActivitiesScreen)
	self.screenGui = screenGui
	self.playerState = playerState or {}
	self.showBlur = showBlurFunc
	self.hideBlur = hideBlurFunc
	self.isVisible = false
	self.currentTab = "mindbody"
	log("Initial state - Age:", self:getAge(), "Money:", self:getMoney(), "InJail:", self:isInJail())
	self:createUI()
	log("‚úÖ ActivitiesScreen created successfully")
	return self
end

function ActivitiesScreen:updateState(newState)
	log("Updating state...")

	-- Store previous jail status using the SAME logic as isInJail()
	local wasInJail = false
	if self.playerState then
		-- Priority: InJail (ExtendedState) > Flags.in_prison > Flags.incarcerated
		if self.playerState.InJail == true then
			wasInJail = true
		elseif self.playerState.InJail == false then
			wasInJail = false -- Explicit false from server means NOT in jail
		elseif self.playerState.Flags then
			wasInJail = self.playerState.Flags.in_prison == true or self.playerState.Flags.incarcerated == true
		end
	end

	if newState then 
		self.playerState = newState 

		-- Check if jail status changed using consistent logic
		local nowInJail = self:isInJail()

		log("State updated - Age:", self:getAge(), "Money:", self:getMoney())
		log("  InJail (ExtendedState):", newState.InJail)
		log("  Flags.in_prison:", newState.Flags and newState.Flags.in_prison)
		log("  Flags.incarcerated:", newState.Flags and newState.Flags.incarcerated)
		log("  JailYearsLeft:", self:getJailYearsLeft())
		log("  wasInJail:", wasInJail, "nowInJail:", nowInJail)

		if wasInJail ~= nowInJail then
			log("üîÑ JAIL STATUS CHANGED! Was:", wasInJail, "Now:", nowInJail)
			-- Always rebuild tabs when jail status changes
			log("Rebuilding tabs due to jail status change")
			self:rebuildTabs()
			self:updateInfoBar()

			-- Switch to appropriate tab
			if nowInJail then
				self.currentTab = "prison"
			elseif self.currentTab == "prison" then
				self.currentTab = "mindbody" -- Switch away from prison tab
			end

			-- Only switch tab content if visible
			if self.isVisible then
				self:switchTab(self.currentTab)
			end
		end
	end
end

function ActivitiesScreen:getAge()
	local state = self.playerState
	if not state then return 18 end
	return state.Age or (state.Stats and state.Stats.Age) or 18
end

function ActivitiesScreen:getMoney()
	local state = self.playerState
	if not state then return 1000 end
	return state.Money or (state.Stats and state.Stats.Money) or 1000
end

function ActivitiesScreen:isInJail()
	local state = self.playerState
	if not state then return false end

	-- PRIORITY ORDER:
	-- 1. ExtendedState.InJail (server authoritative - synced by _G.SyncPrisonStateFromFlags)
	-- 2. Flags.in_prison (fallback)
	-- 3. Flags.incarcerated (secondary fallback)

	-- If InJail is explicitly set (true or false), use that as authoritative
	if state.InJail == true then
		log("isInJail: TRUE (from ExtendedState.InJail)")
		return true
	elseif state.InJail == false then
		log("isInJail: FALSE (from ExtendedState.InJail)")
		return false
	end

	-- Fallback to flags only if InJail is nil (not synced yet)
	local flagsInJail = (state.Flags and state.Flags.in_prison == true) 
		or (state.Flags and state.Flags.incarcerated == true)

	log("isInJail:", flagsInJail, "(from Flags - InJail was nil)")
	return flagsInJail
end

function ActivitiesScreen:getJailYearsLeft()
	local state = self.playerState
	if not state then return 0 end
	return state.JailYearsLeft or 0
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- ADVANCED STAT HELPERS (for skill-based activity modifiers)
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function ActivitiesScreen:getHappiness()
	local state = self.playerState
	if not state then return 50 end
	return state.Happiness or (state.Stats and state.Stats.Happiness) or 50
end

function ActivitiesScreen:getSmarts()
	local state = self.playerState
	if not state then return 50 end
	return state.Smarts or (state.Stats and state.Stats.Smarts) or 50
end

function ActivitiesScreen:getHealth()
	local state = self.playerState
	if not state then return 50 end
	return state.Health or (state.Stats and state.Stats.Health) or 50
end

function ActivitiesScreen:getFlags()
	local state = self.playerState
	if not state then return {} end
	return state.Flags or {}
end

-- Calculate effectiveness preview for an activity
function ActivitiesScreen:getActivityEffectiveness(activityId)
	local happiness = self:getHappiness()
	local smarts = self:getSmarts()
	local health = self:getHealth()
	local flags = self:getFlags()

	-- Mood bonus
	local moodBonus = 1.0
	if happiness >= 80 then moodBonus = 1.3
	elseif happiness >= 60 then moodBonus = 1.15
	elseif happiness <= 20 then moodBonus = 0.7
	elseif happiness <= 40 then moodBonus = 0.85
	end

	-- Smarts bonus for learning activities
	local smartsBonus = 1.0
	if activityId == "study" or activityId == "read" then
		smartsBonus = 0.8 + (smarts / 100) * 0.5
	end

	-- Health bonus for physical activities
	local healthBonus = 1.0
	if activityId == "gym" or activityId == "run" or activityId == "yoga" then
		healthBonus = 0.8 + (health / 100) * 0.5
	end

	-- Athletic background bonus
	local athleticBonus = 1.0
	if flags.athletic_child and (activityId == "gym" or activityId == "run" or activityId == "yoga") then
		athleticBonus = 1.2
	end

	return moodBonus * smartsBonus * healthBonus * athleticBonus
end

-- Get effectiveness text/emoji for display
function ActivitiesScreen:getEffectivenessIndicator(activityId)
	local effectiveness = self:getActivityEffectiveness(activityId)

	if effectiveness >= 1.3 then
		return "üî•", C.Green -- Super effective
	elseif effectiveness >= 1.1 then
		return "‚¨ÜÔ∏è", C.Blue -- Boosted
	elseif effectiveness <= 0.7 then
		return "‚¨áÔ∏è", C.Red -- Reduced
	elseif effectiveness <= 0.85 then
		return "üòî", C.Amber -- Struggling
	else
		return nil, nil -- Normal
	end
end

-- Calculate crime risk modifier for preview
function ActivitiesScreen:getCrimeRiskModifier(crimeId)
	local smarts = self:getSmarts()
	local happiness = self:getHappiness()
	local flags = self:getFlags()

	local riskModifier = 0

	-- Smarts reduces risk
	local smartsReduction = math.floor((smarts - 50) / 50 * 15)
	riskModifier = riskModifier - smartsReduction

	-- Criminal experience reduces risk
	if flags.criminal_tendencies then riskModifier = riskModifier - 5 end
	if flags.petty_thief or flags.shoplifter then riskModifier = riskModifier - 5 end
	if flags.car_thief or flags.burglar then riskModifier = riskModifier - 8 end
	if flags.crew_member then riskModifier = riskModifier - 10 end
	if flags.underboss or flags.crime_boss or flags.crew_leader then riskModifier = riskModifier - 15 end

	-- Low happiness increases risk
	if happiness <= 20 then riskModifier = riskModifier + 10
	elseif happiness <= 40 then riskModifier = riskModifier + 5
	end

	return riskModifier
end

-- Get crime risk indicator for display
function ActivitiesScreen:getCrimeRiskIndicator()
	local modifier = self:getCrimeRiskModifier()

	if modifier <= -15 then
		return "üéØ", C.Green -- Expert criminal
	elseif modifier <= -8 then
		return "üëå", C.Blue -- Experienced
	elseif modifier >= 10 then
		return "‚ö†Ô∏è", C.Red -- Risky state
	elseif modifier >= 5 then
		return "üò∞", C.Amber -- Careless
	else
		return nil, nil -- Normal
	end
end

function ActivitiesScreen:createUI()
	-- Main overlay
	self.overlay = Instance.new("Frame")
	self.overlay.Name = "ActivitiesOverlay"
	self.overlay.Size = UDim2.fromScale(1, 1)
	self.overlay.BackgroundColor3 = C.Bg
	self.overlay.Visible = false
	self.overlay.ZIndex = 80
	self.overlay.Parent = self.screenGui
	
	-- MOBILE FIX: Responsive layout constants (CRITICAL: Added IS_TINY_PHONE support)
	-- CRITICAL FIX #309: Increased header height for better visibility
	local HEADER_HEIGHT = IS_TINY_PHONE and 56 or (IS_SMALL_PHONE and 64 or px(80))
	local INFO_HEIGHT = IS_TINY_PHONE and 36 or (IS_SMALL_PHONE and 40 or px(48))
	local TAB_HEIGHT = IS_TINY_PHONE and 42 or btnHeight(52)
	local GAP = IS_TINY_PHONE and 4 or padSize(8)

	-- Custom header (matches OccupationScreen for consistency)
	local header = Instance.new("Frame")
	header.Name = "Header"
	header.Size = UDim2.new(1, 0, 0, HEADER_HEIGHT)
	header.BackgroundColor3 = C.Gray100
	header.BorderSizePixel = 0
	header.ZIndex = 84
	header.Parent = self.overlay

	local headerBottom = Instance.new("Frame")
	headerBottom.Name = "BottomBorder"
	headerBottom.Size = UDim2.new(1, 0, 0, 1)
	headerBottom.Position = UDim2.new(0, 0, 1, -1)
	headerBottom.BackgroundColor3 = C.Gray200
	headerBottom.BorderSizePixel = 0
	headerBottom.ZIndex = 85
	headerBottom.Parent = header

	-- MOBILE FIX: Responsive title
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Name = "Title"
	titleLabel.Size = UDim2.new(1, -px(80), 1, 0)
	titleLabel.Position = UDim2.new(0, padSize(16), 0, 0)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Font = F.Title
	titleLabel.TextSize = textSize(20)
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.TextColor3 = C.Gray900
	titleLabel.Text = "üéØ Activities"
	titleLabel.ZIndex = 85
	titleLabel.Parent = header

	-- MOBILE FIX: Touch-friendly close button (CRITICAL: IS_TINY_PHONE support)
	-- CRITICAL FIX #310: Made close button bigger and changed to simple "X"
	local closeBtnSize = IS_TINY_PHONE and 36 or btnHeight(44)
	local closeButton = Instance.new("TextButton")
	closeButton.Name = "CloseButton"
	closeButton.Size = UDim2.new(0, closeBtnSize, 0, closeBtnSize)
	closeButton.AnchorPoint = Vector2.new(1, 0.5)
	closeButton.Position = UDim2.new(1, IS_TINY_PHONE and -10 or -padSize(16), 0.5, 0)
	closeButton.BackgroundColor3 = C.White
	closeButton.BackgroundTransparency = 0
	closeButton.Font = Enum.Font.GothamBold
	closeButton.TextSize = textSize(20)
	closeButton.TextColor3 = C.Gray700
	closeButton.Text = "X"
	closeButton.AutoButtonColor = false
	closeButton.ZIndex = 86
	closeButton.Parent = header
	UI.corner(closeButton, px(10))
	UI.stroke(closeButton, 1, 0.5, C.Gray300)

	closeButton.MouseButton1Click:Connect(function() self:hide() end)
	closeButton.MouseEnter:Connect(function()
		UI.tween(closeButton, TweenInfo.new(0.12), { BackgroundTransparency = 0 })
	end)
	closeButton.MouseLeave:Connect(function()
		UI.tween(closeButton, TweenInfo.new(0.12), { BackgroundTransparency = 0.1 })
	end)

	-- Content root (prevents UI cutoff issues)
	self.contentRoot = Instance.new("Frame")
	self.contentRoot.Name = "ContentRoot"
	self.contentRoot.BackgroundTransparency = 1
	self.contentRoot.ZIndex = 80
	self.contentRoot.Size = UDim2.new(1, 0, 1, -HEADER_HEIGHT)
	self.contentRoot.Position = UDim2.new(0, 0, 0, HEADER_HEIGHT)
	self.contentRoot.Parent = self.overlay

	-- MOBILE FIX: Responsive padding
	local contentPad = Instance.new("UIPadding")
	contentPad.PaddingLeft = UDim.new(0, padSize(8))
	contentPad.PaddingRight = UDim.new(0, padSize(8))
	contentPad.PaddingTop = UDim.new(0, GAP)
	contentPad.PaddingBottom = UDim.new(0, padSize(8))
	contentPad.Parent = self.contentRoot

	-- Layout calculations
	local infoY = 0
	local tabY = infoY + INFO_HEIGHT + GAP
	local scrollY = tabY + TAB_HEIGHT + GAP

	-- Info bar (positioned relative to contentRoot - FIXES CUT OFF ISSUE)
	self.infoBar = Instance.new("Frame")
	self.infoBar.Name = "InfoBar"
	self.infoBar.Size = UDim2.new(1, 0, 0, INFO_HEIGHT)
	self.infoBar.Position = UDim2.new(0, 0, 0, infoY)
	self.infoBar.BackgroundColor3 = C.White
	self.infoBar.ZIndex = 84
	self.infoBar.Parent = self.contentRoot
	UI.corner(self.infoBar, 12)
	UI.stroke(self.infoBar, 1, 0.9, C.Gray200)

	local infoLayout = Instance.new("UIListLayout")
	infoLayout.FillDirection = Enum.FillDirection.Horizontal
	infoLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
	infoLayout.VerticalAlignment = Enum.VerticalAlignment.Center
	infoLayout.Padding = UDim.new(0, 8)
	infoLayout.Parent = self.infoBar

	-- CRITICAL FIX: Match OccupationScreen styling for consistent look
	-- Use proper sizing and don't use TextScaled (causes weird resizing)
	self.ageChip = UI.createInfoChip(self.infoBar, {
		name = "AgeChip", icon = "", text = "Age 18",
		bgColor = C.BluePale, textColor = C.BlueDark, order = 1, width = 75
	})
	self.ageChip.icon.Text = ""
	self.ageChip.text.Text = "Age 18"
	self.ageChip.text.Position = UDim2.new(0, 10, 0, 0)
	self.ageChip.text.Size = UDim2.new(1, -20, 1, 0)
	self.ageChip.text.TextXAlignment = Enum.TextXAlignment.Center

	self.moneyChip = UI.createInfoChip(self.infoBar, {
		name = "MoneyChip", icon = "", text = "$0",
		bgColor = C.GreenPale, textColor = C.GreenDark, order = 2, width = 90
	})
	self.moneyChip.icon.Text = ""
	self.moneyChip.text.Text = "$0"
	self.moneyChip.text.Position = UDim2.new(0, 10, 0, 0)
	self.moneyChip.text.Size = UDim2.new(1, -20, 1, 0)
	self.moneyChip.text.TextXAlignment = Enum.TextXAlignment.Center

	self.statusChip = UI.createInfoChip(self.infoBar, {
		name = "StatusChip", icon = "", text = "Adult",
		bgColor = C.AmberPale, textColor = C.AmberDark, order = 3, width = 90
	})
	self.statusChip.icon.Text = ""
	self.statusChip.text.Text = "Adult"
	self.statusChip.text.Position = UDim2.new(0, 10, 0, 0)
	self.statusChip.text.Size = UDim2.new(1, -20, 1, 0)
	self.statusChip.text.TextXAlignment = Enum.TextXAlignment.Center

	-- Tab bar (positioned relative to contentRoot)
	self.tabBar = Instance.new("Frame")
	self.tabBar.Name = "TabBar"
	self.tabBar.Size = UDim2.new(1, 0, 0, TAB_HEIGHT)
	self.tabBar.Position = UDim2.new(0, 0, 0, tabY)
	self.tabBar.BackgroundColor3 = C.Gray100
	self.tabBar.ZIndex = 84
	self.tabBar.Parent = self.contentRoot
	UI.corner(self.tabBar, 12)
	UI.pad(self.tabBar, 4, 4, 4, 4)

	local tabLayout = Instance.new("UIListLayout")
	tabLayout.FillDirection = Enum.FillDirection.Horizontal
	tabLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
	tabLayout.VerticalAlignment = Enum.VerticalAlignment.Center
	tabLayout.Padding = UDim.new(0, 6)
	tabLayout.Parent = self.tabBar

	self.tabBtns = {}
	self:rebuildTabs()

	-- Scroll area (positioned relative to contentRoot)
	self.contentScroll = Instance.new("ScrollingFrame")
	self.contentScroll.Name = "ContentScroll"
	self.contentScroll.Size = UDim2.new(1, 0, 1, -scrollY)
	self.contentScroll.Position = UDim2.new(0, 0, 0, scrollY)
	self.contentScroll.BackgroundTransparency = 1
	self.contentScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
	self.contentScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
	self.contentScroll.ScrollBarThickness = 4
	self.contentScroll.ScrollBarImageColor3 = C.Gray300
	self.contentScroll.ZIndex = 81
	self.contentScroll.Parent = self.contentRoot

	local contentLayout = Instance.new("UIListLayout")
	contentLayout.Padding = UDim.new(0, 12)
	contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
	contentLayout.Parent = self.contentScroll

	-- Modals
	self:createResultModal()
	self:createMinigameModal()

	-- Initial populate
	self:populateMindBody()
end

function ActivitiesScreen:rebuildTabs()
	-- Clear existing tabs
	for _, child in ipairs(self.tabBar:GetChildren()) do
		if child:IsA("TextButton") then child:Destroy() end
	end
	self.tabBtns = {}

	local inJail = self:isInJail()
	local age = self:getAge()
	local tabs

	if inJail then
		-- PRISON MODE: Limited activities
		tabs = {
			{ id = "prison", text = "Prison", color = C.Gray700 },
			{ id = "mindbody", text = "Exercise", color = C.Cyan },
		}
		self.currentTab = "prison"
	elseif age < 5 then
		-- BABY/TODDLER MODE (0-4): Only fun activities and mischief
		tabs = {
			{ id = "fun", text = "üéà Play", color = C.Purple },
			{ id = "mischief", text = "üòà Mischief", color = C.Red },
		}
		-- Default to fun for babies
		if self.currentTab ~= "fun" and self.currentTab ~= "mischief" then
			self.currentTab = "fun"
		end
	elseif age < 13 then
		-- CHILD MODE (5-12): Fun, social, and mild mischief
		tabs = {
			{ id = "fun", text = "üéÆ Fun", color = C.Purple },
			{ id = "social", text = "üë• Social", color = C.Pink },
			{ id = "mischief", text = "üòà Trouble", color = C.Red },
		}
		-- Switch to appropriate tab
		if self.currentTab == "mindbody" or self.currentTab == "crime" then
			self.currentTab = "fun"
		end
	elseif age < 18 then
		-- TEEN MODE (13-17): Everything but serious crime + Education!
		tabs = {
			{ id = "mindbody", text = "üí™ Mind", color = C.Cyan },
			{ id = "education", text = "üìö School", color = C.Amber },
			{ id = "social", text = "üë• Social", color = C.Pink },
			{ id = "mischief", text = "üòà Trouble", color = C.Red },
		}
		if self.currentTab == "crime" then
			self.currentTab = "mischief"
		end
	else
		-- ADULT MODE (18+): Full activities + Education (BitLife style - no separate premium tab)
		tabs = {
			{ id = "mindbody", text = "Mind", color = C.Cyan },
			{ id = "education", text = "üìö Learn", color = C.Amber },
			{ id = "social", text = "Social", color = C.Pink },
			{ id = "crime", text = "Crime", color = C.Red },
		}
		
		-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
		-- CRITICAL FIX #88/#89: PREMIUM ACTIVITY TABS
		-- Add special tabs for premium gamepass features
		-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
		local flags = self.playerState and self.playerState.Flags or {}
		local royalState = self.playerState and self.playerState.RoyalState
		local fameState = self.playerState and self.playerState.FameState
		local mobState = self.playerState and self.playerState.MobState
		
		-- ROYAL TAB: For players who are royalty
		local isRoyal = flags.is_royalty or flags.royal_birth or (royalState and royalState.isRoyal)
		if isRoyal then
			table.insert(tabs, { id = "royal", text = "üëë Royal", color = Color3.fromRGB(218, 165, 32) }) -- Gold color
		end
		
		-- FAME TAB: For players with a celebrity career
		local hasFameCareer = flags.fame_career or (fameState and fameState.careerPath)
		if hasFameCareer then
			table.insert(tabs, { id = "fame", text = "‚≠ê Fame", color = Color3.fromRGB(255, 215, 0) }) -- Star gold
		end
		
		-- MAFIA TAB: For players in the mob
		local isInMob = flags.in_mob or (mobState and mobState.inMob)
		if isInMob then
			table.insert(tabs, { id = "mafia", text = "üî´ Mafia", color = Color3.fromRGB(88, 28, 28) }) -- Dark red
		end
	end

	local tabWidth = 0.95 / #tabs

	for i, tab in ipairs(tabs) do
		local btn = Instance.new("TextButton")
		btn.Name = tab.id
		btn.Size = UDim2.new(tabWidth, 0, 1, 0)
		btn.BackgroundColor3 = (self.currentTab == tab.id or (i == 1 and not self.tabBtns[self.currentTab])) and tab.color or C.White
		btn.Font = F.Button
		btn.TextSize = 13
		btn.TextColor3 = (self.currentTab == tab.id or (i == 1 and not self.tabBtns[self.currentTab])) and C.White or C.Gray600
		btn.Text = tab.text
		btn.AutoButtonColor = false
		btn.LayoutOrder = i
		btn.ZIndex = 85
		btn.Parent = self.tabBar
		UI.corner(btn, 10)

		self.tabBtns[tab.id] = { btn = btn, color = tab.color }
		btn.MouseButton1Click:Connect(function() self:switchTab(tab.id) end)
	end
	
	-- If current tab doesn't exist, switch to first available
	if not self.tabBtns[self.currentTab] then
		self.currentTab = tabs[1].id
	end
end

function ActivitiesScreen:updateInfoBar()
	self.ageChip.text.Text = "Age " .. self:getAge()
	self.moneyChip.text.Text = UI.formatMoney(self:getMoney())

	local inJail = self:isInJail()
	local jailYears = self:getJailYearsLeft()
	local age = self:getAge()

	if inJail then
		-- Show jail time remaining
		local jailText = jailYears > 0 and string.format("‚õìÔ∏è%.0fy", jailYears) or "‚õìÔ∏èJail"
		self.statusChip.text.Text = jailText
		self.statusChip.chip.BackgroundColor3 = C.RedPale
		self.statusChip.text.TextColor3 = C.RedDark
	else
		-- CRITICAL FIX: Show life stage instead of just "Free"
		local statusText = "Adult"
		local bgColor = C.GreenPale
		local textColor = C.GreenDark
		
		if age < 2 then
			statusText = "üë∂ Baby"
			bgColor = C.PurplePale or C.BluePale
			textColor = C.PurpleDark or C.BlueDark
		elseif age < 5 then
			statusText = "üßí Toddler"
			bgColor = C.PurplePale or C.BluePale
			textColor = C.PurpleDark or C.BlueDark
		elseif age < 13 then
			statusText = "üìö Child"
			bgColor = C.BluePale
			textColor = C.BlueDark
		elseif age < 18 then
			statusText = "üéÆ Teen"
			bgColor = C.AmberPale or C.Amber
			textColor = C.AmberDark
		elseif age < 30 then
			statusText = "‚ú® Young"
			bgColor = C.GreenPale
			textColor = C.GreenDark
		elseif age < 50 then
			statusText = "üíº Adult"
			bgColor = C.GreenPale
			textColor = C.GreenDark
		elseif age < 65 then
			statusText = "üëî Midlife"
			bgColor = C.BluePale
			textColor = C.BlueDark
		elseif age < 80 then
			statusText = "üßì Senior"
			bgColor = C.PurplePale or C.BluePale
			textColor = C.PurpleDark or C.BlueDark
		else
			statusText = "üë¥ Elder"
			bgColor = C.Gray200
			textColor = C.Gray700
		end
		
		self.statusChip.text.Text = statusText
		self.statusChip.chip.BackgroundColor3 = bgColor
		self.statusChip.text.TextColor3 = textColor
	end
end

function ActivitiesScreen:switchTab(tabId)
	-- CRITICAL FIX #313: Debounce to prevent flickering from rapid tab switches
	if self._switchingTab then return end
	self._switchingTab = true
	
	log("Switching tab to:", tabId)
	self.currentTab = tabId

	for id, data in pairs(self.tabBtns) do
		local isActive = id == tabId
		-- CRITICAL FIX #313: Use immediate color change instead of tween to reduce flicker
		data.btn.BackgroundColor3 = isActive and data.color or C.White
		data.btn.TextColor3 = isActive and C.White or C.Gray600
	end

	-- Clear content
	for _, child in ipairs(self.contentScroll:GetChildren()) do
		if child:IsA("Frame") then child:Destroy() end
	end

	log("Populating tab content...")
	if tabId == "prison" then self:populatePrison()
	elseif tabId == "mindbody" then self:populateMindBody()
	elseif tabId == "education" then self:populateEducation()
	elseif tabId == "social" then self:populateSocial()
	elseif tabId == "fun" then self:populateFun()
	elseif tabId == "crime" then self:populateCrime()
	elseif tabId == "mischief" then self:populateMischief()
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- CRITICAL FIX #88/#89/#90: PREMIUM ACTIVITY TABS
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	elseif tabId == "royal" then self:populateRoyal()
	elseif tabId == "fame" then self:populateFame()
	elseif tabId == "mafia" then self:populateMafia()
	end
	log("Tab content populated")
	
	-- CRITICAL FIX #313: Release debounce after a short delay
	task.delay(0.1, function()
		self._switchingTab = false
	end)
end

function ActivitiesScreen:populateMindBody()
	self:updateInfoBar()

	-- Section card
	local section = Instance.new("Frame")
	section.Name = "MindBodySection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 1
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)

	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section

	-- Header
	local header = Instance.new("Frame")
	header.Size = UDim2.new(1, 0, 0, 36)
	header.BackgroundTransparency = 1
	header.LayoutOrder = 0
	header.ZIndex = 83
	header.Parent = section

	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, 120, 0, 32)
	badge.BackgroundColor3 = C.Cyan
	badge.ZIndex = 84
	badge.Parent = header
	UI.pill(badge)

	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.fromScale(1, 1)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.Font = F.Button
	badgeLabel.TextSize = 14
	badgeLabel.TextColor3 = C.White
	badgeLabel.Text = "Mind & Body"
	badgeLabel.ZIndex = 85
	badgeLabel.Parent = badge

	local countLabel = Instance.new("TextLabel")
	countLabel.Size = UDim2.new(0, 80, 1, 0)
	countLabel.Position = UDim2.new(0, 130, 0, 0)
	countLabel.BackgroundTransparency = 1
	countLabel.Font = F.Medium
	countLabel.TextSize = 13
	countLabel.TextColor3 = C.Gray400
	countLabel.TextXAlignment = Enum.TextXAlignment.Left
	countLabel.Text = #MindBody .. " activities"
	countLabel.ZIndex = 84
	countLabel.Parent = header

	for i, item in ipairs(MindBody) do
		self:createActivityCard(section, item, i, C.Cyan, C.CyanPale)
	end
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- EDUCATION TAB (Like BitLife!) - Go back to school, get GED, etc.
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ActivitiesScreen:populateEducation()
	self:updateInfoBar()

	local section = Instance.new("Frame")
	section.Name = "EducationSection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 1
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)

	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section

	-- Header
	local header = Instance.new("Frame")
	header.Size = UDim2.new(1, 0, 0, 36)
	header.BackgroundTransparency = 1
	header.LayoutOrder = 0
	header.ZIndex = 83
	header.Parent = section

	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, 120, 0, 32)
	badge.BackgroundColor3 = C.Amber
	badge.ZIndex = 84
	badge.Parent = header
	UI.pill(badge)

	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.fromScale(1, 1)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.Font = F.Button
	badgeLabel.TextSize = 14
	badgeLabel.TextColor3 = C.White
	badgeLabel.Text = "üìö Education"
	badgeLabel.ZIndex = 85
	badgeLabel.Parent = badge

	local countLabel = Instance.new("TextLabel")
	countLabel.Size = UDim2.new(0, 120, 1, 0)
	countLabel.Position = UDim2.new(0, 130, 0, 0)
	countLabel.BackgroundTransparency = 1
	countLabel.Font = F.Medium
	countLabel.TextSize = 13
	countLabel.TextColor3 = C.Gray400
	countLabel.TextXAlignment = Enum.TextXAlignment.Left
	countLabel.Text = #Education .. " programs"
	countLabel.ZIndex = 84
	countLabel.Parent = header

	-- Info text for dropouts
	local infoText = Instance.new("TextLabel")
	infoText.Size = UDim2.new(1, 0, 0, 40)
	infoText.BackgroundTransparency = 1
	infoText.Font = F.Body
	infoText.TextSize = 12
	infoText.TextColor3 = C.Gray500
	infoText.TextWrapped = true
	infoText.TextXAlignment = Enum.TextXAlignment.Left
	infoText.Text = "üí° Dropped out? Get your GED or return to school! Need a degree? Apply to college, trade school, or professional programs!"
	infoText.LayoutOrder = 1
	infoText.ZIndex = 83
	infoText.Parent = section

	for i, item in ipairs(Education) do
		self:createActivityCard(section, item, i + 1, C.Amber, C.AmberPale)
	end
end

function ActivitiesScreen:populateSocial()
	self:updateInfoBar()

	local section = Instance.new("Frame")
	section.Name = "SocialSection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 1
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)

	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section

	-- Header
	local header = Instance.new("Frame")
	header.Size = UDim2.new(1, 0, 0, 36)
	header.BackgroundTransparency = 1
	header.LayoutOrder = 0
	header.ZIndex = 83
	header.Parent = section

	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, 90, 0, 32)
	badge.BackgroundColor3 = C.Pink
	badge.ZIndex = 84
	badge.Parent = header
	UI.pill(badge)

	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.fromScale(1, 1)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.Font = F.Button
	badgeLabel.TextSize = 14
	badgeLabel.TextColor3 = C.White
	badgeLabel.Text = "Social"
	badgeLabel.ZIndex = 85
	badgeLabel.Parent = badge

	local countLabel = Instance.new("TextLabel")
	countLabel.Size = UDim2.new(0, 80, 1, 0)
	countLabel.Position = UDim2.new(0, 100, 0, 0)
	countLabel.BackgroundTransparency = 1
	countLabel.Font = F.Medium
	countLabel.TextSize = 13
	countLabel.TextColor3 = C.Gray400
	countLabel.TextXAlignment = Enum.TextXAlignment.Left
	countLabel.Text = #Social .. " activities"
	countLabel.ZIndex = 84
	countLabel.Parent = header

	for i, item in ipairs(Social) do
		self:createActivityCard(section, item, i, C.Pink, C.PinkPale)
	end
end

function ActivitiesScreen:populateFun()
	self:updateInfoBar()
	
	local age = self:getAge()
	
	-- Determine which activities to show based on age
	local activities
	local headerText
	local ageMessage
	
	if age < 5 then
		-- Baby/Toddler fun activities
		activities = {}
		for _, item in ipairs(BabyFun) do
			if age >= (item.minAge or 0) and age <= (item.maxAge or 99) then
				table.insert(activities, item)
			end
		end
		headerText = "üéà Playtime!"
		ageMessage = "Things babies and toddlers love to do!"
	else
		-- Regular entertainment for older kids/adults
		activities = {}
		for _, item in ipairs(Entertainment) do
			if age >= (item.minAge or 0) then
				table.insert(activities, item)
			end
		end
		headerText = "Entertainment"
		ageMessage = nil
	end

	-- Age-appropriate message card for babies
	if ageMessage then
		local msgCard = Instance.new("Frame")
		msgCard.Size = UDim2.new(1, 0, 0, 60)
		msgCard.BackgroundColor3 = C.PurplePale or C.BluePale
		msgCard.LayoutOrder = 0
		msgCard.ZIndex = 82
		msgCard.Parent = self.contentScroll
		UI.corner(msgCard, 16)
		UI.stroke(msgCard, 1, 0.7, C.Purple)

		local msgIcon = Instance.new("TextLabel")
		msgIcon.Size = UDim2.new(0, 40, 0, 40)
		msgIcon.Position = UDim2.new(0, 12, 0.5, -20)
		msgIcon.BackgroundTransparency = 1
		msgIcon.Font = Enum.Font.GothamBold
		msgIcon.TextSize = 32
		msgIcon.Text = "üë∂"
		msgIcon.ZIndex = 83
		msgIcon.Parent = msgCard

		local msgText = Instance.new("TextLabel")
		msgText.Size = UDim2.new(1, -70, 1, -16)
		msgText.Position = UDim2.new(0, 60, 0, 8)
		msgText.BackgroundTransparency = 1
		msgText.Font = F.Body
		msgText.TextSize = 14
		msgText.TextColor3 = C.PurpleDark or C.BlueDark
		msgText.TextXAlignment = Enum.TextXAlignment.Left
		msgText.TextWrapped = true
		msgText.Text = ageMessage
		msgText.ZIndex = 83
		msgText.Parent = msgCard
	end

	local section = Instance.new("Frame")
	section.Name = "FunSection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 1
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)

	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section

	-- Header
	local header = Instance.new("Frame")
	header.Size = UDim2.new(1, 0, 0, 36)
	header.BackgroundTransparency = 1
	header.LayoutOrder = 0
	header.ZIndex = 83
	header.Parent = section

	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, 125, 0, 32)
	badge.BackgroundColor3 = C.Purple
	badge.ZIndex = 84
	badge.Parent = header
	UI.pill(badge)

	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.fromScale(1, 1)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.Font = F.Button
	badgeLabel.TextSize = 14
	badgeLabel.TextColor3 = C.White
	badgeLabel.Text = headerText
	badgeLabel.ZIndex = 85
	badgeLabel.Parent = badge

	local countLabel = Instance.new("TextLabel")
	countLabel.Size = UDim2.new(0, 80, 1, 0)
	countLabel.Position = UDim2.new(0, 135, 0, 0)
	countLabel.BackgroundTransparency = 1
	countLabel.Font = F.Medium
	countLabel.TextSize = 13
	countLabel.TextColor3 = C.Gray400
	countLabel.TextXAlignment = Enum.TextXAlignment.Left
	countLabel.Text = #activities .. " options"
	countLabel.ZIndex = 84
	countLabel.Parent = header

	for i, item in ipairs(activities) do
		self:createActivityCard(section, item, i, C.Purple, C.PurplePale)
	end
end

function ActivitiesScreen:populateCrime()
	self:updateInfoBar()

	-- Warning card
	local warningCard = Instance.new("Frame")
	warningCard.Size = UDim2.new(1, 0, 0, 75)
	warningCard.BackgroundColor3 = C.RedPale
	warningCard.LayoutOrder = 0
	warningCard.ZIndex = 82
	warningCard.Parent = self.contentScroll
	UI.corner(warningCard, 16)
	UI.stroke(warningCard, 1, 0.7, C.Red)

	local warnIcon = Instance.new("TextLabel")
	warnIcon.Size = UDim2.new(0, 44, 0, 44)
	warnIcon.Position = UDim2.new(0, 12, 0.5, -22)
	warnIcon.BackgroundColor3 = C.Red
	warnIcon.BackgroundTransparency = 0.85
	warnIcon.Font = Enum.Font.GothamBold
	warnIcon.TextSize = 28
	warnIcon.Text = "‚ö†Ô∏è"
	warnIcon.TextColor3 = C.Red
	warnIcon.ZIndex = 83
	warnIcon.Parent = warningCard
	UI.corner(warnIcon, 12)

	local warnText = Instance.new("TextLabel")
	warnText.Size = UDim2.new(1, -80, 1, -16)
	warnText.Position = UDim2.new(0, 70, 0, 8)
	warnText.BackgroundTransparency = 1
	warnText.Font = F.Body
	warnText.TextSize = 13
	warnText.TextColor3 = C.RedDark
	warnText.TextXAlignment = Enum.TextXAlignment.Left
	warnText.TextWrapped = true
	warnText.Text = "Crime is risky! You can get caught and go to prison. Higher risk = higher reward."
	warnText.ZIndex = 83
	warnText.Parent = warningCard

	-- Crime section
	local section = Instance.new("Frame")
	section.Name = "CrimeSection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 1
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)

	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section

	-- Header
	local header = Instance.new("Frame")
	header.Size = UDim2.new(1, 0, 0, 36)
	header.BackgroundTransparency = 1
	header.LayoutOrder = 0
	header.ZIndex = 83
	header.Parent = section

	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, 125, 0, 32)
	badge.BackgroundColor3 = C.Red
	badge.ZIndex = 84
	badge.Parent = header
	UI.pill(badge)

	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.fromScale(1, 1)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.Font = F.Button
	badgeLabel.TextSize = 14
	badgeLabel.TextColor3 = C.White
	badgeLabel.Text = "Criminal Acts"
	badgeLabel.ZIndex = 85
	badgeLabel.Parent = badge

	for i, item in ipairs(Crimes) do
		self:createCrimeCard(section, item, i)
	end
	
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- ORGANIZED CRIME SECTION (BitLife style - prompts purchase if locked)
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	self:createOrganizedCrimeSection()
end

function ActivitiesScreen:createOrganizedCrimeSection()
	-- CRITICAL FIX #1: Only show organized crime for adults (18+)
	local age = self:getAge()
	if age < 18 then
		return -- Don't show organized crime to minors
	end
	
	local mobState = self:getMobState()
	local isInMob = mobState and mobState.inMob
	
	-- Organized Crime section card
	local section = Instance.new("Frame")
	section.Name = "OrganizedCrimeSection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 10
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)
	
	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section
	
	-- CRITICAL UI FIX: Mobile responsive header
	local headerH = IS_TINY_PHONE and 30 or (IS_SMALL_PHONE and 32 or 36)
	local badgeW = IS_TINY_PHONE and 120 or (IS_SMALL_PHONE and 140 or 165)
	local badgeH = IS_TINY_PHONE and 26 or (IS_SMALL_PHONE and 28 or 32)
	local crownS = IS_TINY_PHONE and 22 or (IS_SMALL_PHONE and 24 or 28)
	
	local header = Instance.new("Frame")
	header.Size = UDim2.new(1, 0, 0, headerH)
	header.BackgroundTransparency = 1
	header.LayoutOrder = 0
	header.ZIndex = 83
	header.Parent = section
	
	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, badgeW, 0, badgeH)
	badge.BackgroundColor3 = C.Gray800
	badge.ZIndex = 84
	badge.Parent = header
	UI.pill(badge)
	
	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.fromScale(1, 1)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.Font = F.Button
	badgeLabel.TextSize = textSize(14)
	badgeLabel.TextColor3 = C.White
	badgeLabel.Text = IS_TINY_PHONE and "üî´ Mafia" or "üî´ Organized Crime"
	badgeLabel.ZIndex = 85
	badgeLabel.Parent = badge
	
	-- Crown indicator (premium) - positioned after badge
	local crownBadge = Instance.new("Frame")
	crownBadge.Size = UDim2.new(0, crownS, 0, crownS)
	crownBadge.Position = UDim2.new(0, badgeW + 8, 0, (badgeH - crownS) / 2)
	crownBadge.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
	crownBadge.ZIndex = 84
	crownBadge.Parent = header
	UI.corner(crownBadge, crownS / 2)
	
	local crownIcon = Instance.new("TextLabel")
	crownIcon.Size = UDim2.fromScale(1, 1)
	crownIcon.BackgroundTransparency = 1
	crownIcon.Font = F.Body
	crownIcon.TextSize = textSize(14)
	crownIcon.Text = "üëë"
	crownIcon.ZIndex = 85
	crownIcon.Parent = crownBadge
	
	if isInMob then
		-- Show current mob status and operations
		self:createMobStatusCard(section, mobState)
		self:createMobPerksRow(section, mobState)
		self:createMobOperationsCards(section, mobState)
	else
		-- Show "Join the Mob" card (BitLife style)
		self:createJoinMobCard(section)
	end
end

function ActivitiesScreen:createJoinMobCard(parent)
	-- Crime families available
	local families = {
		{ id = "italian", name = "Italian Mafia", emoji = "üáÆüáπ", desc = "La Cosa Nostra" },
		{ id = "russian", name = "Russian Bratva", emoji = "üá∑üá∫", desc = "The Brotherhood" },
		{ id = "yakuza", name = "Japanese Yakuza", emoji = "üáØüáµ", desc = "Way of Honor" },
		{ id = "cartel", name = "Mexican Cartel", emoji = "üá≤üáΩ", desc = "Smuggling Empire" },
		{ id = "triad", name = "Chinese Triad", emoji = "üá®üá≥", desc = "Ancient Society" },
	}
	
	-- CRITICAL UI FIX: Scale everything for mobile
	local cardH = IS_TINY_PHONE and 60 or (IS_SMALL_PHONE and 65 or 70)
	local iconS = IS_TINY_PHONE and 36 or (IS_SMALL_PHONE and 40 or 48)
	local btnW = IS_TINY_PHONE and 52 or (IS_SMALL_PHONE and 58 or 65)
	local btnH = IS_TINY_PHONE and 30 or (IS_SMALL_PHONE and 33 or 36)
	local nameSize = textSize(14)
	local descSize = textSize(11)
	local emojiSize = textSize(24)
	local leftPad = IS_TINY_PHONE and 6 or (IS_SMALL_PHONE and 8 or 10)
	local rightPad = IS_TINY_PHONE and 6 or (IS_SMALL_PHONE and 8 or 10)
	local textLeft = iconS + leftPad + (IS_TINY_PHONE and 4 or 8)
	local textRight = btnW + rightPad + (IS_TINY_PHONE and 8 or 16)
	
	-- Check gamepass once (not per card)
	local hasGamepass = self:checkGamepassOwnership("MAFIA")
	
	for i, family in ipairs(families) do
		local card = Instance.new("Frame")
		card.Name = "MobCard_" .. family.id
		card.Size = UDim2.new(1, 0, 0, cardH)
		card.AutomaticSize = Enum.AutomaticSize.Y
		card.BackgroundColor3 = C.White
		card.LayoutOrder = i
		card.ZIndex = 84
		card.Parent = parent
		UI.corner(card, px(14))
		UI.stroke(card, 1, 0.85, C.Gray200)
		
		-- Emoji icon
		local iconFrame = Instance.new("Frame")
		iconFrame.Size = UDim2.new(0, iconS, 0, iconS)
		iconFrame.Position = UDim2.new(0, leftPad, 0.5, -iconS/2)
		iconFrame.BackgroundColor3 = C.Gray100
		iconFrame.ZIndex = 85
		iconFrame.Parent = card
		UI.corner(iconFrame, px(12))
		
		local iconLabel = Instance.new("TextLabel")
		iconLabel.Size = UDim2.fromScale(1, 1)
		iconLabel.BackgroundTransparency = 1
		iconLabel.Font = F.Body
		iconLabel.TextSize = emojiSize
		iconLabel.Text = family.emoji
		iconLabel.ZIndex = 86
		iconLabel.Parent = iconFrame
		
		-- Family name
		local nameLabel = Instance.new("TextLabel")
		nameLabel.Size = UDim2.new(1, -textLeft - textRight, 0, nameSize + 4)
		nameLabel.Position = UDim2.new(0, textLeft, 0, IS_TINY_PHONE and 8 or 12)
		nameLabel.BackgroundTransparency = 1
		nameLabel.Font = F.Title
		nameLabel.TextSize = nameSize
		nameLabel.TextColor3 = C.Gray900
		nameLabel.TextXAlignment = Enum.TextXAlignment.Left
		nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
		nameLabel.Text = IS_TINY_PHONE and family.name:gsub(" Mafia", ""):gsub(" Bratva", ""):gsub(" Yakuza", ""):gsub(" Cartel", ""):gsub(" Triad", "") or family.name
		nameLabel.ZIndex = 85
		nameLabel.Parent = card
		
		-- Description
		local descLabel = Instance.new("TextLabel")
		descLabel.Size = UDim2.new(1, -textLeft - textRight, 0, descSize + 4)
		descLabel.Position = UDim2.new(0, textLeft, 0, (IS_TINY_PHONE and 8 or 12) + nameSize + 2)
		descLabel.BackgroundTransparency = 1
		descLabel.Font = F.Body
		descLabel.TextSize = descSize
		descLabel.TextColor3 = C.Gray500
		descLabel.TextXAlignment = Enum.TextXAlignment.Left
		descLabel.TextTruncate = Enum.TextTruncate.AtEnd
		descLabel.Text = family.desc
		descLabel.ZIndex = 85
		descLabel.Parent = card
		
		-- Join button
		local joinBtn = Instance.new("TextButton")
		joinBtn.Size = UDim2.new(0, btnW, 0, btnH)
		joinBtn.AnchorPoint = Vector2.new(1, 0.5)
		joinBtn.Position = UDim2.new(1, -rightPad, 0.5, 0)
		joinBtn.BackgroundColor3 = hasGamepass and C.Red or C.Gray700
		joinBtn.Font = F.Button
		joinBtn.TextSize = textSize(12)
		joinBtn.TextColor3 = C.White
		joinBtn.Text = hasGamepass and "Join" or "üëë"
		joinBtn.AutoButtonColor = false
		joinBtn.ZIndex = 86
		joinBtn.Parent = card
		UI.corner(joinBtn, px(10))
		
		joinBtn.MouseEnter:Connect(function()
			UI.tween(joinBtn, TweenInfo.new(0.12), {
				Size = UDim2.new(0, btnW + 4, 0, btnH + 4),
				BackgroundColor3 = (hasGamepass and C.RedDark or C.Gray800)
			})
		end)
		joinBtn.MouseLeave:Connect(function()
			UI.tween(joinBtn, TweenInfo.new(0.12), {
				Size = UDim2.new(0, btnW, 0, btnH),
				BackgroundColor3 = hasGamepass and C.Red or C.Gray700
			})
		end)
		
		joinBtn.MouseButton1Click:Connect(function()
			if hasGamepass then
				self:attemptJoinMob(family.id)
			else
				self:promptGamepassPurchase("MAFIA", "üî´ Organized Crime", "Join crime families, rise through ranks, run operations!")
			end
		end)
	end
end

function ActivitiesScreen:createMobStatusCard(parent, mobState)
	-- CRITICAL FIX #6: Nil safety for mobState
	if not mobState then
		return
	end
	
	-- CRITICAL UI FIX: Scale for mobile
	local cardH = IS_TINY_PHONE and 110 or (IS_SMALL_PHONE and 125 or 140)
	local pad = IS_TINY_PHONE and 6 or (IS_SMALL_PHONE and 8 or 10)
	local titleSize = textSize(16)
	local labelSize = textSize(13)
	local heatSize = textSize(10)
	local barH = IS_TINY_PHONE and 6 or 8
	
	local card = Instance.new("Frame")
	card.Name = "MobStatusCard"
	card.Size = UDim2.new(1, 0, 0, cardH)
	card.BackgroundColor3 = C.Gray800
	card.LayoutOrder = 1
	card.ZIndex = 84
	card.Parent = parent
	UI.corner(card, px(14))
	
	-- Family name
	local familyLabel = Instance.new("TextLabel")
	familyLabel.Size = UDim2.new(1, -pad*2, 0, titleSize + 8)
	familyLabel.Position = UDim2.new(0, pad, 0, pad)
	familyLabel.BackgroundTransparency = 1
	familyLabel.Font = F.Title
	familyLabel.TextSize = titleSize
	familyLabel.TextColor3 = C.White
	familyLabel.TextXAlignment = Enum.TextXAlignment.Left
	familyLabel.TextTruncate = Enum.TextTruncate.AtEnd
	familyLabel.Text = (mobState.familyEmoji or "üî´") .. " " .. (mobState.familyName or "Crime Family")
	familyLabel.ZIndex = 85
	familyLabel.Parent = card
	
	-- Rank + Respect row
	local row2Y = pad + titleSize + 6
	local rowH = labelSize + 4
	
	local rankLabel = Instance.new("TextLabel")
	rankLabel.Size = UDim2.new(0.5, -pad, 0, rowH)
	rankLabel.Position = UDim2.new(0, pad, 0, row2Y)
	rankLabel.BackgroundTransparency = 1
	rankLabel.Font = F.Medium
	rankLabel.TextSize = labelSize
	rankLabel.TextColor3 = C.Gray300
	rankLabel.TextXAlignment = Enum.TextXAlignment.Left
	rankLabel.TextTruncate = Enum.TextTruncate.AtEnd
	rankLabel.Text = (mobState.rankEmoji or "") .. " " .. (mobState.rankName or "Associate")
	rankLabel.ZIndex = 85
	rankLabel.Parent = card
	
	local respectLabel = Instance.new("TextLabel")
	respectLabel.Size = UDim2.new(0.5, -pad, 0, rowH)
	respectLabel.Position = UDim2.new(0.5, 0, 0, row2Y)
	respectLabel.BackgroundTransparency = 1
	respectLabel.Font = F.Medium
	respectLabel.TextSize = labelSize
	respectLabel.TextColor3 = C.Gray300
	respectLabel.TextXAlignment = Enum.TextXAlignment.Left
	respectLabel.Text = "üí™ " .. (mobState.respect or 0)
	respectLabel.ZIndex = 85
	respectLabel.Parent = card
	
	-- Heat bar
	local barY = row2Y + rowH + 4
	local heatBg = Instance.new("Frame")
	heatBg.Size = UDim2.new(1, -pad*2, 0, barH)
	heatBg.Position = UDim2.new(0, pad, 0, barY)
	heatBg.BackgroundColor3 = C.Gray600
	heatBg.ZIndex = 85
	heatBg.Parent = card
	UI.corner(heatBg, px(4))
	
	local heatFill = Instance.new("Frame")
	heatFill.Size = UDim2.new((mobState.heat or 0) / 100, 0, 1, 0)
	heatFill.BackgroundColor3 = C.Red
	heatFill.ZIndex = 86
	heatFill.Parent = heatBg
	UI.corner(heatFill, px(4))
	
	local heatLabel = Instance.new("TextLabel")
	heatLabel.Size = UDim2.new(1, -pad*2, 0, heatSize + 4)
	heatLabel.Position = UDim2.new(0, pad, 0, barY + barH + 2)
	heatLabel.BackgroundTransparency = 1
	heatLabel.Font = F.Body
	heatLabel.TextSize = heatSize
	heatLabel.TextColor3 = C.Gray400
	heatLabel.TextXAlignment = Enum.TextXAlignment.Left
	heatLabel.TextTruncate = Enum.TextTruncate.AtEnd
	local heatVal = mobState.heat or 0
	local heatStatus = heatVal > 70 and "Cops watching!" or (heatVal > 40 and "Noticed" or "Laying low")
	heatLabel.Text = "üî• " .. heatVal .. "% - " .. heatStatus
	heatLabel.ZIndex = 85
	heatLabel.Parent = card

	if mobState.lastEvent then
		local eventLabel = Instance.new("TextLabel")
		eventLabel.Size = UDim2.new(1, -pad*2, 0, textSize(10) + 10)
		eventLabel.Position = UDim2.new(0, pad, 0, barY + barH + heatSize + 10)
		eventLabel.BackgroundTransparency = 1
		eventLabel.Font = F.Body
		eventLabel.TextSize = textSize(10)
		eventLabel.TextColor3 = C.Gray300
		eventLabel.TextXAlignment = Enum.TextXAlignment.Left
		eventLabel.TextYAlignment = Enum.TextYAlignment.Top
		eventLabel.TextWrapped = true
		eventLabel.Text = "Last update: " .. mobState.lastEvent
		eventLabel.ZIndex = 85
		eventLabel.Parent = card
	end
end

function ActivitiesScreen:createMobPerksRow(parent, mobState)
	if not mobState then
		return
	end

	local row = Instance.new("Frame")
	row.Name = "MobPerksRow"
	row.Size = UDim2.new(1, 0, 0, IS_TINY_PHONE and 58 or (IS_SMALL_PHONE and 64 or 72))
	row.BackgroundTransparency = 1
	row.LayoutOrder = 2
	row.ZIndex = 83
	row.Parent = parent

	local perks = {
		{ label = "Respect", value = mobState.respect or 0, icon = "üí™", color = C.Red },
		{ label = "Heat", value = mobState.heat or 0, icon = "üî•", color = C.Orange },
		{ label = "Loyalty", value = mobState.loyalty or 0, icon = "ü§ù", color = C.Green },
	}

	local grid = Instance.new("UIGridLayout")
	grid.FillDirection = Enum.FillDirection.Horizontal
	grid.FillDirectionMaxCells = #perks
	grid.CellPadding = UDim2.new(0, IS_TINY_PHONE and 6 or (IS_SMALL_PHONE and 8 or 10), 0, 0)
	grid.CellSize = UDim2.new(1 / #perks, -(IS_TINY_PHONE and 6 or 10), 1, 0)
	grid.HorizontalAlignment = Enum.HorizontalAlignment.Left
	grid.VerticalAlignment = Enum.VerticalAlignment.Center
	grid.Parent = row

	for _, perk in ipairs(perks) do
		local card = Instance.new("Frame")
		card.Size = UDim2.new(1 / #perks, 0, 1, 0)
		card.BackgroundColor3 = Color3.fromRGB(248, 250, 252)
		card.ZIndex = 84
		card.Parent = row
		UI.corner(card, px(12))
		UI.stroke(card, 1, 0.9, C.Gray200)

		local label = Instance.new("TextLabel")
		label.Size = UDim2.new(1, -12, 0, textSize(11) + 2)
		label.Position = UDim2.new(0, 6, 0, 6)
		label.BackgroundTransparency = 1
		label.Font = F.Medium
		label.TextSize = textSize(11)
		label.TextColor3 = C.Gray600
		label.TextXAlignment = Enum.TextXAlignment.Left
		label.Text = perk.icon .. " " .. perk.label
		label.ZIndex = 85
		label.Parent = card

		local valueLabel = Instance.new("TextLabel")
		valueLabel.Size = UDim2.new(1, -12, 0, textSize(16) + 2)
		valueLabel.Position = UDim2.new(0, 6, 0, 6 + textSize(11) + 4)
		valueLabel.BackgroundTransparency = 1
		valueLabel.Font = F.Title
		valueLabel.TextSize = textSize(16)
		valueLabel.TextColor3 = perk.color or C.Gray800
		valueLabel.TextXAlignment = Enum.TextXAlignment.Left
		valueLabel.Text = tostring(perk.value)
		valueLabel.ZIndex = 85
		valueLabel.Parent = card
	end
end

function ActivitiesScreen:createMobOperationsCards(parent, mobState)
	-- CRITICAL FIX #5: Nil safety for mobState
	if not mobState then
		return
	end
	
	-- Get available operations based on state data
	local operations = {}
	if mobState.operations and #mobState.operations > 0 then
		for _, op in ipairs(mobState.operations) do
			local minReward = op.minReward or 0
			local maxReward = op.maxReward or minReward
			local rewardText
			if maxReward > minReward then
				rewardText = formatMoneyShort(minReward) .. " - " .. formatMoneyShort(maxReward)
			else
				rewardText = formatMoneyShort(minReward)
			end
			table.insert(operations, {
				id = op.id,
				name = op.name,
				shortName = op.shortName or op.name,
				emoji = op.emoji or "üí£",
				risk = op.risk or 0,
				reward = rewardText,
				minRank = op.minRank or op.rankRequired or 1,
				description = op.description,
			})
		end
	end

	if #operations == 0 then
		operations = {
			{ id = "protection", name = "Protection Racket", shortName = "Protection", emoji = "üí∞", risk = 20, reward = "$2K", minRank = 1, description = "Collect envelopes from shop owners." },
			{ id = "gambling", name = "Run Gambling Ring", shortName = "Gambling", emoji = "üé∞", risk = 30, reward = "$5K", minRank = 1, description = "Operate an underground casino." },
			{ id = "smuggling", name = "Smuggle Goods", shortName = "Smuggle", emoji = "üì¶", risk = 40, reward = "$10K", minRank = 2, description = "Move contraband through the docks." },
			{ id = "heist", name = "Plan a Heist", shortName = "Heist", emoji = "üè¶", risk = 60, reward = "$100K", minRank = 3, description = "Coordinate a high-stakes robbery." },
			{ id = "hitjob", name = "Hit Job", shortName = "Hit", emoji = "üéØ", risk = 80, reward = "$25K", minRank = 4, description = "Take out a rival target." },
		}
	end

	table.sort(operations, function(a, b)
		return (a.minRank or 1) < (b.minRank or 1)
	end)

	local header = Instance.new("TextLabel")
	header.Size = UDim2.new(1, 0, 0, textSize(13) + 10)
	header.BackgroundTransparency = 1
	header.Font = F.Medium
	header.TextSize = textSize(13)
	header.TextColor3 = C.Gray600
	header.TextXAlignment = Enum.TextXAlignment.Left
	header.Text = "Family Operations"
	header.LayoutOrder = 3
	header.ZIndex = 83
	header.Parent = parent
	
	-- CRITICAL UI FIX: Scale for mobile
	local cardH = IS_TINY_PHONE and 70 or (IS_SMALL_PHONE and 78 or 86)
	local iconS = IS_TINY_PHONE and 32 or (IS_SMALL_PHONE and 38 or 44)
	local btnW = IS_TINY_PHONE and 42 or (IS_SMALL_PHONE and 48 or 55)
	local btnH = IS_TINY_PHONE and 26 or (IS_SMALL_PHONE and 29 or 32)
	local pad = IS_TINY_PHONE and 6 or (IS_SMALL_PHONE and 8 or 10)
	local nameSize = textSize(13)
	local infoSize = textSize(11)
	local descSize = textSize(10)
	local emojiSize = textSize(20)
	local textLeft = iconS + pad + (IS_TINY_PHONE and 4 or 8)
	local textRight = btnW + pad + (IS_TINY_PHONE and 6 or 12)
	
	local currentRank = (mobState and mobState.rankLevel) or 1
	
	for i, op in ipairs(operations) do
		local requiredRank = op.minRank or 1
		local unlocked = currentRank >= requiredRank
		
		local card = Instance.new("Frame")
		card.Name = "OpCard_" .. op.id
		card.Size = UDim2.new(1, 0, 0, cardH)
		card.BackgroundColor3 = unlocked and C.White or C.Gray100
		card.LayoutOrder = i + 10
		card.ZIndex = 84
		card.Parent = parent
		UI.corner(card, px(14))
		UI.stroke(card, 1, 0.85, C.Gray200)
		
		-- Emoji
		local iconFrame = Instance.new("Frame")
		iconFrame.Size = UDim2.new(0, iconS, 0, iconS)
		iconFrame.Position = UDim2.new(0, pad, 0.5, -iconS/2)
		iconFrame.BackgroundColor3 = unlocked and C.RedPale or C.Gray200
		iconFrame.ZIndex = 85
		iconFrame.Parent = card
		UI.corner(iconFrame, px(12))
		
		local iconLabel = Instance.new("TextLabel")
		iconLabel.Size = UDim2.fromScale(1, 1)
		iconLabel.BackgroundTransparency = 1
		iconLabel.Font = F.Body
		iconLabel.TextSize = emojiSize
		iconLabel.Text = unlocked and op.emoji or "üîí"
		iconLabel.ZIndex = 86
		iconLabel.Parent = iconFrame
		
		-- Name (use shortName for tiny phones)
		local nameLabel = Instance.new("TextLabel")
		nameLabel.Size = UDim2.new(1, -textLeft - textRight, 0, nameSize + 4)
		nameLabel.Position = UDim2.new(0, textLeft, 0, IS_TINY_PHONE and 6 or 10)
		nameLabel.BackgroundTransparency = 1
		nameLabel.Font = F.Title
		nameLabel.TextSize = nameSize
		nameLabel.TextColor3 = unlocked and C.Gray900 or C.Gray400
		nameLabel.TextXAlignment = Enum.TextXAlignment.Left
		nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
		nameLabel.Text = IS_TINY_PHONE and op.shortName or op.name
		nameLabel.ZIndex = 85
		nameLabel.Parent = card
		
		-- Risk/Reward
		local infoLabel = Instance.new("TextLabel")
		infoLabel.Size = UDim2.new(1, -textLeft - textRight, 0, infoSize + 4)
		infoLabel.Position = UDim2.new(0, textLeft, 0, (IS_TINY_PHONE and 6 or 10) + nameSize + 2)
		infoLabel.BackgroundTransparency = 1
		infoLabel.Font = F.Body
		infoLabel.TextSize = infoSize
		infoLabel.TextColor3 = C.Gray500
		infoLabel.TextXAlignment = Enum.TextXAlignment.Left
		infoLabel.TextTruncate = Enum.TextTruncate.AtEnd
		local rewardText = op.reward or "$$$"
		infoLabel.Text = unlocked and (string.format("%d%% ‚Ä¢ %s", op.risk or 0, rewardText)) or ("Rank " .. requiredRank)
		infoLabel.ZIndex = 85
		infoLabel.Parent = card

		if op.description then
			local descLabel = Instance.new("TextLabel")
			descLabel.Size = UDim2.new(1, -textLeft - textRight, 0, descSize + 6)
			descLabel.Position = UDim2.new(0, textLeft, 0, (IS_TINY_PHONE and 6 or 10) + nameSize + infoSize + 6)
			descLabel.BackgroundTransparency = 1
			descLabel.Font = F.Body
			descLabel.TextSize = descSize
			descLabel.TextColor3 = C.Gray500
			descLabel.TextXAlignment = Enum.TextXAlignment.Left
			descLabel.TextWrapped = true
			descLabel.Text = op.description
			descLabel.ZIndex = 85
			descLabel.AutomaticSize = Enum.AutomaticSize.Y
			descLabel.Parent = card
		end
		
		-- Do button
		local doBtn = Instance.new("TextButton")
		doBtn.Size = UDim2.new(0, btnW, 0, btnH)
		doBtn.AnchorPoint = Vector2.new(1, 0.5)
		doBtn.Position = UDim2.new(1, -pad, 0.5, 0)
		doBtn.BackgroundColor3 = unlocked and C.Red or C.Gray300
		doBtn.Font = F.Button
		doBtn.TextSize = textSize(12)
		doBtn.TextColor3 = C.White
		doBtn.Text = unlocked and "Do" or "üîí"
		doBtn.AutoButtonColor = false
		doBtn.ZIndex = 86
		doBtn.Parent = card
		UI.corner(doBtn, px(8))
		
		if unlocked then
			doBtn.MouseButton1Click:Connect(function()
				self:doMobOperation(op.id, op.name)
			end)
		end
	end
	
	-- Leave family button (scaled for mobile)
	local leaveCardH = IS_TINY_PHONE and 40 or (IS_SMALL_PHONE and 45 or 50)
	local leaveBtnH = IS_TINY_PHONE and 28 or (IS_SMALL_PHONE and 32 or 36)
	local leavePad = IS_TINY_PHONE and 6 or (IS_SMALL_PHONE and 8 or 10)
	
	local leaveCard = Instance.new("Frame")
	leaveCard.Name = "LeaveCard"
	leaveCard.Size = UDim2.new(1, 0, 0, leaveCardH)
	leaveCard.BackgroundColor3 = C.White
	leaveCard.LayoutOrder = 100
	leaveCard.ZIndex = 84
	leaveCard.Parent = parent
	UI.corner(leaveCard, px(14))
	UI.stroke(leaveCard, 1, 0.85, C.Gray200)
	
	local leaveBtn = Instance.new("TextButton")
	leaveBtn.Size = UDim2.new(1, -leavePad*2, 0, leaveBtnH)
	leaveBtn.Position = UDim2.new(0, leavePad, 0.5, -leaveBtnH/2)
	leaveBtn.BackgroundColor3 = C.Gray200
	leaveBtn.Font = F.Button
	leaveBtn.TextSize = textSize(13)
	leaveBtn.TextColor3 = C.Gray700
	leaveBtn.Text = IS_TINY_PHONE and "üö™ Leave" or "üö™ Leave the Family (Risky!)"
	leaveBtn.AutoButtonColor = false
	leaveBtn.ZIndex = 85
	leaveBtn.Parent = leaveCard
	UI.corner(leaveBtn, px(10))
	
	leaveBtn.MouseButton1Click:Connect(function()
		self:attemptLeaveMob()
	end)
end

function ActivitiesScreen:attemptJoinMob(familyId)
	log("Attempting to join mob:", familyId)
	local JoinMob = getRemote("JoinMob")
	if JoinMob then
		-- CRITICAL FIX #4: Add pcall protection
		local success, result = pcall(function()
			return JoinMob:InvokeServer(familyId)
		end)
		if success and result and result.success then
			-- CRITICAL FIX #26: Update local state with mob info immediately
			if self.playerState then
				self.playerState.MobState = result.mobState or {
					inMob = true,
					familyId = familyId,
					familyName = result.familyName or "Crime Family",
					familyEmoji = result.familyEmoji or "üî´",
					rankLevel = 1,
					rankName = "Associate",
					rankEmoji = "üî∞",
					respect = 0,
					heat = 0,
					loyalty = 50,
				}
				self.playerState.Flags = self.playerState.Flags or {}
				self.playerState.Flags.in_mob = true
				self.playerState.Flags.mafia_member = true
			end
			-- Also update self.state for getMobState()
			if self.state then
				self.state.MobState = self.playerState and self.playerState.MobState or result.mobState
				self.state.Flags = self.state.Flags or {}
				self.state.Flags.in_mob = true
			end
			self:showResult(true, result.message or "You've been initiated into the family!", "üî´")
			-- CRITICAL FIX #34: Delay refresh to allow state to propagate
			task.delay(0.3, function()
				self:switchTab("crime") -- Refresh to show mob operations
			end)
		elseif success and result then
			self:showResult(false, result.message or "The family rejected you.", "‚ùå")
		else
			self:showResult(false, "Connection error. Try again.", "‚ùå")
		end
	else
		-- Fallback for testing - also update local state
		if self.playerState then
			self.playerState.MobState = {
				inMob = true,
				familyId = familyId,
				familyName = "Crime Family",
				familyEmoji = "üî´",
				rankLevel = 1,
				rankName = "Associate",
				rankEmoji = "üî∞",
				respect = 0,
				heat = 0,
				loyalty = 50,
			}
			self.playerState.Flags = self.playerState.Flags or {}
			self.playerState.Flags.in_mob = true
		end
		self:showResult(true, "You've joined the crime family! Rise through the ranks...", "üî´")
		task.delay(0.3, function()
			self:switchTab("crime")
		end)
	end
end

function ActivitiesScreen:attemptLeaveMob()
	log("Attempting to leave mob")
	local LeaveMob = getRemote("LeaveMob")
	if LeaveMob then
		-- CRITICAL FIX #4: Add pcall protection
		local success, result = pcall(function()
			return LeaveMob:InvokeServer()
		end)
		if success and result and result.success then
			self:showResult(true, result.message or "You've left the family. Watch your back...", "üö™")
			self:switchTab("crime") -- Refresh
		elseif success and result then
			self:showResult(false, result.message or "You can't leave... not alive anyway.", "üíÄ")
		else
			self:showResult(false, "Connection error. Try again.", "‚ùå")
		end
	else
		self:showResult(true, "You've left the crime family. They won't forget this...", "üö™")
	end
end

function ActivitiesScreen:doMobOperation(opId, opName)
	log("Doing mob operation:", opId)
	local DoMobOp = getRemote("DoMobOperation")
	if DoMobOp then
		-- CRITICAL FIX #3: Add pcall protection for server calls
		local success, result = pcall(function()
			return DoMobOp:InvokeServer(opId)
		end)
		if success and result and result.success then
			local msg = result.message or string.format("Operation successful! +$%s +%d respect", result.money or 0, result.respect or 0)
			self:showResult(true, msg, "üí∞")
			
			-- CRITICAL FIX: Update local mob state after operation
			if self.state and self.state.MobState then
				if result.respect then
					self.state.MobState.respect = (self.state.MobState.respect or 0) + result.respect
				end
				if result.promoted then
					-- Refresh tab to show new rank
					task.delay(0.5, function()
						self:switchTab("crime")
					end)
				end
			end
		elseif success and result then
			local msg = result.message or "The operation failed..."
			-- CRITICAL FIX: If arrested, update local state
			if result.arrested and self.state then
				self.state.InJail = true
			end
			self:showResult(false, msg, result.arrested and "üöî" or "‚ùå")
		else
			self:showResult(false, "Connection error. Try again.", "‚ùå")
		end
	else
		-- Fallback for testing
		self:showResult(true, opName .. " completed! You earned cash and respect.", "üí∞")
	end
	self:updateInfoBar()
	self:switchTab("crime") -- Refresh
end

function ActivitiesScreen:getMobState()
	-- CRITICAL FIX #21 & #34: Check both playerState and state for MobState
	if self.playerState and self.playerState.MobState then
		return self.playerState.MobState
	end
	if self.state and self.state.MobState then
		return self.state.MobState
	end
	-- Also check flags to ensure consistency
	local flags = (self.playerState and self.playerState.Flags) or (self.state and self.state.Flags)
	if flags and flags.in_mob then
		-- Return a minimal mob state if we know they're in mob but don't have full state
		return {
			inMob = true,
			familyId = flags.mob_family_id,
			familyName = flags.mob_family_name or "Crime Family",
			familyEmoji = "üî´",
			rankLevel = flags.mob_rank or 1,
			rankName = "Associate",
			rankEmoji = "üî∞",
			respect = 0,
			heat = 0,
			loyalty = 50,
		}
	end
	return nil
end

function ActivitiesScreen:checkGamepassOwnership(gamepassKey)
	-- CRITICAL FIX #2: Add pcall protection for remote calls
	local CheckGamepass = getRemote("CheckGamepass")
	if CheckGamepass then
		local success, owns = pcall(function()
			return CheckGamepass:InvokeServer(gamepassKey)
		end)
		if success then
			return owns == true
		end
	end
	return false
end

function ActivitiesScreen:promptGamepassPurchase(gamepassKey, title, description)
	-- Show purchase prompt modal (BitLife style)
	self:showGamepassPrompt(gamepassKey, title, description)
end

function ActivitiesScreen:showGamepassPrompt(gamepassKey, title, description)
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- CRITICAL FIX: Premium BitLife-style purchase prompt with proper mobile scaling
	-- Matches the quality of AssetsScreen result modal
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	if self.gamepassPromptOverlay then
		self.gamepassPromptOverlay:Destroy()
	end
	
	-- CRITICAL: Mobile-responsive dimensions
	local modalWidth = IS_TINY_PHONE and 280 or (IS_SMALL_PHONE and 300 or 340)
	local modalHeight = IS_TINY_PHONE and 280 or (IS_SMALL_PHONE and 300 or 340)
	local padX = IS_TINY_PHONE and 12 or (IS_SMALL_PHONE and 16 or 20)
	local padY = IS_TINY_PHONE and 10 or (IS_SMALL_PHONE and 14 or 18)
	local crownSize = IS_TINY_PHONE and 44 or (IS_SMALL_PHONE and 52 or 64)
	local titleSize = textSize(IS_TINY_PHONE and 16 or 20)
	local descSize = textSize(IS_TINY_PHONE and 12 or 14)
	local btnTextSize = textSize(IS_TINY_PHONE and 14 or 16)
	local btnHeight = IS_TINY_PHONE and 40 or (IS_SMALL_PHONE and 44 or 50)
	
	-- Overlay background
	local overlay = Instance.new("Frame")
	overlay.Name = "GamepassPromptOverlay"
	overlay.Size = UDim2.fromScale(1, 1)
	overlay.BackgroundColor3 = C.Black
	overlay.BackgroundTransparency = 0.35
	overlay.ZIndex = 200
	overlay.Parent = self.screenGui
	self.gamepassPromptOverlay = overlay
	
	-- Click outside to close (BEHIND container)
	local closeArea = Instance.new("TextButton")
	closeArea.Size = UDim2.fromScale(1, 1)
	closeArea.BackgroundTransparency = 1
	closeArea.Text = ""
	closeArea.ZIndex = 200
	closeArea.Parent = overlay
	closeArea.MouseButton1Click:Connect(function()
		overlay:Destroy()
	end)
	
	-- Premium shadow
	local shadowOffset = IS_TINY_PHONE and 6 or 10
	local shadow = Instance.new("Frame")
	shadow.Size = UDim2.new(0, modalWidth + shadowOffset, 0, modalHeight + shadowOffset)
	shadow.AnchorPoint = Vector2.new(0.5, 0.5)
	shadow.Position = UDim2.new(0.5, shadowOffset/2, 0.5, shadowOffset/2)
	shadow.BackgroundColor3 = C.Black
	shadow.BackgroundTransparency = 0.65
	shadow.ZIndex = 201
	shadow.Parent = overlay
	UI.corner(shadow, IS_TINY_PHONE and 22 or 28)
	
	-- Gold outer shell (premium feel)
	local shell = Instance.new("Frame")
	shell.Size = UDim2.new(0, modalWidth, 0, modalHeight)
	shell.AnchorPoint = Vector2.new(0.5, 0.5)
	shell.Position = UDim2.fromScale(0.5, 0.5)
	shell.BackgroundColor3 = Color3.fromRGB(255, 200, 50) -- Rich gold
	shell.ZIndex = 202
	shell.Parent = overlay
	UI.corner(shell, IS_TINY_PHONE and 20 or 26)
	
	-- Gold stroke for extra premium
	local shellStroke = Instance.new("UIStroke")
	shellStroke.Color = Color3.fromRGB(200, 150, 0)
	shellStroke.Thickness = 2
	shellStroke.Parent = shell
	
	-- White inner card
	local inner = Instance.new("Frame")
	inner.Size = UDim2.new(1, -8, 1, -8)
	inner.Position = UDim2.new(0, 4, 0, 4)
	inner.BackgroundColor3 = C.White
	inner.ZIndex = 203
	inner.Parent = shell
	UI.corner(inner, IS_TINY_PHONE and 18 or 24)
	
	-- Crown icon frame (circular gold bg)
	local crownFrame = Instance.new("Frame")
	crownFrame.Size = UDim2.new(0, crownSize, 0, crownSize)
	crownFrame.AnchorPoint = Vector2.new(0.5, 0)
	crownFrame.Position = UDim2.new(0.5, 0, 0, padY)
	crownFrame.BackgroundColor3 = Color3.fromRGB(255, 240, 180)
	crownFrame.ZIndex = 204
	crownFrame.Parent = inner
	UI.corner(crownFrame, crownSize/2)
	
	local crownLabel = Instance.new("TextLabel")
	crownLabel.Size = UDim2.fromScale(1, 1)
	crownLabel.BackgroundTransparency = 1
	crownLabel.Font = F.Body
	crownLabel.TextSize = IS_TINY_PHONE and 28 or (IS_SMALL_PHONE and 34 or 40)
	crownLabel.Text = "üëë"
	crownLabel.ZIndex = 205
	crownLabel.Parent = crownFrame
	
	-- Title (properly positioned below crown)
	local titleY = padY + crownSize + (IS_TINY_PHONE and 8 or 14)
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Size = UDim2.new(1, -padX*2, 0, titleSize + 8)
	titleLabel.Position = UDim2.new(0, padX, 0, titleY)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Font = F.Title
	titleLabel.TextSize = titleSize
	titleLabel.TextColor3 = C.Gray900
	titleLabel.Text = title
	titleLabel.TextTruncate = Enum.TextTruncate.AtEnd
	titleLabel.ZIndex = 204
	titleLabel.Parent = inner
	
	-- Description (properly spaced below title)
	local descY = titleY + titleSize + (IS_TINY_PHONE and 6 or 12)
	local descLabel = Instance.new("TextLabel")
	descLabel.Size = UDim2.new(1, -padX*2, 0, IS_TINY_PHONE and 40 or 56)
	descLabel.Position = UDim2.new(0, padX, 0, descY)
	descLabel.BackgroundTransparency = 1
	descLabel.Font = F.Body
	descLabel.TextSize = descSize
	descLabel.TextColor3 = C.Gray500
	descLabel.TextWrapped = true
	descLabel.TextYAlignment = Enum.TextYAlignment.Top
	descLabel.Text = description
	descLabel.ZIndex = 204
	descLabel.Parent = inner
	
	-- Buy button (positioned from bottom)
	local btnGap = IS_TINY_PHONE and 8 or 12
	local buyBtn = Instance.new("TextButton")
	buyBtn.Size = UDim2.new(1, -padX*2, 0, btnHeight)
	buyBtn.Position = UDim2.new(0, padX, 1, -(btnHeight*2 + btnGap + padY))
	buyBtn.BackgroundColor3 = Color3.fromRGB(255, 200, 50)
	buyBtn.Font = F.Button
	buyBtn.TextSize = btnTextSize
	buyBtn.TextColor3 = C.Gray900
	buyBtn.Text = "üëë Unlock Now"
	buyBtn.AutoButtonColor = false
	buyBtn.ZIndex = 204
	buyBtn.Parent = inner
	UI.corner(buyBtn, IS_TINY_PHONE and 10 or 14)
	
	-- Hover effect
	buyBtn.MouseEnter:Connect(function()
		UI.tween(buyBtn, TweenInfo.new(0.12), { BackgroundColor3 = Color3.fromRGB(255, 180, 30) })
	end)
	buyBtn.MouseLeave:Connect(function()
		UI.tween(buyBtn, TweenInfo.new(0.12), { BackgroundColor3 = Color3.fromRGB(255, 200, 50) })
	end)
	
	buyBtn.MouseButton1Click:Connect(function()
		-- Prompt actual Roblox purchase
		local PromptPurchase = getRemote("PromptGamepass")
		if PromptPurchase then
			PromptPurchase:FireServer(gamepassKey)
		end
		overlay:Destroy()
	end)
	
	-- Close button (below buy button)
	local closeBtn = Instance.new("TextButton")
	closeBtn.Size = UDim2.new(1, -padX*2, 0, btnHeight - 8)
	closeBtn.Position = UDim2.new(0, padX, 1, -(btnHeight - 8 + padY))
	closeBtn.BackgroundColor3 = C.Gray100
	closeBtn.Font = F.Button
	closeBtn.TextSize = textSize(IS_TINY_PHONE and 12 or 14)
	closeBtn.TextColor3 = C.Gray500
	closeBtn.Text = "Maybe Later"
	closeBtn.AutoButtonColor = false
	closeBtn.ZIndex = 204
	closeBtn.Parent = inner
	UI.corner(closeBtn, IS_TINY_PHONE and 8 or 12)
	
	closeBtn.MouseEnter:Connect(function()
		UI.tween(closeBtn, TweenInfo.new(0.12), { BackgroundColor3 = C.Gray200 })
	end)
	closeBtn.MouseLeave:Connect(function()
		UI.tween(closeBtn, TweenInfo.new(0.12), { BackgroundColor3 = C.Gray100 })
	end)
	
	closeBtn.MouseButton1Click:Connect(function()
		overlay:Destroy()
	end)
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- MISCHIEF TAB - Age-appropriate troublemaking!
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ActivitiesScreen:populateMischief()
	self:updateInfoBar()
	
	local age = self:getAge()
	
	-- Determine which mischief activities based on age
	local activities = {}
	local headerText
	local headerColor
	local warningText
	
	if age < 5 then
		-- Baby/Toddler mischief
		for _, item in ipairs(BabyMischief) do
			if age >= (item.minAge or 0) and age <= (item.maxAge or 99) then
				table.insert(activities, item)
			end
		end
		headerText = "üòà Baby Mischief"
		headerColor = C.Red
		warningText = "Be a little troublemaker! These are normal baby things... mostly."
	elseif age < 13 then
		-- Child mischief
		for _, item in ipairs(ChildMischief) do
			if age >= (item.minAge or 0) and age <= (item.maxAge or 99) then
				table.insert(activities, item)
			end
		end
		headerText = "üòà Kid Trouble"
		headerColor = C.Red
		warningText = "Being a kid means getting into trouble sometimes. Just don't get caught!"
	else
		-- Teen mischief
		for _, item in ipairs(TeenMischief) do
			if age >= (item.minAge or 0) and age <= (item.maxAge or 99) then
				table.insert(activities, item)
			end
		end
		headerText = "üòà Teen Rebellion"
		headerColor = C.Red
		warningText = "Being a teenager is about pushing limits. Some of these could get you in real trouble!"
	end

	-- Warning/Info card
	local warningCard = Instance.new("Frame")
	warningCard.Size = UDim2.new(1, 0, 0, 70)
	warningCard.BackgroundColor3 = C.RedPale
	warningCard.LayoutOrder = 0
	warningCard.ZIndex = 82
	warningCard.Parent = self.contentScroll
	UI.corner(warningCard, 16)
	UI.stroke(warningCard, 1, 0.7, C.Red)

	local warnIcon = Instance.new("TextLabel")
	warnIcon.Size = UDim2.new(0, 44, 0, 44)
	warnIcon.Position = UDim2.new(0, 12, 0.5, -22)
	warnIcon.BackgroundTransparency = 1
	warnIcon.Font = Enum.Font.GothamBold
	warnIcon.TextSize = 32
	if age < 5 then
		warnIcon.Text = "üë∂"
	elseif age < 13 then
		warnIcon.Text = "üßí"
	else
		warnIcon.Text = "üòà"
	end
	warnIcon.ZIndex = 83
	warnIcon.Parent = warningCard

	local warnText = Instance.new("TextLabel")
	warnText.Size = UDim2.new(1, -75, 1, -16)
	warnText.Position = UDim2.new(0, 65, 0, 8)
	warnText.BackgroundTransparency = 1
	warnText.Font = F.Body
	warnText.TextSize = 13
	warnText.TextColor3 = C.RedDark
	warnText.TextXAlignment = Enum.TextXAlignment.Left
	warnText.TextWrapped = true
	warnText.Text = warningText
	warnText.ZIndex = 83
	warnText.Parent = warningCard

	-- Mischief section
	local section = Instance.new("Frame")
	section.Name = "MischiefSection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 1
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)

	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section

	-- Header
	local header = Instance.new("Frame")
	header.Size = UDim2.new(1, 0, 0, 36)
	header.BackgroundTransparency = 1
	header.LayoutOrder = 0
	header.ZIndex = 83
	header.Parent = section

	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, 140, 0, 32)
	badge.BackgroundColor3 = headerColor
	badge.ZIndex = 84
	badge.Parent = header
	UI.pill(badge)

	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.fromScale(1, 1)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.Font = F.Button
	badgeLabel.TextSize = 14
	badgeLabel.TextColor3 = C.White
	badgeLabel.Text = headerText
	badgeLabel.ZIndex = 85
	badgeLabel.Parent = badge

	local countLabel = Instance.new("TextLabel")
	countLabel.Size = UDim2.new(0, 80, 1, 0)
	countLabel.Position = UDim2.new(0, 150, 0, 0)
	countLabel.BackgroundTransparency = 1
	countLabel.Font = F.Medium
	countLabel.TextSize = 13
	countLabel.TextColor3 = C.Gray400
	countLabel.TextXAlignment = Enum.TextXAlignment.Left
	countLabel.Text = #activities .. " options"
	countLabel.ZIndex = 84
	countLabel.Parent = header

	-- Create cards for each mischief activity
	for i, item in ipairs(activities) do
		self:createMischiefCard(section, item, i)
	end
end

-- Create a mischief activity card
function ActivitiesScreen:createMischiefCard(parent, item, index)
	local age = self:getAge()
	local card = Instance.new("Frame")
	card.Name = "MischiefCard_" .. item.id
	card.Size = UDim2.new(1, 0, 0, 65)
	card.BackgroundColor3 = C.White
	card.LayoutOrder = index
	card.ZIndex = 84
	card.Parent = parent
	UI.corner(card, 14)
	UI.stroke(card, 1, 0.85, C.Gray200)

	-- Emoji icon
	local iconFrame = Instance.new("Frame")
	iconFrame.Size = UDim2.new(0, 48, 0, 48)
	iconFrame.Position = UDim2.new(0, 8, 0.5, -24)
	iconFrame.BackgroundColor3 = C.RedPale
	iconFrame.ZIndex = 85
	iconFrame.Parent = card
	UI.corner(iconFrame, 12)

	local iconLabel = Instance.new("TextLabel")
	iconLabel.Size = UDim2.fromScale(1, 1)
	iconLabel.BackgroundTransparency = 1
	iconLabel.Font = Enum.Font.GothamBold
	iconLabel.TextSize = 26
	iconLabel.Text = item.emoji
	iconLabel.ZIndex = 86
	iconLabel.Parent = iconFrame

	-- Name
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(1, -130, 0, 22)
	nameLabel.Position = UDim2.new(0, 65, 0, 10)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Font = F.Medium or Enum.Font.GothamMedium
	nameLabel.TextSize = 15
	nameLabel.TextColor3 = C.Gray900
	nameLabel.TextXAlignment = Enum.TextXAlignment.Left
	nameLabel.Text = item.name
	nameLabel.ZIndex = 85
	nameLabel.Parent = card

	-- Effect
	local effectLabel = Instance.new("TextLabel")
	effectLabel.Size = UDim2.new(1, -130, 0, 18)
	effectLabel.Position = UDim2.new(0, 65, 0, 34)
	effectLabel.BackgroundTransparency = 1
	effectLabel.Font = F.Body
	effectLabel.TextSize = 12
	effectLabel.TextColor3 = C.Gray500
	effectLabel.TextXAlignment = Enum.TextXAlignment.Left
	effectLabel.Text = item.effect or ""
	effectLabel.ZIndex = 85
	effectLabel.Parent = card

	-- Risk indicator if present
	if item.risk and item.risk > 0 then
		local riskLabel = Instance.new("TextLabel")
		riskLabel.Size = UDim2.new(0, 50, 0, 20)
		riskLabel.AnchorPoint = Vector2.new(1, 0.5)
		riskLabel.Position = UDim2.new(1, -60, 0.5, 0)
		riskLabel.BackgroundColor3 = C.RedPale
		riskLabel.Font = F.Medium
		riskLabel.TextSize = 11
		riskLabel.TextColor3 = C.RedDark
		riskLabel.Text = "‚ö†Ô∏è" .. item.risk .. "%"
		riskLabel.ZIndex = 85
		riskLabel.Parent = card
		UI.pill(riskLabel)
	end

	-- Do button
	local doBtn = Instance.new("TextButton")
	doBtn.Size = UDim2.new(0, 50, 0, 36)
	doBtn.AnchorPoint = Vector2.new(1, 0.5)
	doBtn.Position = UDim2.new(1, -8, 0.5, 0)
	doBtn.BackgroundColor3 = C.Red
	doBtn.Font = F.Button
	doBtn.TextSize = 13
	doBtn.TextColor3 = C.White
	doBtn.Text = "Do It!"
	doBtn.AutoButtonColor = false
	doBtn.ZIndex = 86
	doBtn.Parent = card
	UI.corner(doBtn, 10)

	doBtn.MouseEnter:Connect(function()
		UI.tween(doBtn, TweenInfo.new(0.1), { BackgroundColor3 = C.RedDark or C.Red })
	end)
	doBtn.MouseLeave:Connect(function()
		UI.tween(doBtn, TweenInfo.new(0.1), { BackgroundColor3 = C.Red })
	end)

	doBtn.MouseButton1Click:Connect(function()
		self:doMischief(item)
	end)
end

-- Execute mischief activity
function ActivitiesScreen:doMischief(item)
	log("Doing mischief:", item.id, item.name)
	
	-- Use DoActivity remote for mischief (server handles it)
	-- CRITICAL FIX: Add pcall protection for robust error handling
	if DoActivity then
		local success, result = pcall(function()
			return DoActivity:InvokeServer(item.id)
		end)
		if success and result then
			if result.success then
				self:showResult(true, result.message or ("You " .. string.lower(item.name) .. "!"), item.emoji)
			else
				self:showResult(false, result.message or "That didn't work out...", "üòÖ")
			end
		elseif not success then
			-- Server error - use fallback message
			local messages = {
				cry_loudly = "You cry SO LOUD! Everyone comes running!",
				throw_food = "SPLAT! Food goes everywhere! Mom is NOT happy.",
				break_toy = "Oops! The toy is in pieces now...",
				draw_walls = "Your artistic masterpiece covers the whole wall!",
				refuse_nap = "NO NAP! You're cranky but FREE!",
				tantrum = "You SCREAM and kick! Maximum drama!",
				bite_sibling = "CHOMP! Your sibling runs away crying!",
				hide_mom_keys = "The keys are hidden REALLY well. Mom searches for an hour!",
				skip_chores = "You sneak away from chores. Hope no one notices!",
				prank_sibling = "GOTCHA! Your sibling falls for it!",
				sneak_candy = "You grab candy when no one's looking. Sweet success!",
				stay_up_late = "You watch TV under the covers until midnight!",
				cheat_test = "You peek at your neighbor's paper...",
				talk_back = "You give your parents some ATTITUDE!",
				blame_sibling = "It wasn't ME, it was THEM!",
				fake_sick = "Cough cough... you're suddenly 'too sick' for school!",
				toilet_paper_house = "The neighbor's house is now decorated in TP!",
				ring_doorbell_run = "DING DONG... and you're GONE!",
				sneak_out = "You climb out the window into the night!",
				skip_class = "You ditch class and hang out instead!",
				party_crash = "You show up uninvited but act like you belong!",
				fake_id = "You get a fake ID... hope it works!",
				vandalize = "You leave your mark on something...",
				bully = "You pick on someone smaller...",
				steal_parents_car = "You take the car for a joyride!",
				break_curfew = "It's way past curfew and you're still out!",
				drink_underage = "You drink at a party... hope no one tells!",
				smoke = "You try a cigarette. Gross!",
			}
			
			local msg = messages[item.id] or ("You " .. string.lower(item.name) .. "!")
			self:showResult(true, msg, item.emoji)
		end
	else
		logWarn("DoActivity remote not found!")
		self:showResult(false, "Something went wrong!", "‚ùå")
	end
	
	-- Update UI
	self:updateInfoBar()
end

function ActivitiesScreen:populatePrison()
	log("=== POPULATING PRISON VIEW ===")
	self:updateInfoBar()

	local jailYears = self:getJailYearsLeft()
	log("Jail years remaining:", jailYears)

	-- Prison status header
	local headerCard = Instance.new("Frame")
	headerCard.Size = UDim2.new(1, 0, 0, 95)
	headerCard.BackgroundColor3 = C.Gray800
	headerCard.LayoutOrder = 0
	headerCard.ZIndex = 82
	headerCard.Parent = self.contentScroll
	UI.corner(headerCard, 18)

	-- Prison emoji icon
	local iconFrame = Instance.new("Frame")
	iconFrame.Size = UDim2.new(0, 55, 0, 55)
	iconFrame.Position = UDim2.new(0, 16, 0.5, -27.5)
	iconFrame.BackgroundColor3 = C.Gray700
	iconFrame.ZIndex = 83
	iconFrame.Parent = headerCard
	UI.corner(iconFrame, 12)

	local headerIcon = Instance.new("TextLabel")
	headerIcon.Size = UDim2.fromScale(1, 1)
	headerIcon.BackgroundTransparency = 1
	headerIcon.Font = F.Body
	headerIcon.TextSize = 32
	headerIcon.Text = "‚õìÔ∏è"
	headerIcon.TextColor3 = C.White
	headerIcon.ZIndex = 84
	headerIcon.Parent = iconFrame

	local headerText = Instance.new("TextLabel")
	headerText.Size = UDim2.new(1, -85, 0, 26)
	headerText.Position = UDim2.new(0, 80, 0, 14)
	headerText.BackgroundTransparency = 1
	headerText.Font = F.Title
	headerText.TextSize = 20
	headerText.TextColor3 = C.White
	headerText.TextXAlignment = Enum.TextXAlignment.Left
	headerText.Text = "You're in Prison"
	headerText.ZIndex = 83
	headerText.Parent = headerCard

	-- Sentence badge
	local sentenceBadge = Instance.new("Frame")
	sentenceBadge.Size = UDim2.new(0, 120, 0, 26)
	sentenceBadge.Position = UDim2.new(0, 80, 0, 42)
	sentenceBadge.BackgroundColor3 = C.RedPale
	sentenceBadge.ZIndex = 83
	sentenceBadge.Parent = headerCard
	UI.pill(sentenceBadge)

	local sentenceText = Instance.new("TextLabel")
	sentenceText.Size = UDim2.fromScale(1, 1)
	sentenceText.BackgroundTransparency = 1
	sentenceText.Font = F.Medium
	sentenceText.TextSize = 12
	sentenceText.TextColor3 = C.RedDark
	sentenceText.Text = jailYears > 0 and string.format("%.1f years left", jailYears) or "Sentence pending"
	sentenceText.ZIndex = 84
	sentenceText.Parent = sentenceBadge

	local headerSub = Instance.new("TextLabel")
	headerSub.Size = UDim2.new(1, -85, 0, 20)
	headerSub.Position = UDim2.new(0, 80, 0, 70)
	headerSub.BackgroundTransparency = 1
	headerSub.Font = F.Body
	headerSub.TextSize = 13
	headerSub.TextColor3 = C.Gray400
	headerSub.TextXAlignment = Enum.TextXAlignment.Left
	headerSub.Text = "Choose your actions wisely..."
	headerSub.ZIndex = 83
	headerSub.Parent = headerCard

	-- Prison section
	local section = Instance.new("Frame")
	section.Name = "PrisonSection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 1
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)

	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section

	-- Header
	local header = Instance.new("Frame")
	header.Size = UDim2.new(1, 0, 0, 36)
	header.BackgroundTransparency = 1
	header.LayoutOrder = 0
	header.ZIndex = 83
	header.Parent = section

	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, 130, 0, 32)
	badge.BackgroundColor3 = C.Gray600
	badge.ZIndex = 84
	badge.Parent = header
	UI.pill(badge)

	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.fromScale(1, 1)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.Font = F.Button
	badgeLabel.TextSize = 14
	badgeLabel.TextColor3 = C.White
	badgeLabel.Text = "Prison Actions"
	badgeLabel.ZIndex = 85
	badgeLabel.Parent = badge

	for i, item in ipairs(PrisonActivities) do
		self:createPrisonCard(section, item, i)
	end
end

function ActivitiesScreen:createActivityCard(parent, item, order, accentColor, paleColor)
	local age = self:getAge()
	local money = self:getMoney()
	local flags = self:getFlags()
	local cost = item.cost or 0
	local accentDark = accentColor:Lerp(C.Black, 0.2)
	
	-- CRITICAL FIX: Check for activity-specific flags like requiresFlag and maxAge
	local meetsFlag = true
	if item.requiresFlag then
		meetsFlag = flags[item.requiresFlag] == true
	end
	local meetsMaxAge = true
	if item.maxAge then
		meetsMaxAge = age <= item.maxAge
	end
	
	-- CRITICAL FIX: Default minAge to 0 if not specified to prevent nil comparison error
	local canDo = age >= (item.minAge or 0) and money >= cost and not self:isInJail() and meetsFlag and meetsMaxAge

	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- CRITICAL REVAMP: Premium Card with Shell Structure (like LifeClient popup)
	-- Container -> Shadow -> Shell -> Inner Card
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	
	-- Container (holds everything)
	local container = Instance.new("Frame")
	container.Name = item.id .. "_Container"
	container.Size = UDim2.new(1, 0, 0, 95)
	container.BackgroundTransparency = 1
	container.LayoutOrder = order
	container.ZIndex = 82
	container.Parent = parent
	
	-- Shadow layer (premium depth)
	local shadow = Instance.new("Frame")
	shadow.Name = "Shadow"
	shadow.Size = UDim2.new(1, 4, 1, 4)
	shadow.Position = UDim2.new(0, 2, 0, 2)
	shadow.BackgroundColor3 = C.Black
	shadow.BackgroundTransparency = canDo and 0.92 or 0.96
	shadow.ZIndex = 82
	shadow.Parent = container
	UI.corner(shadow, 18)
	
	-- Colored shell (accent border)
	local shell = Instance.new("Frame")
	shell.Name = "Shell"
	shell.Size = UDim2.new(1, 0, 1, 0)
	shell.BackgroundColor3 = canDo and accentColor or C.Gray300
	shell.ZIndex = 83
	shell.Parent = container
	UI.corner(shell, 16)
	
	-- Inner white card
	local card = Instance.new("Frame")
	card.Name = "Card"
	card.Size = UDim2.new(1, -6, 1, -6)
	card.Position = UDim2.new(0, 3, 0, 3)
	card.BackgroundColor3 = C.White
	card.ZIndex = 84
	card.Parent = shell
	UI.corner(card, 14)
	
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- PREMIUM HOVER & PRESS EFFECTS
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	
	if canDo then
		-- CRITICAL FIX: Reduced width to not cover the action button on the right
		local pressArea = Instance.new("TextButton")
		pressArea.Name = "PressArea"
		pressArea.Size = UDim2.new(1, -95, 1, 0)  -- Leave 95px for button
		pressArea.BackgroundTransparency = 1
		pressArea.Text = ""
		pressArea.ZIndex = 90
		pressArea.Parent = container
		
		local isHovering = false
		local isPressed = false
		
		pressArea.MouseEnter:Connect(function()
			if isPressed then return end
			isHovering = true
			-- Premium hover: lift and brighten
			UI.tween(container, TweenInfo.new(0.15, Enum.EasingStyle.Quad), {
				Size = UDim2.new(1, 0, 0, 99)
			})
			UI.tween(shell, TweenInfo.new(0.12), { BackgroundColor3 = accentDark })
			UI.tween(shadow, TweenInfo.new(0.12), {
				BackgroundTransparency = 0.85,
				Position = UDim2.new(0, 3, 0, 4)
			})
			UI.tween(card, TweenInfo.new(0.12), { BackgroundColor3 = paleColor:Lerp(C.White, 0.85) })
		end)
		
		pressArea.MouseLeave:Connect(function()
			isHovering = false
			isPressed = false
			-- Return to normal
			UI.tween(container, TweenInfo.new(0.15, Enum.EasingStyle.Quad), {
				Size = UDim2.new(1, 0, 0, 95)
			})
			UI.tween(shell, TweenInfo.new(0.12), { BackgroundColor3 = accentColor })
			UI.tween(shadow, TweenInfo.new(0.12), {
				BackgroundTransparency = 0.92,
				Position = UDim2.new(0, 2, 0, 2)
			})
			UI.tween(card, TweenInfo.new(0.12), { BackgroundColor3 = C.White })
		end)
		
		pressArea.MouseButton1Down:Connect(function()
			isPressed = true
			-- Press down effect
			UI.tween(container, TweenInfo.new(0.08), {
				Size = UDim2.new(1, 0, 0, 91)
			})
			UI.tween(shell, TweenInfo.new(0.08), { BackgroundColor3 = accentDark:Lerp(C.Black, 0.1) })
		end)
		
		pressArea.MouseButton1Up:Connect(function()
			isPressed = false
			if isHovering then
				UI.tween(container, TweenInfo.new(0.1), {
					Size = UDim2.new(1, 0, 0, 99)
				})
				UI.tween(shell, TweenInfo.new(0.1), { BackgroundColor3 = accentDark })
			end
		end)
	end

	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- ICON (with gradient and ring)
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

	-- Icon ring
	local iconRing = Instance.new("Frame")
	iconRing.Size = UDim2.new(0, 62, 0, 62)
	iconRing.Position = UDim2.new(0, 10, 0.5, -31)
	iconRing.BackgroundColor3 = canDo and accentColor or C.Gray400
	iconRing.ZIndex = 85
	iconRing.Parent = card
	UI.corner(iconRing, 16)
	
	local iconFrame = Instance.new("Frame")
	iconFrame.Size = UDim2.new(1, -6, 1, -6)
	iconFrame.Position = UDim2.new(0, 3, 0, 3)
	iconFrame.BackgroundColor3 = canDo and paleColor or C.Gray200
	iconFrame.ZIndex = 86
	iconFrame.Parent = iconRing
	UI.corner(iconFrame, 14)
	
	-- Gradient for premium look
	if canDo then
		local iconGrad = Instance.new("UIGradient")
		iconGrad.Color = ColorSequence.new({
			ColorSequenceKeypoint.new(0, Color3.new(1, 1, 1)),
			ColorSequenceKeypoint.new(1, paleColor:Lerp(C.White, 0.3)),
		})
		iconGrad.Rotation = 135
		iconGrad.Parent = iconFrame
	end

	local iconLabel = Instance.new("TextLabel")
	iconLabel.Size = UDim2.fromScale(1, 1)
	iconLabel.BackgroundTransparency = 1
	iconLabel.Font = F.Body
	iconLabel.TextSize = 30
	iconLabel.TextColor3 = canDo and accentColor or C.Gray500
	iconLabel.TextTransparency = canDo and 0 or 0.3
	iconLabel.Text = item.emoji
	iconLabel.ZIndex = 87
	iconLabel.Parent = iconFrame

	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- TITLE & DETAILS
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

	-- Title (CRITICAL FIX: Added truncation to prevent overflow)
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Size = UDim2.new(0.5, -90, 0, 24)  -- Adjusted width to fit better
	titleLabel.Position = UDim2.new(0, 84, 0, 8)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Font = F.Title
	titleLabel.TextSize = 15  -- Slightly smaller for longer names
	titleLabel.TextColor3 = canDo and C.Gray900 or C.Gray500
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.TextTruncate = Enum.TextTruncate.AtEnd
	titleLabel.Text = item.name
	titleLabel.ZIndex = 85
	titleLabel.Parent = card

	-- Effect badge (CRITICAL FIX: Dynamic width for longer text)
	local effectText = item.effect
	local displayEffect = effectText
	if cost > 0 then
		displayEffect = effectText .. " üíµ$" .. cost
	end
	
	local effectBadge = Instance.new("Frame")
	effectBadge.Size = UDim2.new(0, math.min(180, #displayEffect * 7 + 16), 0, 24)  -- Dynamic width based on text
	effectBadge.Position = UDim2.new(0, 84, 0, 34)
	effectBadge.BackgroundColor3 = canDo and (cost > 0 and C.AmberPale or C.GreenPale) or C.Gray100
	effectBadge.ZIndex = 85
	effectBadge.Parent = card
	UI.pill(effectBadge)

	local effectLabel = Instance.new("TextLabel")
	effectLabel.Size = UDim2.fromScale(1, 1)
	effectLabel.BackgroundTransparency = 1
	effectLabel.Font = F.Medium
	effectLabel.TextSize = 10  -- Smaller to fit better
	effectLabel.TextColor3 = canDo and (cost > 0 and C.AmberDark or C.GreenDark) or C.Gray500
	effectLabel.TextTruncate = Enum.TextTruncate.AtEnd
	effectLabel.Text = displayEffect
	effectLabel.ZIndex = 86
	effectLabel.Parent = effectBadge

	-- Minigame badge (more visible)
	if item.hasMinigame then
		local miniBadge = Instance.new("Frame")
		miniBadge.Size = UDim2.new(0, 75, 0, 20)
		miniBadge.Position = UDim2.new(0, 84, 0, 64)
		miniBadge.BackgroundColor3 = canDo and C.PurplePale or C.Gray100
		miniBadge.ZIndex = 85
		miniBadge.Parent = card
		UI.pill(miniBadge)
		
		local miniLabel = Instance.new("TextLabel")
		miniLabel.Size = UDim2.fromScale(1, 1)
		miniLabel.BackgroundTransparency = 1
		miniLabel.Font = F.Button
		miniLabel.TextSize = 10
		miniLabel.TextColor3 = canDo and C.Purple or C.Gray500
		miniLabel.Text = "üéÆ Minigame"
		miniLabel.ZIndex = 86
		miniLabel.Parent = miniBadge
	end

	-- Effectiveness indicator
	if canDo then
		local effectEmoji, effectColor = self:getEffectivenessIndicator(item.id)
		if effectEmoji and effectColor then
			local effectIndicator = Instance.new("Frame")
			effectIndicator.Size = UDim2.new(0, 30, 0, 30)
			effectIndicator.Position = UDim2.new(1, -100, 0, 8)
			effectIndicator.BackgroundColor3 = effectColor:Lerp(C.White, 0.7)
			effectIndicator.ZIndex = 85
			effectIndicator.Parent = card
			UI.corner(effectIndicator, 15)

			local effectLbl = Instance.new("TextLabel")
			effectLbl.Size = UDim2.fromScale(1, 1)
			effectLbl.BackgroundTransparency = 1
			effectLbl.Font = F.Body
			effectLbl.TextSize = 15
			effectLbl.TextColor3 = effectColor
			effectLbl.Text = effectEmoji
			effectLbl.ZIndex = 86
			effectLbl.Parent = effectIndicator
		end
	end

	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- ACTION BUTTON (premium with shadow)
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

	-- Button shadow (CRITICAL FIX: Must be SIBLING of button, not child, so emoji shows properly)
	local btnShadow
	if canDo then
		btnShadow = Instance.new("Frame")
		btnShadow.Name = "ActionBtnShadow"
		btnShadow.Size = UDim2.new(0, 79, 0, 54)
		btnShadow.AnchorPoint = Vector2.new(1, 0.5)
		btnShadow.Position = UDim2.new(1, -6, 0.5, 2)
		btnShadow.BackgroundColor3 = accentDark
		btnShadow.BackgroundTransparency = 0.6
		btnShadow.ZIndex = 94
		btnShadow.Parent = card
		UI.corner(btnShadow, 14)
	end

	local actionBtn = Instance.new("TextButton")
	actionBtn.Name = "ActionBtn"
	actionBtn.Size = UDim2.new(0, 75, 0, 50)
	actionBtn.AnchorPoint = Vector2.new(1, 0.5)
	actionBtn.Position = UDim2.new(1, -8, 0.5, 0)
	actionBtn.BackgroundColor3 = canDo and accentColor or C.Gray300
	actionBtn.Font = F.Button
	actionBtn.TextSize = 15
	actionBtn.TextColor3 = canDo and C.White or C.Gray500
	actionBtn.AutoButtonColor = false
	actionBtn.ZIndex = 95  -- Higher than shadow and pressArea
	actionBtn.Parent = card
	UI.corner(actionBtn, 14)

	if canDo then
		local isLoading = false
		actionBtn.Text = item.hasMinigame and "üéÆ Play" or "‚Üí Go!"
		
		actionBtn.MouseEnter:Connect(function()
			if isLoading then return end
			UI.tween(actionBtn, TweenInfo.new(0.12, Enum.EasingStyle.Quad), {
				BackgroundColor3 = accentDark,
				Size = UDim2.new(0, 80, 0, 54)
			})
			if btnShadow then
				UI.tween(btnShadow, TweenInfo.new(0.12), {
					Size = UDim2.new(0, 84, 0, 58)
				})
			end
		end)
		actionBtn.MouseLeave:Connect(function()
			if isLoading then return end
			UI.tween(actionBtn, TweenInfo.new(0.12), {
				BackgroundColor3 = accentColor,
				Size = UDim2.new(0, 75, 0, 50)
			})
			if btnShadow then
				UI.tween(btnShadow, TweenInfo.new(0.12), {
					Size = UDim2.new(0, 79, 0, 54)
				})
			end
		end)
		actionBtn.MouseButton1Click:Connect(function()
			if isLoading then return end
			isLoading = true
			
			-- Loading state
			actionBtn.Text = "‚è≥..."
			UI.tween(actionBtn, TweenInfo.new(0.1), { BackgroundColor3 = C.Gray400 })
			
			task.spawn(function()
				task.wait(0.1)
				if item.hasMinigame then
					self:showMinigame(item, accentColor)
				else
					self:doActivity(item)
				end
				
				-- Reset after completion
				task.wait(0.5)
				if actionBtn and actionBtn.Parent then
					isLoading = false
					actionBtn.Text = item.hasMinigame and "üéÆ Play" or "‚Üí Go!"
					actionBtn.BackgroundColor3 = accentColor
				end
			end)
		end)
	else
		-- CRITICAL FIX #312: More helpful error messages for locked activities
		local btnText = "üîí "
		if age < (item.minAge or 0) then
			btnText = btnText .. "Age " .. (item.minAge or 0)
		elseif money < cost then
			btnText = "üíµ Need $" .. cost
		elseif self:isInJail() then
			btnText = "‚õìÔ∏è Jailed"
		elseif not meetsFlag then
			-- CRITICAL FIX #312: Show specific requirement for locked activities
			if item.requiresFlag == "in_mob" then
				btnText = "üî´ Join Mafia"
			elseif item.requiresFlag == "is_royalty" or item.requiresFlag == "royal_birth" then
				btnText = "üëë Royalty Only"
			elseif item.requiresFlag == "is_monarch" then
				btnText = "üëë Monarch Only"
			elseif item.requiresFlag == "has_job" or item.requiresFlag == "employed" then
				btnText = "üíº Need Job"
			else
				btnText = "üîí Locked"
			end
		elseif not meetsMaxAge then
			btnText = "üîí Too Old"
		else
			btnText = "üîí N/A"
		end
		actionBtn.Text = btnText
	end
end

function ActivitiesScreen:createCrimeCard(parent, item, order)
	local age = self:getAge()
	local canDo = age >= item.minAge and not self:isInJail()

	local card = Instance.new("Frame")
	card.Name = item.id
	card.Size = UDim2.new(1, 0, 0, 90)
	card.BackgroundColor3 = C.White
	card.LayoutOrder = order
	card.ZIndex = 83
	card.Parent = parent
	UI.corner(card, 14)
	UI.stroke(card, canDo and 1 or 1, canDo and 0.7 or 0.88, canDo and C.Red or C.Gray200)
	
	-- CRITICAL UI FIX: Add subtle shadow
	if UI.createShadow then
		UI.createShadow(card, 2, 8, C.Black, canDo and 0.92 or 0.96)
	end

	-- Icon with emoji
	local iconFrame = Instance.new("Frame")
	iconFrame.Size = UDim2.new(0, 56, 0, 56)
	iconFrame.Position = UDim2.new(0, 12, 0.5, -28)
	iconFrame.BackgroundColor3 = C.RedPale
	iconFrame.ZIndex = 84
	iconFrame.Parent = card
	UI.corner(iconFrame, 12)

	local iconLabel = Instance.new("TextLabel")
	iconLabel.Size = UDim2.fromScale(1, 1)
	iconLabel.BackgroundTransparency = 1
	iconLabel.Font = F.Body
	iconLabel.TextSize = 28
	iconLabel.TextColor3 = C.Red
	iconLabel.Text = item.emoji
	iconLabel.ZIndex = 85
	iconLabel.Parent = iconFrame

	-- Title (CRITICAL FIX: Added truncation to prevent overflow)
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Size = UDim2.new(0.5, -85, 0, 22)  -- Adjusted width with margin
	titleLabel.Position = UDim2.new(0, 80, 0, 10)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Font = F.Title
	titleLabel.TextSize = 14  -- Slightly smaller to fit better
	titleLabel.TextColor3 = canDo and C.Gray900 or C.Gray500
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.TextTruncate = Enum.TextTruncate.AtEnd
	titleLabel.Text = item.name
	titleLabel.ZIndex = 84
	titleLabel.Parent = card

	-- Risk badge
	local riskColor = item.risk >= 60 and C.RedPale or item.risk >= 40 and C.AmberPale or C.GreenPale
	local riskText = item.risk >= 60 and C.RedDark or item.risk >= 40 and C.AmberDark or C.GreenDark

	local riskBadge = Instance.new("Frame")
	riskBadge.Size = UDim2.new(0, 85, 0, 24)
	riskBadge.Position = UDim2.new(0, 80, 0, 34)
	riskBadge.BackgroundColor3 = riskColor
	riskBadge.ZIndex = 84
	riskBadge.Parent = card
	UI.pill(riskBadge)

	local riskLabel = Instance.new("TextLabel")
	riskLabel.Size = UDim2.fromScale(1, 1)
	riskLabel.BackgroundTransparency = 1
	riskLabel.Font = F.Medium
	riskLabel.TextSize = 11
	riskLabel.TextColor3 = riskText
	riskLabel.Text = "Risk: " .. item.risk .. "%"
	riskLabel.ZIndex = 85
	riskLabel.Parent = riskBadge

	-- Reward
	local rewardLabel = Instance.new("TextLabel")
	rewardLabel.Size = UDim2.new(0.4, 0, 0, 18)
	rewardLabel.Position = UDim2.new(0, 80, 0, 62)
	rewardLabel.BackgroundTransparency = 1
	rewardLabel.Font = F.Body
	rewardLabel.TextSize = 12
	rewardLabel.TextColor3 = C.Gray500
	rewardLabel.TextXAlignment = Enum.TextXAlignment.Left
	rewardLabel.Text = "Reward: " .. item.reward
	rewardLabel.ZIndex = 84
	rewardLabel.Parent = card

	-- Skill modifier indicator (shows how your stats affect this crime)
	if canDo then
		local crimeEmoji, crimeColor = self:getCrimeRiskIndicator()
		if crimeEmoji and crimeColor then
			local skillIndicator = Instance.new("Frame")
			skillIndicator.Size = UDim2.new(0, 28, 0, 28)
			skillIndicator.Position = UDim2.new(1, -100, 0, 10)
			skillIndicator.BackgroundColor3 = crimeColor
			skillIndicator.BackgroundTransparency = 0.85
			skillIndicator.ZIndex = 84
			skillIndicator.Parent = card
			UI.corner(skillIndicator, 14)

			local skillLabel = Instance.new("TextLabel")
			skillLabel.Size = UDim2.fromScale(1, 1)
			skillLabel.BackgroundTransparency = 1
			skillLabel.Font = F.Body
			skillLabel.TextSize = 14
			skillLabel.TextColor3 = crimeColor
			skillLabel.Text = crimeEmoji
			skillLabel.ZIndex = 85
			skillLabel.Parent = skillIndicator
		end
	end

	-- Button shadow (CRITICAL FIX: Must be SIBLING of button so emoji/text shows properly)
	local btnShadow
	if canDo then
		btnShadow = Instance.new("Frame")
		btnShadow.Name = "ActionBtnShadow"
		btnShadow.Size = UDim2.new(0, 82, 0, 48)
		btnShadow.AnchorPoint = Vector2.new(1, 0.5)
		btnShadow.Position = UDim2.new(1, -10, 0.5, 2)
		btnShadow.BackgroundColor3 = C.RedDark
		btnShadow.BackgroundTransparency = 0.6
		btnShadow.ZIndex = 84
		btnShadow.Parent = card
		UI.corner(btnShadow, 12)
	end

	-- Action button
	local actionBtn = Instance.new("TextButton")
	actionBtn.Size = UDim2.new(0, 78, 0, 44)
	actionBtn.AnchorPoint = Vector2.new(1, 0.5)
	actionBtn.Position = UDim2.new(1, -12, 0.5, 0)
	actionBtn.BackgroundColor3 = canDo and C.Red or C.Gray300
	actionBtn.Font = F.Button
	actionBtn.TextSize = 13
	actionBtn.TextColor3 = canDo and C.White or C.Gray500
	actionBtn.AutoButtonColor = false
	actionBtn.ZIndex = 85  -- Higher than shadow
	actionBtn.Parent = card
	UI.corner(actionBtn, 12)

	if canDo then
		-- CRITICAL FIX: Show minigame indicator for crimes that have minigames (e.g., bank robbery)
		actionBtn.Text = item.hasMinigame and "üéÆ Heist" or "üîì Commit"
		local isLoading = false
		
		actionBtn.MouseEnter:Connect(function()
			if isLoading then return end
			UI.tween(actionBtn, TweenInfo.new(0.12), { BackgroundColor3 = C.RedDark })
			if btnShadow then
				UI.tween(btnShadow, TweenInfo.new(0.12), { Size = UDim2.new(0, 86, 0, 52) })
			end
		end)
		actionBtn.MouseLeave:Connect(function()
			if isLoading then return end
			UI.tween(actionBtn, TweenInfo.new(0.12), { BackgroundColor3 = C.Red })
			if btnShadow then
				UI.tween(btnShadow, TweenInfo.new(0.12), { Size = UDim2.new(0, 82, 0, 48) })
			end
		end)
		actionBtn.MouseButton1Click:Connect(function()
			if isLoading then return end
			isLoading = true
			actionBtn.Text = "‚è≥..."
			
			-- CRITICAL FIX: Check for minigame BEFORE committing crime
			task.spawn(function()
				task.wait(0.1)
				if item.hasMinigame then
					-- Show crime minigame (bank robbery heist)
					self:showCrimeMinigame(item)
				else
					-- Normal crime - no minigame
					self:doCrime(item)
				end
				
				-- Reset button
				task.wait(0.5)
				if actionBtn and actionBtn.Parent then
					isLoading = false
					actionBtn.Text = item.hasMinigame and "üéÆ Heist" or "üîì Commit"
					actionBtn.BackgroundColor3 = C.Red
				end
			end)
		end)
	else
		actionBtn.Text = age < item.minAge and "Age " .. item.minAge .. "+" or "Jailed"
	end
end

function ActivitiesScreen:createPrisonCard(parent, item, order)
	local money = self:getMoney()
	local cost = item.cost or 0
	local canDo = money >= cost

	local card = Instance.new("Frame")
	card.Name = item.id
	card.Size = UDim2.new(1, 0, 0, 90)
	card.BackgroundColor3 = C.White
	card.LayoutOrder = order
	card.ZIndex = 83
	card.Parent = parent
	UI.corner(card, 14)
	UI.stroke(card, 1, canDo and 0.7 or 0.88, canDo and C.Gray600 or C.Gray200)
	
	-- CRITICAL UI FIX: Add subtle shadow
	if UI.createShadow then
		UI.createShadow(card, 2, 8, C.Black, 0.94)
	end

	-- Icon with emoji
	local iconFrame = Instance.new("Frame")
	iconFrame.Size = UDim2.new(0, 56, 0, 56)
	iconFrame.Position = UDim2.new(0, 12, 0.5, -28)
	iconFrame.BackgroundColor3 = item.risk and C.RedPale or C.Gray100
	iconFrame.ZIndex = 84
	iconFrame.Parent = card
	UI.corner(iconFrame, 12)

	local iconLabel = Instance.new("TextLabel")
	iconLabel.Size = UDim2.fromScale(1, 1)
	iconLabel.BackgroundTransparency = 1
	iconLabel.Font = F.Body
	iconLabel.TextSize = 28
	iconLabel.TextColor3 = item.risk and C.Red or C.Gray600
	iconLabel.Text = item.emoji
	iconLabel.ZIndex = 85
	iconLabel.Parent = iconFrame

	-- Title (CRITICAL FIX: Added truncation to prevent overflow)
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Size = UDim2.new(0.5, -85, 0, 22)  -- Adjusted width with margin
	titleLabel.Position = UDim2.new(0, 80, 0, 12)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Font = F.Title
	titleLabel.TextSize = 14  -- Slightly smaller to fit better
	titleLabel.TextColor3 = C.Gray900
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.TextTruncate = Enum.TextTruncate.AtEnd
	titleLabel.Text = item.name
	titleLabel.ZIndex = 84
	titleLabel.Parent = card

	-- Badge (CRITICAL FIX: Dynamic width for longer text)
	local badgeText = item.risk and ("Risk: " .. item.risk .. "%") or item.effect
	local badgeBg = item.risk and C.RedPale or C.GreenPale
	local badgeColor = item.risk and C.RedDark or C.GreenDark

	local effectBadge = Instance.new("Frame")
	effectBadge.Size = UDim2.new(0, math.min(140, #badgeText * 7 + 16), 0, 24)  -- Dynamic width
	effectBadge.Position = UDim2.new(0, 80, 0, 38)
	effectBadge.BackgroundColor3 = badgeBg
	effectBadge.ZIndex = 84
	effectBadge.Parent = card
	UI.pill(effectBadge)

	local effectLabel = Instance.new("TextLabel")
	effectLabel.Size = UDim2.fromScale(1, 1)
	effectLabel.BackgroundTransparency = 1
	effectLabel.Font = F.Medium
	effectLabel.TextSize = 11
	effectLabel.TextColor3 = badgeColor
	effectLabel.Text = badgeText .. (cost > 0 and " | $" .. cost or "")
	effectLabel.ZIndex = 85
	effectLabel.Parent = effectBadge

	-- Button shadow (CRITICAL FIX: Must be SIBLING of button so text shows properly)
	local accentColor = canDo and (item.risk and C.Red or C.Amber) or C.Gray300
	local accentDark = canDo and (item.risk and C.RedDark or C.AmberDark) or C.Gray400
	
	local btnShadow
	if canDo then
		btnShadow = Instance.new("Frame")
		btnShadow.Name = "ActionBtnShadow"
		btnShadow.Size = UDim2.new(0, 72, 0, 46)
		btnShadow.AnchorPoint = Vector2.new(1, 0.5)
		btnShadow.Position = UDim2.new(1, -10, 0.5, 2)
		btnShadow.BackgroundColor3 = accentDark
		btnShadow.BackgroundTransparency = 0.6
		btnShadow.ZIndex = 84
		btnShadow.Parent = card
		UI.corner(btnShadow, 12)
	end

	-- Action button
	local actionBtn = Instance.new("TextButton")
	actionBtn.Size = UDim2.new(0, 68, 0, 42)
	actionBtn.AnchorPoint = Vector2.new(1, 0.5)
	actionBtn.Position = UDim2.new(1, -12, 0.5, 0)
	actionBtn.BackgroundColor3 = accentColor
	actionBtn.Font = F.Button
	actionBtn.TextSize = 14
	actionBtn.TextColor3 = canDo and C.White or C.Gray500
	actionBtn.Text = canDo and "‚Üí Go!" or "Need $"
	actionBtn.AutoButtonColor = false
	actionBtn.ZIndex = 85  -- Higher than shadow
	actionBtn.Parent = card
	UI.corner(actionBtn, 12)

	if canDo then
		actionBtn.MouseEnter:Connect(function()
			UI.tween(actionBtn, TweenInfo.new(0.12), { BackgroundColor3 = accentDark })
			if btnShadow then
				UI.tween(btnShadow, TweenInfo.new(0.12), { Size = UDim2.new(0, 76, 0, 50) })
			end
		end)
		actionBtn.MouseLeave:Connect(function()
			UI.tween(actionBtn, TweenInfo.new(0.12), { BackgroundColor3 = accentColor })
			if btnShadow then
				UI.tween(btnShadow, TweenInfo.new(0.12), { Size = UDim2.new(0, 72, 0, 46) })
			end
		end)
		actionBtn.MouseButton1Click:Connect(function()
			self:doPrisonActivity(item)
		end)
	end
end

function ActivitiesScreen:createResultModal()
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- CRITICAL REVAMP: Premium Result Modal (matching Quit Job modal style)
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	
	self.resultModal = {}
	
	-- Close/dim overlay
	local closeArea = Instance.new("TextButton")
	closeArea.Name = "ResultModalCloseArea"
	closeArea.Size = UDim2.fromScale(1, 1)
	closeArea.BackgroundColor3 = C.Black
	closeArea.BackgroundTransparency = 0.35
	closeArea.Text = ""
	closeArea.AutoButtonColor = false
	closeArea.ZIndex = 98
	closeArea.Visible = false
	closeArea.Parent = self.screenGui
	self.resultModal.closeArea = closeArea
	self.resultModal.overlay = closeArea  -- Alias for compatibility
	
	-- Container (CRITICAL FIX: IS_TINY_PHONE responsive sizing)
	local modalWidth = IS_TINY_PHONE and 280 or 340
	local modalHeight = IS_TINY_PHONE and 260 or 320
	
	local container = Instance.new("Frame")
	container.Name = "ResultModalContainer"
	container.Size = UDim2.new(0, modalWidth, 0, modalHeight)
	container.AnchorPoint = Vector2.new(0.5, 0.5)
	container.Position = UDim2.fromScale(0.5, 0.5)
	container.BackgroundTransparency = 1
	container.ZIndex = 99
	container.Parent = closeArea
	self.resultModal.container = container
	
	-- Premium shadow (CRITICAL FIX: IS_TINY_PHONE responsive sizing)
	local shadowPad = IS_TINY_PHONE and 8 or 12
	local shadow = Instance.new("Frame")
	shadow.Name = "Shadow"
	shadow.Size = UDim2.new(1, shadowPad, 1, shadowPad)
	shadow.Position = UDim2.new(0, shadowPad/2, 0, shadowPad/2)
	shadow.BackgroundColor3 = C.Black
	shadow.BackgroundTransparency = 0.7
	shadow.ZIndex = 99
	shadow.Parent = container
	UI.corner(shadow, IS_TINY_PHONE and 20 or 28)
	
	-- Colored shell (accent border)
	local shell = Instance.new("Frame")
	shell.Name = "Shell"
	shell.Size = UDim2.fromScale(1, 1)
	shell.BackgroundColor3 = C.Green
	shell.ZIndex = 100
	shell.Parent = container
	UI.corner(shell, 26)
	self.resultModal.shell = shell
	
	-- Shell stroke for extra polish
	local shellStroke = Instance.new("UIStroke")
	shellStroke.Color = C.GreenDark
	shellStroke.Thickness = 2
	shellStroke.Transparency = 0.5
	shellStroke.Parent = shell
	self.resultModal.shellStroke = shellStroke
	
	-- Inner white card
	local card = Instance.new("Frame")
	card.Name = "Card"
	card.Size = UDim2.new(1, -10, 1, -10)
	card.Position = UDim2.new(0, 5, 0, 5)
	card.BackgroundColor3 = C.White
	card.ZIndex = 101
	card.Parent = shell
	UI.corner(card, 22)
	
	-- Emoji frame (CRITICAL FIX: IS_TINY_PHONE responsive sizing)
	local emojiSize = IS_TINY_PHONE and 56 or 80
	local emojiFrame = Instance.new("Frame")
	emojiFrame.Size = UDim2.new(0, emojiSize, 0, emojiSize)
	emojiFrame.AnchorPoint = Vector2.new(0.5, 0)
	emojiFrame.Position = UDim2.new(0.5, 0, 0, IS_TINY_PHONE and 12 or 20)
	emojiFrame.BackgroundColor3 = C.GreenPale
	emojiFrame.ZIndex = 102
	emojiFrame.Parent = card
	UI.corner(emojiFrame, emojiSize/2)
	self.resultModal.emojiFrame = emojiFrame
	
	-- Emoji label
	local emojiLabel = Instance.new("TextLabel")
	emojiLabel.Size = UDim2.fromScale(1, 1)
	emojiLabel.BackgroundTransparency = 1
	emojiLabel.Font = F.Body
	emojiLabel.TextSize = IS_TINY_PHONE and 32 or 44
	emojiLabel.Text = "üéâ"
	emojiLabel.ZIndex = 103
	emojiLabel.Parent = emojiFrame
	self.resultModal.emojiLabel = emojiLabel
	
	-- Title (CRITICAL FIX: IS_TINY_PHONE responsive positioning)
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Size = UDim2.new(1, -32, 0, IS_TINY_PHONE and 24 or 32)
	titleLabel.AnchorPoint = Vector2.new(0.5, 0)
	titleLabel.Position = UDim2.new(0.5, 0, 0, IS_TINY_PHONE and 72 or 108)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Font = F.Title
	titleLabel.TextSize = IS_TINY_PHONE and 17 or 22
	titleLabel.TextColor3 = C.GreenDark
	titleLabel.Text = "Activity Complete!"
	titleLabel.ZIndex = 102
	titleLabel.Parent = card
	self.resultModal.titleLabel = titleLabel
	
	-- Message
	local messageLabel = Instance.new("TextLabel")
	messageLabel.Size = UDim2.new(1, -32, 0, 70)
	messageLabel.AnchorPoint = Vector2.new(0.5, 0)
	messageLabel.Position = UDim2.new(0.5, 0, 0, 145)
	messageLabel.BackgroundTransparency = 1
	messageLabel.Font = F.Body
	messageLabel.TextSize = 15
	messageLabel.TextColor3 = C.Gray700
	messageLabel.TextWrapped = true
	messageLabel.Text = "You did it!"
	messageLabel.ZIndex = 102
	messageLabel.Parent = card
	self.resultModal.messageLabel = messageLabel
	
	-- Button shadow (CRITICAL FIX: Must be SIBLING of button, not child, so it renders behind)
	local btnShadow = Instance.new("Frame")
	btnShadow.Name = "OkBtnShadow"
	btnShadow.Size = UDim2.new(0.7, 4, 0, 56)
	btnShadow.AnchorPoint = Vector2.new(0.5, 0)
	btnShadow.Position = UDim2.new(0.5, 2, 0, 232)
	btnShadow.BackgroundColor3 = C.GreenDark
	btnShadow.BackgroundTransparency = 0.5
	btnShadow.ZIndex = 102
	btnShadow.Parent = card
	UI.corner(btnShadow, 14)
	self.resultModal.okBtnShadow = btnShadow
	
	-- OK Button (premium styling)
	local okBtn = Instance.new("TextButton")
	okBtn.Name = "OkBtn"
	okBtn.Size = UDim2.new(0.7, 0, 0, 52)
	okBtn.AnchorPoint = Vector2.new(0.5, 0)
	okBtn.Position = UDim2.new(0.5, 0, 0, 230)
	okBtn.BackgroundColor3 = C.Green
	okBtn.Font = F.Button
	okBtn.TextSize = 17
	okBtn.TextColor3 = C.White
	okBtn.Text = "üëç Awesome!"
	okBtn.AutoButtonColor = false
	okBtn.ZIndex = 103
	okBtn.Parent = card
	UI.corner(okBtn, 14)
	self.resultModal.okButton = okBtn
	
	-- Button hover effects (CRITICAL FIX: Also animate shadow)
	okBtn.MouseEnter:Connect(function()
		UI.tween(okBtn, TweenInfo.new(0.12, Enum.EasingStyle.Quad), {
			Size = UDim2.new(0.72, 0, 0, 56),
			BackgroundColor3 = shell.BackgroundColor3:Lerp(C.Black, 0.15)
		})
		UI.tween(btnShadow, TweenInfo.new(0.12), {
			Size = UDim2.new(0.72, 4, 0, 60)
		})
	end)
	okBtn.MouseLeave:Connect(function()
		UI.tween(okBtn, TweenInfo.new(0.12), {
			Size = UDim2.new(0.7, 0, 0, 52),
			BackgroundColor3 = shell.BackgroundColor3
		})
		UI.tween(btnShadow, TweenInfo.new(0.12), {
			Size = UDim2.new(0.7, 4, 0, 56)
		})
	end)
	
	-- CRITICAL FIX #3: When dismissing result modal, ALWAYS rebuild tabs and update UI
	local function onResultDismiss()
		local inJail = self:isInJail()
		log("Result modal dismissed - checking state. InJail:", inJail)
		self:rebuildTabs()
		self:updateInfoBar()
		if inJail and self.currentTab ~= "prison" then
			self.currentTab = "prison"
		elseif not inJail and self.currentTab == "prison" then
			self.currentTab = "mindbody"
		end
		self:switchTab(self.currentTab)
	end
	
	-- Custom show/hide methods (CRITICAL FIX: IS_TINY_PHONE responsive animation sizes)
	self.resultModal.show = function()
		closeArea.Visible = true
		closeArea.BackgroundTransparency = 1
		container.Position = UDim2.new(0.5, 0, 0.5, 40)
		container.Size = UDim2.new(0, IS_TINY_PHONE and 260 or 320, 0, IS_TINY_PHONE and 240 or 300)
		
		UI.tween(closeArea, TweenInfo.new(0.2), { BackgroundTransparency = 0.35 })
		UI.tween(container, TweenInfo.new(0.25, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
			Position = UDim2.fromScale(0.5, 0.5),
			Size = UDim2.new(0, IS_TINY_PHONE and 280 or 340, 0, IS_TINY_PHONE and 260 or 320)
		})
	end
	
	self.resultModal.hide = function(callback)
		UI.tween(closeArea, TweenInfo.new(0.15), { BackgroundTransparency = 1 })
		UI.tween(container, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
			Position = UDim2.new(0.5, 0, 0.5, 25),
			Size = UDim2.new(0, 320, 0, 300)
		})
		task.delay(0.15, function()
			closeArea.Visible = false
			if callback then callback() end
		end)
	end
	
	closeArea.MouseButton1Click:Connect(function()
		self.resultModal.hide(onResultDismiss)
	end)
	okBtn.MouseButton1Click:Connect(function()
		self.resultModal.hide(onResultDismiss)
	end)
end

function ActivitiesScreen:createMinigameModal()
	self.minigameOverlay = Instance.new("Frame")
	self.minigameOverlay.Size = UDim2.fromScale(1, 1)
	self.minigameOverlay.BackgroundColor3 = C.Black
	self.minigameOverlay.BackgroundTransparency = 0.4
	self.minigameOverlay.Visible = false
	self.minigameOverlay.ZIndex = 96
	self.minigameOverlay.Parent = self.screenGui

	-- CRITICAL FIX: Made card taller to prevent cramped UI
	local card = Instance.new("Frame")
	card.Size = UDim2.new(0.92, 0, 0, 520) -- Taller for escape grid
	card.AnchorPoint = Vector2.new(0.5, 0.5)
	card.Position = UDim2.fromScale(0.5, 0.5)
	card.BackgroundColor3 = C.White
	card.ZIndex = 97
	card.Parent = self.minigameOverlay
	UI.corner(card, 24)
	self.minigameCard = card

	-- Title - positioned lower to give breathing room
	self.minigameTitle = Instance.new("TextLabel")
	self.minigameTitle.Size = UDim2.new(1, -20, 0, 45)
	self.minigameTitle.Position = UDim2.new(0, 10, 0, 8)
	self.minigameTitle.BackgroundTransparency = 1
	self.minigameTitle.Font = F.Title
	self.minigameTitle.TextSize = 20
	self.minigameTitle.TextColor3 = C.Gray900
	self.minigameTitle.Text = "Tap to Workout!"
	self.minigameTitle.TextWrapped = true
	self.minigameTitle.ZIndex = 98
	self.minigameTitle.Parent = card

	-- Progress bar (for tap games)
	local progressBg = Instance.new("Frame")
	progressBg.Name = "ProgressBg"
	progressBg.Size = UDim2.new(0.85, 0, 0, 26)
	progressBg.AnchorPoint = Vector2.new(0.5, 0)
	progressBg.Position = UDim2.new(0.5, 0, 0, 60)
	progressBg.BackgroundColor3 = C.Gray200
	progressBg.ZIndex = 98
	progressBg.Parent = card
	UI.pill(progressBg)
	self.progressBg = progressBg

	self.progressFill = Instance.new("Frame")
	self.progressFill.Size = UDim2.new(0, 0, 1, 0)
	self.progressFill.BackgroundColor3 = C.Green
	self.progressFill.ZIndex = 99
	self.progressFill.Parent = progressBg
	UI.pill(self.progressFill)

	-- Tap area (for tap games)
	self.tapArea = Instance.new("TextButton")
	self.tapArea.Name = "TapArea"
	self.tapArea.Size = UDim2.new(0.65, 0, 0, 190)
	self.tapArea.AnchorPoint = Vector2.new(0.5, 0)
	self.tapArea.Position = UDim2.new(0.5, 0, 0, 100)
	self.tapArea.BackgroundColor3 = C.Cyan
	self.tapArea.Font = F.Title
	self.tapArea.TextSize = 50
	self.tapArea.TextColor3 = C.White
	self.tapArea.Text = "TAP!"
	self.tapArea.AutoButtonColor = false
	self.tapArea.ZIndex = 98
	self.tapArea.Parent = card
	UI.corner(self.tapArea, 24)

	-- Counter
	self.tapCounter = Instance.new("TextLabel")
	self.tapCounter.Size = UDim2.new(1, 0, 0, 45)
	self.tapCounter.AnchorPoint = Vector2.new(0.5, 0)
	self.tapCounter.Position = UDim2.new(0.5, 0, 0, 300)
	self.tapCounter.BackgroundTransparency = 1
	self.tapCounter.Font = F.Title
	self.tapCounter.TextSize = 32
	self.tapCounter.TextColor3 = C.Gray700
	self.tapCounter.Text = "0 / 20"
	self.tapCounter.ZIndex = 98
	self.tapCounter.Parent = card

	-- CRITICAL FIX: Instructions repositioned - at bottom of card, below buttons
	self.minigameInstructions = Instance.new("TextLabel")
	self.minigameInstructions.Name = "Instructions"
	self.minigameInstructions.Size = UDim2.new(1, -20, 0, 40)
	self.minigameInstructions.AnchorPoint = Vector2.new(0.5, 1)
	self.minigameInstructions.Position = UDim2.new(0.5, 0, 1, -10)
	self.minigameInstructions.BackgroundTransparency = 1
	self.minigameInstructions.Font = F.Body
	self.minigameInstructions.TextSize = 13
	self.minigameInstructions.TextColor3 = C.Gray500
	self.minigameInstructions.TextWrapped = true
	self.minigameInstructions.Text = "Tap as fast as you can!"
	self.minigameInstructions.ZIndex = 98
	self.minigameInstructions.Parent = card

	-- ===== PRISON ESCAPE GRID (hidden by default) =====
	self.escapeGrid = Instance.new("Frame")
	self.escapeGrid.Name = "EscapeGrid"
	self.escapeGrid.Size = UDim2.new(0, 280, 0, 280)
	self.escapeGrid.AnchorPoint = Vector2.new(0.5, 0)
	self.escapeGrid.Position = UDim2.new(0.5, 0, 0, 60)
	self.escapeGrid.BackgroundColor3 = C.Gray800
	self.escapeGrid.Visible = false
	self.escapeGrid.ZIndex = 98
	self.escapeGrid.Parent = card
	UI.corner(self.escapeGrid, 12)

	-- Grid cells (8x8 grid)
	self.gridSize = 8
	self.cellSize = 35
	self.gridCells = {}
	for row = 1, self.gridSize do
		self.gridCells[row] = {}
		for col = 1, self.gridSize do
			local cell = Instance.new("Frame")
			cell.Name = "Cell_" .. row .. "_" .. col
			cell.Size = UDim2.new(0, self.cellSize - 2, 0, self.cellSize - 2)
			cell.Position = UDim2.new(0, (col - 1) * self.cellSize, 0, (row - 1) * self.cellSize)
			cell.BackgroundColor3 = C.Gray700
			cell.ZIndex = 99
			cell.Parent = self.escapeGrid
			UI.corner(cell, 4)
			self.gridCells[row][col] = cell
		end
	end

	-- Player icon (green)
	self.playerCell = Instance.new("TextLabel")
	self.playerCell.Name = "Player"
	self.playerCell.Size = UDim2.new(0, self.cellSize - 6, 0, self.cellSize - 6)
	self.playerCell.BackgroundColor3 = C.Green
	self.playerCell.Font = F.Body
	self.playerCell.TextSize = 20
	self.playerCell.TextColor3 = C.White
	self.playerCell.Text = "üèÉ"
	self.playerCell.ZIndex = 100
	self.playerCell.Parent = self.escapeGrid
	UI.corner(self.playerCell, 6)

	-- Cop icon (red)
	self.copCell = Instance.new("TextLabel")
	self.copCell.Name = "Cop"
	self.copCell.Size = UDim2.new(0, self.cellSize - 6, 0, self.cellSize - 6)
	self.copCell.BackgroundColor3 = C.Red
	self.copCell.Font = F.Body
	self.copCell.TextSize = 20
	self.copCell.TextColor3 = C.White
	self.copCell.Text = "üëÆ"
	self.copCell.ZIndex = 100
	self.copCell.Parent = self.escapeGrid
	UI.corner(self.copCell, 6)

	-- Exit icon (yellow)
	self.exitCell = Instance.new("TextLabel")
	self.exitCell.Name = "Exit"
	self.exitCell.Size = UDim2.new(0, self.cellSize - 6, 0, self.cellSize - 6)
	self.exitCell.BackgroundColor3 = C.Amber
	self.exitCell.Font = F.Body
	self.exitCell.TextSize = 20
	self.exitCell.TextColor3 = C.Black
	self.exitCell.Text = "üö™"
	self.exitCell.ZIndex = 100
	self.exitCell.Parent = self.escapeGrid
	UI.corner(self.exitCell, 6)

	-- CRITICAL FIX: Direction buttons repositioned to not cover text
	-- Grid is 280px ending at Y=340, so buttons start at Y=355
	self.dirButtons = Instance.new("Frame")
	self.dirButtons.Name = "DirectionButtons"
	self.dirButtons.Size = UDim2.new(0, 150, 0, 100)
	self.dirButtons.AnchorPoint = Vector2.new(0.5, 0)
	self.dirButtons.Position = UDim2.new(0.5, 0, 0, 360)
	self.dirButtons.BackgroundTransparency = 1
	self.dirButtons.Visible = false
	self.dirButtons.ZIndex = 98
	self.dirButtons.Parent = card

	local dirData = {
		{ dir = "up", text = "‚¨ÜÔ∏è", pos = UDim2.new(0.5, -22, 0, 0) },
		{ dir = "down", text = "‚¨áÔ∏è", pos = UDim2.new(0.5, -22, 0, 55) },
		{ dir = "left", text = "‚¨ÖÔ∏è", pos = UDim2.new(0, 0, 0, 27) },
		{ dir = "right", text = "‚û°Ô∏è", pos = UDim2.new(1, -44, 0, 27) },
	}

	self.dirBtns = {}
	for _, d in ipairs(dirData) do
		local btn = Instance.new("TextButton")
		btn.Name = d.dir
		btn.Size = UDim2.new(0, 40, 0, 40)
		btn.Position = d.pos
		btn.BackgroundColor3 = C.Gray600
		btn.Font = F.Body
		btn.TextSize = 22
		btn.TextColor3 = C.White
		btn.Text = d.text
		btn.AutoButtonColor = false
		btn.ZIndex = 99
		btn.Parent = self.dirButtons
		UI.corner(btn, 10)
		self.dirBtns[d.dir] = btn

		btn.MouseButton1Click:Connect(function()
			self:movePlayer(d.dir)
		end)
	end

	-- Variables
	self.tapCount = 0
	self.tapGoal = 20
	self.minigameActive = false
	self.currentMinigameItem = nil
	self.minigameAccent = C.Cyan
	self.minigameType = "tap" -- "tap" or "escape"

	-- Escape game state
	self.playerPos = { row = 1, col = 1 }
	self.copPos = { row = 8, col = 8 }
	self.exitPos = { row = 8, col = 1 }
	self.movesLeft = 20

	-- Tap handler (CRITICAL FIX: Also handles crime_tap for crime minigames)
	self.tapArea.MouseButton1Click:Connect(function()
		-- CRITICAL FIX: Accept both "tap" and "crime_tap" minigame types
		if not self.minigameActive then return end
		if self.minigameType ~= "tap" and self.minigameType ~= "crime_tap" then return end
		
		self.tapCount = self.tapCount + 1
		self.tapCounter.Text = self.tapCount .. " / " .. self.tapGoal

		-- Pulse
		UI.tween(self.tapArea, TweenInfo.new(0.05), { Size = UDim2.new(0.62, 0, 0, 185) })
		task.delay(0.05, function()
			UI.tween(self.tapArea, TweenInfo.new(0.1), { Size = UDim2.new(0.65, 0, 0, 190) })
		end)

		-- Progress
		local progress = math.clamp(self.tapCount / self.tapGoal, 0, 1)
		UI.tween(self.progressFill, TweenInfo.new(0.1), { Size = UDim2.new(progress, 0, 1, 0) })

		-- Win check
		if self.tapCount >= self.tapGoal then
			self.minigameActive = false
			-- CRITICAL FIX: Route to correct completion handler
			if self.minigameType == "crime_tap" then
				self:completeCrimeMinigame(true)
			else
				self:completeMinigame(true)
			end
		end
	end)
end

function ActivitiesScreen:setGridPosition(element, row, col)
	local x = (col - 1) * self.cellSize + 2
	local y = (row - 1) * self.cellSize + 2
	element.Position = UDim2.new(0, x, 0, y)
end

function ActivitiesScreen:movePlayer(direction)
	if not self.minigameActive or self.minigameType ~= "escape" then return end

	log("=== ESCAPE MINIGAME MOVE ===")
	log("Direction:", direction)
	log("Player pos before:", self.playerPos.row, self.playerPos.col)
	log("Moves left:", self.movesLeft)

	local newRow, newCol = self.playerPos.row, self.playerPos.col

	if direction == "up" then newRow = newRow - 1
	elseif direction == "down" then newRow = newRow + 1
	elseif direction == "left" then newCol = newCol - 1
	elseif direction == "right" then newCol = newCol + 1
	end

	-- Boundary check
	if newRow < 1 or newRow > self.gridSize or newCol < 1 or newCol > self.gridSize then
		log("Move blocked - out of bounds")
		return
	end

	-- Wall check - can't walk through walls!
	if self:isWall(newRow, newCol) then
		log("Move blocked - wall at", newRow, newCol)
		-- Flash the wall red briefly to indicate collision
		local wallCell = self.gridCells[newRow][newCol]
		if wallCell then
			UI.tween(wallCell, TweenInfo.new(0.1), { BackgroundColor3 = C.Red })
			task.delay(0.15, function()
				if wallCell and wallCell.Parent then
					UI.tween(wallCell, TweenInfo.new(0.1), { BackgroundColor3 = C.Gray900 })
				end
			end)
		end
		return
	end

	-- Move player
	self.playerPos.row, self.playerPos.col = newRow, newCol
	self:setGridPosition(self.playerCell, newRow, newCol)
	self.movesLeft = self.movesLeft - 1
	self.tapCounter.Text = "Moves: " .. self.movesLeft

	log("Player pos after:", self.playerPos.row, self.playerPos.col)

	-- Check win (reached exit)
	if self.playerPos.row == self.exitPos.row and self.playerPos.col == self.exitPos.col then
		log("ESCAPED! Player reached exit!")
		self.minigameActive = false
		self:completeMinigame(true)
		return
	end

	-- Move cop towards player (after player moves)
	self:moveCop()

	-- Check if cop caught player
	if self.playerPos.row == self.copPos.row and self.playerPos.col == self.copPos.col then
		log("CAUGHT! Cop caught player!")
		self.minigameActive = false
		self:completeMinigame(false)
		return
	end

	-- Check out of moves
	if self.movesLeft <= 0 then
		log("OUT OF MOVES!")
		self.minigameActive = false
		self:completeMinigame(false)
		return
	end
end

function ActivitiesScreen:moveCop()
	-- Cop moves toward player using simple pathfinding that respects walls
	local dRow = self.playerPos.row - self.copPos.row
	local dCol = self.playerPos.col - self.copPos.col

	log("Cop AI - dRow:", dRow, "dCol:", dCol, "from", self.copPos.row, self.copPos.col)

	-- Try to move in the direction with greatest difference first
	local moved = false
	local tryMoves = {}

	-- Prioritize directions based on distance to player
	if math.abs(dRow) >= math.abs(dCol) then
		-- Prefer vertical movement
		if dRow > 0 then
			table.insert(tryMoves, { row = 1, col = 0 }) -- down
		elseif dRow < 0 then
			table.insert(tryMoves, { row = -1, col = 0 }) -- up
		end
		if dCol > 0 then
			table.insert(tryMoves, { row = 0, col = 1 }) -- right
		elseif dCol < 0 then
			table.insert(tryMoves, { row = 0, col = -1 }) -- left
		end
	else
		-- Prefer horizontal movement
		if dCol > 0 then
			table.insert(tryMoves, { row = 0, col = 1 }) -- right
		elseif dCol < 0 then
			table.insert(tryMoves, { row = 0, col = -1 }) -- left
		end
		if dRow > 0 then
			table.insert(tryMoves, { row = 1, col = 0 }) -- down
		elseif dRow < 0 then
			table.insert(tryMoves, { row = -1, col = 0 }) -- up
		end
	end

	-- Try each move in order of priority
	for _, move in ipairs(tryMoves) do
		local newRow = self.copPos.row + move.row
		local newCol = self.copPos.col + move.col

		-- Check bounds and walls
		if newRow >= 1 and newRow <= self.gridSize and
			newCol >= 1 and newCol <= self.gridSize and
			not self:isWall(newRow, newCol) then
			self.copPos.row = newRow
			self.copPos.col = newCol
			moved = true
			log("Cop moved to:", newRow, newCol)
			break
		end
	end

	-- If no direct move worked, try random adjacent cells (cop is stuck)
	if not moved then
		local randomMoves = {
			{ row = -1, col = 0 }, { row = 1, col = 0 },
			{ row = 0, col = -1 }, { row = 0, col = 1 },
		}
		-- Shuffle
		for i = #randomMoves, 2, -1 do
			local j = math.random(i)
			randomMoves[i], randomMoves[j] = randomMoves[j], randomMoves[i]
		end

		for _, move in ipairs(randomMoves) do
			local newRow = self.copPos.row + move.row
			local newCol = self.copPos.col + move.col
			if newRow >= 1 and newRow <= self.gridSize and
				newCol >= 1 and newCol <= self.gridSize and
				not self:isWall(newRow, newCol) then
				self.copPos.row = newRow
				self.copPos.col = newCol
				log("Cop randomly moved to:", newRow, newCol)
				break
			end
		end
	end

	self:setGridPosition(self.copCell, self.copPos.row, self.copPos.col)
end

-- Generate a maze with walls that create corridors
function ActivitiesScreen:generateMaze()
	log("=== GENERATING MAZE ===")

	-- Initialize all cells as passable (false = no wall)
	self.walls = {}
	for row = 1, self.gridSize do
		self.walls[row] = {}
		for col = 1, self.gridSize do
			self.walls[row][col] = false
		end
	end

	-- Create maze patterns - several predefined layouts that are challenging but fair
	local mazePatterns = {
		-- Pattern 1: Classic L-shapes
		{
			{0,0,0,0,0,0,0,0},
			{0,1,1,0,1,1,1,0},
			{0,0,0,0,0,0,1,0},
			{0,1,1,1,1,0,0,0},
			{0,0,0,0,1,0,1,1},
			{1,1,1,0,0,0,0,0},
			{0,0,0,0,1,1,0,1},
			{0,0,1,0,0,0,0,0},
		},
		-- Pattern 2: Zigzag corridors
		{
			{0,0,0,1,0,0,0,0},
			{1,1,0,1,0,1,1,0},
			{0,0,0,0,0,0,1,0},
			{0,1,1,1,1,0,0,0},
			{0,0,0,0,0,1,1,0},
			{0,1,1,0,0,0,0,0},
			{0,0,0,0,1,1,1,0},
			{0,1,0,0,0,0,0,0},
		},
		-- Pattern 3: Center maze
		{
			{0,0,0,0,0,0,0,0},
			{0,1,1,1,1,1,1,0},
			{0,1,0,0,0,0,1,0},
			{0,0,0,1,1,0,0,0},
			{0,1,0,0,1,0,1,0},
			{0,1,0,0,0,0,1,0},
			{0,1,1,1,0,1,1,0},
			{0,0,0,0,0,0,0,0},
		},
		-- Pattern 4: Prison block style
		{
			{0,0,0,0,1,0,0,0},
			{0,1,0,0,1,0,1,0},
			{0,1,0,1,1,0,1,0},
			{0,0,0,0,0,0,0,0},
			{1,1,0,1,0,1,1,0},
			{0,0,0,1,0,0,0,0},
			{0,1,0,1,0,1,0,1},
			{0,0,0,0,0,0,0,0},
		},
		-- Pattern 5: Spiral approach
		{
			{0,0,0,0,0,0,0,0},
			{1,1,1,1,1,1,0,0},
			{0,0,0,0,0,0,0,1},
			{0,1,1,1,1,1,0,0},
			{0,0,0,0,0,1,0,1},
			{1,1,0,1,0,0,0,0},
			{0,0,0,1,0,1,1,0},
			{0,0,0,0,0,0,0,0},
		},
	}

	-- Pick a random maze pattern
	local pattern = mazePatterns[math.random(#mazePatterns)]

	-- Apply pattern to walls
	for row = 1, self.gridSize do
		for col = 1, self.gridSize do
			self.walls[row][col] = (pattern[row][col] == 1)
		end
	end

	-- Always ensure start and exit are clear
	self.walls[1][4] = false -- Player start
	self.walls[8][1] = false -- Exit
	self.walls[8][5] = false -- Cop start

	-- Clear path around exit
	self.walls[7][1] = false
	self.walls[8][2] = false

	log("Maze generated with pattern")

	return self.walls
end

-- Check if a position is blocked by a wall
function ActivitiesScreen:isWall(row, col)
	if row < 1 or row > self.gridSize or col < 1 or col > self.gridSize then
		return true -- Out of bounds = wall
	end
	return self.walls and self.walls[row] and self.walls[row][col] == true
end

function ActivitiesScreen:showEscapeMinigame()
	log("=== STARTING ESCAPE MINIGAME ===")

	self.minigameType = "escape"
	self.minigameActive = true

	-- Hide tap elements
	self.tapArea.Visible = false
	self.progressBg.Visible = false

	-- Show escape elements
	self.escapeGrid.Visible = true
	self.dirButtons.Visible = true

	-- Generate maze with walls
	self:generateMaze()

	-- Reset positions
	self.playerPos = { row = 1, col = 4 }
	self.copPos = { row = 8, col = 5 }
	self.exitPos = { row = 8, col = 1 }
	self.movesLeft = 30 -- More moves due to maze

	self:setGridPosition(self.playerCell, self.playerPos.row, self.playerPos.col)
	self:setGridPosition(self.copCell, self.copPos.row, self.copPos.col)
	self:setGridPosition(self.exitCell, self.exitPos.row, self.exitPos.col)

	-- Update grid visuals - walls are dark brick, passable are gray, exit is yellow
	for row = 1, self.gridSize do
		for col = 1, self.gridSize do
			local cell = self.gridCells[row][col]

			-- Clear any existing wall label
			local existingLabel = cell:FindFirstChild("WallLabel")
			if existingLabel then existingLabel:Destroy() end

			if self:isWall(row, col) then
				-- Wall cell - brick color with brick emoji
				cell.BackgroundColor3 = Color3.fromRGB(80, 50, 30) -- Brown brick color
				cell.BorderSizePixel = 0

				-- Add brick emoji
				local brickLabel = Instance.new("TextLabel")
				brickLabel.Name = "WallLabel"
				brickLabel.Size = UDim2.new(1, 0, 1, 0)
				brickLabel.Position = UDim2.new(0, 0, 0, 0)
				brickLabel.BackgroundTransparency = 1
				brickLabel.Font = Enum.Font.SourceSans
				brickLabel.TextSize = 18
				brickLabel.Text = "üß±"
				brickLabel.ZIndex = 99
				brickLabel.Parent = cell
			elseif row == self.exitPos.row and col == self.exitPos.col then
				-- Exit cell - highlighted with green glow
				cell.BackgroundColor3 = Color3.fromRGB(50, 120, 50) -- Green for exit
			else
				-- Normal passable cell - floor tile look
				cell.BackgroundColor3 = Color3.fromRGB(60, 65, 70) -- Dark floor
			end
		end
	end

	self.minigameTitle.Text = "üîì ESCAPE PRISON!"
	self.tapCounter.Text = "Moves: " .. self.movesLeft
	self.minigameInstructions.Text = "Navigate the maze! Reach the üö™ door before the üëÆ cop catches you!"

	-- Show modal
	self.minigameOverlay.Visible = true
	self.minigameCard.Position = UDim2.new(0.5, 0, 0.5, 50)
	self.minigameCard.BackgroundTransparency = 1

	UI.tween(self.minigameCard, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Position = UDim2.fromScale(0.5, 0.5),
		BackgroundTransparency = 0
	})

	log("Escape minigame started with maze - Player:", self.playerPos.row, self.playerPos.col, "Cop:", self.copPos.row, self.copPos.col, "Exit:", self.exitPos.row, self.exitPos.col)
	log("Wall count:", self:countWalls())
end

function ActivitiesScreen:countWalls()
	local count = 0
	for row = 1, self.gridSize do
		for col = 1, self.gridSize do
			if self:isWall(row, col) then count = count + 1 end
		end
	end
	return count
end

function ActivitiesScreen:showMinigame(item, accentColor)
	log("=== STARTING ACTIVITY MINIGAME ===")
	log("Item:", item.id, "MinigameType:", item.minigameType or "tap", "Accent:", tostring(accentColor))

	self.currentMinigameItem = item
	self.minigameAccent = accentColor
	
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- CRITICAL FIX: Use proper minigame system based on activity type!
	-- Different activities use different minigames for variety
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	
	local minigameType = item.minigameType or "mash"  -- Default to mash (tap)
	
	-- Try to use the global Minigames module if available
	local MinigamesModule = game.ReplicatedStorage:FindFirstChild("Minigames")
	if MinigamesModule then
		local success, Minigames = pcall(function() return require(MinigamesModule) end)
		if success and Minigames and Minigames.new then
			-- Create minigames instance if needed
			if not self._minigamesInstance then
				local ok, mg = pcall(function() return Minigames.new(self.screenGui) end)
				if ok and mg then
					self._minigamesInstance = mg
				end
			end
			
			if self._minigamesInstance and self._minigamesInstance.play then
				log("Using Minigames module for:", minigameType)
				self._minigamesInstance:play(minigameType, function(won, stats)
					log("Minigame result - Won:", won)
					if won then
						self:doActivity(item, true)  -- Bonus for winning minigame
					else
						self:showResult(false, "You didn't complete the challenge. No gains today!", "üòÖ")
					end
				end, {
					difficulty = item.id == "gym" and "medium" or "easy",
					taps = item.id == "gym" and 25 or 15,
				})
				return
			end
		end
	end
	
	-- Fallback to built-in tap minigame if Minigames module not available
	log("Falling back to built-in tap minigame")
	self.minigameType = "tap"
	self.tapCount = 0
	self.tapGoal = item.id == "gym" and 25 or 15
	self.minigameActive = true

	-- Show tap elements, hide escape elements
	self.tapArea.Visible = true
	self.progressBg.Visible = true
	self.escapeGrid.Visible = false
	self.dirButtons.Visible = false

	-- Proper minigame titles for each activity type
	local title
	if item.id == "gym" then
		title = "üí™ Tap to Workout!"
	elseif item.id == "study" then
		title = "üìö Tap to Study!"
	elseif item.id == "drivers_license" then
		title = "üöó Tap to Pass Your Driving Test!"
	elseif item.id == "meditate" then
		title = "üßò Tap at the Right Moment!"
	elseif item.id == "martial_arts" then
		title = "ü•ã Tap to Practice!"
	else
		title = "üëÜ Tap to Complete!"
	end

	self.minigameTitle.Text = title
	self.tapArea.Text = "TAP!"
	self.tapArea.BackgroundColor3 = accentColor
	self.progressFill.BackgroundColor3 = accentColor
	self.progressFill.Size = UDim2.new(0, 0, 1, 0)
	self.tapCounter.Text = "0 / " .. self.tapGoal
	
	local instructions
	if item.id == "drivers_license" then
		instructions = "Tap to answer driving test questions!"
	elseif item.id == "meditate" then
		instructions = "Tap when the circle is centered!"
	else
		instructions = "Tap as fast as you can!"
	end
	self.minigameInstructions.Text = instructions

	self.minigameOverlay.Visible = true
	self.minigameCard.Position = UDim2.new(0.5, 0, 0.5, 50)
	self.minigameCard.BackgroundTransparency = 1

	UI.tween(self.minigameCard, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Position = UDim2.fromScale(0.5, 0.5),
		BackgroundTransparency = 0
	})

	-- Timeout
	task.delay(10, function()
		if self.minigameActive and self.minigameOverlay.Visible and self.minigameType == "tap" then
			self.minigameActive = false
			self:completeMinigame(self.tapCount >= self.tapGoal * 0.5)
		end
	end)
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- CRITICAL FIX: Crime Minigame (Bank Robbery Heist!)
-- This was never being called because crime cards skipped minigame check
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ActivitiesScreen:showCrimeMinigame(item)
	log("=== STARTING CRIME MINIGAME ===")
	log("Crime:", item.id, "MinigameType:", item.minigameType or "heist")

	self.currentMinigameItem = item
	self.minigameAccent = C.Red
	
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	-- CRITICAL FIX: Use proper minigame system based on crime type!
	-- Different crimes use different minigames:
	-- - Bank Robbery/Burglary -> Heist (crack the safe)
	-- - GTA -> Getaway (escape the cops)
	-- - Pickpocket -> QTE (quick reaction)
	-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	
	local minigameType = item.minigameType or "heist"  -- Default to heist
	
	-- Try to use the global Minigames module if available
	local MinigamesModule = game.ReplicatedStorage:FindFirstChild("Minigames")
	if MinigamesModule then
		local success, Minigames = pcall(function() return require(MinigamesModule) end)
		if success and Minigames and Minigames.new then
			-- Create minigames instance if needed
			if not self._minigamesInstance then
				local ok, mg = pcall(function() return Minigames.new(self.screenGui) end)
				if ok and mg then
					self._minigamesInstance = mg
				end
			end
			
			if self._minigamesInstance and self._minigamesInstance.play then
				log("Using Minigames module for crime:", minigameType)
				self._minigamesInstance:play(minigameType, function(won, stats)
					log("Crime minigame result - Won:", won)
					self:doCrimeWithBonus(item, won)
				end, {
					difficulty = item.risk and item.risk >= 60 and "hard" or "medium",
				})
				return
			end
		end
	end
	
	-- Fallback to built-in tap minigame if Minigames module not available
	log("Falling back to built-in crime tap minigame")
	self.minigameType = "crime_tap"
	self.tapCount = 0
	self.tapGoal = item.id == "bank_robbery" and 30 or 20
	self.minigameActive = true

	-- Show tap elements, hide escape elements
	self.tapArea.Visible = true
	self.progressBg.Visible = true
	self.escapeGrid.Visible = false
	self.dirButtons.Visible = false

	-- Crime-specific minigame titles
	local title
	if item.id == "bank_robbery" then
		title = "üè¶ TAP TO CRACK THE SAFE!"
	elseif item.id == "burglary" then
		title = "üè† TAP TO BREAK IN!"
	elseif item.id == "gta" then
		title = "üöó TAP TO HOTWIRE THE CAR!"
	elseif item.id == "pickpocket" then
		title = "üëõ TAP AT THE RIGHT MOMENT!"
	else
		title = "üîì TAP TO COMPLETE THE HEIST!"
	end

	self.minigameTitle.Text = title
	self.tapArea.Text = "TAP!"
	self.tapArea.BackgroundColor3 = C.Red
	self.progressFill.BackgroundColor3 = C.Red
	self.progressFill.Size = UDim2.new(0, 0, 1, 0)
	self.tapCounter.Text = "0 / " .. self.tapGoal
	
	local instructions = item.id == "bank_robbery" and "Crack the vault before security arrives!" or "Tap fast to complete the crime!"
	self.minigameInstructions.Text = instructions

	self.minigameOverlay.Visible = true
	self.minigameCard.Position = UDim2.new(0.5, 0, 0.5, 50)
	self.minigameCard.BackgroundTransparency = 1

	UI.tween(self.minigameCard, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Position = UDim2.fromScale(0.5, 0.5),
		BackgroundTransparency = 0
	})

	-- Timeout - shorter for crime (8 seconds - alarm triggered!)
	task.delay(8, function()
		if self.minigameActive and self.minigameOverlay.Visible and self.minigameType == "crime_tap" then
			self.minigameActive = false
			self:completeCrimeMinigame(self.tapCount >= self.tapGoal)
		end
	end)
end

function ActivitiesScreen:completeCrimeMinigame(success)
	log("=== CRIME MINIGAME COMPLETE ===")
	log("Success:", success)

	task.delay(0.3, function()
		self.minigameOverlay.Visible = false

		-- Reset UI elements
		self.escapeGrid.Visible = false
		self.dirButtons.Visible = false
		self.tapArea.Visible = true
		self.progressBg.Visible = true

		if success then
			-- Player completed the heist minigame - bonus success chance!
			log("Heist minigame success! Calling server with bonus...")
			self:doCrimeWithBonus(self.currentMinigameItem, true)
		else
			-- Player failed minigame - higher chance of getting caught
			log("Heist minigame failed! Calling server without bonus...")
			self:doCrimeWithBonus(self.currentMinigameItem, false)
		end
	end)
end

function ActivitiesScreen:doCrimeWithBonus(item, bonus)
	log("=== COMMITTING CRIME (WITH MINIGAME RESULT) ===")
	log("Crime:", item.id, "Bonus:", bonus)

	if not CommitCrime then
		logWarn("CommitCrime remote not available!")
		self:showResult(false, "Server not available", "Error")
		return
	end

	-- Pass bonus flag to server - indicates minigame success
	-- CRITICAL FIX: Add pcall protection
	local success, result = pcall(function()
		return CommitCrime:InvokeServer(item.id, bonus)
	end)
	log("Server response:", success and (result and "received" or "nil") or "error")

	if success and result then
		log("Success:", result.success, "Caught:", result.caught, "Message:", result.message)
		local emoji = result.caught and "Caught!" or (result.success and "Success!" or "Failed")
		self:showResult(result.success, result.message, emoji)
	else
		logWarn("Server returned nil!")
		self:showResult(false, "Server error", "Error")
	end
end

function ActivitiesScreen:completeMinigame(success)
	log("=== MINIGAME COMPLETE ===")
	log("Type:", self.minigameType, "Success:", success)

	task.delay(0.3, function()
		self.minigameOverlay.Visible = false

		-- Reset UI elements
		self.escapeGrid.Visible = false
		self.dirButtons.Visible = false
		self.tapArea.Visible = true
		self.progressBg.Visible = true

		if self.minigameType == "escape" then
			-- Prison escape minigame
			if success then
				log("Escape successful! Calling server...")
				self:doPrisonActivityAfterMinigame(true)
			else
				log("Escape failed!")
				self:doPrisonActivityAfterMinigame(false)
			end
		else
			-- Tap minigame
			if success then
				self:doActivity(self.currentMinigameItem, true)
			else
				self:showResult(false, "You gave up halfway through. No gains today!", "Failed")
			end
		end
	end)
end

function ActivitiesScreen:doPrisonActivityAfterMinigame(escaped)
	log("=== PRISON ESCAPE MINIGAME RESULT ===")
	log("Escaped:", escaped)

	if not DoPrisonAction then
		logWarn("DoPrisonAction remote not available!")
		self:showResult(false, "Server not available", "Error")
		return
	end

	-- The server handles the actual escape logic, but we pass the minigame result
	if escaped then
		-- CRITICAL FIX: Don't show result popup here!
		-- The server will send an event popup with escape choices.
		-- Showing a popup here causes DOUBLE POPUP bug.
		-- CRITICAL FIX: Add pcall protection
		local success, result = pcall(function()
			return DoPrisonAction:InvokeServer("prison_escape")
		end)
		if success and result then
			log("Server response:", result.success, result.message)
			-- Server handles the popup via presentEvent - don't show duplicate!
		else
			self:showResult(false, "Server error", "Error")
		end
	else
		-- Player failed minigame - got caught
		-- Call server first to add time, THEN show the result
		-- CRITICAL FIX: Add pcall protection
		local callSuccess, serverResult = pcall(function()
			return DoPrisonAction:InvokeServer("prison_escape_failed")
		end)
		if callSuccess and serverResult then
			log("Server response for failed escape:", serverResult.success, serverResult.message)
			self:showResult(false, serverResult.message or "You got caught trying to escape! More time added to your sentence.", "Caught!")
		else
			self:showResult(false, "You got caught trying to escape! More time added to your sentence.", "Caught!")
		end
	end
end

function ActivitiesScreen:doActivity(item, bonus)
	log("=== DOING ACTIVITY ===")
	log("Activity ID:", item.id, "Name:", item.name, "Bonus:", bonus or false)
	log("Player Age:", self:getAge(), "Money:", self:getMoney())

	if not DoActivity then
		logWarn("DoActivity remote not available!")
		self:showResult(false, "Server not available", "Error")
		return
	end

	log("Invoking server DoActivity...")
	-- CRITICAL FIX: Add pcall protection for server calls
	local success, result = pcall(function()
		return DoActivity:InvokeServer(item.id, bonus or false)
	end)
	if not success then
		logWarn("DoActivity call failed:", result)
		self:showResult(false, "Server error", "Error")
		return
	end
	log("Server response:", result and "received" or "nil")

	if result then
		log("Success:", result.success, "Message:", result.message)
		self:showResult(result.success, result.message, result.success and "Done!" or "Failed")
	else
		logWarn("Server returned nil!")
		self:showResult(false, "Server error", "Error")
	end
end

function ActivitiesScreen:doCrime(item)
	log("=== COMMITTING CRIME ===")
	log("Crime ID:", item.id, "Name:", item.name, "Risk:", item.risk)
	log("Player Age:", self:getAge(), "Money:", self:getMoney())

	if not CommitCrime then
		logWarn("CommitCrime remote not available!")
		self:showResult(false, "Server not available", "Error")
		return
	end

	log("Invoking server CommitCrime...")
	-- CRITICAL FIX: Add pcall protection for server calls
	local success, result = pcall(function()
		return CommitCrime:InvokeServer(item.id)
	end)
	if not success then
		logWarn("CommitCrime call failed:", result)
		self:showResult(false, "Server error", "Error")
		return
	end
	log("Server response:", result and "received" or "nil")

	if result then
		log("Success:", result.success, "Caught:", result.caught, "Message:", result.message)
		local emoji = result.caught and "Caught!" or (result.success and "Success!" or "Failed")
		self:showResult(result.success, result.message, emoji)
	else
		logWarn("Server returned nil!")
		self:showResult(false, "Server error", "Error")
	end
end

function ActivitiesScreen:doPrisonActivity(item)
	log("=== DOING PRISON ACTIVITY ===")
	log("Prison Activity ID:", item.id, "Name:", item.name)
	log("Player Money:", self:getMoney())

	-- Prison escape has a minigame!
	if item.id == "prison_escape" then
		log("Starting prison escape minigame...")
		self:showEscapeMinigame()
		return
	end

	if not DoPrisonAction then
		logWarn("DoPrisonAction remote not available!")
		self:showResult(false, "Server not available", "Error")
		return
	end

	log("Invoking server DoPrisonAction...")
	-- CRITICAL FIX: Add pcall protection for server calls
	local success, result = pcall(function()
		return DoPrisonAction:InvokeServer(item.id)
	end)
	if not success then
		logWarn("DoPrisonAction call failed:", result)
		self:showResult(false, "Server error", "Error")
		return
	end
	log("Server response:", result and "received" or "nil")

	if result then
		log("Success:", result.success, "Message:", result.message)
		local emoji = result.success and "Done!" or "Failed"
		if item.id == "prison_riot" then emoji = result.success and "Chaos!" or "Caught!" end
		if item.id == "prison_snitch" then emoji = result.success and "Snitched!" or "Oops!" end
		self:showResult(result.success, result.message, emoji)
	else
		logWarn("Server returned nil!")
		self:showResult(false, "Server error", "Error")
	end
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- CRITICAL FIX #88: ROYAL ACTIVITIES TAB
-- Activities specific to players who are royalty (have royalty gamepass + is_royalty)
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ActivitiesScreen:populateRoyal()
	self:updateInfoBar()
	
	local royalState = self.playerState and self.playerState.RoyalState or {}
	local isMonarch = royalState.isMonarch
	local popularity = royalState.popularity or 50
	local countryName = royalState.countryName or "Kingdom"
	local title = royalState.title or (isMonarch and "Monarch" or "Royal")
	
	-- Royal status header
	local headerCard = Instance.new("Frame")
	headerCard.Size = UDim2.new(1, 0, 0, 100)
	headerCard.BackgroundColor3 = Color3.fromRGB(218, 165, 32) -- Gold
	headerCard.LayoutOrder = 0
	headerCard.ZIndex = 82
	headerCard.Parent = self.contentScroll
	UI.corner(headerCard, 18)
	
	local iconFrame = Instance.new("Frame")
	iconFrame.Size = UDim2.new(0, 55, 0, 55)
	iconFrame.Position = UDim2.new(0, 16, 0.5, -27.5)
	iconFrame.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
	iconFrame.ZIndex = 83
	iconFrame.Parent = headerCard
	UI.corner(iconFrame, 12)
	
	local headerIcon = Instance.new("TextLabel")
	headerIcon.Size = UDim2.fromScale(1, 1)
	headerIcon.BackgroundTransparency = 1
	headerIcon.Font = F.Body or Enum.Font.Gotham
	headerIcon.TextSize = 32
	headerIcon.Text = isMonarch and "üëë" or "üè∞"
	headerIcon.ZIndex = 84
	headerIcon.Parent = iconFrame
	
	local headerText = Instance.new("TextLabel")
	headerText.Size = UDim2.new(1, -85, 0, 26)
	headerText.Position = UDim2.new(0, 80, 0, 14)
	headerText.BackgroundTransparency = 1
	headerText.Font = F.Title or Enum.Font.GothamBold
	headerText.TextSize = 18
	headerText.TextColor3 = C.White
	headerText.TextXAlignment = Enum.TextXAlignment.Left
	headerText.Text = title .. " of " .. countryName
	headerText.ZIndex = 83
	headerText.Parent = headerCard
	
	local popBadge = Instance.new("Frame")
	popBadge.Size = UDim2.new(0, 140, 0, 26)
	popBadge.Position = UDim2.new(0, 80, 0, 42)
	popBadge.BackgroundColor3 = Color3.fromRGB(255, 255, 200)
	popBadge.ZIndex = 83
	popBadge.Parent = headerCard
	UI.pill(popBadge)
	
	local popText = Instance.new("TextLabel")
	popText.Size = UDim2.fromScale(1, 1)
	popText.BackgroundTransparency = 1
	popText.Font = F.Medium or Enum.Font.GothamMedium
	popText.TextSize = 12
	popText.TextColor3 = Color3.fromRGB(139, 69, 19)
	popText.Text = "üë• Popularity: " .. popularity .. "%"
	popText.ZIndex = 84
	popText.Parent = popBadge
	
	-- Royal duties section
	-- CRITICAL FIX #107: Added minAge to all items to prevent nil comparison error
	local RoyalDuties = {
		{ id = "public_appearance", name = "Public Appearance", emoji = "üì∏", effect = "+Popularity", cost = 0, minAge = 5 },
		{ id = "charity_visit", name = "Visit Charity", emoji = "‚ù§Ô∏è", effect = "+Popularity +Happiness", cost = 10000, minAge = 8 },
		{ id = "state_dinner", name = "Host State Dinner", emoji = "üçΩÔ∏è", effect = "+Diplomacy", cost = 50000, minAge = 18 },
		{ id = "open_parliament", name = "Open Parliament", emoji = "üèõÔ∏è", effect = "+Respect", cost = 0, monarchOnly = true, minAge = 21 },
		{ id = "knight_ceremony", name = "Knight Someone", emoji = "‚öîÔ∏è", effect = "+Popularity", cost = 0, monarchOnly = true, minAge = 21 },
		{ id = "royal_wedding", name = "Attend Royal Wedding", emoji = "üíí", effect = "+Happiness +Popularity", cost = 0, minAge = 5 },
		{ id = "military_review", name = "Military Review", emoji = "üéñÔ∏è", effect = "+Popularity", cost = 0, minAge = 16 },
		{ id = "charity_gala", name = "Host Charity Gala", emoji = "üé≠", effect = "+Popularity +Fame", cost = 100000, minAge = 18 },
	}
	
	local section = Instance.new("Frame")
	section.Name = "RoyalDutiesSection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 1
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)
	
	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section
	
	local header = Instance.new("Frame")
	header.Size = UDim2.new(1, 0, 0, 36)
	header.BackgroundTransparency = 1
	header.LayoutOrder = 0
	header.ZIndex = 83
	header.Parent = section
	
	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, 120, 0, 32)
	badge.BackgroundColor3 = Color3.fromRGB(218, 165, 32)
	badge.ZIndex = 84
	badge.Parent = header
	UI.pill(badge)
	
	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.fromScale(1, 1)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.Font = F.Button or Enum.Font.GothamBold
	badgeLabel.TextSize = 14
	badgeLabel.TextColor3 = C.White
	badgeLabel.Text = "üëë Royal Duties"
	badgeLabel.ZIndex = 85
	badgeLabel.Parent = badge
	
	for i, duty in ipairs(RoyalDuties) do
		if not duty.monarchOnly or isMonarch then
			self:createActivityCard(section, duty, i, Color3.fromRGB(218, 165, 32), Color3.fromRGB(255, 248, 220))
		end
	end
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- CRITICAL FIX #89: FAME ACTIVITIES TAB
-- Activities specific to players with a celebrity career
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ActivitiesScreen:populateFame()
	self:updateInfoBar()
	
	local fameState = self.playerState and self.playerState.FameState or {}
	local fame = (self.playerState and self.playerState.Fame) or 0
	local careerPath = fameState.careerPath or "Celebrity"
	local followers = fameState.followers or 0
	
	-- Fame status header
	local headerCard = Instance.new("Frame")
	headerCard.Size = UDim2.new(1, 0, 0, 100)
	headerCard.BackgroundColor3 = Color3.fromRGB(255, 215, 0) -- Gold
	headerCard.LayoutOrder = 0
	headerCard.ZIndex = 82
	headerCard.Parent = self.contentScroll
	UI.corner(headerCard, 18)
	
	local iconFrame = Instance.new("Frame")
	iconFrame.Size = UDim2.new(0, 55, 0, 55)
	iconFrame.Position = UDim2.new(0, 16, 0.5, -27.5)
	iconFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 200)
	iconFrame.ZIndex = 83
	iconFrame.Parent = headerCard
	UI.corner(iconFrame, 12)
	
	local headerIcon = Instance.new("TextLabel")
	headerIcon.Size = UDim2.fromScale(1, 1)
	headerIcon.BackgroundTransparency = 1
	headerIcon.Font = F.Body or Enum.Font.Gotham
	headerIcon.TextSize = 32
	headerIcon.Text = "‚≠ê"
	headerIcon.ZIndex = 84
	headerIcon.Parent = iconFrame
	
	local headerText = Instance.new("TextLabel")
	headerText.Size = UDim2.new(1, -85, 0, 26)
	headerText.Position = UDim2.new(0, 80, 0, 14)
	headerText.BackgroundTransparency = 1
	headerText.Font = F.Title or Enum.Font.GothamBold
	headerText.TextSize = 18
	headerText.TextColor3 = C.White
	headerText.TextXAlignment = Enum.TextXAlignment.Left
	headerText.Text = string.upper(careerPath) .. " Career"
	headerText.ZIndex = 83
	headerText.Parent = headerCard
	
	local fameBadge = Instance.new("Frame")
	fameBadge.Size = UDim2.new(0, 200, 0, 26)
	fameBadge.Position = UDim2.new(0, 80, 0, 42)
	fameBadge.BackgroundColor3 = Color3.fromRGB(255, 255, 200)
	fameBadge.ZIndex = 83
	fameBadge.Parent = headerCard
	UI.pill(fameBadge)
	
	local fameText = Instance.new("TextLabel")
	fameText.Size = UDim2.fromScale(1, 1)
	fameText.BackgroundTransparency = 1
	fameText.Font = F.Medium or Enum.Font.GothamMedium
	fameText.TextSize = 12
	fameText.TextColor3 = Color3.fromRGB(139, 69, 19)
	fameText.Text = "üåü Fame: " .. fame .. "% | üë• " .. UI.formatNumber(followers) .. " followers"
	fameText.ZIndex = 84
	fameText.Parent = fameBadge
	
	-- Fame activities
	-- CRITICAL FIX #108: Added minAge to all items to prevent nil comparison error
	local FameActivities = {
		{ id = "audition", name = "Go to Audition", emoji = "üé¨", effect = "+Fame +Money", cost = 0, minAge = 16 },
		{ id = "social_post", name = "Post on Social Media", emoji = "üì±", effect = "+Followers", cost = 0, minAge = 13 },
		{ id = "interview", name = "Do an Interview", emoji = "üé§", effect = "+Fame", cost = 0, minAge = 14 },
		{ id = "photoshoot", name = "Do a Photoshoot", emoji = "üì∏", effect = "+Looks +Fame", cost = 500, minAge = 16 },
		{ id = "endorsement", name = "Seek Endorsement", emoji = "üíº", effect = "+Money", cost = 0, minAge = 18 },
		{ id = "publicity_stunt", name = "Publicity Stunt", emoji = "üé™", effect = "+Fame +Risk", cost = 5000, minAge = 18 },
		{ id = "charity_event", name = "Charity Event", emoji = "‚ù§Ô∏è", effect = "+Fame +Happiness", cost = 10000, minAge = 16 },
		{ id = "album_tour", name = "Go on Tour", emoji = "üé∏", effect = "+Fame +Money -Health", cost = 50000, minAge = 18 },
	}
	
	local section = Instance.new("Frame")
	section.Name = "FameSection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 1
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)
	
	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section
	
	for i, activity in ipairs(FameActivities) do
		self:createActivityCard(section, activity, i, Color3.fromRGB(255, 215, 0), Color3.fromRGB(255, 248, 220))
	end
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- CRITICAL FIX #90: MAFIA ACTIVITIES TAB
-- Activities specific to players in the mob
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ActivitiesScreen:populateMafia()
	self:updateInfoBar()
	
	local mobState = self.playerState and self.playerState.MobState or {}
	local familyName = mobState.familyName or "Crime Family"
	local rankName = mobState.rankName or "Associate"
	local respect = mobState.respect or 0
	local heat = mobState.heat or 0
	
	-- Mafia status header
	local headerCard = Instance.new("Frame")
	headerCard.Size = UDim2.new(1, 0, 0, 100)
	headerCard.BackgroundColor3 = Color3.fromRGB(88, 28, 28) -- Dark red
	headerCard.LayoutOrder = 0
	headerCard.ZIndex = 82
	headerCard.Parent = self.contentScroll
	UI.corner(headerCard, 18)
	
	local iconFrame = Instance.new("Frame")
	iconFrame.Size = UDim2.new(0, 55, 0, 55)
	iconFrame.Position = UDim2.new(0, 16, 0.5, -27.5)
	iconFrame.BackgroundColor3 = Color3.fromRGB(120, 40, 40)
	iconFrame.ZIndex = 83
	iconFrame.Parent = headerCard
	UI.corner(iconFrame, 12)
	
	local headerIcon = Instance.new("TextLabel")
	headerIcon.Size = UDim2.fromScale(1, 1)
	headerIcon.BackgroundTransparency = 1
	headerIcon.Font = F.Body or Enum.Font.Gotham
	headerIcon.TextSize = 32
	headerIcon.Text = mobState.rankEmoji or "üî´"
	headerIcon.ZIndex = 84
	headerIcon.Parent = iconFrame
	
	local headerText = Instance.new("TextLabel")
	headerText.Size = UDim2.new(1, -85, 0, 26)
	headerText.Position = UDim2.new(0, 80, 0, 14)
	headerText.BackgroundTransparency = 1
	headerText.Font = F.Title or Enum.Font.GothamBold
	headerText.TextSize = 18
	headerText.TextColor3 = C.White
	headerText.TextXAlignment = Enum.TextXAlignment.Left
	headerText.Text = rankName .. " - " .. familyName
	headerText.ZIndex = 83
	headerText.Parent = headerCard
	
	local statsBadge = Instance.new("Frame")
	statsBadge.Size = UDim2.new(0, 200, 0, 26)
	statsBadge.Position = UDim2.new(0, 80, 0, 42)
	statsBadge.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
	statsBadge.ZIndex = 83
	statsBadge.Parent = headerCard
	UI.pill(statsBadge)
	
	local statsText = Instance.new("TextLabel")
	statsText.Size = UDim2.fromScale(1, 1)
	statsText.BackgroundTransparency = 1
	statsText.Font = F.Medium or Enum.Font.GothamMedium
	statsText.TextSize = 12
	statsText.TextColor3 = C.White
	statsText.Text = "üí™ Respect: " .. respect .. " | üî• Heat: " .. heat .. "%"
	statsText.ZIndex = 84
	statsText.Parent = statsBadge
	
	-- Mafia operations
	-- CRITICAL FIX #109: Added minAge to all items to prevent nil comparison error
	local MafiaOperations = {
		{ id = "collect_protection", name = "Collect Protection", emoji = "üí∞", effect = "+Money +Heat", risk = 20, minAge = 18, cost = 0 },
		{ id = "contraband_run", name = "Contraband Run", emoji = "üì¶", effect = "+Money +Heat", risk = 35, minAge = 18, cost = 0 },
		{ id = "hit_job", name = "Hit Job", emoji = "üî´", effect = "+Respect +Heat", risk = 50, minAge = 18, cost = 0 },
		{ id = "heist", name = "Plan a Heist", emoji = "üè¶", effect = "+Money +Heat", risk = 60, hasMinigame = true, minigameType = "heist", minAge = 18, cost = 0 },
		{ id = "intimidate", name = "Intimidate Someone", emoji = "üò†", effect = "+Respect", risk = 25, minAge = 18, cost = 0 },
		{ id = "recruit", name = "Recruit Members", emoji = "üë•", effect = "+Loyalty", risk = 10, minAge = 18, cost = 0 },
		{ id = "bribe_cops", name = "Bribe Police", emoji = "üëÆ", effect = "-Heat", cost = 50000, minAge = 18 },
		{ id = "lay_low", name = "Lay Low", emoji = "üè†", effect = "-Heat", cost = 0, minAge = 18 },
	}
	
	local section = Instance.new("Frame")
	section.Name = "MafiaSection"
	section.Size = UDim2.new(1, 0, 0, 0)
	section.AutomaticSize = Enum.AutomaticSize.Y
	section.BackgroundColor3 = C.White
	section.LayoutOrder = 1
	section.ZIndex = 82
	section.Parent = self.contentScroll
	UI.corner(section, 18)
	UI.stroke(section, 1, 0.88, C.Gray200)
	UI.pad(section, 14, 14, 14, 16)
	
	local sectionLayout = Instance.new("UIListLayout")
	sectionLayout.Padding = UDim.new(0, 10)
	sectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
	sectionLayout.Parent = section
	
	for i, op in ipairs(MafiaOperations) do
		self:createActivityCard(section, op, i, Color3.fromRGB(139, 0, 0), Color3.fromRGB(255, 220, 220))
	end
	
	-- CRITICAL FIX #314: Info card about getting a legitimate job while in mafia
	local jobInfoCard = Instance.new("Frame")
	jobInfoCard.Name = "JobInfoCard"
	jobInfoCard.Size = UDim2.new(1, 0, 0, 70)
	jobInfoCard.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
	jobInfoCard.LayoutOrder = 999
	jobInfoCard.ZIndex = 82
	jobInfoCard.Parent = self.contentScroll
	UI.corner(jobInfoCard, 14)
	
	local jobIcon = Instance.new("TextLabel")
	jobIcon.Size = UDim2.new(0, 40, 0, 40)
	jobIcon.Position = UDim2.new(0, 12, 0.5, -20)
	jobIcon.BackgroundTransparency = 1
	jobIcon.Font = F.Body or Enum.Font.Gotham
	jobIcon.TextSize = 28
	jobIcon.Text = "üíº"
	jobIcon.ZIndex = 83
	jobIcon.Parent = jobInfoCard
	
	local jobTitle = Instance.new("TextLabel")
	jobTitle.Size = UDim2.new(1, -70, 0, 22)
	jobTitle.Position = UDim2.new(0, 60, 0, 10)
	jobTitle.BackgroundTransparency = 1
	jobTitle.Font = F.Title or Enum.Font.GothamBold
	jobTitle.TextSize = 14
	jobTitle.TextColor3 = Color3.fromRGB(200, 200, 220)
	jobTitle.TextXAlignment = Enum.TextXAlignment.Left
	jobTitle.Text = "üí° Want a Cover Job?"
	jobTitle.ZIndex = 83
	jobTitle.Parent = jobInfoCard
	
	local jobDesc = Instance.new("TextLabel")
	jobDesc.Size = UDim2.new(1, -70, 0, 30)
	jobDesc.Position = UDim2.new(0, 60, 0, 32)
	jobDesc.BackgroundTransparency = 1
	jobDesc.Font = F.Body or Enum.Font.Gotham
	jobDesc.TextSize = 11
	jobDesc.TextColor3 = Color3.fromRGB(160, 160, 180)
	jobDesc.TextXAlignment = Enum.TextXAlignment.Left
	jobDesc.TextWrapped = true
	jobDesc.Text = "You can get a regular job in the Jobs tab as a cover. Having legit income helps hide your criminal activities!"
	jobDesc.ZIndex = 83
	jobDesc.Parent = jobInfoCard
end

function ActivitiesScreen:showResult(success, message, emoji)
	local shellColor = success and C.Green or C.Red
	local shellStroke = success and C.GreenDark or C.RedDark
	local pale = success and C.GreenPale or C.RedPale

	self.resultModal.shell.BackgroundColor3 = shellColor
	self.resultModal.shellStroke.Color = shellStroke
	self.resultModal.emojiFrame.BackgroundColor3 = pale
	
	-- CRITICAL UI FIX: Better default emojis
	local displayEmoji = emoji
	if not displayEmoji or displayEmoji == "OK" or displayEmoji == "Done!" then
		displayEmoji = success and "‚ú®" or "üòî"
	elseif displayEmoji == "X" or displayEmoji == "Error" or displayEmoji == "Failed" then
		displayEmoji = "‚ùå"
	elseif displayEmoji == "Success!" then
		displayEmoji = "üí∞"
	elseif displayEmoji == "Caught!" then
		displayEmoji = "üöî"
	elseif displayEmoji == "Chaos!" then
		displayEmoji = "üî•"
	elseif displayEmoji == "Snitched!" then
		displayEmoji = "ü§´"
	end
	self.resultModal.emojiLabel.Text = displayEmoji
	
	-- CRITICAL UI FIX: More descriptive titles based on context
	local title = success and "Activity Complete!" or "Uh oh..."
	if emoji == "Caught!" then title = "Busted!" end
	if emoji == "Chaos!" then title = "Prison Riot!" end
	
	self.resultModal.titleLabel.Text = title
	self.resultModal.titleLabel.TextColor3 = success and C.GreenDark or C.RedDark
	self.resultModal.messageLabel.Text = message or (success and "You did it!" or "Something went wrong...")
	self.resultModal.okButton.BackgroundColor3 = shellColor
	self.resultModal.okButton.Text = success and "üëç Awesome!" or "üòî Okay..."

	-- Use custom show method if available, fallback to UI.showModal
	if self.resultModal.show then
		self.resultModal.show()
	elseif UI.showModal then
		UI.showModal(self.resultModal)
	end
end

function ActivitiesScreen:show()
	log("=== SHOWING ActivitiesScreen ===")
	local inJail = self:isInJail()
	log("Current state - Age:", self:getAge(), "Money:", self:getMoney(), "InJail:", inJail, "JailYearsLeft:", self:getJailYearsLeft())

	-- Rebuild tabs (jail vs normal mode)
	self:rebuildTabs()
	self:updateInfoBar()

	-- Set appropriate starting tab
	if inJail then
		self.currentTab = "prison"
	elseif self.currentTab == "prison" then
		-- Was viewing prison but no longer in jail - switch to normal tab
		self.currentTab = "mindbody"
	end

	self:switchTab(self.currentTab)
	UI.slideInScreen(self.overlay, "right")
	self.isVisible = true
	log("‚úÖ ActivitiesScreen is now visible")
end

function ActivitiesScreen:hide()
	log("=== HIDING ActivitiesScreen ===")
	UI.slideOutScreen(self.overlay, "right", function()
		self.resultModal.overlay.Visible = false
		self.minigameOverlay.Visible = false
		log("‚úÖ ActivitiesScreen hidden, modals cleaned up")
	end)
	self.isVisible = false
end

return ActivitiesScreen
