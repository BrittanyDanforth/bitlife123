--[[
	PoliceEvents.lua
	
	Career events for Law Enforcement careers (Police Officer, Detective, etc.)
	
	Features:
	- Daily patrol encounters
	- Crime investigations
	- Corruption temptations
	- Career advancement to detective/sergeant
	- Internal affairs investigations
	- Dangerous situations
	
	CRITICAL FIX #RVS-9: Premium path blocking for mafia players
]]

local RANDOM = Random.new()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CRITICAL FIX #RVS-POLICE-1: Premium path blocking
-- Police events should NEVER fire for mafia players (obvious conflict of interest!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function isBlockedByMafiaPath(state)
	if not state.Flags then return false end
	local flags = state.Flags
	
	-- Block if player is in mafia
	if flags.primary_wish_type == "mafia" then return true end
	if flags.in_mob or flags.mafia_member then return true end
	if state.MobState and state.MobState.inMob then return true end
	
	-- Also block if player has serious criminal record (can't be cop with felonies)
	if flags.criminal_record and flags.violent_crime then return true end
	
	return false
end

-- CRITICAL FIX: Police job IDs for eligibility checks
-- eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category doesn't work because police jobs use "government" category
local POLICE_JOB_IDS = {
	police_officer = true,
	detective = true,
	police_chief = true,
	probation_officer = true,
	fbi_agent = true,
	cia_agent = true,
}

local function isPoliceJob(state)
	-- CRITICAL FIX #RVS-POLICE-2: Check mafia path blocking first
	if isBlockedByMafiaPath(state) then return false end
	if not state.CurrentJob then return false end
	local jobId = state.CurrentJob.id or state.CurrentJob
	return POLICE_JOB_IDS[jobId] == true
end

local events = {
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- DAILY PATROL EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "routine_traffic_stop",
		emoji = "ğŸš”",
		title = "Routine Traffic Stop",
		text = "You pull over a vehicle for speeding. The driver seems nervous. Something feels off.",
		question = "How do you proceed?",
		category = "career_police",
		weight = 8,
		minAge = 21,
		maxAge = 60,
		baseChance = 0.6,
		cooldown = 2,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { in_prison = true, suspended = true },
		
		choices = {
			{
				index = 1,
				text = "By the book - just write the ticket",
				effects = { Happiness = 2 },
				feedText = "You wrote the ticket and let them go.",
				onResolve = function(state)
					if RANDOM:NextNumber() < 0.1 then
						-- The car was actually carrying something illegal
						if state.AddFeed then
							state:AddFeed("ğŸ’­ Later you heard that driver was arrested in another county with contraband. Should've searched...")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Request backup and search the vehicle",
				effects = { Happiness = 3 },
				feedText = "You called for backup...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					if outcome < 0.4 then
						-- Find something
						state.CareerInfo = state.CareerInfo or {}
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						if state.AddFeed then
							state:AddFeed("ğŸ¯ Good instincts! You found illegal items. One more arrest on your record!")
						end
					elseif outcome < 0.7 then
						-- Nothing found
						if state.AddFeed then
							state:AddFeed("ğŸ” Search came up clean. False alarm.")
						end
					else
						-- Complaint filed
						state.Flags = state.Flags or {}
						state.Flags.complaint_filed = true
						if state.AddFeed then
							state:AddFeed("ğŸ˜¤ Driver filed a complaint. Internal Affairs wants to talk...")
						end
					end
				end,
			},
			{
				index = 3,
				text = "Let them off with a warning",
				effects = { Happiness = 5, Health = 1 },
				feedText = "You gave them a warning. Sometimes mercy matters.",
			},
		},
	},
	
	{
		id = "domestic_disturbance",
		emoji = "ğŸ ",
		title = "Domestic Disturbance Call",
		text = "Dispatch sends you to a home where neighbors reported yelling and breaking glass. These calls are always unpredictable.",
		question = "How do you approach?",
		category = "career_police",
		weight = 7,
		minAge = 21,
		maxAge = 55,
		baseChance = 0.5,
		cooldown = 3,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "Wait for backup before approaching",
				effects = { Happiness = 2, Smarts = 2 },
				feedText = "You waited for backup. Smart and safe.",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					if outcome < 0.5 then
						if state.AddFeed then
							state:AddFeed("ğŸ¤ With backup, you de-escalated the situation safely. Everyone went home.")
						end
					else
						state.CareerInfo = state.CareerInfo or {}
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						if state.AddFeed then
							state:AddFeed("ğŸš” Made an arrest for domestic violence. You helped protect someone.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Go in immediately - someone might be in danger",
				effects = { Happiness = 3 },
				feedText = "You rushed in to help...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					if outcome < 0.3 then
						-- Heroic outcome
						state.CareerInfo = state.CareerInfo or {}
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						state.Flags = state.Flags or {}
						state.Flags.hero_cop = true
						if state.AddFeed then
							state:AddFeed("ğŸ¦¸ You saved someone's life! Department commendation incoming.")
						end
					elseif outcome < 0.6 then
						-- Situation resolved
						if state.AddFeed then
							state:AddFeed("âœ… You calmed things down. Just a heated argument.")
						end
					else
						-- Got hurt
						if state.ModifyStat then
							state:ModifyStat("Health", RANDOM:NextInteger(-15, -5))
						end
						if state.AddFeed then
							state:AddFeed("ğŸ¤• Things got physical. You got hurt but subdued the aggressor.")
						end
					end
				end,
			},
			{
				index = 3,
				text = "Call a social worker to accompany you",
				effects = { Happiness = 5, Smarts = 3 },
				feedText = "You called for specialized support.",
				onResolve = function(state)
					if state.AddFeed then
						state:AddFeed("ğŸ’™ The social worker de-escalated beautifully. Modern policing at its best.")
					end
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- CORRUPTION / ETHICS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "bribe_offered",
		emoji = "ğŸ’°",
		title = "Bribe Offer",
		text = "During a traffic stop, the driver opens their wallet and you see stacks of cash. 'Officer, maybe we can work something out? $5,000, no questions asked.'",
		question = "What do you do?",
		category = "career_police",
		weight = 5,
		minAge = 21,
		maxAge = 60,
		baseChance = 0.45,
		cooldown = 4,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "Arrest them for attempting to bribe an officer",
				effects = { Happiness = 8, Smarts = 5 },
				feedText = "You arrested them for bribery!",
				onResolve = function(state)
					state.CareerInfo = state.CareerInfo or {}
					state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
					state.Flags = state.Flags or {}
					state.Flags.honest_cop = true
					if state.AddFeed then
						state:AddFeed("âš–ï¸ You did the right thing. The department commended your integrity.")
					end
				end,
			},
			{
				index = 2,
				text = "Take the money and let them go",
				effects = { Happiness = -3, Money = 5000 },
				setFlags = { corrupt_cop = true, dirty = true },
				feedText = "You took the bribe...",
				onResolve = function(state)
					if RANDOM:NextNumber() < 0.2 then
						-- Internal affairs was watching
						state.Flags.under_investigation = true
						if state.AddFeed then
							state:AddFeed("ğŸ˜° Someone was watching. Internal Affairs wants to see you...")
						end
					end
				end,
			},
			{
				index = 3,
				text = "Let them off with a warning - no money involved",
				effects = { Happiness = 2 },
				feedText = "You let them go. Maybe mercy, maybe avoiding a situation.",
			},
		},
	},
	
	{
		id = "internal_affairs_investigation",
		emoji = "ğŸ”",
		title = "Internal Affairs Investigation",
		text = "Internal Affairs has called you in for questioning. They're investigating complaints against you. Your career could be on the line.",
		question = "How do you handle this?",
		category = "career_police",
		weight = 6,
		minAge = 22,
		maxAge = 60,
		baseChance = 0.4,
		cooldown = 5,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		requiresFlags = { complaint_filed = true },
		blockedByFlags = { in_prison = true, cleared_by_ia = true },
		
		choices = {
			{
				index = 1,
				text = "Cooperate fully - I have nothing to hide",
				effects = { Happiness = 5 },
				feedText = "You cooperated with the investigation...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					local corrupt = state.Flags and state.Flags.corrupt_cop
					if corrupt then
						if outcome < 0.5 then
							-- They found evidence
							state.CurrentJob = nil
							state.Flags.fired_from_police = true
							state.Flags.disgraced = true
							if state.AddFeed then
								state:AddFeed("ğŸ‘®â€â™‚ï¸âŒ They found evidence of corruption. You've been fired from the force.")
							end
						else
							-- Covered your tracks
							state.Flags.cleared_by_ia = true
							if state.AddFeed then
								state:AddFeed("ğŸ˜… Insufficient evidence. You're cleared... this time.")
							end
						end
					else
						state.Flags.cleared_by_ia = true
						state.Flags.complaint_filed = nil
						if state.AddFeed then
							state:AddFeed("âœ… Investigation cleared you completely! Your record is clean.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Get a union lawyer immediately",
				-- CRITICAL FIX: Validate money before hiring lawyer
				effects = {}, -- Money handled in onResolve
				feedText = "Looking for a lawyer...",
				onResolve = function(state)
					local money = state.Money or 0
					local lawyerCost = 2000
					
					if money >= lawyerCost then
						state.Money = money - lawyerCost
						state.Flags = state.Flags or {}
						state.Flags.cleared_by_ia = true
						state.Flags.complaint_filed = nil
						if state.AddFeed then
							state:AddFeed("âš–ï¸ Your lawyer ($2000) got the investigation dropped. Worth it.")
						end
					elseif money >= 500 then
						-- Budget lawyer - less effective
						state.Money = money - 500
						local roll = math.random()
						if roll < 0.6 then
							state.Flags = state.Flags or {}
							state.Flags.cleared_by_ia = true
							state.Flags.complaint_filed = nil
							if state.AddFeed then
								state:AddFeed("âš–ï¸ Budget lawyer ($500) managed to help. Close call.")
							end
						else
							if state.AddFeed then
								state:AddFeed("âš–ï¸ Budget lawyer wasn't enough. Investigation continues...")
							end
						end
					else
						-- Can't afford lawyer - represent yourself
						local roll = math.random()
						if roll < 0.3 then
							state.Flags = state.Flags or {}
							state.Flags.cleared_by_ia = true
							state.Flags.complaint_filed = nil
							if state.AddFeed then
								state:AddFeed("âš–ï¸ Represented yourself and got lucky! Cleared.")
							end
						else
							if state.ModifyStat then state:ModifyStat("Happiness", -5) end
							if state.AddFeed then
								state:AddFeed("âš–ï¸ Can't afford a lawyer. Going in alone...")
							end
						end
					end
				end,
			},
			{
				index = 3,
				text = "Resign before they can fire you",
				effects = { Happiness = -10 },
				feedText = "You resigned from the force.",
				onResolve = function(state)
					state.CurrentJob = nil
					state.Flags.former_cop = true
					if state.AddFeed then
						state:AddFeed("ğŸš¶ You left the force on your own terms. Time for a new chapter.")
					end
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- CAREER ADVANCEMENT
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "detective_promotion",
		emoji = "ğŸ•µï¸",
		title = "Detective Exam",
		text = "You've been on the force for years. The detective exam is coming up. This could be your chance to move up.",
		question = "What do you do?",
		category = "career_police",
		weight = 5,
		minAge = 26,
		maxAge = 50,
		baseChance = 0.55,
		cooldown = 6,
		oneTime = true,
		blockedByFlags = { detective = true, in_prison = true },
		-- CRITICAL FIX: Combined both eligibility checks into one function
		-- Previously had DUPLICATE eligibility keys - second one was overwriting first!
		eligibility = function(state)
			-- Must be a police officer
			if not isPoliceJob(state) then return false end
			-- Must have some arrest experience
			local arrests = state.CareerInfo and state.CareerInfo.arrests or 0
			return arrests >= 5
		end,
		
		choices = {
			{
				index = 1,
				text = "Study hard and take the exam",
				effects = { Happiness = 5, Smarts = 3 },
				feedText = "You prepared for the detective exam...",
				onResolve = function(state)
					local smarts = state.Stats and state.Stats.Smarts or 50
					local passChance = 0.4 + (smarts / 200) -- 40-90% based on smarts
					
					if RANDOM:NextNumber() < passChance then
						state.Flags = state.Flags or {}
						state.Flags.detective = true
						if state.CurrentJob then
							state.CurrentJob.name = "Detective"
							state.CurrentJob.salary = (state.CurrentJob.salary or 50000) * 1.4
						end
						if state.AddFeed then
							state:AddFeed("ğŸ‰ You passed! You're now Detective " .. (state.Name or "Unknown") .. "!")
						end
					else
						if state.AddFeed then
							state:AddFeed("ğŸ˜” You didn't pass this time. Maybe next year.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Not ready yet - stay on patrol",
				effects = { Happiness = 2 },
				feedText = "You decided to wait. More street experience first.",
			},
		},
	},
	
	{
		id = "sergeant_promotion",
		emoji = "â­",
		title = "Sergeant Position Open",
		text = "A sergeant position has opened up in your precinct. Your captain thinks you'd be a good fit for a leadership role.",
		question = "Do you go for it?",
		category = "career_police",
		weight = 4,
		minAge = 30,
		maxAge = 55,
		baseChance = 0.455,
		cooldown = 7,
		oneTime = true,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { sergeant = true, in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "Apply for the promotion",
				effects = { Happiness = 5 },
				feedText = "You applied for sergeant...",
				onResolve = function(state)
					local honest = state.Flags and state.Flags.honest_cop
					local heroic = state.Flags and state.Flags.hero_cop
					local corrupt = state.Flags and state.Flags.corrupt_cop
					
					local baseChance = 0.5
					if honest then baseChance = baseChance + 0.2 end
					if heroic then baseChance = baseChance + 0.2 end
					if corrupt then baseChance = baseChance - 0.3 end
					
					if RANDOM:NextNumber() < baseChance then
						state.Flags = state.Flags or {}
						state.Flags.sergeant = true
						if state.CurrentJob then
							state.CurrentJob.name = "Sergeant"
							state.CurrentJob.salary = (state.CurrentJob.salary or 60000) * 1.3
						end
						if state.AddFeed then
							state:AddFeed("â­ Congratulations, Sergeant! You're now leading a team.")
						end
					else
						if state.AddFeed then
							state:AddFeed("ğŸ˜” Someone else got the position. Keep working hard.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Stay on the streets - I like the action",
				effects = { Happiness = 5 },
				feedText = "You prefer being in the field. Leadership isn't for everyone.",
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- DANGEROUS SITUATIONS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "active_shooter",
		emoji = "âš ï¸",
		title = "Active Shooter Situation",
		text = "Dispatch reports an active shooter at a public location. You're the closest unit. Lives are at stake.",
		question = "What do you do?",
		category = "career_police",
		weight = 4,
		minAge = 21,
		maxAge = 55,
		baseChance = 0.4,
		cooldown = 30,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "âš¡ RUSH IN - Stop the threat!",
				effects = {},
				feedText = "You charged into danger...",
				-- CRITICAL FIX: QTE minigame for intense police action!
				triggerMinigame = "qte",
				minigameOptions = { difficulty = "hard" },
				onResolve = function(state, minigameResult)
					local won = minigameResult and (minigameResult.success or minigameResult.won)
					state.Flags = state.Flags or {}
					
					if won then
						-- HERO - You stopped the shooter!
						state.Flags.hero_cop = true
						state.Flags.medal_of_valor = true
						state:ModifyStat("Happiness", 20)
						state:ModifyStat("Health", -5)
						state:AddFeed("âš¡ğŸ¦¸ You NEUTRALIZED the threat! Lives SAVED! MEDAL OF VALOR! You're a LEGEND!")
					else
						-- Injured trying to help
						state.Flags.wounded_in_line = true
						state:ModifyStat("Health", -30)
						state:ModifyStat("Happiness", -5)
						state:AddFeed("âš¡ğŸ¥ You were shot while rushing in. Survived, but badly wounded. A hero regardless.")
					end
				end,
			},
			{
				index = 2,
				text = "Wait for SWAT - follow protocol",
				effects = { Happiness = -5, Smarts = 3 },
				feedText = "You waited for specialized units...",
				onResolve = function(state)
					if RANDOM:NextNumber() < 0.3 then
						-- More casualties while waiting
						state.Flags = state.Flags or {}
						state.Flags.ptsd_trauma = true
						if state.AddFeed then
							state:AddFeed("ğŸ’” More people were hurt while you waited. Could you have done more?")
						end
						if state.ModifyStat then
							state:ModifyStat("Happiness", -10)
						end
					else
						if state.AddFeed then
							state:AddFeed("âœ… SWAT handled it professionally. Right call to wait.")
						end
					end
				end,
			},
			{
				index = 3,
				text = "Coordinate evacuation - save who you can",
				effects = { Happiness = 5, Smarts = 5 },
				feedText = "You focused on getting people to safety.",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.saved_civilians = true
					if state.AddFeed then
						state:AddFeed("ğŸš¨ You evacuated dozens of people to safety. Well done.")
					end
				end,
			},
		},
	},
	
	{
		id = "partner_in_danger",
		emoji = "ğŸ‘®",
		title = "Partner in Danger",
		text = "Your partner radioed for help - they're pinned down by gunfire during a pursuit. Backup is minutes away.",
		question = "What do you do?",
		category = "career_police",
		weight = 5,
		minAge = 21,
		maxAge = 55,
		baseChance = 0.45,
		cooldown = 5,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "Go in alone - my partner needs me NOW",
				effects = { Happiness = 5 },
				feedText = "You rushed to help your partner...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					if outcome < 0.5 then
						-- Both survive
						state.Flags = state.Flags or {}
						state.Flags.loyal_partner = true
						if state.AddFeed then
							state:AddFeed("ğŸ’ª You saved your partner! Brothers in blue forever.")
						end
					elseif outcome < 0.8 then
						-- You get hurt
						if state.ModifyStat then
							state:ModifyStat("Health", RANDOM:NextInteger(-20, -10))
						end
						if state.AddFeed then
							state:AddFeed("ğŸ¤• You got shot but your partner is alive. Worth it.")
						end
					else
						-- Both survive but close call
						if state.AddFeed then
							state:AddFeed("ğŸ˜° Bullets everywhere but you both made it. Close one.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Wait for backup - we need numbers",
				effects = { Happiness = -5 },
				feedText = "You waited for backup...",
				onResolve = function(state)
					if RANDOM:NextNumber() < 0.3 then
						-- Partner wounded
						state.Flags = state.Flags or {}
						state.Flags.partner_wounded = true
						if state.AddFeed then
							state:AddFeed("ğŸ˜” Your partner was hurt waiting for backup. They survived but...")
						end
					else
						if state.AddFeed then
							state:AddFeed("âœ… Backup arrived in time. Everyone's okay.")
						end
					end
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- RETIREMENT / END GAME
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "police_retirement",
		emoji = "ğŸ–ï¸",
		title = "Retirement from the Force",
		text = "After decades on the force, it's time to hang up the badge. You've seen a lot. Done a lot. Time to rest.",
		question = "How do you feel about retirement?",
		category = "career_police",
		weight = 5,
		minAge = 50,
		maxAge = 65,
		baseChance = 0.5,
		cooldown = 6,
		oneTime = true,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { retired_cop = true, in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "Full pension - I've earned it",
				effects = { Happiness = 15, Health = 5 },
				setFlags = { retired_cop = true },
				feedText = "You retired with full honors and pension.",
				onResolve = function(state)
					state.CurrentJob = nil
					state.Flags = state.Flags or {}
					state.Flags.retired = true
					state.Flags.pension = true
					-- Set up pension income
					state.CareerInfo = state.CareerInfo or {}
					state.CareerInfo.pensionAmount = 4000 -- Monthly pension
					if state.AddFeed then
						state:AddFeed("ğŸ‘®â€â™‚ï¸ Thank you for your service. Enjoy retirement!")
					end
				end,
			},
			{
				index = 2,
				text = "Stay on as a desk officer",
				effects = { Happiness = 5 },
				feedText = "You moved to a desk position. Lighter duties, still on the job.",
			},
			{
				index = 3,
				text = "Become a private investigator",
				effects = { Happiness = 10 },
				feedText = "You opened your own PI business. Still solving cases.",
				onResolve = function(state)
					state.CurrentJob = nil
					state.Flags = state.Flags or {}
					state.Flags.private_investigator = true
					if state.AddFeed then
						state:AddFeed("ğŸ” You're now a private investigator. Same skills, new rules.")
					end
				end,
			},
		},
	},
}

return events
