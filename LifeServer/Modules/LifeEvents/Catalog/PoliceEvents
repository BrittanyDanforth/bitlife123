--[[
	PoliceEvents.lua
	
	Career events for Law Enforcement careers (Police Officer, Detective, etc.)
	
	Features:
	- Daily patrol encounters
	- Crime investigations
	- Corruption temptations
	- Career advancement to detective/sergeant
	- Internal affairs investigations
	- Dangerous situations
	
	CRITICAL FIX #RVS-9: Premium path blocking for mafia players
]]

local RANDOM = Random.new()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CRITICAL FIX #RVS-POLICE-1: Premium path blocking
-- Police events should NEVER fire for mafia players (obvious conflict of interest!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function isBlockedByMafiaPath(state)
	if not state.Flags then return false end
	local flags = state.Flags
	
	-- Block if player is in mafia
	if flags.primary_wish_type == "mafia" then return true end
	if flags.in_mob or flags.mafia_member then return true end
	if state.MobState and state.MobState.inMob then return true end
	
	-- Also block if player has serious criminal record (can't be cop with felonies)
	if flags.criminal_record and flags.violent_crime then return true end
	
	return false
end

-- CRITICAL FIX: Police job IDs for eligibility checks
-- eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category doesn't work because police jobs use "government" category
local POLICE_JOB_IDS = {
	police_officer = true,
	detective = true,
	police_chief = true,
	probation_officer = true,
	fbi_agent = true,
	cia_agent = true,
}

local function isPoliceJob(state)
	-- CRITICAL FIX #RVS-POLICE-2: Check mafia path blocking first
	if isBlockedByMafiaPath(state) then return false end
	if not state.CurrentJob then return false end
	local jobId = state.CurrentJob.id or state.CurrentJob
	return POLICE_JOB_IDS[jobId] == true
end

local events = {
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- DAILY PATROL EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "routine_traffic_stop",
		emoji = "ğŸš”",
		title = "Routine Traffic Stop",
		text = "You pull over a vehicle for speeding. The driver seems nervous. Something feels off.",
		question = "How do you proceed?",
		category = "career_police",
		weight = 8,
		minAge = 21,
		maxAge = 60,
		baseChance = 0.6,
		cooldown = 4, -- CRITICAL FIX: Increased from 2 to reduce spam
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { in_prison = true, suspended = true },
		
		choices = {
			{
				index = 1,
				text = "By the book - just write the ticket",
				effects = { Happiness = 2 },
				feedText = "You wrote the ticket and let them go.",
				onResolve = function(state)
					if RANDOM:NextNumber() < 0.1 then
						-- The car was actually carrying something illegal
						if state.AddFeed then
							state:AddFeed("ğŸ’­ Later you heard that driver was arrested in another county with contraband. Should've searched...")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Request backup and search the vehicle",
				effects = { Happiness = 3 },
				feedText = "You called for backup...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					if outcome < 0.4 then
						-- Find something
						state.CareerInfo = state.CareerInfo or {}
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						if state.AddFeed then
							state:AddFeed("ğŸ¯ Good instincts! You found illegal items. One more arrest on your record!")
						end
					elseif outcome < 0.7 then
						-- Nothing found
						if state.AddFeed then
							state:AddFeed("ğŸ” Search came up clean. False alarm.")
						end
					else
						-- Complaint filed
						state.Flags = state.Flags or {}
						state.Flags.complaint_filed = true
						if state.AddFeed then
							state:AddFeed("ğŸ˜¤ Driver filed a complaint. Internal Affairs wants to talk...")
						end
					end
				end,
			},
			{
				index = 3,
				text = "Let them off with a warning",
				effects = { Happiness = 5, Health = 1 },
				feedText = "You gave them a warning. Sometimes mercy matters.",
			},
		},
	},
	
	{
		id = "domestic_disturbance",
		emoji = "ğŸ ",
		title = "Domestic Disturbance Call",
		text = "Dispatch sends you to a home where neighbors reported yelling and breaking glass. These calls are always unpredictable.",
		question = "How do you approach?",
		category = "career_police",
		weight = 7,
		minAge = 21,
		maxAge = 55,
		baseChance = 0.5,
		cooldown = 3,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "Wait for backup before approaching",
				effects = { Happiness = 2, Smarts = 2 },
				feedText = "You waited for backup. Smart and safe.",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					if outcome < 0.5 then
						if state.AddFeed then
							state:AddFeed("ğŸ¤ With backup, you de-escalated the situation safely. Everyone went home.")
						end
					else
						state.CareerInfo = state.CareerInfo or {}
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						if state.AddFeed then
							state:AddFeed("ğŸš” Made an arrest for domestic violence. You helped protect someone.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Go in immediately - someone might be in danger",
				effects = { Happiness = 3 },
				feedText = "You rushed in to help...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					if outcome < 0.3 then
						-- Heroic outcome
						state.CareerInfo = state.CareerInfo or {}
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						state.Flags = state.Flags or {}
						state.Flags.hero_cop = true
						if state.AddFeed then
							state:AddFeed("ğŸ¦¸ You saved someone's life! Department commendation incoming.")
						end
					elseif outcome < 0.6 then
						-- Situation resolved
						if state.AddFeed then
							state:AddFeed("âœ… You calmed things down. Just a heated argument.")
						end
					else
						-- Got hurt
						if state.ModifyStat then
							state:ModifyStat("Health", RANDOM:NextInteger(-15, -5))
						end
						if state.AddFeed then
							state:AddFeed("ğŸ¤• Things got physical. You got hurt but subdued the aggressor.")
						end
					end
				end,
			},
			{
				index = 3,
				text = "Call a social worker to accompany you",
				effects = { Happiness = 5, Smarts = 3 },
				feedText = "You called for specialized support.",
				onResolve = function(state)
					if state.AddFeed then
						state:AddFeed("ğŸ’™ The social worker de-escalated beautifully. Modern policing at its best.")
					end
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- CORRUPTION / ETHICS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "bribe_offered",
		emoji = "ğŸ’°",
		title = "Bribe Offer",
		text = "During a traffic stop, the driver opens their wallet and you see stacks of cash. 'Officer, maybe we can work something out? $5,000, no questions asked.'",
		question = "What do you do?",
		category = "career_police",
		weight = 5,
		minAge = 21,
		maxAge = 60,
		baseChance = 0.45,
		cooldown = 4,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "Arrest them for attempting to bribe an officer",
				effects = { Happiness = 8, Smarts = 5 },
				feedText = "You arrested them for bribery!",
				onResolve = function(state)
					state.CareerInfo = state.CareerInfo or {}
					state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
					state.Flags = state.Flags or {}
					state.Flags.honest_cop = true
					if state.AddFeed then
						state:AddFeed("âš–ï¸ You did the right thing. The department commended your integrity.")
					end
				end,
			},
			{
				index = 2,
				text = "Take the money and let them go",
				effects = { Happiness = -3, Money = 5000 },
				setFlags = { corrupt_cop = true, dirty = true },
				feedText = "You took the bribe...",
				onResolve = function(state)
					if RANDOM:NextNumber() < 0.2 then
						-- Internal affairs was watching
						state.Flags.under_investigation = true
						if state.AddFeed then
							state:AddFeed("ğŸ˜° Someone was watching. Internal Affairs wants to see you...")
						end
					end
				end,
			},
			{
				index = 3,
				text = "Let them off with a warning - no money involved",
				effects = { Happiness = 2 },
				feedText = "You let them go. Maybe mercy, maybe avoiding a situation.",
			},
		},
	},
	
	{
		id = "internal_affairs_investigation",
		emoji = "ğŸ”",
		title = "Internal Affairs Investigation",
		text = "Internal Affairs has called you in for questioning. They're investigating complaints against you. Your career could be on the line.",
		question = "How do you handle this?",
		category = "career_police",
		weight = 6,
		minAge = 22,
		maxAge = 60,
		baseChance = 0.4,
		cooldown = 5,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		requiresFlags = { complaint_filed = true },
		blockedByFlags = { in_prison = true, cleared_by_ia = true },
		
		choices = {
			{
				index = 1,
				text = "Cooperate fully - I have nothing to hide",
				effects = { Happiness = 5 },
				feedText = "You cooperated with the investigation...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					local corrupt = state.Flags and state.Flags.corrupt_cop
					if corrupt then
						if outcome < 0.5 then
							-- They found evidence
							state.CurrentJob = nil
							state.Flags.fired_from_police = true
							state.Flags.disgraced = true
							if state.AddFeed then
								state:AddFeed("ğŸ‘®â€â™‚ï¸âŒ They found evidence of corruption. You've been fired from the force.")
							end
						else
							-- Covered your tracks
							state.Flags.cleared_by_ia = true
							if state.AddFeed then
								state:AddFeed("ğŸ˜… Insufficient evidence. You're cleared... this time.")
							end
						end
					else
						state.Flags.cleared_by_ia = true
						state.Flags.complaint_filed = nil
						if state.AddFeed then
							state:AddFeed("âœ… Investigation cleared you completely! Your record is clean.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Get a union lawyer immediately",
				-- CRITICAL FIX: Validate money before hiring lawyer
				effects = {}, -- Money handled in onResolve
				feedText = "Looking for a lawyer...",
				onResolve = function(state)
					local money = state.Money or 0
					local lawyerCost = 2000
					
					if money >= lawyerCost then
						state.Money = money - lawyerCost
						state.Flags = state.Flags or {}
						state.Flags.cleared_by_ia = true
						state.Flags.complaint_filed = nil
						if state.AddFeed then
							state:AddFeed("âš–ï¸ Your lawyer ($2000) got the investigation dropped. Worth it.")
						end
					elseif money >= 500 then
						-- Budget lawyer - less effective
						state.Money = money - 500
						local roll = math.random()
						if roll < 0.6 then
							state.Flags = state.Flags or {}
							state.Flags.cleared_by_ia = true
							state.Flags.complaint_filed = nil
							if state.AddFeed then
								state:AddFeed("âš–ï¸ Budget lawyer ($500) managed to help. Close call.")
							end
						else
							if state.AddFeed then
								state:AddFeed("âš–ï¸ Budget lawyer wasn't enough. Investigation continues...")
							end
						end
					else
						-- Can't afford lawyer - represent yourself
						local roll = math.random()
						if roll < 0.3 then
							state.Flags = state.Flags or {}
							state.Flags.cleared_by_ia = true
							state.Flags.complaint_filed = nil
							if state.AddFeed then
								state:AddFeed("âš–ï¸ Represented yourself and got lucky! Cleared.")
							end
						else
							if state.ModifyStat then state:ModifyStat("Happiness", -5) end
							if state.AddFeed then
								state:AddFeed("âš–ï¸ Can't afford a lawyer. Going in alone...")
							end
						end
					end
				end,
			},
			{
				index = 3,
				text = "Resign before they can fire you",
				effects = { Happiness = -10 },
				feedText = "You resigned from the force.",
				onResolve = function(state)
					state.CurrentJob = nil
					state.Flags.former_cop = true
					if state.AddFeed then
						state:AddFeed("ğŸš¶ You left the force on your own terms. Time for a new chapter.")
					end
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- CAREER ADVANCEMENT
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "detective_promotion",
		emoji = "ğŸ•µï¸",
		title = "Detective Exam",
		text = "You've been on the force for years. The detective exam is coming up. This could be your chance to move up.",
		question = "What do you do?",
		category = "career_police",
		weight = 5,
		minAge = 26,
		maxAge = 50,
		baseChance = 0.55,
		cooldown = 6,
		oneTime = true,
		blockedByFlags = { detective = true, in_prison = true },
		-- CRITICAL FIX: Combined both eligibility checks into one function
		-- Previously had DUPLICATE eligibility keys - second one was overwriting first!
		eligibility = function(state)
			-- Must be a police officer
			if not isPoliceJob(state) then return false end
			-- Must have some arrest experience
			local arrests = state.CareerInfo and state.CareerInfo.arrests or 0
			return arrests >= 5
		end,
		
		choices = {
			{
				index = 1,
				text = "Study hard and take the exam",
				effects = { Happiness = 5, Smarts = 3 },
				feedText = "You prepared for the detective exam...",
				onResolve = function(state)
					local smarts = state.Stats and state.Stats.Smarts or 50
					local passChance = 0.4 + (smarts / 200) -- 40-90% based on smarts
					
					if RANDOM:NextNumber() < passChance then
						state.Flags = state.Flags or {}
						state.Flags.detective = true
						if state.CurrentJob then
							state.CurrentJob.name = "Detective"
							state.CurrentJob.salary = (state.CurrentJob.salary or 50000) * 1.4
						end
						if state.AddFeed then
							state:AddFeed("ğŸ‰ You passed! You're now Detective " .. (state.Name or "Unknown") .. "!")
						end
					else
						if state.AddFeed then
							state:AddFeed("ğŸ˜” You didn't pass this time. Maybe next year.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Not ready yet - stay on patrol",
				effects = { Happiness = 2 },
				feedText = "You decided to wait. More street experience first.",
			},
		},
	},
	
	{
		id = "sergeant_promotion",
		emoji = "â­",
		title = "Sergeant Position Open",
		text = "A sergeant position has opened up in your precinct. Your captain thinks you'd be a good fit for a leadership role.",
		question = "Do you go for it?",
		category = "career_police",
		weight = 4,
		minAge = 30,
		maxAge = 55,
		baseChance = 0.455,
		cooldown = 7,
		oneTime = true,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { sergeant = true, in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "Apply for the promotion",
				effects = { Happiness = 5 },
				feedText = "You applied for sergeant...",
				onResolve = function(state)
					local honest = state.Flags and state.Flags.honest_cop
					local heroic = state.Flags and state.Flags.hero_cop
					local corrupt = state.Flags and state.Flags.corrupt_cop
					
					local baseChance = 0.5
					if honest then baseChance = baseChance + 0.2 end
					if heroic then baseChance = baseChance + 0.2 end
					if corrupt then baseChance = baseChance - 0.3 end
					
					if RANDOM:NextNumber() < baseChance then
						state.Flags = state.Flags or {}
						state.Flags.sergeant = true
						if state.CurrentJob then
							state.CurrentJob.name = "Sergeant"
							state.CurrentJob.salary = (state.CurrentJob.salary or 60000) * 1.3
						end
						if state.AddFeed then
							state:AddFeed("â­ Congratulations, Sergeant! You're now leading a team.")
						end
					else
						if state.AddFeed then
							state:AddFeed("ğŸ˜” Someone else got the position. Keep working hard.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Stay on the streets - I like the action",
				effects = { Happiness = 5 },
				feedText = "You prefer being in the field. Leadership isn't for everyone.",
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- DANGEROUS SITUATIONS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "active_shooter",
		emoji = "âš ï¸",
		title = "Active Shooter Situation",
		text = "Dispatch reports an active shooter at a public location. You're the closest unit. Lives are at stake.",
		question = "What do you do?",
		category = "career_police",
		weight = 4,
		minAge = 21,
		maxAge = 55,
		baseChance = 0.4,
		cooldown = 30,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "âš¡ RUSH IN - Stop the threat!",
				effects = {},
				feedText = "You charged into danger...",
				-- CRITICAL FIX: QTE minigame for intense police action!
				triggerMinigame = "qte",
				minigameOptions = { difficulty = "hard" },
				onResolve = function(state, minigameResult)
					local won = minigameResult and (minigameResult.success or minigameResult.won)
					state.Flags = state.Flags or {}
					
					if won then
						-- HERO - You stopped the shooter!
						state.Flags.hero_cop = true
						state.Flags.medal_of_valor = true
						state:ModifyStat("Happiness", 20)
						state:ModifyStat("Health", -5)
						state:AddFeed("âš¡ğŸ¦¸ You NEUTRALIZED the threat! Lives SAVED! MEDAL OF VALOR! You're a LEGEND!")
					else
						-- Injured trying to help
						state.Flags.wounded_in_line = true
						state:ModifyStat("Health", -30)
						state:ModifyStat("Happiness", -5)
						state:AddFeed("âš¡ğŸ¥ You were shot while rushing in. Survived, but badly wounded. A hero regardless.")
					end
				end,
			},
			{
				index = 2,
				text = "Wait for SWAT - follow protocol",
				effects = { Happiness = -5, Smarts = 3 },
				feedText = "You waited for specialized units...",
				onResolve = function(state)
					if RANDOM:NextNumber() < 0.3 then
						-- More casualties while waiting
						state.Flags = state.Flags or {}
						state.Flags.ptsd_trauma = true
						if state.AddFeed then
							state:AddFeed("ğŸ’” More people were hurt while you waited. Could you have done more?")
						end
						if state.ModifyStat then
							state:ModifyStat("Happiness", -10)
						end
					else
						if state.AddFeed then
							state:AddFeed("âœ… SWAT handled it professionally. Right call to wait.")
						end
					end
				end,
			},
			{
				index = 3,
				text = "Coordinate evacuation - save who you can",
				effects = { Happiness = 5, Smarts = 5 },
				feedText = "You focused on getting people to safety.",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.saved_civilians = true
					if state.AddFeed then
						state:AddFeed("ğŸš¨ You evacuated dozens of people to safety. Well done.")
					end
				end,
			},
		},
	},
	
	{
		id = "partner_in_danger",
		emoji = "ğŸ‘®",
		title = "Partner in Danger",
		text = "Your partner radioed for help - they're pinned down by gunfire during a pursuit. Backup is minutes away.",
		question = "What do you do?",
		category = "career_police",
		weight = 5,
		minAge = 21,
		maxAge = 55,
		baseChance = 0.45,
		cooldown = 5,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "Go in alone - my partner needs me NOW",
				effects = { Happiness = 5 },
				feedText = "You rushed to help your partner...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					if outcome < 0.5 then
						-- Both survive
						state.Flags = state.Flags or {}
						state.Flags.loyal_partner = true
						if state.AddFeed then
							state:AddFeed("ğŸ’ª You saved your partner! Brothers in blue forever.")
						end
					elseif outcome < 0.8 then
						-- You get hurt
						if state.ModifyStat then
							state:ModifyStat("Health", RANDOM:NextInteger(-20, -10))
						end
						if state.AddFeed then
							state:AddFeed("ğŸ¤• You got shot but your partner is alive. Worth it.")
						end
					else
						-- Both survive but close call
						if state.AddFeed then
							state:AddFeed("ğŸ˜° Bullets everywhere but you both made it. Close one.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Wait for backup - we need numbers",
				effects = { Happiness = -5 },
				feedText = "You waited for backup...",
				onResolve = function(state)
					if RANDOM:NextNumber() < 0.3 then
						-- Partner wounded
						state.Flags = state.Flags or {}
						state.Flags.partner_wounded = true
						if state.AddFeed then
							state:AddFeed("ğŸ˜” Your partner was hurt waiting for backup. They survived but...")
						end
					else
						if state.AddFeed then
							state:AddFeed("âœ… Backup arrived in time. Everyone's okay.")
						end
					end
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- RETIREMENT / END GAME
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- HOUSE RAID MISSIONS - Interactive raid system for cops
	-- Like a mini-mission where you lead a team to raid a location
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "house_raid_mission",
		emoji = "ğŸš¨",
		title = "ğŸš¨ RAID OPERATION",
		text = "Intel came in about an armed suspect holed up in a house. Multiple weapons reported inside. SWAT is tied up on another call - your unit is going in. This is your moment. The team is ready, waiting on your command.",
		question = "How do you want to approach this raid?",
		category = "career_police",
		weight = 10,
		minAge = 22,
		maxAge = 55,
		baseChance = 0.45,
		cooldown = 4, -- CRITICAL FIX: Increased from 2 to reduce spam
		priority = "high",
		isMilestone = true,
		eligibility = function(state)
			if isBlockedByMafiaPath(state) then return false end
			if not isPoliceJob(state) then return false end
			-- Must have been on the force for at least 1 year
			local yearsWorked = (state.CareerInfo and state.CareerInfo.yearsAtJob) or 0
			return yearsWorked >= 1
		end,
		blockedByFlags = { in_prison = true, suspended = true, on_leave = true },
		
		choices = {
			{
				index = 1,
				text = "ğŸšª Dynamic entry - breach the front door",
				effects = { Happiness = 5 },
				feedText = "BREACH! BREACH! BREACH!",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					state.CareerInfo = state.CareerInfo or {}
					state.Flags = state.Flags or {}
					
					if outcome < 0.35 then
						-- Perfect raid - suspect surrenders
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						state.CareerInfo.raidSuccesses = (state.CareerInfo.raidSuccesses or 0) + 1
						state.Flags.successful_raid = true
						state:ModifyStat("Happiness", 20)
						state.Money = (state.Money or 0) + 2000 -- Bonus pay
						state:AddFeed("ğŸ¯ PERFECT EXECUTION! Suspect surrendered immediately! Weapons seized, no shots fired. The Captain is impressed!")
					elseif outcome < 0.65 then
						-- Firefight but successful
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						state.CareerInfo.raidSuccesses = (state.CareerInfo.raidSuccesses or 0) + 1
						state.Flags.raid_veteran = true
						state:ModifyStat("Happiness", 10)
						state:ModifyStat("Health", -10)
						state.Money = (state.Money or 0) + 1500
						state:AddFeed("ğŸ’¥ Firefight! Suspect opened fire but your team returned fire and secured him. Minor injuries on your side. Arsenal of weapons recovered!")
					elseif outcome < 0.85 then
						-- Suspect escapes
						state:ModifyStat("Happiness", -5)
						state.Flags.suspect_escaped = true
						state:AddFeed("ğŸƒ Suspect fled through a back window! He's in the wind. Captain is NOT happy. Better luck next time.")
					else
						-- Officer wounded
						state.Flags.wounded_in_raid = true
						state:ModifyStat("Health", -25)
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ©¹ Shot in the shoulder during entry! Suspect in custody but you're heading to the hospital. Line of duty injury.")
					end
				end,
			},
			{
				index = 2,
				text = "ğŸªŸ Surround first - cover all exits",
				effects = { Happiness = 3, Smarts = 3 },
				feedText = "Setting up a perimeter...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					state.CareerInfo = state.CareerInfo or {}
					state.Flags = state.Flags or {}
					
					if outcome < 0.45 then
						-- Tactical success
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						state.CareerInfo.raidSuccesses = (state.CareerInfo.raidSuccesses or 0) + 1
						state.Flags.tactical_officer = true
						state:ModifyStat("Happiness", 15)
						state:ModifyStat("Smarts", 3)
						state.Money = (state.Money or 0) + 1800
						state:AddFeed("ğŸ¯ TEXTBOOK OPERATION! Perimeter secure, negotiated surrender. Weapons cache recovered. By-the-book excellence!")
					elseif outcome < 0.75 then
						-- Standoff resolved
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						state:ModifyStat("Happiness", 8)
						state:AddFeed("â° 4-hour standoff. Suspect eventually surrendered when he realized there was no escape. Patience paid off.")
					else
						-- Barricade situation
						state:ModifyStat("Happiness", -3)
						state.Flags.hostage_situation_experienced = true
						state:AddFeed("ğŸ˜° He took a hostage! Negotiators called in. Eventually resolved but extremely tense. That could've gone worse.")
					end
				end,
			},
			{
				index = 3,
				text = "ğŸ“¢ Negotiate first - try to talk him out",
				effects = { Happiness = 2, Smarts = 5 },
				feedText = "Attempting negotiation...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					state.CareerInfo = state.CareerInfo or {}
					state.Flags = state.Flags or {}
					
					if outcome < 0.40 then
						-- Peaceful surrender
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						state.CareerInfo.peacefulResolutions = (state.CareerInfo.peacefulResolutions or 0) + 1
						state.Flags.skilled_negotiator = true
						state:ModifyStat("Happiness", 20)
						state:ModifyStat("Smarts", 5)
						state:AddFeed("ğŸ•Šï¸ INCREDIBLE! You talked him down! He came out peacefully with hands up. No shots fired. You might have a future in hostage negotiation!")
					elseif outcome < 0.65 then
						-- Partial success
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						state:ModifyStat("Happiness", 8)
						state:AddFeed("ğŸ“¢ After an hour of talking, he agreed to surrender. Weapons recovered. Good work de-escalating!")
					else
						-- Negotiation fails, forced entry
						state:ModifyStat("Happiness", -5)
						state:ModifyStat("Health", -8)
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						state:AddFeed("âŒ Negotiation failed - he started shooting! Had to breach. Suspect in custody but situation went sideways. Win is a win though.")
					end
				end,
			},
			{
				index = 4,
				text = "â³ Wait for SWAT - this is above my pay grade",
				effects = { Smarts = 2 },
				feedText = "Calling for SWAT backup...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					state.Flags = state.Flags or {}
					
					if outcome < 0.5 then
						-- SWAT handles it
						state:ModifyStat("Happiness", 3)
						state:AddFeed("ğŸ¦º SWAT took over and handled it professionally. Sometimes the smart move is knowing your limits.")
					elseif outcome < 0.8 then
						-- Captain disappointed
						state:ModifyStat("Happiness", -5)
						state.Flags.captain_disappointed = true
						state:AddFeed("ğŸ˜¤ Captain asked why you didn't go in. 'SWAT was tied up on your call!' Awkward conversation...")
					else
						-- Suspect fled during wait
						state:ModifyStat("Happiness", -10)
						state.Flags.suspect_escaped_waiting = true
						state:AddFeed("ğŸƒ Suspect escaped while waiting for SWAT! He was gone when they arrived. This one's on you...")
					end
				end,
			},
		},
	},
	
	{
		id = "gang_hideout_raid",
		emoji = "ğŸšï¸",
		title = "ğŸšï¸ GANG HIDEOUT TAKEDOWN",
		text = "Major operation: Intelligence identified a gang hideout with multiple armed members and stolen weapons. This is a coordinated multi-unit raid. High risk, high reward. Your team is the entry unit.",
		question = "The green light is given. What's your approach?",
		category = "career_police",
		weight = 7,
		minAge = 24,
		maxAge = 50,
		baseChance = 0.35,
		cooldown = 4,
		priority = "high",
		eligibility = function(state)
			if isBlockedByMafiaPath(state) then return false end
			if not isPoliceJob(state) then return false end
			-- Must have some raid experience
			local raidExp = (state.CareerInfo and state.CareerInfo.raidSuccesses) or 0
			local yearsWorked = (state.CareerInfo and state.CareerInfo.yearsAtJob) or 0
			return yearsWorked >= 2 or raidExp >= 1
		end,
		blockedByFlags = { in_prison = true, suspended = true },
		
		choices = {
			{
				index = 1,
				text = "ğŸ”¥ Full tactical assault - overwhelming force",
				effects = { Happiness = 5 },
				feedText = "GO GO GO! Multiple entry points!",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					state.CareerInfo = state.CareerInfo or {}
					state.Flags = state.Flags or {}
					
					if outcome < 0.30 then
						-- Perfect operation
						local arrests = RANDOM:NextInteger(4, 8)
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + arrests
						state.CareerInfo.raidSuccesses = (state.CareerInfo.raidSuccesses or 0) + 1
						state.Flags.gang_buster = true
						state:ModifyStat("Happiness", 30)
						state.Money = (state.Money or 0) + 5000
						state:AddFeed(string.format("ğŸ† MASSIVE SUCCESS! %d gang members arrested! Arsenal of weapons seized! This will be on the news. Commendation incoming!", arrests))
					elseif outcome < 0.60 then
						-- Successful but casualties
						local arrests = RANDOM:NextInteger(2, 5)
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + arrests
						state.CareerInfo.raidSuccesses = (state.CareerInfo.raidSuccesses or 0) + 1
						state:ModifyStat("Happiness", 10)
						state:ModifyStat("Health", -15)
						state.Money = (state.Money or 0) + 3000
						state:AddFeed(string.format("ğŸ’¥ Intense firefight! %d arrests made. Several officers injured including you. But the gang is dismantled.", arrests))
					elseif outcome < 0.85 then
						-- Some escape
						local arrests = RANDOM:NextInteger(1, 3)
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + arrests
						state:ModifyStat("Happiness", 2)
						state:AddFeed(string.format("ğŸƒ Some gang members escaped during the chaos. %d arrested but the leaders got away. Partial success.", arrests))
					else
						-- Bad outcome
						state:ModifyStat("Health", -30)
						state:ModifyStat("Happiness", -15)
						state.Flags.wounded_badly = true
						state:AddFeed("ğŸ©¹ Ambush! They were ready for us. Multiple officers down. You took several rounds. Helicopter evac to trauma center.")
					end
				end,
			},
			{
				index = 2,
				text = "ğŸŒ™ Night raid - element of surprise",
				effects = { Happiness = 3, Smarts = 3 },
				feedText = "0300 hours. Darkness is our ally...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					state.CareerInfo = state.CareerInfo or {}
					state.Flags = state.Flags or {}
					
					if outcome < 0.50 then
						-- Caught them sleeping
						local arrests = RANDOM:NextInteger(5, 10)
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + arrests
						state.CareerInfo.raidSuccesses = (state.CareerInfo.raidSuccesses or 0) + 1
						state.Flags.night_raid_specialist = true
						state:ModifyStat("Happiness", 25)
						state:ModifyStat("Smarts", 3)
						state.Money = (state.Money or 0) + 4500
						state:AddFeed(string.format("ğŸŒ™ PERFECT SURPRISE! Caught them all asleep! %d arrests, zero shots fired! Tactical excellence!", arrests))
					elseif outcome < 0.75 then
						-- Good but not perfect
						local arrests = RANDOM:NextInteger(3, 6)
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + arrests
						state:ModifyStat("Happiness", 12)
						state:AddFeed(string.format("ğŸŒƒ Night assault successful. %d in custody. A few got away in the dark but solid result.", arrests))
					else
						-- They were awake
						state:ModifyStat("Health", -18)
						state:ModifyStat("Happiness", -8)
						local arrests = RANDOM:NextInteger(1, 3)
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + arrests
						state:AddFeed("âš ï¸ They had lookouts! Firefight in the dark. " .. arrests .. " arrested. Several injuries on both sides.")
					end
				end,
			},
			{
				index = 3,
				text = "ğŸ“ Coordinate with other agencies first",
				effects = { Smarts = 5 },
				feedText = "Getting FBI and DEA involved...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					state.CareerInfo = state.CareerInfo or {}
					state.Flags = state.Flags or {}
					
					if outcome < 0.55 then
						-- Joint operation success
						local arrests = RANDOM:NextInteger(8, 15)
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + math.floor(arrests / 2) -- Split credit
						state.Flags.federal_contacts = true
						state:ModifyStat("Happiness", 20)
						state:ModifyStat("Smarts", 5)
						state:AddFeed(string.format("ğŸ›ï¸ JOINT TASK FORCE SUCCESS! %d total arrests including leadership! FBI gave you credit for the intel. Career-making bust!", arrests))
					else
						-- Bureaucracy delays things
						local arrests = RANDOM:NextInteger(2, 5)
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + arrests
						state:ModifyStat("Happiness", 3)
						state:AddFeed(string.format("ğŸ“‹ By the time paperwork cleared, half the gang scattered. %d arrests. Red tape slowed us down.", arrests))
					end
				end,
			},
		},
	},
	
	{
		id = "weapons_cache_intel",
		emoji = "ğŸ”«",
		title = "ğŸ”« WEAPONS CACHE LOCATED",
		text = "An informant tipped you off about a cache of illegal weapons in an abandoned warehouse. No warrant yet, but the weapons could be moved any minute. Your call.",
		question = "What do you do?",
		category = "career_police",
		weight = 8,
		minAge = 22,
		maxAge = 55,
		baseChance = 0.40,
		cooldown = 3,
		eligibility = isPoliceJob,
		blockedByFlags = { in_prison = true, suspended = true },
		
		choices = {
			{
				index = 1,
				text = "Get the warrant first - by the book",
				effects = { Smarts = 5 },
				feedText = "Rushing the warrant through...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					state.CareerInfo = state.CareerInfo or {}
					state.Flags = state.Flags or {}
					
					if outcome < 0.40 then
						-- Warrant in time
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 2
						state.CareerInfo.weaponsSeized = (state.CareerInfo.weaponsSeized or 0) + 1
						state.Flags.clean_bust = true
						state:ModifyStat("Happiness", 15)
						state:ModifyStat("Smarts", 3)
						state:AddFeed("âš–ï¸ Warrant came through! 50+ illegal weapons seized, all admissible in court. 2 arrests. Airtight case!")
					else
						-- Too slow
						state:ModifyStat("Happiness", -8)
						state:AddFeed("ğŸ˜¤ By the time warrant came through, warehouse was empty. They got tipped off. Frustrating!")
					end
				end,
			},
			{
				index = 2,
				text = "Act now - exigent circumstances",
				effects = { Happiness = 5 },
				feedText = "Moving in now!",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					state.CareerInfo = state.CareerInfo or {}
					state.Flags = state.Flags or {}
					
					if outcome < 0.35 then
						-- Caught them
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 3
						state.CareerInfo.weaponsSeized = (state.CareerInfo.weaponsSeized or 0) + 1
						state:ModifyStat("Happiness", 20)
						state.Money = (state.Money or 0) + 2000
						state:AddFeed("ğŸ¯ Perfect timing! 3 suspects with the weapons! Major bust! Exigent circumstances held up in court!")
					elseif outcome < 0.65 then
						-- Found weapons but no suspects
						state.CareerInfo.weaponsSeized = (state.CareerInfo.weaponsSeized or 0) + 1
						state:ModifyStat("Happiness", 8)
						state:AddFeed("ğŸ”« Weapons found but no one there. 75 firearms off the streets. No arrests but still a win.")
					else
						-- Legal trouble
						state:ModifyStat("Happiness", -10)
						state.Flags.fourth_amendment_violation = true
						state:AddFeed("âš–ï¸ Internal Affairs wants to talk. Your entry may have violated the 4th Amendment. Case could get thrown out.")
					end
				end,
			},
			{
				index = 3,
				text = "Surveillance only - gather more intel",
				effects = { Smarts = 3 },
				feedText = "Setting up surveillance...",
				onResolve = function(state)
					local outcome = RANDOM:NextNumber()
					state.Flags = state.Flags or {}
					
					if outcome < 0.50 then
						-- Intel pays off big
						state.Flags.intel_specialist = true
						state:ModifyStat("Smarts", 5)
						state:ModifyStat("Happiness", 10)
						state:AddFeed("ğŸ” Surveillance identified the whole network! This will lead to a much bigger operation. Good patience.")
					else
						-- Nothing comes of it
						state:ModifyStat("Happiness", -3)
						state:AddFeed("ğŸ‘€ Watched for days but they never returned. Cache was moved. Opportunity lost.")
					end
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- RETIREMENT / END GAME
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "police_retirement",
		emoji = "ğŸ–ï¸",
		title = "Retirement from the Force",
		text = "After decades on the force, it's time to hang up the badge. You've seen a lot. Done a lot. Time to rest.",
		question = "How do you feel about retirement?",
		category = "career_police",
		weight = 5,
		minAge = 50,
		maxAge = 65,
		baseChance = 0.5,
		cooldown = 6,
		oneTime = true,
		eligibility = isPoliceJob, -- CRITICAL FIX: Use job ID check instead of category,
		blockedByFlags = { retired_cop = true, in_prison = true },
		
		choices = {
			{
				index = 1,
				text = "Full pension - I've earned it",
				effects = { Happiness = 15, Health = 5 },
				setFlags = { retired_cop = true },
				feedText = "You retired with full honors and pension.",
				onResolve = function(state)
					state.CurrentJob = nil
					state.Flags = state.Flags or {}
					state.Flags.retired = true
					state.Flags.pension = true
					-- Set up pension income
					state.CareerInfo = state.CareerInfo or {}
					state.CareerInfo.pensionAmount = 4000 -- Monthly pension
					if state.AddFeed then
						state:AddFeed("ğŸ‘®â€â™‚ï¸ Thank you for your service. Enjoy retirement!")
					end
				end,
			},
			{
				index = 2,
				text = "Stay on as a desk officer",
				effects = { Happiness = 5 },
				feedText = "You moved to a desk position. Lighter duties, still on the job.",
			},
			{
				index = 3,
				text = "Become a private investigator",
				effects = { Happiness = 10 },
				feedText = "You opened your own PI business. Still solving cases.",
				onResolve = function(state)
					state.CurrentJob = nil
					state.Flags = state.Flags or {}
					state.Flags.private_investigator = true
					if state.AddFeed then
						state:AddFeed("ğŸ” You're now a private investigator. Same skills, new rules.")
					end
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- CRITICAL FIX: Added LIFE-THREATENING events for police officers
	-- User requested: "IF IM POLICE I CAN DIE FROM A MISSION"
	-- Police work is inherently dangerous - officers can be killed in the line of duty
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "police_active_shooter",
		emoji = "ğŸ’€",
		title = "ACTIVE SHOOTER CALL",
		textVariants = {
			"Dispatch: ACTIVE SHOOTER at local mall! Multiple victims! You're the first on scene!",
			"Shots fired at a school! Children are in danger! You're closest to the scene!",
			"Armed robbery in progress - suspects have opened fire on civilians! You're responding!",
			"Domestic violence call escalated - subject has barricaded with hostages and a gun!",
		},
		text = "A life-or-death situation! Do you enter or wait for backup?",
		category = "career_police",
		weight = 3, -- Rare but realistic
		minAge = 21,
		maxAge = 60,
		baseChance = 0.35,
		cooldown = 5,
		eligibility = isPoliceJob,
		blockedByFlags = { in_prison = true, suspended = true },
		
		choices = {
			{
				index = 1,
				text = "Go in NOW - lives are at stake!",
				feedText = "You charge in alone...",
				effects = {},
				onResolve = function(state)
					local health = (state.Stats and state.Stats.Health) or 50
					local smarts = (state.Stats and state.Stats.Smarts) or 50
					local survivalChance = 0.50 + (health / 200) + (smarts / 300)
					local roll = math.random()
					
					if roll < survivalChance then
						-- HERO! Stopped the shooter
						state.Flags = state.Flags or {}
						state.Flags.police_hero = true
						state.Flags.medal_of_valor = true
						state.Stats = state.Stats or {}
						state.Stats.Happiness = math.min(100, (state.Stats.Happiness or 50) + 25)
						state.Stats.Health = math.max(30, (state.Stats.Health or 50) - 15) -- Minor injuries possible
						state.Money = (state.Money or 0) + 5000 -- Bonus
						if state.AddFeed then
							state:AddFeed("ğŸ… HERO! You neutralized the threat and saved lives! Medal of Valor!")
						end
					elseif roll < survivalChance + 0.3 then
						-- Wounded but survived
						state.Stats = state.Stats or {}
						state.Stats.Health = math.max(10, (state.Stats.Health or 50) - 40)
						state.Stats.Happiness = (state.Stats.Happiness or 50) - 15
						state.Flags = state.Flags or {}
						state.Flags.wounded_in_action = true
						state.Flags.hospitalized = true
						if state.AddFeed then
							state:AddFeed("ğŸ¥ You stopped the shooter but took several rounds. Hospitalized with serious injuries.")
						end
					else
						-- KILLED IN LINE OF DUTY - 20% chance when going in alone
						state.Flags = state.Flags or {}
						state.Flags.dead = true
						state.Flags.cause_of_death = "Killed in Line of Duty"
						state.Stats = state.Stats or {}
						state.Stats.Health = 0
						if state.AddFeed then
							state:AddFeed("â˜ ï¸ END OF WATCH. You gave your life protecting others. A hero's death.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Wait for backup - we need a tactical approach",
				feedText = "Establishing perimeter and waiting...",
				effects = { Happiness = -10 },
				onResolve = function(state)
					local roll = math.random()
					if roll < 0.3 then
						-- Shooter escaped or more victims
						state.Stats = state.Stats or {}
						state.Stats.Happiness = (state.Stats.Happiness or 50) - 25
						state.Flags = state.Flags or {}
						state.Flags.guilt = true
						if state.AddFeed then
							state:AddFeed("ğŸ˜” More victims while you waited. The guilt is crushing. Did you make the right call?")
						end
					elseif roll < 0.7 then
						-- SWAT resolved it
						if state.AddFeed then
							state:AddFeed("âœ… SWAT team resolved the situation. Proper protocol worked.")
						end
					else
						-- You helped tactically
						state.Stats = state.Stats or {}
						state.Stats.Smarts = (state.Stats.Smarts or 50) + 3
						if state.AddFeed then
							state:AddFeed("âœ… Your tactical setup helped SWAT resolve it safely. Good police work.")
						end
					end
				end,
			},
		},
	},
	
	{
		id = "police_ambush",
		emoji = "âš ï¸",
		title = "OFFICER DOWN - AMBUSH!",
		text = "You respond to a routine call. It's a trap! Gunfire erupts from multiple directions!",
		category = "career_police",
		weight = 2, -- Very rare but real
		minAge = 21,
		maxAge = 60,
		baseChance = 0.25,
		cooldown = 5,
		eligibility = isPoliceJob,
		blockedByFlags = { in_prison = true, suspended = true },
		
		choices = {
			{
				index = 1,
				text = "Take cover and return fire!",
				feedText = "Bullets flying everywhere!",
				triggerMinigame = "qte", -- Combat minigame
				minigameOptions = { difficulty = "hard" },
				onResolve = function(state, minigameResult)
				if minigameResult and minigameResult.success then
					state.Flags = state.Flags or {}
					state.Flags.ambush_survivor = true
					state.Stats = state.Stats or {}
					state.Stats.Health = math.max(30, (state.Stats.Health or 50) - 20)
					if state.AddFeed then
						state:AddFeed("ğŸ”« You survived the ambush! Attackers fled when backup arrived.")
					end
				else
					-- Didn't survive the minigame
					local deathRoll = math.random(1, 100)
					if deathRoll <= 40 then
						state.Flags = state.Flags or {}
						state.Flags.dead = true
						state.Flags.cause_of_death = "Killed in Ambush"
						state.Stats = state.Stats or {}
						state.Stats.Health = 0
						if state.AddFeed then
							state:AddFeed("â˜ ï¸ Killed in ambush. Your name will be on the memorial wall.")
						end
					else
						state.Stats = state.Stats or {}
						state.Stats.Health = 5
						state.Flags = state.Flags or {}
						state.Flags.critically_wounded = true
						state.Flags.hospitalized = true
						state.Flags.medical_retirement = true
						state.CurrentJob = nil
						state.Flags.employed = nil
						if state.AddFeed then
							state:AddFeed("ğŸ¥ Critical injuries. Medical retirement forced. Your career is over.")
						end
					end
				end
			end,
		},
		{
			index = 2,
			text = "Call for backup and retreat!",
			feedText = "Running for cover...",
			effects = { Health = -10 },
			onResolve = function(state)
				local roll = math.random()
				if roll < 0.7 then
					-- Escaped
					state.Stats = state.Stats or {}
					state.Stats.Health = math.max(30, (state.Stats.Health or 50) - 15)
					if state.AddFeed then
						state:AddFeed("ğŸš” You escaped the kill zone. Wounded but alive. Backup arrived in time.")
					end
				else
					-- Shot while retreating
					state.Stats = state.Stats or {}
					state.Stats.Health = math.max(10, (state.Stats.Health or 50) - 35)
					state.Flags = state.Flags or {}
					state.Flags.shot_in_back = true
					state.Flags.hospitalized = true
					if state.AddFeed then
						state:AddFeed("ğŸ¥ Hit while retreating. Vest stopped most rounds. You'll recover.")
					end
				end
			end,
		},
	},
	
	{
		id = "police_foot_chase",
		emoji = "ğŸƒ",
		title = "Foot Chase - Armed Suspect!",
		text = "You spot a wanted armed felon! They're running through alleys and over fences!",
		category = "career_police",
		weight = 7,
		minAge = 21,
		maxAge = 50, -- Younger cops for foot chases
		baseChance = 0.50,
		cooldown = 4, -- CRITICAL FIX: Increased from 2 to reduce spam
		eligibility = isPoliceJob,
		blockedByFlags = { in_prison = true, suspended = true },
		
		choices = {
			{
				index = 1,
				text = "Chase them down!",
				feedText = "Heart pounding, you pursue...",
				effects = { Health = -3 },
				onResolve = function(state)
					local health = (state.Stats and state.Stats.Health) or 50
					local successChance = 0.40 + (health / 150)
					local roll = math.random()
					
					if roll < successChance then
						state.Flags = state.Flags or {}
						state.Flags.caught_felon = true
						state.CareerInfo = state.CareerInfo or {}
						state.CareerInfo.arrests = (state.CareerInfo.arrests or 0) + 1
						if state.AddFeed then
							state:AddFeed("ğŸƒ GOT HIM! You tackled the suspect after a three-block chase!")
						end
					elseif roll < successChance + 0.3 then
						-- Got away
						state.Stats = state.Stats or {}
						state.Stats.Happiness = (state.Stats.Happiness or 50) - 5
						if state.AddFeed then
							state:AddFeed("ğŸƒ Lost them in the maze of alleys. Suspect escaped.")
						end
					else
						-- Dangerous confrontation
						local dangerRoll = math.random(1, 100)
						if dangerRoll <= 20 then
							state.Stats = state.Stats or {}
							state.Stats.Health = math.max(20, (state.Stats.Health or 50) - 25)
							state.Flags = state.Flags or {}
							state.Flags.injured_on_duty = true
							if state.AddFeed then
								state:AddFeed("âš ï¸ Suspect turned and fired! You're hit but backup arrived. Will recover.")
							end
						else
							state.Flags = state.Flags or {}
							state.Flags.caught_felon = true
							state.Stats = state.Stats or {}
						state.Stats.Health = math.max(35, (state.Stats.Health or 50) - 10)
						if state.AddFeed then
							state:AddFeed("ğŸƒ Suspect surrendered when cornered. A bit banged up but good arrest!")
						end
					end
					end
				end,
			},
			{
				index = 2,
				text = "Call for K-9 and air support",
				feedText = "Setting up a perimeter...",
				effects = { Smarts = 3 },
				onResolve = function(state)
					local roll = math.random()
					if roll < 0.6 then
						state.Flags = state.Flags or {}
						state.Flags.smart_cop = true
						if state.AddFeed then
							state:AddFeed("ğŸ• K-9 tracked them down. Safe arrest, no injuries. Smart policing.")
						end
					else
						if state.AddFeed then
							state:AddFeed("ğŸš Suspect escaped the perimeter. At least no one got hurt.")
						end
					end
				end,
			},
		},
	},
}

return events
