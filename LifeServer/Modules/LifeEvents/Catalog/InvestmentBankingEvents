--[[
	Investment Banking / High Finance Career Events
	AAA-quality events with random BitLife-style outcomes
	User CANNOT control outcomes - everything is randomized
	
	Careers covered:
	- Investment Banking Analyst
	- Investment Banker
	- Hedge Fund Manager
	- Private Equity
	- Venture Capital
	- CFO
]]

local InvestmentBankingEvents = {}

-- Helper function to check if player has a finance career
local function hasFinanceJob(state)
	if not state.CurrentJob then return false end
	local jobId = (state.CurrentJob.id or ""):lower()
	local jobCat = (state.CurrentJob.category or ""):lower()
	return jobCat == "finance" or jobId:find("banker") or jobId:find("analyst") or 
		   jobId:find("hedge") or jobId:find("fund") or jobId:find("equity") or
		   jobId:find("cfo") or jobId:find("financial")
end

local function isInvestmentBanker(state)
	if not state.CurrentJob then return false end
	local jobId = (state.CurrentJob.id or ""):lower()
	return jobId:find("investment") or jobId:find("ib_analyst") or jobId:find("banker")
end

InvestmentBankingEvents.events = {
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- INVESTMENT BANKING ANALYST EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "ib_allnighter_deal",
		title = "ğŸ’¼ All-Nighter for the Deal!",
		emoji = "ğŸ’¼",
		text = "A massive M&A deal is closing tomorrow. The Managing Director needs the pitch book done by 6 AM. It's currently 11 PM.",
		category = "career_finance",
		weight = 18,
		minAge = 22, maxAge = 40,
		baseChance = 0.3, -- LOWERED to prevent spam
		cooldown = 5, -- INCREASED
		requiresJob = true,
		eligibility = isInvestmentBanker,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Grind through the night",
				effects = { Health = -8, Happiness = -5 },
				feedText = "Sleep is for the weak...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 55 then
						local bonus = math.random(10000, 50000)
						state.Money = (state.Money or 0) + bonus
						state:ModifyStat("Happiness", 15)
						state.Flags = state.Flags or {}
						state.Flags.dealmaker = true
						state:AddFeed(string.format("ğŸ’¼ Deal closed! $%s bonus! MD personally thanked you!", bonus))
					elseif roll <= 85 then
						state:ModifyStat("Happiness", 3)
						state:AddFeed("ğŸ’¼ Work was good enough. Nobody praised you but no complaints either.")
					else
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ’¼ Made errors due to exhaustion. MD furious. Bad look.")
					end
				end,
			},
			{
				text = "Ask to extend the deadline",
				effects = {},
				feedText = "This isn't humanly possible...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 30 then
						state:ModifyStat("Happiness", 8)
						state:AddFeed("ğŸ’¼ They agreed! Got extra time and delivered quality work!")
					else
						state:ModifyStat("Happiness", -15)
						state.Flags = state.Flags or {}
						state.Flags.not_team_player = true
						state:AddFeed("ğŸ’¼ 'If you can't handle it, we'll find someone who can.' Ominous.")
					end
				end,
			},
		},
	},
	
	{
		id = "ib_bonus_season",
		title = "ğŸ’° Bonus Season!",
		emoji = "ğŸ’°",
		text = "It's bonus season at the bank. You've worked 100+ hour weeks all year. Time to see if it paid off!",
		category = "career_finance",
		weight = 16,
		minAge = 22, maxAge = 55,
		baseChance = 0.3, -- LOWERED
		cooldown = 5, -- INCREASED
		requiresJob = true,
		eligibility = isInvestmentBanker,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Wait anxiously for the number",
				effects = { Happiness = -3 },
				feedText = "Everything rides on this...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					local salary = state.CurrentJob and state.CurrentJob.salary or 100000
					
					if roll <= 25 then
						local bonus = math.floor(salary * math.random(150, 250) / 100)
						state.Money = (state.Money or 0) + bonus
						state:ModifyStat("Happiness", 25)
						state.Flags = state.Flags or {}
						state.Flags.top_performer = true
						state:AddFeed(string.format("ğŸ’° HUGE BONUS! $%s! Top performer! Champagne time!", bonus))
					elseif roll <= 55 then
						local bonus = math.floor(salary * math.random(80, 120) / 100)
						state.Money = (state.Money or 0) + bonus
						state:ModifyStat("Happiness", 10)
						state:AddFeed(string.format("ğŸ’° Solid bonus. $%s. In line with expectations.", bonus))
					elseif roll <= 85 then
						local bonus = math.floor(salary * math.random(40, 70) / 100)
						state.Money = (state.Money or 0) + bonus
						state:ModifyStat("Happiness", -5)
						state:AddFeed(string.format("ğŸ’° Below expectations. $%s. 'Market conditions' they said.", bonus))
					else
						state:ModifyStat("Happiness", -20)
						state:AddFeed("ğŸ’° Minimal bonus. They're pushing you out. Start job hunting.")
					end
				end,
			},
		},
	},
	
	{
		id = "ib_client_tantrum",
		title = "Client Meltdown",
		emoji = "ğŸ˜¤",
		text = "A billionaire client is throwing a tantrum on a call. They're screaming about their portfolio performance and threatening to pull everything.",
		category = "career_finance",
		weight = 14,
		minAge = 24, maxAge = 55,
		baseChance = 0.25, -- LOWERED to prevent spam
		cooldown = 5, -- INCREASED
		requiresJob = true,
		eligibility = hasFinanceJob,
		blockedByFlags = { in_prison = true, lost_client = true },
		
		choices = {
			{
				text = "Stay calm and professional",
				effects = { Smarts = 2 },
				feedText = "Kill them with kindness...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Happiness", 10)
						state.Money = (state.Money or 0) + math.random(5000, 20000)
						state:AddFeed("ğŸ˜¤ Calmed them down! Client apologized later. Respect earned.")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ˜¤ They pulled half their money anyway. At least you kept composure.")
					end
				end,
			},
			{
				text = "Match their energy",
				effects = { Happiness = -3 },
				feedText = "Nobody talks to me like that!",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 20 then
						state:ModifyStat("Happiness", 8)
						state:AddFeed("ğŸ˜¤ Somehow they respected the pushback! Bizarre but it worked!")
					else
						state:ModifyStat("Happiness", -15)
						state.Flags = state.Flags or {}
						state.Flags.lost_client = true
						state:AddFeed("ğŸ˜¤ Lost the client. And your job might be next. HR involved.")
					end
				end,
			},
			{
				text = "Pass them to your manager",
				effects = {},
				feedText = "Above my pay grade...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ˜¤ Manager handled it. Smart move knowing when to escalate.")
					else
						state:ModifyStat("Happiness", -8)
						state:AddFeed("ğŸ˜¤ Manager annoyed you couldn't handle it. 'Need to step up.'")
					end
				end,
			},
		},
	},
	
	{
		id = "ib_insider_info",
		title = "ğŸ¤« Suspicious Information",
		emoji = "ğŸ¤«",
		text = "A colleague just let slip material non-public information about an upcoming acquisition. You could make millions if you traded on it...",
		category = "career_finance",
		weight = 12,
		minAge = 24, maxAge = 60,
		baseChance = 0.4,
		cooldown = 5,
		requiresJob = true,
		eligibility = hasFinanceJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Trade on it - can't get caught",
				effects = {},
				feedText = "Easy money...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 25 then
						local profit = math.random(500000, 2000000)
						state.Money = (state.Money or 0) + profit
						state:ModifyStat("Happiness", 15)
						state.Flags = state.Flags or {}
						state.Flags.insider_trader = true
						state:AddFeed(string.format("ğŸ¤« Made $%s. Nobody noticed. Yet.", profit))
					elseif roll <= 60 then
						state:ModifyStat("Happiness", -25)
						state.Money = math.max(0, (state.Money or 0) - 500000)
						state.Flags = state.Flags or {}
						state.Flags.sec_investigation = true
						state:AddFeed("ğŸ¤« SEC is investigating. Lawyers already cost you a fortune.")
					else
						state:ModifyStat("Happiness", -30)
						state.Flags = state.Flags or {}
						state.Flags.in_prison = true
						state.PrisonYearsRemaining = math.random(3, 10)
						state.CurrentJob = nil
						state:AddFeed("ğŸ¤« ARRESTED for insider trading! Federal charges! Career over!")
					end
				end,
			},
			{
				text = "Report to compliance",
				effects = { Smarts = 5, Happiness = 5 },
				setFlags = { compliance_hero = true },
				feedText = "Doing the right thing.",
				onResolve = function(state)
					state:AddFeed("ğŸ¤« Did the right thing. Colleague fired. You're protected by whistleblower laws.")
				end,
			},
			{
				text = "Pretend you didn't hear anything",
				effects = { Happiness = 3 },
				feedText = "None of my business.",
			},
		},
	},
	
	{
		id = "ib_headhunter_call",
		title = "Headhunter on the Phone!",
		emoji = "ğŸ“",
		text = "A top headhunter is calling. A rival bank wants to poach you with a 40% raise and a signing bonus!",
		category = "career_finance",
		weight = 14,
		minAge = 25, maxAge = 50,
		baseChance = 0.45,
		cooldown = 3,
		requiresJob = true,
		eligibility = isInvestmentBanker,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Take the interview",
				effects = {},
				feedText = "Always good to know your value...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						local raise = math.floor((state.CurrentJob and state.CurrentJob.salary or 150000) * 0.4)
						local bonus = math.random(50000, 200000)
						state.Money = (state.Money or 0) + bonus
						state.CurrentJob = state.CurrentJob or {}
						state.CurrentJob.salary = (state.CurrentJob.salary or 150000) + raise
						state:ModifyStat("Happiness", 15)
						state:AddFeed(string.format("ğŸ“ Got the offer! $%s signing bonus! 40%% raise!", bonus))
					elseif roll <= 80 then
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ“ Didn't get the offer, but your current firm counter-offered a raise!")
						state.Money = (state.Money or 0) + math.random(10000, 30000)
					else
						state:ModifyStat("Happiness", -8)
						state:AddFeed("ğŸ“ Word got back to your firm. They're questioning your loyalty.")
					end
				end,
			},
			{
				text = "Use it to negotiate at current firm",
				effects = { Smarts = 2 },
				feedText = "Leverage is everything...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						local raise = math.random(20000, 80000)
						state.Money = (state.Money or 0) + raise
						state:ModifyStat("Happiness", 12)
						state:AddFeed(string.format("ğŸ“ Counter-offered! $%s raise to stay! Power move!", raise))
					else
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ“ 'Take the other offer then.' Called your bluff. Awkward.")
					end
				end,
			},
			{
				text = "Stay loyal - not interested",
				effects = { Happiness = 3 },
				feedText = "Happy where I am.",
			},
		},
	},
	
	{
		id = "ib_market_crash",
		title = "ğŸ“‰ Market Crash!",
		emoji = "ğŸ“‰",
		text = "Markets just crashed 10% in one day. Panic everywhere. Clients are calling non-stop. Your team has to figure this out!",
		category = "career_finance",
		weight = 12,
		minAge = 22, maxAge = 65,
		baseChance = 0.4,
		cooldown = 4,
		requiresJob = true,
		eligibility = hasFinanceJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Stay calm and advise clients not to panic sell",
				effects = { Smarts = 3 },
				feedText = "This is when professionals shine...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 55 then
						state.Money = (state.Money or 0) + math.random(20000, 100000)
						state:ModifyStat("Happiness", 15)
						state.Flags = state.Flags or {}
						state.Flags.market_veteran = true
						state:AddFeed("ğŸ“‰ Kept clients calm. Market recovered. You look like a genius now!")
					else
						state:ModifyStat("Happiness", -8)
						state:AddFeed("ğŸ“‰ Market kept falling. Clients angry they didn't sell. Hindsight is 20/20.")
					end
				end,
			},
			{
				text = "Tell clients to sell everything NOW",
				effects = { Happiness = -5 },
				feedText = "Protect capital at all costs!",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 30 then
						state:ModifyStat("Happiness", 10)
						state:AddFeed("ğŸ“‰ Market crashed further. Clients glad they got out. Lucky call!")
					else
						state:ModifyStat("Happiness", -15)
						state.Flags = state.Flags or {}
						state.Flags.bad_advice = true
						state:AddFeed("ğŸ“‰ Market bounced immediately. Clients sold at the bottom. You're in trouble.")
					end
				end,
			},
		},
	},
	
	{
		id = "ib_ipo_lead",
		title = "ğŸš€ Lead on Major IPO!",
		emoji = "ğŸš€",
		text = "You've been asked to lead the IPO for a hot tech unicorn! This could be career-defining!",
		category = "career_finance",
		weight = 10,
		minAge = 28, maxAge = 50,
		baseChance = 0.35,
		cooldown = 5,
		oneTime = true,
		requiresJob = true,
		eligibility = isInvestmentBanker,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Accept and give it everything!",
				effects = { Health = -5, Smarts = 5 },
				feedText = "Once in a lifetime opportunity!",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 45 then
						local bonus = math.random(500000, 3000000)
						state.Money = (state.Money or 0) + bonus
						state:ModifyStat("Happiness", 30)
						state.Fame = (state.Fame or 0) + 30
						state.Flags = state.Flags or {}
						state.Flags.ipo_legend = true
						state:AddFeed(string.format("ğŸš€ IPO was MASSIVE success! $%s bonus! Your name in the financial press!", bonus))
					elseif roll <= 75 then
						local bonus = math.random(100000, 400000)
						state.Money = (state.Money or 0) + bonus
						state:ModifyStat("Happiness", 15)
						state:AddFeed(string.format("ğŸš€ IPO went okay. $%s bonus. Not legendary, but solid.", bonus))
					else
						state:ModifyStat("Happiness", -20)
						state.Flags = state.Flags or {}
						state.Flags.ipo_disaster = true
						state:AddFeed("ğŸš€ IPO flopped. Stock crashed day one. Your name associated with failure.")
					end
				end,
			},
		},
	},
	
	{
		id = "ib_ethics_dilemma",
		title = "Ethics vs Profit",
		emoji = "âš–ï¸",
		text = "Your analysis shows the company you're advising to buy has hidden liabilities. Revealing this will kill the deal (and your bonus).",
		category = "career_finance",
		weight = 12,
		minAge = 24, maxAge = 55,
		baseChance = 0.4,
		cooldown = 4,
		requiresJob = true,
		eligibility = isInvestmentBanker,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Disclose everything to the client",
				effects = { Smarts = 5, Happiness = -3 },
				setFlags = { ethical_banker = true },
				feedText = "Integrity over money.",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Happiness", 15)
						state.Money = (state.Money or 0) + math.random(20000, 100000)
						state:AddFeed("âš–ï¸ Client appreciated honesty! They'll work with you exclusively from now on!")
					else
						state:ModifyStat("Happiness", 5)
						state:AddFeed("âš–ï¸ Deal died, no bonus. But you can sleep at night.")
					end
				end,
			},
			{
				text = "Bury it deep in the footnotes",
				effects = { Happiness = -5 },
				feedText = "Technically compliant...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						local bonus = math.random(50000, 200000)
						state.Money = (state.Money or 0) + bonus
						state:ModifyStat("Happiness", 8)
						state:AddFeed(string.format("âš–ï¸ Deal closed. $%s bonus. Nobody looked closely.", bonus))
					else
						state:ModifyStat("Happiness", -20)
						state.Flags = state.Flags or {}
						state.Flags.legal_trouble = true
						state:AddFeed("âš–ï¸ They found it later. Lawsuit incoming. You might have to testify.")
					end
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- NEW EVENTS - ENHANCED VARIETY, LINKAGE, AND CONSEQUENCES
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	{
		id = "ib_top_performer_consequence",
		title = "ğŸ’ Top Performer Perks",
		emoji = "ğŸ’",
		text = "Being named top performer has its perks! The MD is personally mentoring you now.",
		category = "career_finance",
		weight = 6,
		minAge = 24, maxAge = 45,
		baseChance = 0.3, -- LOWERED
		cooldown = 6, -- INCREASED
		oneTime = true, -- Only once
		requiresJob = true,
		eligibility = isInvestmentBanker,
		-- LINKAGE: Only triggers if you were named top performer
		requiresFlags = { top_performer = true },
		blockedByFlags = { in_prison = true, deal_leader = true },
		
		choices = {
			{
				text = "Ask to lead the next big deal",
				effects = { Smarts = 5 },
				feedText = "Ambitious move...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 55 then
						local bonus = math.random(200000, 800000)
						state.Money = (state.Money or 0) + bonus
						state:ModifyStat("Happiness", 20)
						state.Flags = state.Flags or {}
						state.Flags.deal_leader = true
						state:AddFeed(string.format("ğŸ’ Led a $2B acquisition! $%s bonus! Fast track to VP!", bonus))
					else
						state:ModifyStat("Happiness", -8)
						state:AddFeed("ğŸ’ The deal fell through. Not your fault but the spotlight isn't kind.")
					end
				end,
			},
			{
				text = "Learn everything you can from the MD",
				effects = { Smarts = 8, Happiness = 5 },
				feedText = "Knowledge is power...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.md_mentee = true
					state.Flags.industry_knowledge = true
					state:AddFeed("ğŸ’ Absorbing decades of wisdom! You're learning things they don't teach in b-school!")
				end,
			},
		},
	},
	
	{
		id = "ib_sec_investigation_consequence",
		title = "ğŸ” SEC Investigation Deepens",
		emoji = "ğŸ”",
		text = "Remember those trades? The SEC investigation is getting serious. They want to interview you.",
		category = "career_finance",
		weight = 12,
		minAge = 25, maxAge = 60,
		baseChance = 0.35, -- LOWERED
		cooldown = 5, -- INCREASED
		oneTime = true, -- Only once!
		requiresJob = true,
		eligibility = hasFinanceJob,
		-- LINKAGE: Only triggers if SEC is investigating
		requiresFlags = { sec_investigation = true },
		blockedByFlags = { in_prison = true, cleared_by_sec = true, banned_from_finance = true },
		
		choices = {
			{
				text = "Cooperate fully with investigators",
				effects = { Happiness = -10 },
				feedText = "Nothing to hide...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state.Flags = state.Flags or {}
						state.Flags.sec_investigation = nil
						state.Flags.cleared_by_sec = true
						state:ModifyStat("Happiness", 15)
						state:AddFeed("ğŸ” Investigation closed! No charges! You can breathe again!")
					elseif roll <= 80 then
						state.Money = math.max(0, (state.Money or 0) - math.random(100000, 300000))
						state.Flags = state.Flags or {}
						state.Flags.sec_investigation = nil
						state:AddFeed("ğŸ” Settled with a fine. No admission of guilt. Career can continue.")
					else
						state.Flags = state.Flags or {}
						state.Flags.sec_investigation = nil
						state.Flags.banned_from_finance = true
						state.CurrentJob = nil
						state:AddFeed("ğŸ” Banned from the securities industry! Career OVER!")
					end
				end,
			},
		{
			text = "Lawyer up and fight it ($200K)",
			effects = { Money = -200000, Happiness = -15 },
			feedText = "Going to war...",
			eligibility = function(state) return (state.Money or 0) >= 200000, "ğŸ’¸ Need $200K for legal defense" end,
			onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 35 then
						state.Flags = state.Flags or {}
						state.Flags.sec_investigation = nil
						state.Flags.beat_the_feds = true
						state:ModifyStat("Happiness", 25)
						state:AddFeed("ğŸ” Your legal team CRUSHED IT! Case dismissed! You're untouchable!")
					else
						state.Flags = state.Flags or {}
						state.Flags.in_prison = true
						state.PrisonYearsRemaining = math.random(2, 8)
						state.CurrentJob = nil
						state.Flags.sec_investigation = nil
						state:AddFeed("ğŸ” Lost the case. Federal prison. Should have cooperated.")
					end
				end,
			},
			{
				text = "Flee the country",
				effects = { Happiness = -20 },
				feedText = "Running...",
				onResolve = function(state)
					state.Money = math.max(0, (state.Money or 0) - math.random(500000, 1000000))
					state.Flags = state.Flags or {}
					state.Flags.fugitive = true
					state.Flags.sec_investigation = nil
					state.CurrentJob = nil
					state:AddFeed("ğŸ” Living in a country with no extradition. Rich but paranoid. Forever looking over your shoulder.")
				end,
			},
		},
	},
	
	{
		id = "ib_ipo_legend_consequence",
		title = "ğŸŒŸ IPO Legend Status",
		emoji = "ğŸŒŸ",
		text = "After that legendary IPO, you're being offered a partner position at a new hedge fund!",
		category = "career_finance",
		weight = 8,
		minAge = 30, maxAge = 55,
		baseChance = 0.45,
		cooldown = 5,
		oneTime = true,
		requiresJob = true,
		eligibility = isInvestmentBanker,
		-- LINKAGE: Only triggers if IPO was legendary
		requiresFlags = { ipo_legend = true },
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Take the partner position",
				effects = { Happiness = 20 },
				feedText = "Moving up!",
				onResolve = function(state)
					local equity = math.random(1000000, 5000000)
					state.Money = (state.Money or 0) + equity
					state.Flags = state.Flags or {}
					state.Flags.hedge_fund_partner = true
					state.Flags.ipo_legend = nil -- Clear for new adventures
					state:AddFeed(string.format("ğŸŒŸ PARTNER! $%s in equity! Running the show now!", equity))
				end,
			},
			{
				text = "Start your own fund",
				effects = { Smarts = 5 },
				feedText = "Going solo...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					local investment = 500000
					if (state.Money or 0) < investment then
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸŒŸ Can't afford to start your own fund. Need at least $500k.")
					else
						-- CRITICAL FIX: Prevent negative money
						state.Money = math.max(0, (state.Money or 0) - investment)
						if roll <= 50 then
							local returns = math.random(2000000, 10000000)
							state.Money = (state.Money or 0) + returns
							state.Flags = state.Flags or {}
							state.Flags.hedge_fund_founder = true
							state.Fame = (state.Fame or 0) + 50
							state:AddFeed(string.format("ğŸŒŸ YOUR FUND IS CRUSHING IT! $%s returns in year one!", returns))
						else
							state:ModifyStat("Happiness", -15)
							state:AddFeed("ğŸŒŸ Fund underperformed. Investors pulling out. Back to square one.")
						end
					end
				end,
			},
			{
				text = "Stay loyal to current firm",
				effects = { Happiness = 5, Money = 300000 },
				setFlags = { loyal_employee = true },
				feedText = "Loyalty matters.",
				onResolve = function(state)
					state:AddFeed("ğŸŒŸ Stayed put. Promoted to Managing Director. Comfortable but... what if?")
				end,
			},
		},
	},
	
	{
		id = "ib_dealmaker_streak",
		title = "ğŸ”¥ Hot Streak",
		emoji = "ğŸ”¥",
		text = "You've closed 5 deals in a row! You're the hottest dealmaker in the firm!",
		category = "career_finance",
		weight = 6,
		minAge = 26, maxAge = 50,
		baseChance = 0.2, -- LOWERED
		cooldown = 6, -- INCREASED
		requiresJob = true,
		eligibility = isInvestmentBanker,
		-- LINKAGE: REQUIRES dealmaker flag - not just boosted
		requiresFlags = { dealmaker = true },
		blockedByFlags = { in_prison = true, legendary_dealmaker = true },
		
		choices = {
			{
				text = "Go for the biggest deal of your career",
				effects = { Health = -5 },
				feedText = "Swinging for the fences...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						local bonus = math.random(500000, 2000000)
						state.Money = (state.Money or 0) + bonus
						state:ModifyStat("Happiness", 25)
						state.Fame = (state.Fame or 0) + 30
						state.Flags = state.Flags or {}
						state.Flags.legendary_dealmaker = true
						state:AddFeed(string.format("ğŸ”¥ HISTORIC DEAL! $%s bonus! Your name in the Wall Street Journal!", bonus))
					else
						state:ModifyStat("Happiness", -15)
						state.Money = math.max(0, (state.Money or 0) - 50000)
						state:AddFeed("ğŸ”¥ Overreached. Deal collapsed. Streak ended painfully.")
					end
				end,
			},
			{
				text = "Lock in your gains - coast for a bit",
				effects = { Happiness = 8, Health = 5 },
				feedText = "Protecting the streak...",
				onResolve = function(state)
					state.Money = (state.Money or 0) + math.random(100000, 300000)
					state:AddFeed("ğŸ”¥ Played it safe. Took smaller deals. Streak continues quietly.")
				end,
			},
		},
	},
	
	{
		id = "ib_legal_trouble_consequence",
		title = "âš ï¸ Legal Troubles Mount",
		emoji = "âš ï¸",
		text = "Remember that deal with hidden liabilities? The lawsuit is here. You're being deposed.",
		category = "career_finance",
		weight = 12,
		minAge = 26, maxAge = 60,
		baseChance = 0.55,
		cooldown = 4,
		requiresJob = true,
		eligibility = hasFinanceJob,
		-- LINKAGE: Only triggers if you have legal trouble
		requiresFlags = { legal_trouble = true },
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Tell the truth - whatever happens",
				effects = { Smarts = 3 },
				feedText = "Coming clean...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state.Money = math.max(0, (state.Money or 0) - math.random(50000, 200000))
						state.Flags = state.Flags or {}
						state.Flags.legal_trouble = nil
						state.Flags.ethical_banker = true
						state:AddFeed("âš ï¸ Settled out of court. Reputation damaged but career survives.")
					else
						state.Money = math.max(0, (state.Money or 0) - math.random(300000, 800000))
						state.Flags = state.Flags or {}
						state.Flags.legal_trouble = nil
						state:ModifyStat("Happiness", -15)
						state:AddFeed("âš ï¸ Massive settlement. Wiped out your savings. Hard lesson learned.")
					end
				end,
			},
			{
				text = "Blame it on someone else",
				effects = { Happiness = -10 },
				feedText = "Deflecting...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 30 then
						state.Flags = state.Flags or {}
						state.Flags.legal_trouble = nil
						state:AddFeed("âš ï¸ Somehow got away with it. Colleague took the fall. Can you live with that?")
					else
						state:ModifyStat("Happiness", -20)
						state.Flags = state.Flags or {}
						state.Flags.in_prison = true
						state.PrisonYearsRemaining = math.random(1, 5)
						state.Flags.legal_trouble = nil
						state.CurrentJob = nil
						state:AddFeed("âš ï¸ Perjury charges on top of everything else. Prison time.")
					end
				end,
			},
		},
	},
	
	{
		id = "ib_not_team_player_consequence",
		title = "ğŸ“‹ Performance Review",
		emoji = "ğŸ“‹",
		text = "Your reputation as 'not a team player' is coming back to haunt you. PIP incoming.",
		category = "career_finance",
		weight = 12,
		minAge = 23, maxAge = 45,
		baseChance = 0.5,
		cooldown = 4,
		requiresJob = true,
		eligibility = isInvestmentBanker,
		-- LINKAGE: Only triggers if flagged as not team player
		requiresFlags = { not_team_player = true },
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Accept feedback and change behavior",
				effects = { Happiness = -5, Smarts = 3 },
				feedText = "Swallowing pride...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.not_team_player = nil
					state.Flags.reformed = true
					state:AddFeed("ğŸ“‹ Six months later: 'Remarkable turnaround!' You kept your job.")
				end,
			},
			{
				text = "Push back and defend yourself",
				effects = { Happiness = 5 },
				feedText = "Not going down quietly...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 35 then
						state.Money = (state.Money or 0) + math.random(30000, 100000)
						state.Flags = state.Flags or {}
						state.Flags.not_team_player = nil
						state:AddFeed("ğŸ“‹ Your numbers proved them wrong! PIP rescinded! Respect earned!")
					else
						state:ModifyStat("Happiness", -15)
						state.Flags = state.Flags or {}
						state.Flags.terminated = true
						state.CurrentJob = nil
						state:AddFeed("ğŸ“‹ 'Terminated for performance.' Looking for a new job.")
					end
				end,
			},
			{
				text = "Start job hunting immediately",
				effects = { Smarts = 2 },
				feedText = "Writing on the wall...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state.Money = (state.Money or 0) + math.random(50000, 150000) -- Signing bonus
						state.Flags = state.Flags or {}
						state.Flags.not_team_player = nil
						state:AddFeed("ğŸ“‹ Jumped ship! New firm, fresh start! Signing bonus in hand!")
					else
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ“‹ Still looking. Nobody's hiring right now. Stuck.")
					end
				end,
			},
		},
	},
	
	{
		id = "ib_market_veteran_opportunity",
		title = "ğŸ“Š Market Commentary Request",
		emoji = "ğŸ“Š",
		text = "CNBC wants you as a regular market commentator! TV appearances every week!",
		category = "career_finance",
		weight = 8,
		minAge = 30, maxAge = 65,
		baseChance = 0.4,
		cooldown = 5,
		oneTime = true,
		requiresJob = true,
		eligibility = hasFinanceJob,
		-- LINKAGE: Only if you've proven yourself in market crashes
		requiresFlags = { market_veteran = true },
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Become a TV personality",
				effects = { Happiness = 10 },
				feedText = "Hello, America!",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state.Fame = (state.Fame or 0) + 40
						state.Money = (state.Money or 0) + math.random(100000, 300000)
						state.Flags = state.Flags or {}
						state.Flags.tv_personality = true
						state:AddFeed("ğŸ“Š You're a TV STAR! 'The Finance Guy!' Book deal incoming!")
					else
						state.Fame = (state.Fame or 0) - 10
						state:AddFeed("ğŸ“Š Made a bad call on TV. Went viral for the wrong reasons.")
					end
				end,
			},
			{
				text = "Decline - stay behind the scenes",
				effects = { Happiness = 3 },
				setFlags = { behind_the_scenes = true },
				feedText = "Camera shy.",
				onResolve = function(state)
					state:AddFeed("ğŸ“Š Declined. Your clients appreciate your discretion.")
				end,
			},
		},
	},
	
	{
		id = "ib_crypto_opportunity",
		title = "â‚¿ Crypto Hedge Fund Offer",
		emoji = "â‚¿",
		text = "A new crypto hedge fund is launching. They want YOU to run traditional finance operations!",
		category = "career_finance",
		weight = 5,
		minAge = 25, maxAge = 50,
		baseChance = 0.15, -- LOWERED - rare opportunity
		cooldown = 8, -- INCREASED
		oneTime = true, -- Only once
		requiresJob = true,
		eligibility = hasFinanceJob,
		blockedByFlags = { in_prison = true, crypto_millionaire = true },
		
		choices = {
			{
				text = "Join the crypto revolution",
				effects = { Happiness = 8 },
				feedText = "WAGMI!",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 35 then
						local gains = math.random(1000000, 5000000)
						state.Money = (state.Money or 0) + gains
						state.Fame = (state.Fame or 0) + 25
						state.Flags = state.Flags or {}
						state.Flags.crypto_millionaire = true
						state:AddFeed(string.format("â‚¿ CRYPTO BOOM! $%s in equity! To the moon!", gains))
					elseif roll <= 70 then
						state.Money = (state.Money or 0) + math.random(100000, 400000)
						state:AddFeed("â‚¿ Decent returns. Crypto winter hit but you survived.")
					else
						state:ModifyStat("Happiness", -20)
						state.CurrentJob = nil
						state:AddFeed("â‚¿ Fund collapsed. Regulatory nightmare. Your reputation is in tatters.")
					end
				end,
			},
			{
				text = "Stay in traditional finance",
				effects = { Smarts = 3, Money = 50000 },
				feedText = "Boring is beautiful.",
				onResolve = function(state)
					state:AddFeed("â‚¿ Watched crypto from the sidelines. No FOMO. Steady returns.")
				end,
			},
		},
	},
	
	{
		id = "ib_whistleblower_dilemma",
		title = "ğŸš¨ Major Fraud Discovery",
		emoji = "ğŸš¨",
		text = "You discovered your firm is committing massive fraud. Billions in fake numbers. Do you blow the whistle?",
		category = "career_finance",
		weight = 6,
		minAge = 26, maxAge = 55,
		baseChance = 0.3,
		cooldown = 6,
		oneTime = true,
		requiresJob = true,
		eligibility = isInvestmentBanker,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Report to SEC - do the right thing",
				effects = { Happiness = -10, Smarts = 5 },
				feedText = "Whistleblower...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						local reward = math.random(2000000, 10000000)
						state.Money = (state.Money or 0) + reward
						state.Flags = state.Flags or {}
						state.Flags.whistleblower_hero = true
						state.Flags.blacklisted_wallstreet = true
						state.CurrentJob = nil
						state:AddFeed(string.format("ğŸš¨ WHISTLEBLOWER REWARD! $%s! But you'll never work on Wall Street again.", reward))
					else
						state:ModifyStat("Happiness", 10)
						state.Flags = state.Flags or {}
						state.Flags.whistleblower_hero = true
						state.CurrentJob = nil
						state:AddFeed("ğŸš¨ Did the right thing. No reward. But you saved thousands of investors.")
					end
				end,
			},
			{
				text = "Quietly quit and say nothing",
				effects = { Happiness = -15 },
				feedText = "Not my problem...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					state.CurrentJob = nil
					if roll <= 50 then
						state:AddFeed("ğŸš¨ Left quietly. Years later, the fraud was exposed. You feel guilty.")
					else
						state.Flags = state.Flags or {}
						state.Flags.complicit_in_fraud = true
						state:AddFeed("ğŸš¨ Left but they're investigating everyone. You might get dragged in.")
					end
				end,
			},
			{
				text = "Confront management directly",
				effects = {},
				feedText = "Internal resolution...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 25 then
						state.Money = (state.Money or 0) + math.random(500000, 1500000)
						state.Flags = state.Flags or {}
						state.Flags.management_fixer = true
						state:AddFeed("ğŸš¨ They fixed it quietly. You got a huge bonus to keep quiet.")
					else
						state:ModifyStat("Health", -10)
						state.CurrentJob = nil
						state:AddFeed("ğŸš¨ Fired immediately. 'Restructuring.' Watch your back.")
					end
				end,
			},
		},
	},
	
	{
		id = "ib_mentor_wisdom",
		title = "ğŸ“ MD Shares Career Advice",
		emoji = "ğŸ“",
		text = "Your MD mentor pulls you aside. 'Kid, I've been in this game 30 years. Here's what I've learned...'",
		category = "career_finance",
		weight = 12,
		minAge = 24, maxAge = 40,
		baseChance = 0.45,
		cooldown = 4,
		requiresJob = true,
		eligibility = isInvestmentBanker,
		-- LINKAGE: More likely if you're being mentored
		boostedByFlags = { md_mentee = true },
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Listen carefully - absorb everything",
				effects = { Smarts = 8, Happiness = 5 },
				feedText = "Learning from the master...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.industry_wisdom = true
					state.Flags.mentored = true
					state:AddFeed("ğŸ“ 'Relationships matter more than deals. Never burn bridges.' Wisdom acquired!")
				end,
			},
			{
				text = "Ask about their biggest regret",
				effects = { Smarts = 5, Happiness = 2 },
				feedText = "Getting personal...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.learned_from_others_mistakes = true
					state:AddFeed("ğŸ“ 'I missed my kids growing up. Don't make my mistake.' Deep conversation.")
				end,
			},
		},
	},
}

return InvestmentBankingEvents
