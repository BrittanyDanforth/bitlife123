--[[
	Hacker/Cybersecurity Career Events
	AAA-quality branching career path
	
	Two paths:
	1. White Hat (Legit): Script Kiddie -> Pen Tester -> Security Consultant -> CISO
	2. Black Hat (Criminal): Script Kiddie -> Black Hat -> Elite Hacker -> Cyber Crime Boss
	
	Uses: Hacking minigame for breaches, heist minigame for high-stakes operations
	
	CRITICAL FIX #RVS-11: Premium path blocking for royalty players
]]

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CRITICAL FIX #RVS-HACKER-1: Premium path blocking
-- Black hat hacker events should NOT fire for royalty players
-- (White hat/legit security career can still work for anyone)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function isBlockedForBlackHat(state)
	if not state.Flags then return false end
	local flags = state.Flags
	
	-- If player is already a hacker, allow
	if flags.hacker_discovered or flags.black_hat or flags.elite_hacker then
		return false
	end
	
	-- Block black hat path if player chose royalty path
	if flags.primary_wish_type == "royalty" then return true end
	if flags.is_royalty or flags.royal_birth or flags.dating_royalty then return true end
	if state.RoyalState and state.RoyalState.isRoyal then return true end
	
	return false
end

local events = {
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- DISCOVERY AND ENTRY
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "hacker_discovery",
		emoji = "ðŸ’»",
		title = "Natural Hacker",
		text = "While messing around on the computer, you discover you have a talent for finding security flaws.",
		category = "career_hacker",
		weight = 15, -- CRITICAL FIX: Higher weight for discovery events
		baseChance = 0.4, -- CRITICAL FIX: More likely to trigger
		minAge = 12,
		maxAge = 22,
		oneTime = true,
		requiresStats = { Smarts = 45 }, -- CRITICAL FIX: Lower threshold for accessibility
		blockedByFlags = { hacker_discovered = true },
		choices = {
			{
				index = 1,
				text = "Explore this talent further",
				effects = { Smarts = 5, Happiness = 8 },
				setFlags = { hacker_discovered = true, tech_interest = true },
				feedText = "You dove deep into cybersecurity. A new world opens up!",
				triggerMinigame = "hacking",
				minigameOptions = { codes = 3, time = 45 },
			},
			{
				index = 2,
				text = "Seems illegal, ignore it",
				effects = { Happiness = -2 },
				feedText = "You ignored your hacking curiosity.",
			},
		},
	},

	{
		id = "first_hack",
		emoji = "ðŸ”“",
		title = "First Real Hack",
		text = "You've learned enough to try your first real hack. Your school's network has weak security...",
		category = "career_hacker",
		weight = 10,
		minAge = 14,
		maxAge = 22,
		requiresFlags = { hacker_discovered = true },
		blockedByFlags = { first_hack_done = true },
		requiresStats = { Smarts = 60 },
		choices = {
			{
				index = 1,
				text = "Hack in and change grades",
				effects = { Smarts = 3 },
				feedText = "Time to test your skills!",
				triggerMinigame = "hacking",
				minigameOptions = { codes = 4, time = 40 },
				onResolve = function(state, minigameResult)
					state.Flags = state.Flags or {}
					state.Flags.first_hack_done = true
					if minigameResult and minigameResult.success then
						state.Flags.successful_hacker = true
						state.Flags.criminal_record_risk = true
						state.Stats = state.Stats or {}
						-- CRITICAL FIX: Clamp stats to valid range
						state.Stats.Smarts = math.min(100, (state.Stats.Smarts or 50) + 5)
						if state.AddFeed then
							state:AddFeed("ðŸ”“ You hacked the school! Grades changed. You're a real hacker now.")
						end
					else
						-- Got caught!
						state.Flags.caught_hacking = true
						state.Stats = state.Stats or {}
						-- CRITICAL FIX: Clamp stats to valid range
						state.Stats.Happiness = math.max(0, math.min(100, (state.Stats.Happiness or 50) - 15))
						if state.AddFeed then
							state:AddFeed("ðŸš¨ CAUGHT! School traced it back to you. Suspended!")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Just look around, don't change anything",
				effects = { Smarts = 4 },
				setFlags = { first_hack_done = true, ethical_hacker = true },
				feedText = "You explored but didn't cause harm. White hat instincts!",
			},
			{
				index = 3,
				text = "Report the vulnerability instead",
				effects = { Smarts = 5, Happiness = 5 },
				setFlags = { first_hack_done = true, white_hat_path = true },
				feedText = "You reported the flaw! The school thanked you.",
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- THE CHOICE: WHITE HAT OR BLACK HAT
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "hacker_path_choice",
		emoji = "âš”ï¸",
		title = "The Crossroads",
		text = "Your hacking skills have grown. You've been contacted by both a security firm AND a criminal organization.",
		category = "career_hacker",
		weight = 12,
		minAge = 18,
		maxAge = 30,
		oneTime = true,
		requiresFlags = { first_hack_done = true },
		blockedByFlags = { path_chosen = true },
		requiresStats = { Smarts = 65 },
		choices = {
			{
				index = 1,
				text = "Join the security firm (White Hat)",
				effects = { Happiness = 8, Smarts = 3 },
				setFlags = { path_chosen = true, white_hat = true, employed = true, has_job = true },
				feedText = "You chose the light side. Legal hacking pays well too!",
				onResolve = function(state)
					if state.SetCareer then
						state:SetCareer({
							id = "pen_tester",
							name = "Penetration Tester",
							company = "SecureIT Solutions",
							salary = 95000,
							category = "tech",
						})
					end
				end,
			},
			{
				index = 2,
				text = "Join the criminal organization (Black Hat)",
				effects = { Happiness = 5, Money = 50000 },
				setFlags = { path_chosen = true, black_hat = true, criminal = true, employed = true, has_job = true },
				feedText = "You chose the dark side. The money is incredible...",
				onResolve = function(state)
					if state.SetCareer then
						state:SetCareer({
							id = "black_hat_hacker",
							name = "Black Hat Hacker",
							company = "Underground",
							salary = 200000,
							category = "hacker",
						})
					end
				end,
			},
			{
				index = 3,
				text = "Stay freelance for now",
				effects = { Happiness = 3 },
				setFlags = { freelance_hacker = true, employed = true, has_job = true },
				feedText = "You'll take jobs from both sides. Dangerous game...",
				onResolve = function(state)
					if state.SetCareer then
						state:SetCareer({
							id = "freelance_hacker",
							name = "Freelance Hacker",
							company = "Dark Web",
							salary = 60000,
							category = "hacker",
						})
					end
				end,
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- CRITICAL FIX: FREELANCE TO BLACK HAT PROGRESSION
	-- User complaint: "NO HACKER FUN STUFF THAT LET U BE BLCKHAT"
	-- Freelance hackers need a path to go full black hat!
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "freelance_dark_offer",
		emoji = "ðŸ•¶ï¸",
		title = "Dark Side Calling",
		text = "An underground syndicate has noticed your freelance work. They're offering big money to join them full-time as a Black Hat operative.",
		category = "career_hacker",
		weight = 15, -- Higher weight to trigger more often
		minAge = 20,
		maxAge = 45,
		requiresFlags = { freelance_hacker = true },
		blockedByFlags = { black_hat = true, declined_dark_side = true },
		oneTime = true,
		choices = {
			{
				index = 1,
				text = "ðŸ–¤ Join them - go full Black Hat!",
				effects = { Money = 100000, Happiness = 10 },
				setFlags = { black_hat = true, employed = true, has_job = true },
				feedText = "You've crossed to the dark side!",
				onResolve = function(state)
					-- CRITICAL: Actually assign the Black Hat job!
					state.Flags = state.Flags or {}
					state.Flags.black_hat = true
					state.Flags.freelance_hacker = nil
					state.Flags.criminal = true
					state.Flags.criminal_background = true
					
					-- Set the career explicitly
					state.CurrentJob = {
						id = "black_hat_hacker",
						name = "Black Hat Hacker",
						company = "Underground Syndicate",
						salary = 200000,
						category = "hacker",
					}
					state.Flags.employed = true
					state.Flags.has_job = true
					
					if state.AddFeed then
						state:AddFeed("ðŸ–¤ Welcome to the dark side. You're now a Black Hat Hacker making $200K/year!")
					end
				end,
			},
			{
				index = 2,
				text = "ðŸ’¼ Stay freelance - keep my options open",
				effects = { Happiness = 5 },
				feedText = "You prefer the flexibility of freelancing.",
			},
			{
				index = 3,
				text = "ðŸš« Decline - this is too dangerous",
				effects = { Happiness = -5 },
				setFlags = { declined_dark_side = true },
				feedText = "You turned them down. Hopefully they don't take offense...",
			},
		},
	},

	{
		id = "quick_black_hat_start",
		emoji = "ðŸ’»",
		title = "Underground Opportunity",
		text = "Someone on the dark web saw your coding skills. They're recruiting hackers for a criminal operation. High pay, high risk.",
		category = "career_hacker",
		weight = 12,
		minAge = 18,
		maxAge = 35,
		requiresStats = { Smarts = 55 },
		blockedByFlags = { black_hat = true, white_hat = true, declined_hacking_career = true },
		oneTime = true,
		choices = {
			{
				index = 1,
				text = "ðŸ–¤ Join them as a Black Hat Hacker!",
				effects = { Money = 50000, Happiness = 8 },
				setFlags = { black_hat = true, hacker_discovered = true, first_hack_done = true, path_chosen = true },
				feedText = "You're in the underground now!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.black_hat = true
					state.Flags.hacker_discovered = true
					state.Flags.first_hack_done = true
					state.Flags.path_chosen = true
					state.Flags.criminal = true
					state.Flags.criminal_background = true
					
					-- Set the career explicitly
					state.CurrentJob = {
						id = "black_hat_hacker",
						name = "Black Hat Hacker",
						company = "Dark Web Collective",
						salary = 150000,
						category = "hacker",
					}
					state.Flags.employed = true
					state.Flags.has_job = true
					
					if state.AddFeed then
						state:AddFeed("ðŸ–¤ You're now a Black Hat Hacker! Criminal, but incredibly lucrative.")
					end
				end,
			},
			{
				index = 2,
				text = "ðŸ’¼ Ask if they have legit security work instead",
				effects = { Happiness = 5, Smarts = 3 },
				setFlags = { white_hat = true, hacker_discovered = true, first_hack_done = true, path_chosen = true },
				feedText = "They connected you with a legit security firm.",
				onResolve = function(state)
					state.CurrentJob = {
						id = "pen_tester",
						name = "Penetration Tester",
						company = "CyberShield Security",
						salary = 95000,
						category = "tech",
					}
					state.Flags = state.Flags or {}
					state.Flags.employed = true
					state.Flags.has_job = true
					state.Flags.white_hat = true
					
					if state.AddFeed then
						state:AddFeed("ðŸ’¼ You're now a legit Penetration Tester! Good pay, no jail time.")
					end
				end,
			},
			{
				index = 3,
				text = "ðŸš« This is too risky for me",
				effects = { Happiness = -3 },
				setFlags = { declined_hacking_career = true },
				feedText = "You decided hacking isn't your path.",
			},
		},
	},

	{
		id = "cyber_crime_boss_ascension",
		emoji = "ðŸ‘‘",
		title = "King of the Underground",
		text = "After years of elite hacking, the criminal underworld recognizes you as a legend. You're being offered leadership of a cyber crime empire.",
		category = "career_hacker",
		weight = 8,
		minAge = 30,
		maxAge = 55,
		requiresFlags = { elite_hacker = true },
		blockedByFlags = { cyber_crime_boss = true },
		requiresStats = { Smarts = 85 },
		oneTime = true,
		choices = {
			{
				index = 1,
				text = "ðŸ‘‘ Accept the crown - become a Cyber Crime Boss!",
				effects = { Money = 1000000, Happiness = 20 },
				setFlags = { cyber_crime_boss = true },
				feedText = "You're now a Cyber Crime Boss!",
				onResolve = function(state)
					state.CurrentJob = {
						id = "cyber_crime_boss",
						name = "Cyber Crime Boss",
						company = "International Syndicate",
						salary = 1000000,
						category = "hacker",
					}
					state.Flags = state.Flags or {}
					state.Flags.employed = true
					state.Flags.has_job = true
					state.Flags.cyber_crime_boss = true
					state.Flags.most_wanted = true
					
					if state.AddFeed then
						state:AddFeed("ðŸ‘‘ You are now a CYBER CRIME BOSS! $1M/year but Interpol is watching...")
					end
				end,
			},
			{
				index = 2,
				text = "ðŸï¸ Retire - take your millions and disappear",
				effects = { Happiness = 25 },
				setFlags = { retired_hacker = true },
				feedText = "You retired to a private island. Living the dream!",
				onResolve = function(state)
					state.CurrentJob = nil
					state.Flags = state.Flags or {}
					state.Flags.employed = nil
					state.Flags.has_job = nil
					state.Flags.retired_hacker = true
					state.Flags.black_hat = nil
					state.Flags.elite_hacker = nil
					-- Give a big retirement bonus
					state.Money = (state.Money or 0) + 500000
					
					if state.AddFeed then
						state:AddFeed("ðŸï¸ You retired from hacking with $500K bonus. Enjoying the beach life!")
					end
				end,
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- WHITE HAT PATH EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "corporate_pen_test",
		emoji = "ðŸ”",
		title = "Corporate Penetration Test",
		text = "A Fortune 500 company hired your firm to find vulnerabilities in their systems.",
		category = "career_hacker",
		weight = 10,
		minAge = 20,
		maxAge = 50,
		requiresJob = true,
		requiresFlags = { white_hat = true },
		cooldown = 4, -- CRITICAL FIX #606: Increased from 2 to 4 to prevent spam
		choices = {
			{
				index = 1,
				text = "Hack their systems (legally!)",
				effects = { Happiness = 5 },
				feedText = "Time to find those vulnerabilities!",
				triggerMinigame = "hacking",
				minigameOptions = { codes = 5, time = 35 },
				onResolve = function(state, minigameResult)
					if minigameResult and minigameResult.success then
						state.Money = (state.Money or 0) + 25000
						state.Stats = state.Stats or {}
						-- CRITICAL FIX: Clamp stats to valid range (0-100)
						state.Stats.Smarts = math.min(100, (state.Stats.Smarts or 50) + 3)
						state.Stats.Happiness = math.min(100, (state.Stats.Happiness or 50) + 10)
						state.Flags = state.Flags or {}
						state.Flags.successful_pentests = (state.Flags.successful_pentests or 0) + 1
						if state.AddFeed then
							state:AddFeed("ðŸ”“ You found critical vulnerabilities! Big bonus earned!")
						end
					else
						state.Stats = state.Stats or {}
						-- CRITICAL FIX: Clamp stats to valid range (0-100)
						state.Stats.Happiness = math.max(0, (state.Stats.Happiness or 50) - 5)
						if state.AddFeed then
							state:AddFeed("You couldn't crack their systems. Embarrassing.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Take a cautious approach",
				effects = { Smarts = 2, Money = 5000 },
				feedText = "Methodical work, decent findings.",
			},
		},
	},

	{
		id = "security_consultant_promotion",
		emoji = "ðŸ“ˆ",
		title = "Senior Security Role",
		text = "Your pen testing work has been exceptional. You're being promoted to Security Consultant!",
		category = "career_hacker",
		weight = 8,
		minAge = 24,
		maxAge = 45,
		requiresFlags = { white_hat = true },
		requiresStats = { Smarts = 72 },
		oneTime = true,
		choices = {
			{
				index = 1,
				text = "Accept the promotion!",
				effects = { Happiness = 15, Money = 20000 },
				feedText = "You're now a Security Consultant!",
				onResolve = function(state)
					if state.SetCareer then
						state:SetCareer({
							id = "security_consultant",
							name = "Security Consultant",
							company = "CyberGuard Inc",
							salary = 165000,
							category = "tech",
						})
					end
					state.Flags = state.Flags or {}
					state.Flags.senior_security = true
				end,
			},
			{
				index = 2,
				text = "I prefer hands-on hacking",
				effects = { Happiness = 3, Money = 10000 },
				feedText = "You stayed as a senior pen tester.",
			},
		},
	},

	{
		id = "ciso_opportunity",
		emoji = "ðŸ‘”",
		title = "CISO Opportunity",
		text = "A major corporation wants you as their Chief Information Security Officer!",
		category = "career_hacker",
		weight = 5,
		minAge = 30,
		maxAge = 55,
		requiresFlags = { senior_security = true },
		requiresStats = { Smarts = 80 },
		oneTime = true,
		blockedByFlags = { in_prison = true, incarcerated = true },
		choices = {
			{
				index = 1,
				text = "Accept the CISO role!",
				effects = { Happiness = 20, Money = 100000 },
				setFlags = { ciso = true, executive = true },
				feedText = "You're now a C-level executive! CISO of a Fortune 500!",
				onResolve = function(state)
					if state.SetCareer then
						state:SetCareer({
							id = "ciso",
							name = "Chief Information Security Officer",
							company = "Fortune 500",
							salary = 420000,
							category = "tech",
						})
					end
				end,
			},
			{
				index = 2,
				text = "Start security firm ($50,000)",
				effects = { Money = -50000, Happiness = 10 },
				setFlags = { entrepreneur = true, security_founder = true },
				eligibility = function(state) return (state.Money or 0) >= 50000, "ðŸ’¸ Need $50,000 to start a company" end,
				feedText = "ðŸ¢ Started your own cybersecurity company!",
			},
			{
				index = 3,
				text = "Start consulting ($20,000)",
				effects = { Money = -20000, Happiness = 8 },
				setFlags = { security_consultant = true },
				eligibility = function(state) return (state.Money or 0) >= 20000, "ðŸ’¸ Need $20,000 to start consulting" end,
				feedText = "ðŸ’» Started as a security consultant. Building up!",
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- BLACK HAT PATH EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "bank_heist_hack",
		emoji = "ðŸ¦",
		title = "The Big Score",
		text = "The organization wants you to hack a bank's systems and transfer millions.",
		category = "career_hacker",
		weight = 8,
		minAge = 20,
		maxAge = 45,
		requiresFlags = { black_hat = true },
		cooldown = 5, -- CRITICAL FIX #607: Increased from 3 to 5 to prevent spam
		choices = {
			{
				index = 1,
				text = "Execute the bank hack!",
				effects = { Happiness = 5 },
				feedText = "Millions on the line!",
				triggerMinigame = "hacking",
				minigameOptions = { codes = 6, time = 30 },
				onResolve = function(state, minigameResult)
					if minigameResult and minigameResult.success then
						local payout = math.random(100000, 500000)
						state.Money = (state.Money or 0) + payout
						state.Stats = state.Stats or {}
						-- CRITICAL FIX: Clamp stats to valid range (0-100)
						state.Stats.Happiness = math.min(100, (state.Stats.Happiness or 50) + 15)
						state.Flags = state.Flags or {}
						state.Flags.bank_hacker = true
						state.Flags.heat_level = (state.Flags.heat_level or 0) + 2
						if state.AddFeed then
							state:AddFeed("ðŸ’° JACKPOT! You stole $" .. payout .. " from the bank!")
						end
					else
						-- FBI noticed!
						state.Flags = state.Flags or {}
						state.Flags.fbi_watch = true
						state.Flags.heat_level = (state.Flags.heat_level or 0) + 3
						state.Stats = state.Stats or {}
						-- CRITICAL FIX: Clamp stats to valid range (0-100)
						state.Stats.Happiness = math.max(0, (state.Stats.Happiness or 50) - 10)
						if state.AddFeed then
							state:AddFeed("ðŸš¨ The hack failed! FBI has started investigating!")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Too risky, refuse",
				effects = { Happiness = -5 },
				setFlags = { coward_hacker = true },
				feedText = "You turned down the job. The organization is displeased...",
			},
		},
	},

	{
		id = "ransomware_attack",
		emoji = "â˜ ï¸",
		title = "Ransomware Operation",
		text = "Your organization wants to deploy ransomware against a hospital. Millions at stake.",
		category = "career_hacker",
		weight = 6,
		minAge = 22,
		maxAge = 50,
		requiresFlags = { black_hat = true, bank_hacker = true },
		cooldown = 5, -- CRITICAL FIX #608: Increased from 2 to 5 to prevent spam
		choices = {
			{
				index = 1,
				text = "Deploy the ransomware!",
				effects = { Happiness = -5 },
				feedText = "This is dark... but the money...",
				triggerMinigame = "hacking",
				minigameOptions = { codes = 5, time = 25 },
				onResolve = function(state, minigameResult)
					if minigameResult and minigameResult.success then
						local payout = math.random(500000, 2000000)
						state.Money = (state.Money or 0) + payout
						state.Stats = state.Stats or {}
						-- CRITICAL FIX: Clamp stats to valid range (0-100)
						state.Stats.Happiness = math.max(0, (state.Stats.Happiness or 50) - 10) -- Guilt
						state.Flags = state.Flags or {}
						state.Flags.ransomware_criminal = true
						state.Flags.heat_level = (state.Flags.heat_level or 0) + 5
						state.Flags.most_wanted = true
						if state.AddFeed then
							state:AddFeed("ðŸ’€ Ransomware deployed. $" .. payout .. " extorted. You're a monster now.")
						end
					else
						state.Stats = state.Stats or {}
						-- CRITICAL FIX: Clamp stats to valid range (0-100)
						state.Stats.Health = math.max(0, (state.Stats.Health or 50) - 10)
						if state.AddFeed then
							state:AddFeed("The ransomware failed. Your reputation takes a hit.")
						end
					end
				end,
			},
			{
				index = 2,
				text = "I won't attack a hospital",
				effects = { Happiness = 5 },
				setFlags = { has_ethics = true },
				feedText = "Even criminals have limits. You refused.",
			},
			{
				index = 3,
				text = "Secretly tip off the FBI",
				effects = { Happiness = 10, Smarts = 3 },
				setFlags = { double_agent = true },
				feedText = "You're playing a dangerous game as a double agent...",
			},
		},
	},

	{
		id = "elite_hacker_status",
		emoji = "ðŸ‘¤",
		title = "Elite Status",
		text = "Your hacking exploits have made you legendary in the underground. You're now Elite.",
		category = "career_hacker",
		weight = 6,
		minAge = 25,
		maxAge = 50,
		requiresFlags = { black_hat = true, bank_hacker = true },
		requiresStats = { Smarts = 80 },
		oneTime = true,
		choices = {
			{
				index = 1,
				text = "Embrace my elite status",
				effects = { Happiness = 15, Money = 200000 },
				feedText = "You're now an Elite Hacker. Feared worldwide.",
				onResolve = function(state)
					if state.SetCareer then
						state:SetCareer({
							id = "elite_hacker",
							name = "Elite Hacker",
							company = "Anonymous Collective",
							salary = 500000,
							category = "hacker",
						})
					end
					state.Flags = state.Flags or {}
					state.Flags.elite_hacker = true
				end,
			},
			{
				index = 2,
				text = "Go dark, disappear",
				effects = { Happiness = 5, Money = 100000 },
				setFlags = { ghost = true },
				feedText = "You vanished from the scene. Living in shadows.",
			},
		},
	},

	{
		id = "cyber_crime_boss_rise",
		emoji = "ðŸ’€",
		title = "Rise to Crime Boss",
		text = "The current cyber crime boss wants you to take over the operation.",
		category = "career_hacker",
		weight = 4,
		minAge = 28,
		maxAge = 55,
		requiresFlags = { elite_hacker = true },
		requiresStats = { Smarts = 85 },
		oneTime = true,
		choices = {
			{
				index = 1,
				text = "Take control of the empire",
				effects = { Happiness = 20, Money = 1000000 },
				feedText = "You're now a Cyber Crime Boss!",
				onResolve = function(state)
					if state.SetCareer then
						state:SetCareer({
							id = "cyber_crime_boss",
							name = "Cyber Crime Boss",
							company = "The Syndicate",
							salary = 2000000,
							category = "hacker",
						})
					end
					state.Flags = state.Flags or {}
					state.Flags.crime_boss = true
					state.Flags.most_wanted = true
				end,
			},
		{
			index = 2,
			text = "Go legit - turn yourself in for immunity",
			-- CRITICAL FIX: Remove Money from effects to handle in onResolve with proper validation
			effects = { Happiness = -10 },
			setFlags = { reformed = true, white_hat = true, black_hat = false },
			feedText = "You turned state's witness. New life as a consultant.",
			onResolve = function(state)
				-- CRITICAL FIX: Handle money loss safely - can't lose more than you have
				local forfeiture = math.min(500000, state.Money or 0)
				if forfeiture > 0 then
					state.Money = math.max(0, (state.Money or 0) - forfeiture)
					if state.AddFeed then
						state:AddFeed(string.format("ðŸ’¸ Asset forfeiture: $%d seized by FBI as part of immunity deal.", forfeiture))
					end
				end
				if state.SetCareer then
					state:SetCareer({
						id = "security_consultant",
						name = "Security Consultant",
						company = "FBI Contractor",
						salary = 165000,
						category = "tech",
					})
				end
			end,
		},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- DANGER EVENTS - GETTING CAUGHT
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "fbi_raid",
		emoji = "ðŸš”",
		title = "FBI RAID!",
		text = "The FBI is at your door! They've been tracking your activities!",
		category = "career_hacker",
		weight = 8,
		minAge = 18,
		maxAge = 60,
		requiresFlags = { black_hat = true },
		cooldown = 6, -- CRITICAL FIX #609: Increased from 2 to 6 to prevent spam
		choices = {
			{
				index = 1,
				text = "Try to wipe everything and escape!",
				effects = { Health = -5 },
				feedText = "Quick! Destroy the evidence!",
				triggerMinigame = "hacking",
				minigameOptions = { codes = 4, time = 20 },
				onResolve = function(state, minigameResult)
					if minigameResult and minigameResult.success then
						state.Flags = state.Flags or {}
						state.Flags.escaped_fbi = true
						state.Stats = state.Stats or {}
						-- CRITICAL FIX: Clamp stats to valid range (0-100)
						state.Stats.Happiness = math.min(100, (state.Stats.Happiness or 50) + 10)
						if state.AddFeed then
							state:AddFeed("You wiped everything and escaped! Time to disappear...")
						end
					else
						-- ARRESTED!
						local jailYears = math.random(5, 15)
						state.InJail = true
						state.JailYearsLeft = jailYears
						state.Flags = state.Flags or {}
						state.Flags.in_prison = true
						state.Flags.incarcerated = true
						state.CurrentJob = nil
						state.Flags.employed = nil
						state.Flags.has_job = nil
						if state.AddFeed then
							state:AddFeed("ðŸ”’ ARRESTED! Sentenced to " .. jailYears .. " years for cybercrimes!")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Surrender peacefully",
				effects = { Happiness = -20 },
				feedText = "You cooperated. Might get a reduced sentence.",
				onResolve = function(state)
					local jailYears = math.random(3, 8)
					state.InJail = true
					state.JailYearsLeft = jailYears
					state.Flags = state.Flags or {}
					state.Flags.in_prison = true
					state.Flags.incarcerated = true
					state.CurrentJob = nil
					state.Flags.employed = nil
					state.Flags.has_job = nil
					if state.AddFeed then
						state:AddFeed("ðŸ”’ Arrested. " .. jailYears .. " years. Cooperation reduced sentence.")
					end
				end,
			},
		},
	},

	{
		id = "rival_hackers_threat",
		emoji = "âš ï¸",
		title = "Rivals Closing In",
		text = "A rival hacking group is trying to expose you and take you down. They want you out of business.",
		category = "career_hacker",
		weight = 5,
		minAge = 22,
		maxAge = 60,
		requiresFlags = { elite_hacker = true },
		blockedByFlags = { in_prison = true, incarcerated = true },
		cooldown = 5, -- CRITICAL FIX #610: Increased from 2 to 5 to prevent spam
		choices = {
			{
				index = 1,
				text = "Hack them first!",
				effects = { Smarts = 3 },
				feedText = "Best defense is a good offense!",
				triggerMinigame = "hacking",
				minigameOptions = { codes = 6, time = 25 },
				onResolve = function(state, minigameResult)
					if minigameResult and minigameResult.success then
						state.Money = (state.Money or 0) + 100000
						state.Flags = state.Flags or {}
						state.Flags.eliminated_rivals = true
						if state.AddFeed then
							state:AddFeed("You exposed them to the FBI. Rivals eliminated!")
						end
					else
						state.Stats = state.Stats or {}
						-- CRITICAL FIX: Clamp stats to valid range (0-100)
						state.Stats.Health = math.max(0, (state.Stats.Health or 50) - 15)
						if state.AddFeed then
							state:AddFeed("Your hack failed. They got your personal info and doxed you!")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Go into hiding ($10,000)",
				effects = { Money = -10000, Happiness = -12 },
				setFlags = { in_hiding = true },
				eligibility = function(state) return (state.Money or 0) >= 10000, "ðŸ’¸ Need $10,000 to go into hiding" end,
				feedText = "ðŸƒ Went off the grid. Living rough but safe.",
			},
			{
				index = 3,
				text = "Pay them off ($50,000)",
				effects = { Money = -50000 },
				eligibility = function(state) return (state.Money or 0) >= 50000, "ðŸ’¸ Need $50,000 for payoff" end,
				feedText = "ðŸ’° Paid $50K to make them go away.",
				onResolve = function(state)
					if math.random() < 0.7 then
						if state.AddFeed then state:AddFeed("ðŸ’° They accepted the payoff. For now...") end
					else
						if state.ModifyStat then state:ModifyStat("Health", -10) end
						if state.AddFeed then state:AddFeed("ðŸ’° Payoff wasn't enough. They came after you!") end
					end
				end,
			},
		},
	},
}

return events
