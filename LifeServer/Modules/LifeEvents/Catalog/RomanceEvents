local RANDOM = Random.new()

-- Generate random first name
local function randomName(gender)
	local maleNames = {"James", "Michael", "David", "John", "Alex", "Ryan", "Chris", "Brandon", "Tyler", "Jake"}
	local femaleNames = {"Emma", "Olivia", "Sophia", "Ava", "Isabella", "Mia", "Emily", "Grace", "Lily", "Chloe"}
	local names = (gender == "male") and maleNames or femaleNames
	return names[RANDOM:NextInteger(1, #names)]
end

local events = {
	{
		id = "highschool_crush",
		emoji = "üíò",
		title = "Hallway Crush",
		text = "You keep running into the same person between classes. Ask them out?",
		category = "romance",
		weight = 7,
		minAge = 14,
		maxAge = 19,
		blockedByFlags = { in_prison = true },
		-- CRITICAL FIX: Use requiresSingle to prevent if already dating
		requiresSingle = true,
		choices = {
			{
				index = 1,
				text = "Shoot your shot",
				effects = { Happiness = 4 },
				-- CRITICAL FIX: Use consistent flag name 'has_partner' and 'dating'
				setFlags = { has_partner = true, dating = true },
				feedText = "You started dating your crush!",
				onResolve = function(state)
					local crushName = randomName(state.Gender == "male" and "female" or "male")
					-- CRITICAL FIX: Set partner in the proper location (state.Relationships.partner)
					-- so that requiresPartner checks work correctly
					state.Relationships = state.Relationships or {}
					state.Relationships.partner = {
						id = "partner",
						name = crushName,
						type = "romance",
						role = "Partner",
						relationship = 65,
						age = (state.Age or 16) + RANDOM:NextInteger(-2, 2),
						gender = state.Gender == "male" and "female" or "male",
						alive = true,
					}
					if state.AddFeed then
						state:AddFeed("üíï You started dating " .. crushName .. "!")
					end
				end,
			},
			{
				index = 2,
				text = "Stay quiet",
				effects = { Happiness = -2 },
				feedText = "You stayed quiet about your feelings.",
			},
		},
	},
	{
		id = "adulthood_engagement",
		emoji = "üíç",
		title = "Perfect Proposal Moment",
		text = "Your partner hints they'd say yes if you popped the question.",
		category = "romance",
		weight = 5,
		minAge = 21,
		-- CRITICAL FIX: Use requiresPartner (which checks state.Relationships.partner)
		requiresPartner = true,
		requiresFlags = { dating = true },
		choices = {
			{
				index = 1,
				text = "Propose",
				effects = { Happiness = 6, Money = -3000 },
				setFlags = { engaged = true },
				feedText = "You proposed and they said yes!",
				onResolve = function(state)
					-- Update partner role to Fianc√©/Fianc√©e
					if state.Relationships and state.Relationships.partner then
						local partnerGender = state.Relationships.partner.gender or "female"
						state.Relationships.partner.role = (partnerGender == "female") and "Fianc√©e" or "Fianc√©"
						if state.AddFeed then
							state:AddFeed("üíç " .. state.Relationships.partner.name .. " said YES!")
						end
					end
				end,
			},
			{
				index = 2,
				text = "Not yet",
				effects = { Happiness = -3 },
				feedText = "You decided to wait a bit longer.",
			},
		},
	},
}

return events
