--[[
	NBA Professional Basketball Career Events
	AAA-quality events for basketball career progression
	
	Career Path:
	1. Youth basketball (likes_sports flag from childhood)
	2. High school varsity (plays_basketball, varsity_athlete flags)
	3. College basketball (college_basketball flag via scholarship event)
	4. NBA Draft (nba_declared -> nba_player flags)
	5. NBA Rookie â†’ Starter â†’ Star â†’ Superstar â†’ Legend
	
	CRITICAL: Easier path if player made good early life choices!
	Early flags that help: plays_basketball, varsity_athlete, state_champion,
	basketball_prodigy, college_basketball, scholarship_likely
]]

local NBACareerEvents = {}

local RANDOM = Random.new()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- HELPER FUNCTIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- CRITICAL FIX #NBA-1: Check if player made incompatible life choices
-- If player explicitly chose academic/tech/creative path, block sports discovery
local function hasIncompatibleLifeChoices(state)
	if not state or not state.Flags then return false end
	local f = state.Flags
	-- Block if player explicitly chose non-sports paths in childhood
	if f.academic_focus and not f.likes_sports then return true end
	if f.nerd_group and not f.athletic_focus then return true end
	if f.gamer_kid and not f.likes_sports then return true end
	if f.tech_interest and not f.athletic_focus then return true end
	if f.computer_enthusiast and not f.likes_sports then return true end
	if f.artistic_focus and not f.likes_sports then return true end
	if f.hates_sports then return true end
	if f.prefers_studying then return true end
	if f.bookworm and not f.likes_sports then return true end
	if f.coding_prodigy then return true end
	if f.hacker_discovered then return true end
	-- Block if already committed to another career path
	if f.nfl_player or f.nfl_declared then return true end -- Can't do both NBA and NFL
	if f.actor or f.famous_actor then return true end
	if f.rapper or f.famous_rapper then return true end
	if f.streamer or f.famous_streamer then return true end
	if f.in_mob then return true end
	if f.is_royalty then return true end
	return false
end

local function hasBasketballBackground(state)
	if not state or not state.Flags then return false end
	local f = state.Flags
	-- CRITICAL FIX: Only count ACTUAL basketball experience, not just generic likes_sports
	return f.plays_basketball or f.basketball_prodigy or f.college_basketball or f.varsity_basketball
end

-- CRITICAL FIX #NBA-2: Check if player has STRONG basketball background (for draft)
local function hasStrongBasketballBackground(state)
	if not state or not state.Flags then return false end
	local f = state.Flags
	-- Must have played basketball AND achieved something notable
	if not f.plays_basketball and not f.college_basketball then return false end
	local achievements = 0
	if f.varsity_athlete or f.varsity_basketball then achievements = achievements + 1 end
	if f.basketball_prodigy then achievements = achievements + 1 end
	if f.basketball_talent then achievements = achievements + 1 end
	if f.state_champion then achievements = achievements + 1 end
	if f.march_madness_star then achievements = achievements + 1 end
	if f.college_poy then achievements = achievements + 1 end
	if f.college_mvp then achievements = achievements + 1 end
	if f.national_champion_college then achievements = achievements + 1 end
	if f.aau_player then achievements = achievements + 1 end
	if f.scholarship_likely then achievements = achievements + 1 end
	return achievements >= 2 -- Need at least 2 achievements
end

local function isActiveNBAPlayer(state)
	if not state then return false end
	if state.Flags and state.Flags.nba_retired then return false end
	if not state.CurrentJob then return false end
	local jobId = (state.CurrentJob.id or ""):lower()
	local hasNBAJob = jobId:find("nba") or jobId:find("basketball")
	local hasFlag = state.Flags and state.Flags.nba_player
	return hasNBAJob or hasFlag
end

local function isNBAStar(state)
	if not state or not state.Flags then return false end
	return state.Flags.nba_allstar or state.Flags.nba_mvp or state.Flags.nba_champion
end

local function getNBAYearsPlayed(state)
	if not state or not state.Flags then return 0 end
	local draftAge = state.Flags.nba_draft_age or 21
	return math.max(0, (state.Age or 0) - draftAge)
end

local function getDraftBonus(state)
	local bonus = 0
	if not state or not state.Flags then return bonus end
	local f = state.Flags
	
	-- Early life basketball choices
	if f.plays_basketball then bonus = bonus + 20 end
	if f.varsity_athlete then bonus = bonus + 15 end
	if f.state_champion then bonus = bonus + 20 end
	if f.basketball_prodigy then bonus = bonus + 30 end
	if f.college_basketball then bonus = bonus + 25 end
	if f.scholarship_likely then bonus = bonus + 15 end
	if f.sports_legend then bonus = bonus + 25 end
	if f.college_mvp then bonus = bonus + 20 end
	if f.march_madness_star then bonus = bonus + 15 end
	
	-- Health matters for athletes
	if (state.Health or 0) >= 90 then bonus = bonus + 15
	elseif (state.Health or 0) >= 80 then bonus = bonus + 10
	elseif (state.Health or 0) >= 70 then bonus = bonus + 5
	elseif (state.Health or 0) < 60 then bonus = bonus - 20 end
	
	-- Penalty for late starters without background
	if (state.Age or 18) > 22 and not hasBasketballBackground(state) then
		bonus = bonus - 50
	end
	
	return bonus
end

-- Block conflicting career paths
local function isEligibleForNBA(state)
	if not state then return false end
	local f = state.Flags or {}
	
	-- Block conflicting premium paths
	if f.is_royalty or f.in_mob then return false end
	if state.RoyalState and state.RoyalState.isRoyal then return false end
	if state.MobState and state.MobState.inMob then return false end
	
	-- Block if in prison
	if f.in_prison or state.InJail then return false end
	
	return true
end

-- Format large money values
local function formatMoney(amount)
	if amount >= 1000000000 then
		return string.format("$%.1fB", amount / 1000000000)
	elseif amount >= 1000000 then
		return string.format("$%.1fM", amount / 1000000)
	elseif amount >= 1000 then
		return string.format("$%.0fK", amount / 1000)
	end
	return "$" .. tostring(amount)
end

NBACareerEvents.events = {
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- YOUTH/HIGH SCHOOL BASKETBALL EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- CRITICAL FIX: SPORTS INTEREST DISCOVERY EVENT
	-- This event SETS the likes_sports flag - it's an entry point!
	-- CRITICAL FIX #NBA-3: Now properly blocked if player made incompatible choices!
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "nba_interest_discovery",
		title = "ğŸ€ Basketball Catches Your Eye!",
		emoji = "ğŸ€",
		text = "You see some kids playing basketball at the park. The game looks exciting! The ball swishes through the net - nothing but net!",
		category = "career_nba",
		weight = 15, -- REDUCED from 25 - not everyone discovers basketball
		minAge = 6, maxAge = 11,
		baseChance = 0.30, -- REDUCED from 0.55 - must be more selective
		oneTime = true,
		-- CRITICAL FIX: Block if player already chose a different path!
		blockedByFlags = { 
			academic_focus = true, nerd_group = true, gamer_kid = true, 
			tech_interest = true, hates_sports = true, computer_enthusiast = true,
			artistic_focus = true, bookworm = true, coding_prodigy = true,
			hacker_discovered = true, prefers_studying = true,
			plays_football = true, -- Already chose football path
		},
		eligibility = function(state)
			if not isEligibleForNBA(state) then return false end
			if hasIncompatibleLifeChoices(state) then return false end
			-- CRITICAL FIX: Don't trigger if already playing football
			if state.Flags and state.Flags.plays_football then return false end
			return true
		end,
		
		choices = {
			{
				text = "ğŸ€ I want to try!",
				effects = { Health = 3, Happiness = 5 },
				feedText = "You grab the ball...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.likes_sports = true
					state.Flags.athletic_focus = true
					
					local roll = RANDOM:NextInteger(1, 100)
					if roll <= 35 then
						state.Flags.plays_basketball = true
						state.Flags.basketball_talent = true
						state:ModifyStat("Health", 7)
						state:ModifyStat("Happiness", 10)
						state:AddFeed("ğŸ€ NATURAL TALENT! Your first shot went in! The older kids are impressed!")
					elseif roll <= 70 then
						state.Flags.plays_basketball = true
						state:ModifyStat("Health", 5)
						state:ModifyStat("Happiness", 8)
						state:AddFeed("ğŸ€ You're hooked! Basketball is SO FUN! You want to play every day!")
					else
						state:ModifyStat("Health", 3)
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ€ It's harder than it looks but you want to get better!")
					end
				end,
			},
			{
				text = "Just watch for now",
				effects = { Happiness = 2 },
				feedText = "You watch the game...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.likes_sports = true
					state:AddFeed("ğŸ€ Basketball looks cool! Maybe you'll try it someday!")
				end,
			},
		},
	},
	{
		id = "youth_basketball_camp",
		title = "ğŸ€ Basketball Camp Opportunity",
		emoji = "ğŸ€",
		text = "There's an elite basketball camp this summer. Top college and even NBA scouts attend! It costs money but could be life-changing.",
		category = "career_nba",
		weight = 14, -- REDUCED from 20 - must have some interest first
		minAge = 10, maxAge = 16,
		baseChance = 0.28, -- REDUCED from 0.40
		oneTime = true,
		-- CRITICAL FIX #NBA-4: Block if player chose incompatible paths
		blockedByFlags = { 
			hates_sports = true, academic_focus = true, nerd_group = true,
			gamer_kid = true, tech_interest = true, artistic_focus = true,
			coding_prodigy = true, computer_enthusiast = true,
		},
		eligibility = function(state)
			if not isEligibleForNBA(state) then return false end
			if hasIncompatibleLifeChoices(state) then return false end
			-- CRITICAL FIX: Require SOME prior sports interest or athletic disposition
			if not state.Flags then return false end
			local hasInterest = state.Flags.likes_sports or state.Flags.plays_basketball 
				or state.Flags.athletic_focus or state.Flags.sporty 
				or state.Flags.adventurous_spirit or state.Flags.natural_athlete
				or state.Flags.playground_champion
			return hasInterest
		end,
		
		choices = {
			{
				text = "ğŸ€ Sign me up! ($2,000)",
				effects = { Money = -2000, Health = 5 },
				feedText = "Training hard at camp!",
				eligibility = function(state) return (state.Money or 0) >= 2000 end,
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					
					if roll <= 30 then
						state.Flags.basketball_prodigy = true
						state.Flags.camp_standout = true
						state:ModifyStat("Health", 10)
						state:AddFeed("ğŸ€ YOU DOMINATED! Scouts are calling you a PRODIGY! College offers incoming!")
					elseif roll <= 70 then
						state.Flags.basketball_talent = true
						state.Flags.plays_basketball = true
						state:ModifyStat("Health", 5)
						state:AddFeed("ğŸ€ Great showing! You've definitely got skills. Keep working!")
					else
						state.Flags.plays_basketball = true
						state:AddFeed("ğŸ€ Tough competition but good experience. You learned a lot!")
					end
				end,
			},
			{
				text = "Too expensive, skip it",
				effects = {},
				feedText = "Maybe next year...",
			},
		},
	},
	
	{
		id = "basketball_aau_team",
		title = "ğŸ€ AAU Team Tryout",
		emoji = "ğŸ€",
		text = "The local AAU basketball team is holding tryouts. AAU is where future NBA players get noticed by college scouts!",
		category = "career_nba",
		weight = 12, -- REDUCED slightly
		minAge = 13, maxAge = 17,
		baseChance = 0.22, -- REDUCED slightly
		oneTime = true,
		-- CRITICAL FIX #NBA-5: Block if player chose incompatible paths
		blockedByFlags = { 
			hates_sports = true, academic_focus = true, nerd_group = true,
			gamer_kid = true, tech_interest = true, coding_prodigy = true,
		},
		eligibility = function(state)
			if not isEligibleForNBA(state) then return false end
			if hasIncompatibleLifeChoices(state) then return false end
			-- CRITICAL FIX: Must have ACTUAL basketball experience
			return state.Flags and state.Flags.plays_basketball
		end,
		
		choices = {
			{
				text = "ğŸ€ Try out!",
				effects = { Health = 3 },
				feedText = "Showing what I've got!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					local bonus = 0
					if state.Flags.basketball_prodigy then bonus = 40 end
					if state.Flags.plays_basketball then bonus = bonus + 20 end
					if state.Flags.basketball_talent then bonus = bonus + 15 end
					if (state.Health or 0) >= 70 then bonus = bonus + 10 end
					
					if roll + bonus >= 50 then
						state.Flags.aau_player = true
						state.Flags.plays_basketball = true
						state.Flags.varsity_potential = true
						state:ModifyStat("Happiness", 15)
						state:AddFeed("ğŸ€ YOU MADE THE AAU TEAM! Now you'll play against the best talent in the region!")
					else
						state.Flags.plays_basketball = true
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ€ Didn't make the cut this time. Keep practicing for next year!")
					end
				end,
			},
			{
				text = "Not interested",
				effects = {},
				feedText = "Basketball isn't for me.",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.declined_basketball = true
					-- CRITICAL FIX: Track declining sports
					state.Flags.sports_declines = (state.Flags.sports_declines or 0) + 1
					if state.Flags.sports_declines >= 2 then
						state.Flags.hates_sports = true
					end
					state:AddFeed("ğŸ€ Basketball isn't really your thing.")
				end,
			},
		},
	},
	
	{
		id = "basketball_state_championship",
		title = "ğŸ† State Championship Game!",
		emoji = "ğŸ†",
		text = "Your high school team made it to the STATE CHAMPIONSHIP! The gym is packed, scouts are watching, and the whole town is counting on you!",
		category = "career_nba",
		weight = 10, -- REDUCED from 12
		minAge = 15, maxAge = 18,
		baseChance = 0.18, -- REDUCED from 0.20
		cooldown = 3, -- INCREASED from 2
		-- CRITICAL FIX #NBA-8: Block if chose football or incompatible paths
		blockedByFlags = { 
			hates_sports = true, plays_football = true, varsity_football = true,
			college_football = true, nfl_player = true,
		},
		eligibility = function(state)
			if not isEligibleForNBA(state) then return false end
			if hasIncompatibleLifeChoices(state) then return false end
			-- Must be playing basketball specifically
			return state.Flags and state.Flags.plays_basketball and 
				(state.Flags.varsity_athlete or state.Flags.varsity_basketball)
		end,
		
		choices = {
			{
				text = "ğŸ”¥ Time to be a LEGEND!",
				effects = { Health = -3 },
				feedText = "Leave it all on the court!",
				triggerMinigame = "mash",
				onResolve = function(state, minigameResult)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					local bonus = (minigameResult and minigameResult.success) and 35 or 0
					if state.Flags.basketball_prodigy then bonus = bonus + 25 end
					
					if roll + bonus >= 55 then
						state.Flags.state_champion = true
						state.Flags.basketball_legend = true
						state.Flags.scholarship_likely = true
						state.Fame = math.min(100, (state.Fame or 0) + 20)
						state:ModifyStat("Happiness", 30)
						state:AddFeed("ğŸ† STATE CHAMPIONS!!! You dropped 30 points! Scouts are FLOODING your inbox! LEGEND!")
					else
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ† Lost in the championship. Heartbreaking. You played hard but came up short.")
					end
				end,
			},
			{
				text = "Just play my game",
				effects = {},
				feedText = "Stay focused...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					
					if roll <= 40 then
						state.Flags.state_champion = true
						state:ModifyStat("Happiness", 20)
						state:AddFeed("ğŸ† STATE CHAMPIONS! Team effort! What a feeling!")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ† Tough loss but you held your head high. Next year!")
					end
				end,
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- COLLEGE BASKETBALL EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "college_basketball_scholarship",
		title = "ğŸ“ College Basketball Scholarship!",
		emoji = "ğŸ“",
		text = "A college basketball program is offering you a FULL SCHOLARSHIP! Free education AND a chance to develop for the NBA!",
		category = "career_nba",
		weight = 12, -- REDUCED slightly
		minAge = 17, maxAge = 18,
		baseChance = 0.25, -- REDUCED from 0.35 - scholarships are competitive
		oneTime = true,
		eligibility = function(state)
			if not isEligibleForNBA(state) then return false end
			if hasIncompatibleLifeChoices(state) then return false end
			if state.Flags and state.Flags.college_basketball then return false end
			if not state.Flags then return false end
			-- CRITICAL FIX #NBA-7: Require ACTUAL basketball achievement
			-- Must have played basketball AND made varsity/AAU OR have prodigy status
			local playedBasketball = state.Flags.plays_basketball
			local hasVarsityOrAAU = state.Flags.varsity_basketball or state.Flags.aau_player or
				(state.Flags.varsity_athlete and state.Flags.plays_basketball)
			local isProdigy = state.Flags.basketball_prodigy or state.Flags.state_champion
			return playedBasketball and (hasVarsityOrAAU or isProdigy)
		end,
		blockedByFlags = { 
			college_basketball = true, hates_sports = true, 
			academic_focus = true, chose_academics_over_basketball = true,
		},
		
		choices = {
			{
				text = "ğŸ€ Accept! Ball is life!",
				effects = { Happiness = 20, Health = 5 },
				feedText = "College basketball here I come!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.college_basketball = true
					state.Flags.college_athlete = true
					state.Flags.scholarship_athlete = true
					state.Education = "University (Athletic Scholarship)"
					
					-- Better schools for prodigies
					local schools = { "State University", "Tech University", "Central College" }
					if state.Flags.basketball_prodigy or state.Flags.state_champion then
						schools = { "Duke", "Kentucky", "North Carolina", "Kansas", "UCLA" }
					end
					local school = schools[RANDOM:NextInteger(1, #schools)]
					state.Flags.college_name = school
					
					state:AddFeed(string.format("ğŸ“ Full scholarship to %s! Path to the NBA begins!", school))
				end,
			},
			{
				text = "ğŸ“š Focus on academics instead",
				effects = { Smarts = 10 },
				feedText = "Education first...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.chose_academics_over_basketball = true
					state:AddFeed("ğŸ“š Passed on basketball to focus on studies. Different path!")
				end,
			},
		},
	},
	
	{
		id = "march_madness_tournament",
		title = "ğŸ€ MARCH MADNESS!",
		emoji = "ğŸ€",
		text = "It's the NCAA Tournament - MARCH MADNESS! Your college team made it! This is where legends are made and NBA scouts watch EVERY game!",
		category = "career_nba",
		weight = 10, -- REDUCED from 12
		minAge = 18, maxAge = 22,
		baseChance = 0.20, -- REDUCED from 0.25
		cooldown = 2, -- INCREASED from 1
		-- CRITICAL FIX #NBA-9: Block conflicting paths
		blockedByFlags = { 
			college_football = true, nfl_player = true, hates_sports = true,
		},
		eligibility = function(state)
			if not isEligibleForNBA(state) then return false end
			if hasIncompatibleLifeChoices(state) then return false end
			return state.Flags and state.Flags.college_basketball
		end,
		
		choices = {
			{
				text = "ğŸ”¥ CARRY THE TEAM!",
				effects = { Health = -5 },
				feedText = "Tournament time!",
				triggerMinigame = "mash",
				onResolve = function(state, minigameResult)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					local bonus = (minigameResult and minigameResult.success) and 30 or 0
					if state.Flags.basketball_prodigy then bonus = bonus + 20 end
					
					if roll + bonus >= 70 then
						-- Deep run or championship!
						state.Flags.march_madness_star = true
						state.Flags.tournament_hero = true
						state.Fame = math.min(100, (state.Fame or 0) + 30)
						state:ModifyStat("Happiness", 35)
						
						if roll + bonus >= 90 then
							state.Flags.national_champion_college = true
							state:AddFeed("ğŸ€ NATIONAL CHAMPIONS!!! You scored 35 in the Final! TOURNAMENT MVP! NBA HERE YOU COME!")
						else
							state:AddFeed("ğŸ€ FINAL FOUR! You averaged 25 points! EVERYONE knows your name now! NBA scouts are FIGHTING over you!")
						end
					elseif roll + bonus >= 40 then
						state.Flags.tournament_experience = true
						state:AddFeed("ğŸ€ Made it to the Sweet 16! Good showing. Scouts took notice!")
						state:ModifyStat("Happiness", 10)
					else
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ€ First round exit... Buzzer beater loss. Devastating but it's not over.")
					end
				end,
			},
			{
				text = "Play within the system",
				effects = {},
				feedText = "Team basketball...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					if roll <= 35 then
						state.Flags.tournament_experience = true
						state:AddFeed("ğŸ€ Made the Sweet 16! Solid team performance!")
						state:ModifyStat("Happiness", 15)
					else
						state:AddFeed("ğŸ€ Early exit but gained valuable experience.")
					end
				end,
			},
		},
	},
	
	{
		id = "college_player_of_year",
		title = "ğŸ… Player of the Year Voting!",
		emoji = "ğŸ…",
		text = "You're being considered for National Player of the Year! This is the highest honor in college basketball!",
		category = "career_nba",
		weight = 8,
		minAge = 19, maxAge = 22,
		baseChance = 0.12,
		oneTime = true,
		eligibility = function(state)
			if not isEligibleForNBA(state) then return false end
			if not state.Flags then return false end
			return state.Flags.college_basketball and (state.Flags.march_madness_star or state.Flags.basketball_prodigy)
		end,
		
		choices = {
			{
				text = "Await the results...",
				effects = {},
				feedText = "Fingers crossed...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					local bonus = 0
					if state.Flags.march_madness_star then bonus = 30 end
					if state.Flags.basketball_prodigy then bonus = bonus + 20 end
					if state.Flags.national_champion_college then bonus = bonus + 25 end
					
					if roll + bonus >= 60 then
						state.Flags.college_poy = true
						state.Flags.college_mvp = true
						state.Fame = math.min(100, (state.Fame or 0) + 25)
						state:ModifyStat("Happiness", 30)
						state:AddFeed("ğŸ… NATIONAL PLAYER OF THE YEAR!!! You're the BEST college player in America! Lottery pick GUARANTEED!")
					else
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ… Finished top 5 in voting. Still elite company! NBA awaits!")
					end
				end,
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- NBA DRAFT EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "nba_draft_declaration",
		title = "ğŸ€ Declare for NBA Draft?",
		emoji = "ğŸ€",
		text = "NBA scouts have been watching you closely. Your agent thinks you could get drafted. But the odds are extremely LONG - only the ELITE make it. This is a LIFE-CHANGING decision!",
		question = "Do you declare for the NBA Draft?",
		category = "career_nba",
		weight = 10, -- REDUCED weight - very selective
		minAge = 19, maxAge = 22,
		baseChance = 0.14, -- REDUCED from 0.18 - even harder
		oneTime = true,
		eligibility = function(state)
			if not isEligibleForNBA(state) then return false end
			if hasIncompatibleLifeChoices(state) then return false end
			if not state.Flags then return false end
			if state.Flags.nba_declared or state.Flags.nba_player then return false end
			
			-- CRITICAL FIX #NBA-6: Much stricter requirements!
			-- Must have FULL basketball pipeline: played basketball -> varsity/AAU -> college
			local hasPlayedBasketball = state.Flags.plays_basketball
			local hasCompetitive = state.Flags.varsity_basketball or state.Flags.varsity_athlete or state.Flags.aau_player
			local hasCollegeBasketball = state.Flags.college_basketball
			
			-- Must have the full pipeline
			if not hasPlayedBasketball or not hasCollegeBasketball then return false end
			
			-- CRITICAL: Must have MULTIPLE standout achievements (at least 2)
			if not hasStrongBasketballBackground(state) then return false end
			
			return true
		end,
		blockedByFlags = { 
			in_prison = true, injured = true, nba_declared = true, nba_player = true,
			academic_focus = true, nerd_group = true, gamer_kid = true, hates_sports = true,
		},
		
		choices = {
			{
				text = "ğŸ€ YES! I'm ready for the NBA!",
				effects = { Happiness = 10 },
				feedText = "Declaring for the draft!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.nba_declared = true
					state.Flags.nba_draft_age = state.Age or 21
					
					local roll = RANDOM:NextInteger(1, 100)
					local bonus = getDraftBonus(state)
					
					-- CRITICAL FIX: MUCH harder thresholds - NBA is elite, most don't make it
					if roll + bonus >= 90 then
						-- LOTTERY PICK! - Very rare
						local pickNum = RANDOM:NextInteger(1, 14)
						local signBonus = RANDOM:NextInteger(2000000, 8000000) -- REDUCED from 8-20M
						local salary = RANDOM:NextInteger(1500000, 4000000) -- REDUCED from 5-12M
						
						state.Money = (state.Money or 0) + signBonus
						state.Fame = math.min(100, (state.Fame or 0) + 50)
						state:ModifyStat("Happiness", 40)
						state.Flags.nba_player = true
						state.Flags.nba_lottery_pick = true
						state.Flags.nba_first_round = true
						state.Flags.nba_draft_pick = pickNum
						
						state.CurrentJob = {
							id = "nba_player",
							name = "NBA Player",
							company = "NBA Team",
							salary = salary,
							category = "sports",
						}
						
						state:AddFeed(string.format("ğŸ€ LOTTERY PICK #%d!!! %s signing bonus! %s/year! YOU'RE AN NBA PLAYER!!!", pickNum, formatMoney(signBonus), formatMoney(salary)))
						
					elseif roll + bonus >= 75 then
						-- First round (non-lottery) - Hard
						local pickNum = RANDOM:NextInteger(15, 30)
						local signBonus = RANDOM:NextInteger(800000, 2500000) -- REDUCED from 2-6M
						local salary = RANDOM:NextInteger(800000, 2000000) -- REDUCED from 2-4M
						
						state.Money = (state.Money or 0) + signBonus
						state.Fame = math.min(100, (state.Fame or 0) + 30)
						state:ModifyStat("Happiness", 30)
						state.Flags.nba_player = true
						state.Flags.nba_first_round = true
						state.Flags.nba_draft_pick = pickNum
						
						state.CurrentJob = {
							id = "nba_player",
							name = "NBA Player",
							company = "NBA Team",
							salary = salary,
							category = "sports",
						}
						
						state:AddFeed(string.format("ğŸ€ FIRST ROUND PICK #%d! %s bonus! You're in the NBA!", pickNum, formatMoney(signBonus)))
						
					elseif roll + bonus >= 55 then
						-- Second round - Achievable
						local pickNum = RANDOM:NextInteger(31, 60)
						local signBonus = RANDOM:NextInteger(50000, 400000) -- REDUCED from 200K-1M
						local salary = RANDOM:NextInteger(500000, 900000) -- REDUCED from 800K-1.5M
						
						state.Money = (state.Money or 0) + signBonus
						state.Fame = math.min(100, (state.Fame or 0) + 15)
						state:ModifyStat("Happiness", 20)
						state.Flags.nba_player = true
						state.Flags.nba_second_round = true
						state.Flags.nba_draft_pick = pickNum
						
						state.CurrentJob = {
							id = "nba_player",
							name = "NBA Player",
							company = "NBA Team",
							salary = salary,
							category = "sports",
						}
						
						state:AddFeed(string.format("ğŸ€ Second round #%d! Not lottery but YOU'RE IN THE NBA! Prove yourself!", pickNum))
						
					elseif roll + bonus >= 35 then
						-- Undrafted but signed two-way
						state.Flags.nba_player = true
						state.Flags.nba_undrafted = true
						state:ModifyStat("Happiness", 10)
						state.Fame = math.min(100, (state.Fame or 0) + 5)
						
						state.CurrentJob = {
							id = "nba_player",
							name = "NBA Player (Two-Way)",
							company = "NBA Team",
							salary = 400000, -- Reduced minimum
							category = "sports",
						}
						
						state:AddFeed("ğŸ€ Undrafted but signed a two-way contract! Long shot but you're in!")
					else
						-- MOST COMMON: Not drafted - NBA dream over
						state:ModifyStat("Happiness", -15)
						state.Flags.nba_dream_setback = true
						state:AddFeed("ğŸ€ Went undrafted. Heartbreaking. The NBA dream is over. Maybe G-League or coaching?")
					end
				end,
			},
			{
				text = "ğŸ“š Stay in college - not ready yet",
				effects = { Smarts = 5, Happiness = 5 },
				feedText = "More development time...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.stayed_college_extra = true
					state:AddFeed("ğŸ“š Staying in college to develop more. Smart long-term move!")
				end,
			},
			{
				text = "ğŸŒ Try overseas leagues",
				effects = { Happiness = 5 },
				feedText = "International basketball...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.overseas_basketball = true
					local salary = RANDOM:NextInteger(100000, 400000) -- Reduced
					state.CurrentJob = {
						id = "overseas_basketball",
						name = "International Basketball Player",
						company = "EuroLeague Team",
						salary = salary,
						category = "sports",
					}
					state:AddFeed(string.format("ğŸŒ Signed overseas for %s! Building experience for NBA shot later!", formatMoney(salary)))
				end,
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- NBA ROOKIE YEAR EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "nba_rookie_of_year",
		title = "ğŸŒŸ Rookie of the Year Race!",
		emoji = "ğŸŒŸ",
		text = "Your rookie season has been INCREDIBLE! You're in the running for ROOKIE OF THE YEAR!",
		category = "career_nba",
		weight = 10,
		minAge = 19, maxAge = 24,
		baseChance = 0.15,
		oneTime = true,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			if not state.Flags then return false end
			local yearsPlayed = getNBAYearsPlayed(state)
			return yearsPlayed <= 1 and state.Flags.nba_player and not state.Flags.nba_roy
		end,
		
		choices = {
			{
				text = "Check the results!",
				effects = {},
				feedText = "Waiting for announcement...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					local bonus = 0
					if state.Flags.nba_lottery_pick then bonus = 30 end
					if state.Flags.nba_first_round then bonus = bonus + 15 end
					if state.Flags.college_poy then bonus = bonus + 20 end
					
					if roll + bonus >= 55 then
						state.Flags.nba_roy = true
						state.Fame = math.min(100, (state.Fame or 0) + 25)
						local bonus_money = RANDOM:NextInteger(500000, 2000000)
						state.Money = (state.Money or 0) + bonus_money
						state:ModifyStat("Happiness", 30)
						state:AddFeed(string.format("ğŸŒŸ ROOKIE OF THE YEAR!!! Best newcomer in the NBA! %s endorsement bonus!", formatMoney(bonus_money)))
					else
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸŒŸ Finished top 3 in ROY voting. Great rookie year! The future is bright!")
					end
				end,
			},
		},
	},
	
	{
		id = "nba_rookie_struggles",
		title = "ğŸ˜° NBA Growing Pains",
		emoji = "ğŸ˜°",
		text = "The NBA is HARD. The speed, the athleticism, the travel... you're struggling to adjust to the professional level.",
		category = "career_nba",
		weight = 12,
		minAge = 19, maxAge = 25,
		baseChance = 0.25,
		cooldown = 3,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			local yearsPlayed = getNBAYearsPlayed(state)
			return yearsPlayed <= 2
		end,
		
		choices = {
			{
				text = "ğŸ’ª Work harder in practice",
				effects = { Health = -5 },
				feedText = "Grinding...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					if roll <= 70 then
						state.Flags.hard_worker = true
						state:ModifyStat("Happiness", 10)
						state:AddFeed("ğŸ’ª The extra work is paying off! Coach noticed your improvement!")
					else
						state:ModifyStat("Happiness", -5)
						state:ModifyStat("Health", -5)
						state:AddFeed("ğŸ’ª Working hard but progress is slow. Stay patient!")
					end
				end,
			},
			{
				text = "ğŸ® Get a personal trainer",
				effects = { Money = -50000 },
				feedText = "Investing in myself...",
				eligibility = function(state) return (state.Money or 0) >= 50000 end,
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.personal_trainer = true
					state:ModifyStat("Health", 10)
					state:ModifyStat("Happiness", 10)
					state:AddFeed("ğŸ‹ï¸ Personal trainer is helping! Your game is elevating!")
				end,
			},
			{
				text = "Just keep playing through it",
				effects = {},
				feedText = "Experience is the teacher...",
				onResolve = function(state)
					state:AddFeed("ğŸ€ Learning on the job. Every game is a lesson.")
				end,
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- NBA CAREER EVENTS (CORE)
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "nba_allstar_selection",
		title = "â­ NBA All-Star Voting!",
		emoji = "â­",
		text = "All-Star voting has concluded. Your name has been in the conversation all season...",
		category = "career_nba",
		weight = 10,
		minAge = 21, maxAge = 38,
		baseChance = 0.15,
		cooldown = 2,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			if not state.Flags or not state.Flags.nba_player then return false end
			-- Need some credentials
			local yearsPlayed = getNBAYearsPlayed(state)
			return yearsPlayed >= 2 and (state.Flags.nba_first_round or (state.Fame or 0) >= 40)
		end,
		blockedByFlags = { injured = true, nba_retired = true },
		
		choices = {
			{
				text = "Check the results...",
				effects = {},
				feedText = "Moment of truth...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					local bonus = 0
					if state.Flags.nba_lottery_pick then bonus = 25 end
					if state.Flags.nba_first_round then bonus = bonus + 15 end
					if (state.Fame or 0) >= 70 then bonus = bonus + 20 end
					if state.Flags.nba_allstar then bonus = bonus + 30 end
					
					if roll + bonus >= 55 then
						state.Flags.nba_allstar = true
						state.Flags.nba_allstar_count = (state.Flags.nba_allstar_count or 0) + 1
						state.Fame = math.min(100, (state.Fame or 0) + 20)
						local bonusMoney = RANDOM:NextInteger(200000, 600000)
						state.Money = (state.Money or 0) + bonusMoney
						
						local count = state.Flags.nba_allstar_count
						if count >= 10 then
							state.Flags.nba_legend = true
							state:AddFeed(string.format("â­ %dx ALL-STAR!!! LEGENDARY STATUS! %s bonus!", count, formatMoney(bonusMoney)))
						else
							state:AddFeed(string.format("â­ ALL-STAR #%d! You're among the NBA's elite! %s bonus!", count, formatMoney(bonusMoney)))
						end
						state:ModifyStat("Happiness", 25)
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("â­ Didn't make All-Star this year. Keep grinding for next season!")
					end
				end,
			},
		},
	},
	
	{
		id = "nba_championship_playoffs",
		title = "ğŸ† NBA PLAYOFFS!",
		emoji = "ğŸ†",
		text = "Your team made the PLAYOFFS! This is what the regular season was all about. Win or go home!",
		category = "career_nba",
		weight = 12,
		minAge = 20, maxAge = 40,
		baseChance = 0.20,
		cooldown = 2,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			return state.Flags and state.Flags.nba_player
		end,
		blockedByFlags = { injured = true, nba_retired = true },
		
		choices = {
			{
				text = "ğŸ”¥ Time to dominate!",
				effects = { Health = -5 },
				feedText = "Playoff mode activated!",
				triggerMinigame = "mash",
				onResolve = function(state, minigameResult)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					local bonus = (minigameResult and minigameResult.success) and 25 or 0
					if state.Flags.nba_allstar then bonus = bonus + 20 end
					if state.Flags.nba_champion then bonus = bonus + 15 end
					
					if roll + bonus >= 75 then
						-- Made Finals!
						state.Flags.nba_finals_appearance = true
						state:ModifyStat("Happiness", 20)
						state:AddFeed("ğŸ† NBA FINALS!!! Your team is playing for the CHAMPIONSHIP!")
						
						-- Finals outcome
						local finalsRoll = RANDOM:NextInteger(1, 100) + bonus
						if finalsRoll >= 60 then
							state.Flags.nba_champion = true
							state.Flags.nba_rings = (state.Flags.nba_rings or 0) + 1
							state.Fame = 100
							local prize = RANDOM:NextInteger(3000000, 12000000)
							state.Money = (state.Money or 0) + prize
							state:ModifyStat("Happiness", 40)
							local rings = state.Flags.nba_rings
							state:AddFeed(string.format("ğŸ† NBA CHAMPION!!! RING #%d!!! %s bonus! PARADE TIME!!!", rings, formatMoney(prize)))
						else
							state:ModifyStat("Happiness", -15)
							state:AddFeed("ğŸ† Lost in the Finals. So close... that one will haunt you.")
						end
					elseif roll + bonus >= 45 then
						state.Flags.playoff_experience = true
						state:AddFeed("ğŸ† Conference Finals! Great run but came up short. Next year!")
						state:ModifyStat("Happiness", 10)
					else
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ† First round exit. Disappointing end to the season.")
					end
				end,
			},
			{
				text = "Stay calm, play smart",
				effects = {},
				feedText = "Playoff experience...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					if roll <= 30 then
						state.Flags.playoff_experience = true
						state:AddFeed("ğŸ† Made it to the second round! Solid playoff performance!")
						state:ModifyStat("Happiness", 10)
					else
						state:AddFeed("ğŸ† Early playoff exit. Learn from it and come back stronger.")
					end
				end,
			},
		},
	},
	
	{
		id = "nba_mvp_race",
		title = "ğŸ… NBA MVP Voting!",
		emoji = "ğŸ…",
		text = "You're in the running for NBA MVP! Your stats this season have been HISTORIC. The whole league is watching!",
		category = "career_nba",
		weight = 6,
		minAge = 23, maxAge = 35,
		baseChance = 0.08,
		cooldown = 2,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			if not state.Flags or not state.Flags.nba_player then return false end
			return state.Flags.nba_allstar or (state.Flags.nba_first_round and (state.Fame or 0) >= 60)
		end,
		blockedByFlags = { injured = true, nba_retired = true },
		
		choices = {
			{
				text = "My numbers speak for themselves",
				effects = {},
				feedText = "Awaiting the results...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					local bonus = 0
					if state.Flags.nba_allstar then bonus = 25 end
					if state.Flags.nba_lottery_pick then bonus = bonus + 15 end
					if (state.Fame or 0) >= 85 then bonus = bonus + 20 end
					if state.Flags.nba_mvp then bonus = bonus + 20 end
					
					if roll + bonus >= 65 then
						state.Flags.nba_mvp = true
						state.Flags.nba_mvp_count = (state.Flags.nba_mvp_count or 0) + 1
						state.Fame = 100
						local mvpBonus = RANDOM:NextInteger(8000000, 20000000)
						state.Money = (state.Money or 0) + mvpBonus
						state:ModifyStat("Happiness", 40)
						
						local count = state.Flags.nba_mvp_count
						if count >= 3 then
							state.Flags.nba_goat_conversation = true
							state:AddFeed(string.format("ğŸ… %dx NBA MVP!!! GOAT CONVERSATION!!! %s bonus!", count, formatMoney(mvpBonus)))
						elseif count >= 2 then
							state:AddFeed(string.format("ğŸ… BACK-TO-BACK MVP!!! You're UNSTOPPABLE! %s bonus!", formatMoney(mvpBonus)))
						else
							state:AddFeed(string.format("ğŸ… NBA MVP!!! Most Valuable Player! BEST IN THE WORLD! %s!", formatMoney(mvpBonus)))
						end
					else
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ… Top 3 in MVP voting. Elite season! Just missed the trophy.")
					end
				end,
			},
		},
	},
	
	{
		id = "nba_contract_negotiation",
		title = "ğŸ’° Contract Negotiation",
		emoji = "ğŸ’°",
		text = "Your contract is up. Teams are evaluating your worth. Time to negotiate!",
		category = "career_nba",
		weight = 12,
		minAge = 23, maxAge = 36,
		baseChance = 0.20,
		cooldown = 4,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			return state.Flags and state.Flags.nba_player
		end,
		blockedByFlags = { nba_retired = true },
		
		choices = {
			{
				text = "ğŸ’° Demand max money!",
				effects = {},
				feedText = "Show me the money!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					local bonus = 0
					if state.Flags.nba_allstar then bonus = 35 end
					if state.Flags.nba_mvp then bonus = bonus + 50 end
					if state.Flags.nba_champion then bonus = bonus + 25 end
					if state.Flags.nba_lottery_pick then bonus = bonus + 15 end
					
					local years = RANDOM:NextInteger(3, 5)
					local totalValue, perYear
					
					if roll + bonus >= 75 then
						totalValue = RANDOM:NextInteger(180000000, 280000000)
						perYear = math.floor(totalValue / years)
						state.Flags.nba_supermax = true
						state:AddFeed(string.format("ğŸ’° SUPERMAX!!! %s over %d years! GENERATIONAL WEALTH!", formatMoney(totalValue), years))
						state:ModifyStat("Happiness", 35)
					elseif roll + bonus >= 50 then
						totalValue = RANDOM:NextInteger(80000000, 150000000)
						perYear = math.floor(totalValue / years)
						state:AddFeed(string.format("ğŸ’° Great contract! %s over %d years!", formatMoney(totalValue), years))
						state:ModifyStat("Happiness", 20)
					else
						totalValue = RANDOM:NextInteger(25000000, 70000000)
						perYear = math.floor(totalValue / years)
						state:AddFeed(string.format("ğŸ’° Decent offer: %s over %d years. Prove your worth!", formatMoney(totalValue), years))
						state:ModifyStat("Happiness", 5)
					end
					
					state.Money = (state.Money or 0) + perYear
					if state.CurrentJob then state.CurrentJob.salary = perYear end
				end,
			},
			{
				text = "ğŸ† Take less for championship team",
				effects = {},
				feedText = "Rings over money...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.team_player = true
					state.Flags.ring_chaser = true
					local salary = RANDOM:NextInteger(10000000, 25000000)
					state.Money = (state.Money or 0) + salary
					if state.CurrentJob then state.CurrentJob.salary = salary end
					state:ModifyStat("Happiness", 10)
					state:AddFeed(string.format("ğŸ’° Took %s/year to join a contender. CHAMPIONSHIP OR BUST!", formatMoney(salary)))
				end,
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- NBA INJURIES & SETBACKS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "nba_injury_scare",
		title = "ğŸ¥ Injury Scare!",
		emoji = "ğŸ¥",
		text = "You went down awkwardly during a game! The training staff is rushing to check on you...",
		category = "career_nba",
		weight = 10,
		minAge = 19, maxAge = 40,
		baseChance = 0.18,
		cooldown = 3,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			return state.Flags and state.Flags.nba_player
		end,
		blockedByFlags = { nba_retired = true },
		
		choices = {
			{
				text = "Stay positive, wait for MRI",
				effects = {},
				feedText = "Praying it's nothing serious...",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					
					if roll <= 50 then
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ¥ Just a minor sprain! Week-to-week. You'll be back soon!")
					elseif roll <= 80 then
						state.Flags.injured = true
						state.Flags.missed_games = RANDOM:NextInteger(10, 30)
						state:ModifyStat("Health", -15)
						state:ModifyStat("Happiness", -15)
						state:AddFeed("ğŸ¥ Significant injury. Out 2-3 months. Focus on rehab!")
					else
						state.Flags.injured = true
						state.Flags.major_injury = true
						state.Flags.missed_games = RANDOM:NextInteger(40, 82)
						state:ModifyStat("Health", -30)
						state:ModifyStat("Happiness", -25)
						state:AddFeed("ğŸ¥ TORN ACL! Season over. Long road to recovery ahead...")
					end
				end,
			},
		},
	},
	
	{
		id = "nba_comeback_story",
		title = "ğŸ’ª Injury Comeback!",
		emoji = "ğŸ’ª",
		text = "You've been grinding through rehab. Tonight is your COMEBACK game! The arena is going CRAZY for you!",
		category = "career_nba",
		weight = 10,
		minAge = 20, maxAge = 40,
		baseChance = 0.30,
		oneTime = false,
		cooldown = 3,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			return state.Flags and (state.Flags.injured or state.Flags.major_injury)
		end,
		
		choices = {
			{
				text = "ğŸ”¥ Show them I'm BACK!",
				effects = { Health = 5 },
				feedText = "Comeback kid!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.injured = nil
					state.Flags.major_injury = nil
					state.Flags.overcame_injury = true
					state:ModifyStat("Happiness", 25)
					state:ModifyStat("Health", 15)
					state.Fame = math.min(100, (state.Fame or 0) + 10)
					state:AddFeed("ğŸ’ª COMEBACK GAME! 25 points! Standing ovation! YOU'RE BACK BABY!")
				end,
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- NBA ENDORSEMENTS & BUSINESS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "nba_shoe_deal",
		title = "ğŸ‘Ÿ Shoe Deal Offer!",
		emoji = "ğŸ‘Ÿ",
		text = "A major shoe company wants to sign you to an endorsement deal! They might even give you your own signature shoe!",
		category = "career_nba",
		weight = 10,
		minAge = 19, maxAge = 38,
		baseChance = 0.15,
		cooldown = 5,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			if not state.Flags or not state.Flags.nba_player then return false end
			return state.Flags.nba_allstar or state.Flags.nba_first_round or (state.Fame or 0) >= 50
		end,
		
		choices = {
			{
				text = "ğŸ‘Ÿ Sign with Nike",
				effects = {},
				feedText = "Just Do It!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local dealValue = RANDOM:NextInteger(5000000, 50000000)
					if state.Flags.nba_allstar then dealValue = dealValue * 2 end
					if state.Flags.nba_mvp then dealValue = dealValue * 3 end
					
					state.Money = (state.Money or 0) + dealValue
					state.Flags.nike_athlete = true
					state.Flags.shoe_deal = true
					state.Fame = math.min(100, (state.Fame or 0) + 15)
					
					if state.Flags.nba_allstar then
						state.Flags.signature_shoe = true
						state:AddFeed(string.format("ğŸ‘Ÿ NIKE DEAL! %s! You're getting your own SIGNATURE SHOE!", formatMoney(dealValue)))
					else
						state:AddFeed(string.format("ğŸ‘Ÿ Nike endorsement! %s! Wearing the Swoosh!", formatMoney(dealValue)))
					end
					state:ModifyStat("Happiness", 20)
				end,
			},
			{
				text = "ğŸ‘Ÿ Sign with Adidas",
				effects = {},
				feedText = "Impossible is Nothing!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local dealValue = RANDOM:NextInteger(4000000, 40000000)
					if state.Flags.nba_allstar then dealValue = dealValue * 2 end
					
					state.Money = (state.Money or 0) + dealValue
					state.Flags.adidas_athlete = true
					state.Flags.shoe_deal = true
					state.Fame = math.min(100, (state.Fame or 0) + 12)
					state:AddFeed(string.format("ğŸ‘Ÿ Adidas deal! %s! Three stripes for life!", formatMoney(dealValue)))
					state:ModifyStat("Happiness", 18)
				end,
			},
			{
				text = "Decline for now",
				effects = {},
				feedText = "Not ready yet...",
			},
		},
	},
	
	{
		id = "nba_media_controversy",
		title = "ğŸ“± Social Media Drama!",
		emoji = "ğŸ“±",
		text = "Something you said in an interview is going VIRAL! The media is blowing it out of proportion!",
		category = "career_nba",
		weight = 8,
		minAge = 19, maxAge = 42,
		baseChance = 0.15,
		cooldown = 3,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			return state.Flags and state.Flags.nba_player and (state.Fame or 0) >= 30
		end,
		
		choices = {
			{
				text = "ğŸ“± Apologize publicly",
				effects = {},
				feedText = "Damage control...",
				onResolve = function(state)
					state:ModifyStat("Happiness", -5)
					state:AddFeed("ğŸ“± Issued an apology. Most fans understood. Crisis averted!")
				end,
			},
			{
				text = "ğŸ”¥ Double down on it!",
				effects = {},
				feedText = "Standing my ground!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local roll = RANDOM:NextInteger(1, 100)
					if roll <= 40 then
						state.Flags.controversial = true
						state.Fame = math.min(100, (state.Fame or 0) + 15)
						state:ModifyStat("Happiness", 10)
						state:AddFeed("ğŸ”¥ Fans LOVE your authenticity! Your brand just got stronger!")
					else
						state.Fame = math.max(0, (state.Fame or 0) - 10)
						state:ModifyStat("Happiness", -15)
						state:AddFeed("ğŸ“± Backlash is intense. Lost some endorsement opportunities...")
					end
				end,
			},
		},
	},

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- NBA RETIREMENT & LEGACY
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "nba_retirement_decision",
		title = "ğŸ€ Time to Retire?",
		emoji = "ğŸ€",
		text = "The game is getting harder. Your body aches every morning. Maybe it's time to hang it up...",
		category = "career_nba",
		weight = 12,
		minAge = 34, maxAge = 44,
		baseChance = 0.30,
		cooldown = 2,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			return state.Flags and state.Flags.nba_player and not state.Flags.nba_retired
		end,
		blockedByFlags = { nba_retired = true },
		
		choices = {
			{
				text = "ğŸ€ Play one more year (don't retire)",
				effects = { Health = -8 },
				feedText = "Not done yet!",
				onResolve = function(state)
					local roll = RANDOM:NextInteger(1, 100)
					if roll <= 40 then
						state:ModifyStat("Happiness", 10)
						state:AddFeed("ğŸ€ Still competitive! Proved the doubters wrong! Playing another season.")
					else
						state:ModifyStat("Health", -10)
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ€ The body is betraying you. Playing through pain for one more year...")
					end
				end,
			},
			{
				text = "ğŸ¤ RETIRE - End my NBA career",
				effects = { Happiness = 20 },
				feedText = "What a career!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.nba_retired = true
					state.Flags.retired_athlete = true
					-- CRITICAL FIX: Also set generic retired flag so main system recognizes retirement
					state.Flags.retired = true
					state.Flags.happily_retired = true
					state.Fame = math.min(100, (state.Fame or 0) + 25)
					
					-- Calculate and store pension based on NBA career earnings
					local lastSalary = state.CurrentJob and state.CurrentJob.salary or 2000000
					local yearsPlayed = state.Flags.nba_draft_age and ((state.Age or 30) - state.Flags.nba_draft_age) or 10
					local pensionPercent = math.min(0.50, 0.25 + (yearsPlayed * 0.02)) -- 25-50% based on years
					state.Flags.pension_amount = math.floor(lastSalary * pensionPercent)
					
					local rings = state.Flags.nba_rings or 0
					local mvps = state.Flags.nba_mvp_count or 0
					local allstars = state.Flags.nba_allstar_count or 0
					
					if rings >= 4 or mvps >= 3 then
						state.Flags.nba_goat = true
						state.Flags.hall_of_fame_lock = true
						state:AddFeed(string.format("ğŸ€ LEGENDARY CAREER! %d rings, %dx MVP, %dx All-Star! GOAT STATUS! Pension: $%s/year", rings, mvps, allstars, formatMoney(state.Flags.pension_amount)))
					elseif rings >= 2 or mvps >= 1 or allstars >= 5 then
						state.Flags.hall_of_fame_lock = true
						state:AddFeed(string.format("ğŸ€ AMAZING CAREER! %d ring(s), %dx MVP, %dx All-Star! Hall of Fame LOCK! Pension: $%s/year", rings, mvps, allstars, formatMoney(state.Flags.pension_amount)))
					elseif rings >= 1 or allstars >= 3 then
						state:AddFeed(string.format("ğŸ€ Great career! %d ring(s), %dx All-Star! Pension: $%s/year", rings, allstars, formatMoney(state.Flags.pension_amount)))
					else
						state:AddFeed(string.format("ğŸ€ Solid NBA career. You made it! Pension: $%s/year", formatMoney(state.Flags.pension_amount)))
					end
					
					-- CRITICAL: Clear current job to stop salary payments
					state.CurrentJob = nil
					state.Flags.employed = nil
					state.Flags.has_job = nil
					state:ModifyStat("Happiness", 30)
				end,
			},
		},
	},
	
	{
		id = "nba_hall_of_fame",
		title = "ğŸ† Hall of Fame Induction!",
		emoji = "ğŸ†",
		text = "You've been selected for the BASKETBALL HALL OF FAME! The ultimate honor for any basketball player!",
		category = "career_nba",
		weight = 8,
		minAge = 38, maxAge = 70,
		baseChance = 0.25,
		oneTime = true,
		eligibility = function(state)
			if not state.Flags then return false end
			return state.Flags.nba_retired and state.Flags.hall_of_fame_lock and not state.Flags.hall_of_fame_inducted
		end,
		
		choices = {
			{
				text = "ğŸ¤ Give an emotional speech",
				effects = { Happiness = 30 },
				feedText = "Lifetime achievement!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.hall_of_fame_inducted = true
					state.Fame = 100
					state:AddFeed("ğŸ† HALL OF FAME INDUCTED!!! Your legacy is IMMORTAL! Thank you speech had everyone in tears!")
				end,
			},
		},
	},
	
	{
		id = "nba_jersey_retirement",
		title = "ğŸ½ Jersey Retirement Ceremony!",
		emoji = "ğŸ½",
		text = "Your former team wants to retire your jersey number! Your number will hang in the rafters FOREVER!",
		category = "career_nba",
		weight = 8,
		minAge = 35, maxAge = 70,
		baseChance = 0.30,
		oneTime = true,
		eligibility = function(state)
			if not state.Flags then return false end
			return state.Flags.nba_retired and (state.Flags.nba_allstar or state.Flags.nba_champion) and not state.Flags.jersey_retired
		end,
		
		choices = {
			{
				text = "Attend the ceremony",
				effects = { Happiness = 25 },
				feedText = "Forever honored!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.jersey_retired = true
					state.Fame = math.min(100, (state.Fame or 0) + 20)
					state:AddFeed("ğŸ½ JERSEY RETIRED! Your number hangs in the rafters forever! Standing ovation from the crowd!")
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- NBA MILESTONE EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "nba_scoring_milestone",
		title = "ğŸ“Š Career Scoring Milestone!",
		emoji = "ğŸ“Š",
		text = "You just reached a MAJOR scoring milestone! The basketball world is celebrating your achievement!",
		category = "career_nba",
		weight = 8,
		minAge = 25, maxAge = 42,
		baseChance = 0.12,
		cooldown = 4,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			local yearsPlayed = getNBAYearsPlayed(state)
			return yearsPlayed >= 5 and state.Flags and state.Flags.nba_player
		end,
		
		choices = {
			{
				text = "Celebrate with teammates!",
				effects = { Happiness = 20 },
				feedText = "Historic achievement!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					local milestones = { "10,000 points", "15,000 points", "20,000 points", "25,000 points", "30,000 points" }
					local milestone = milestones[RANDOM:NextInteger(1, #milestones)]
					state.Flags.scoring_milestone = true
					state.Fame = math.min(100, (state.Fame or 0) + 15)
					state:AddFeed(string.format("ğŸ“Š %s career points! Historic achievement! Your name is in the record books!", milestone))
				end,
			},
		},
	},
	
	{
		id = "nba_triple_double",
		title = "ğŸ”¥ TRIPLE-DOUBLE!",
		emoji = "ğŸ”¥",
		text = "You just recorded a TRIPLE-DOUBLE! Points, rebounds, AND assists all in double digits! Complete player!",
		category = "career_nba",
		weight = 10,
		minAge = 19, maxAge = 40,
		baseChance = 0.12,
		cooldown = 2,
		eligibility = function(state)
			if not isActiveNBAPlayer(state) then return false end
			return state.Flags and state.Flags.nba_player
		end,
		
		choices = {
			{
				text = "That's how you play!",
				effects = { Happiness = 15 },
				feedText = "Complete performance!",
				onResolve = function(state)
					state.Flags = state.Flags or {}
					state.Flags.triple_double_count = (state.Flags.triple_double_count or 0) + 1
					local count = state.Flags.triple_double_count
					state.Fame = math.min(100, (state.Fame or 0) + 5)
					
					if count >= 50 then
						state.Flags.triple_double_king = true
						state:AddFeed(string.format("ğŸ”¥ TRIPLE-DOUBLE #%d!!! You're a TRIPLE-DOUBLE MACHINE! Elite company!", count))
					else
						state:AddFeed(string.format("ğŸ”¥ Triple-double #%d! Stuffing the stat sheet!", count))
					end
				end,
			},
		},
	},
}

return NBACareerEvents
