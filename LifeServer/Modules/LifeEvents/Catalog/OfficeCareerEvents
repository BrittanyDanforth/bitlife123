--[[
	Office Career Events
	Events for general corporate/office jobs
	All events use randomized outcomes - NO god mode
	
	Covers: Data Entry, Secretary, HR, Management, Marketing, Accounting, etc.
]]

local OfficeCareerEvents = {}

-- CRITICAL FIX: Helper function to check if player is in an entertainment/celebrity career
-- These players should NOT see generic office events
local function isEntertainmentCareer(state)
	if not state.CurrentJob then return false end
	local jobId = (state.CurrentJob.id or ""):lower()
	local jobName = (state.CurrentJob.name or ""):lower()
	local jobCat = (state.CurrentJob.category or ""):lower()
	
	-- CRITICAL FIX: Block ALL entertainment-related categories
	if jobCat == "entertainment" or jobCat == "celebrity" or jobCat == "fame" or 
	   jobCat == "sports" or jobCat == "music" or jobCat == "acting" or
	   jobCat == "racing" or jobCat == "gaming" then
		return true
	end
	
	-- CRITICAL FIX: Check for isFameCareer flag on job
	if state.CurrentJob.isFameCareer then
		return true
	end
	
	-- Check specific job IDs/names for entertainment careers
	local entertainmentKeywords = {
		"influencer", "streamer", "youtuber", "content_creator", "tiktoker",
		"actor", "actress", "movie_star", "celebrity", "model", "supermodel",
		"rapper", "musician", "singer", "dj", "producer_music",
		"athlete", "player", "football", "basketball", "baseball", "soccer", "mma",
		"host", "anchor", "presenter", "comedian", "performer"
	}
	
	for _, keyword in ipairs(entertainmentKeywords) do
		if jobId:find(keyword) or jobName:find(keyword) then
			return true
		end
	end
	
	-- Check flags
	if state.Flags then
		if state.Flags.isInfluencer or state.Flags.isStreamer or state.Flags.isRapper or
		   state.Flags.isAthlete or state.Flags.isActor or state.Flags.isCelebrity then
			return true
		end
	end
	
	return false
end

-- CRITICAL FIX: Helper function to check if player has an office/corporate job
local function hasOfficeJob(state)
	if not state.CurrentJob then return false end
	
	-- CRITICAL: Exclude entertainment careers
	if isEntertainmentCareer(state) then return false end
	
	local jobId = (state.CurrentJob.id or ""):lower()
	local jobCat = (state.CurrentJob.category or ""):lower()
	
	-- Check categories
	if jobCat == "office" or jobCat == "finance" or jobCat == "corporate" or 
	   jobCat == "admin" or jobCat == "business" then
		return true
	end
	
	-- Check specific job IDs
	local officeKeywords = {
		"manager", "secretary", "assistant", "clerk", "admin", "hr", "human_resources",
		"accountant", "analyst", "consultant", "coordinator", "receptionist",
		"executive", "director", "supervisor", "office", "corporate"
	}
	
	for _, keyword in ipairs(officeKeywords) do
		if jobId:find(keyword) then
			return true
		end
	end
	
	return false
end

OfficeCareerEvents.events = {
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- GENERAL OFFICE EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "office_morning_commute",
		title = "Morning Commute",
		emoji = "ğŸš—",
		textVariants = {
			"The morning commute is brutal today!",
			"Traffic is terrible on the way to work!",
			"Your commute hits a snag this morning.",
		},
		text = "The morning commute is brutal today!",
		question = "How does it go?",
		minAge = 18, maxAge = 70,
		baseChance = 0.5,
		cooldown = 3,
		category = "career_office",
		requiresJob = true,
		eligibility = hasOfficeJob, -- CRITICAL FIX: Use proper eligibility check
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Leave extra early",
				effects = {},
				feedText = "You beat the traffic...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Happiness", 3)
						state:AddFeed("ğŸš— Made it on time! Even got coffee first!")
					elseif roll <= 85 then
						state:ModifyStat("Happiness", 1)
						state:AddFeed("ğŸš— Still got stuck in traffic. But not late!")
					else
						state:ModifyStat("Happiness", -2)
						state:AddFeed("ğŸš— Unexpected road closure! Still late!")
					end
				end,
			},
			{
				text = "Work from home today",
				effects = {},
				feedText = "You message your boss...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", 5)
						state:ModifyStat("Health", 2)
						state:AddFeed("ğŸš— Remote work approved! Productive AND comfortable!")
					else
						state:ModifyStat("Happiness", -3)
						state:AddFeed("ğŸš— Boss said no. Had to go in anyway. Ugh.")
					end
				end,
			},
		},
	},
	{
		id = "office_meeting_marathon",
		title = "Meeting Marathon",
		emoji = "ğŸ“…",
		textVariants = {
			"Your calendar is packed with meetings today!",
			"Back-to-back meetings scheduled all day!",
			"Meeting overload incoming!",
		},
		text = "Your calendar is packed with meetings today!",
		question = "How do you survive?",
		minAge = 18, maxAge = 70,
		baseChance = 0.6,
		cooldown = 2,
		category = "career_office",
		requiresJob = true,
		eligibility = hasOfficeJob, -- CRITICAL FIX: Use proper eligibility check
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Participate actively",
				effects = {},
				feedText = "You engage in every meeting...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:ModifyStat("Smarts", 3)
						state.Flags = state.Flags or {}
						state.Flags.noticed_by_management = true
						state:AddFeed("ğŸ“… Great input! Leadership noticed your contributions!")
					elseif roll <= 75 then
						state:ModifyStat("Happiness", -2)
						state:AddFeed("ğŸ“… Productive but exhausted. So many meetings...")
					else
						state:ModifyStat("Happiness", -4)
						state:AddFeed("ğŸ“… Said something dumb in front of the VP. Oof.")
					end
				end,
			},
			{
				text = "Zone out and multitask",
				effects = {},
				feedText = "You pretend to pay attention...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", 3)
						state:AddFeed("ğŸ“… Got other work done while nodding along. Efficient!")
					else
						state:ModifyStat("Happiness", -4)
						state:AddFeed("ğŸ“… 'What do you think?' Called out! No idea what they asked!")
					end
				end,
			},
		},
	},
	{
		id = "office_email_overload",
		title = "Email Overload",
		emoji = "ğŸ“§",
		textVariants = {
			"Your inbox is overflowing with emails!",
			"200+ unread emails await you this morning!",
			"Email chaos! Your inbox is out of control!",
		},
		text = "Your inbox is overflowing with emails!",
		question = "How do you handle it?",
		minAge = 18, maxAge = 70,
		baseChance = 0.6,
		cooldown = 2,
		category = "career_office",
		requiresJob = true,
		eligibility = hasOfficeJob, -- CRITICAL FIX: Use proper eligibility check
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Declare email bankruptcy - delete all",
				effects = {},
				feedText = "You select all and delete...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ“§ Fresh start! Nothing important was missed!")
					else
						state:ModifyStat("Happiness", -4)
						state:AddFeed("ğŸ“§ Missed an important email from the CEO. Oops!")
					end
				end,
			},
			{
				text = "Power through and respond to all",
				effects = {},
				feedText = "You start typing replies...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Smarts", 2)
						state:ModifyStat("Happiness", 2)
						state:AddFeed("ğŸ“§ Inbox zero achieved! Feeling accomplished!")
					else
						state:ModifyStat("Happiness", -3)
						state:ModifyStat("Health", -1)
						state:AddFeed("ğŸ“§ Took all day. Eyes hurt. Worth it?")
					end
				end,
			},
		},
	},
	{
		id = "office_coworker_conflict",
		title = "Coworker Conflict",
		emoji = "ğŸ˜¤",
		textVariants = {
			"A coworker is really getting on your nerves!",
			"Tension is building between you and a colleague.",
			"Office drama alert! Someone is causing problems!",
		},
		text = "A coworker is really getting on your nerves!",
		question = "How do you handle it?",
		minAge = 18, maxAge = 70,
		baseChance = 0.4,
		cooldown = 3,
		category = "career_office",
		requiresJob = true,
		eligibility = hasOfficeJob, -- CRITICAL FIX: Use proper eligibility check
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Talk it out professionally",
				effects = {},
				feedText = "You ask them to chat...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", 5)
						state:ModifyStat("Smarts", 2)
						state.Flags = state.Flags or {}
						state.Flags.conflict_resolution_skills = true
						state:AddFeed("ğŸ˜¤ Cleared the air! Actually became friends!")
					elseif roll <= 80 then
						state:ModifyStat("Happiness", 2)
						state:AddFeed("ğŸ˜¤ Awkward but things are better now.")
					else
						state:ModifyStat("Happiness", -3)
						state:AddFeed("ğŸ˜¤ They got defensive. Now it's worse. HR here we come.")
					end
				end,
			},
			{
				text = "Go straight to HR",
				effects = {},
				feedText = "You file a complaint...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:ModifyStat("Happiness", 4)
						state:AddFeed("ğŸ˜¤ HR took it seriously! Problem solved!")
					else
						state:ModifyStat("Happiness", -4)
						state:AddFeed("ğŸ˜¤ HR did nothing. Now labeled as 'that person'.")
					end
				end,
			},
			{
				text = "Just avoid them",
				effects = {},
				feedText = "You keep your distance...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Happiness", 2)
						state:AddFeed("ğŸ˜¤ Out of sight, out of mind. Peaceful.")
					else
						state:ModifyStat("Happiness", -2)
						state:AddFeed("ğŸ˜¤ Hard to avoid them. The tension lingers.")
					end
				end,
			},
		},
	},
	{
		id = "office_lunch_break",
		title = "Lunch Break Dilemma",
		emoji = "ğŸ±",
		textVariants = {
			"It's lunch time! Where do you eat?",
			"Your stomach is growling. Lunch break!",
			"Time for the daily lunch decision!",
		},
		text = "It's lunch time! Where do you eat?",
		question = "What's for lunch?",
		minAge = 18, maxAge = 70,
		baseChance = 0.6,
		cooldown = 2,
		category = "career_office",
		requiresJob = true,
		eligibility = hasOfficeJob, -- CRITICAL FIX: Use proper eligibility check
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Eat at desk - working lunch",
				effects = {},
				feedText = "You eat while typing...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:ModifyStat("Smarts", 2)
						state:AddFeed("ğŸ± Got a lot done! Very productive!")
					else
						state:ModifyStat("Happiness", -2)
						state:ModifyStat("Health", -1)
						state:AddFeed("ğŸ± No real break. Feeling burnt out.")
					end
				end,
			},
			{
				text = "Join coworkers at a restaurant",
				effects = { Money = -20 },
				feedText = "You head out with the team...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ± Great bonding time! Learned some office gossip!")
					else
						state:ModifyStat("Happiness", 2)
						state:AddFeed("ğŸ± Nice break but kinda pricey.")
					end
				end,
			},
			{
				text = "Healthy packed lunch",
				effects = {},
				feedText = "You grab your meal prep...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 70 then
						state:ModifyStat("Health", 3)
						state:ModifyStat("Happiness", 3)
						state:AddFeed("ğŸ± Healthy AND saved money! Winning!")
					else
						state:ModifyStat("Happiness", 1)
						state:AddFeed("ğŸ± Healthy but kind of boring...")
					end
				end,
			},
		},
	},
	{
		id = "office_performance_review",
		title = "Performance Review",
		emoji = "ğŸ“Š",
		textVariants = {
			"Performance review time! Your manager wants to meet.",
			"Annual review is scheduled with your boss.",
			"Your work evaluation is coming up!",
		},
		text = "Performance review time! Your manager wants to meet.",
		question = "How does it go?",
		minAge = 18, maxAge = 70,
		baseChance = 0.3,
		cooldown = 4,
		category = "career_office",
		requiresJob = true,
		eligibility = hasOfficeJob, -- CRITICAL FIX: Use proper eligibility check
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Be confident about your work",
				effects = {},
				feedText = "You walk in with your head high...",
				onResolve = function(state)
					local smarts = (state.Stats and state.Stats.Smarts) or 50
					local roll = math.random(1, 100) - math.floor(smarts / 10)
					if roll <= 35 then
						state:ModifyStat("Happiness", 10)
						state.Money = (state.Money or 0) + math.random(500, 1500)
						state.Flags = state.Flags or {}
						state.Flags.great_review = true
						state:AddFeed("ğŸ“Š EXCELLENT REVIEW! Raise incoming!")
					elseif roll <= 70 then
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ“Š Good review! 'Meets expectations' - stable!")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ“Š 'Needs improvement.' That stings.")
					end
				end,
			},
			{
				text = "Ask for specific feedback",
				effects = {},
				feedText = "You want to improve...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Smarts", 3)
						state:ModifyStat("Happiness", 4)
						state:AddFeed("ğŸ“Š Constructive feedback! Now you know what to work on!")
					else
						state:ModifyStat("Happiness", 2)
						state:AddFeed("ğŸ“Š Vague feedback but at least you tried to grow.")
					end
				end,
			},
		},
	},
	{
		id = "office_project_deadline",
		title = "Project Deadline",
		emoji = "â°",
		textVariants = {
			"Big project deadline is tomorrow! Are you ready?",
			"Crunch time! Major deliverable due!",
			"The project you've been working on is due!",
		},
		text = "Big project deadline is tomorrow! Are you ready?",
		question = "How do you handle the pressure?",
		minAge = 18, maxAge = 70,
		baseChance = 0.5,
		cooldown = 3,
		category = "career_office",
		requiresJob = true,
		eligibility = hasOfficeJob, -- CRITICAL FIX: Use proper eligibility check
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Work overtime to finish",
				effects = {},
				feedText = "You stay late at the office...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Smarts", 4)
						state:ModifyStat("Happiness", 5)
						state.Flags = state.Flags or {}
						state.Flags.reliable_worker = true
						state:AddFeed("â° Delivered on time! Leadership impressed!")
					elseif roll <= 80 then
						state:ModifyStat("Happiness", 2)
						state:ModifyStat("Health", -2)
						state:AddFeed("â° Got it done but exhausted. Weekend ruined.")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("â° Still couldn't finish. Had to ask for extension.")
					end
				end,
			},
			{
				text = "Ask for an extension",
				effects = {},
				feedText = "You explain the situation...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:ModifyStat("Happiness", 4)
						state:AddFeed("â° Extension granted! Breathing room!")
					else
						state:ModifyStat("Happiness", -4)
						state:AddFeed("â° Denied! Now under even more pressure!")
					end
				end,
			},
		},
	},
	{
		id = "office_new_software",
		title = "New Software Rollout",
		emoji = "ğŸ’»",
		textVariants = {
			"The company is rolling out new software!",
			"Time to learn a new system at work!",
			"IT is implementing new tools you need to learn.",
		},
		text = "The company is rolling out new software you need to learn!",
		question = "How quickly do you adapt?",
		minAge = 18, maxAge = 70,
		baseChance = 0.4,
		cooldown = 4,
		category = "career_office",
		requiresJob = true,
		eligibility = hasOfficeJob, -- CRITICAL FIX: Use proper eligibility check
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Embrace it and learn fast",
				effects = {},
				feedText = "You dive into the training...",
				onResolve = function(state)
					local smarts = (state.Stats and state.Stats.Smarts) or 50
					local roll = math.random(1, 100) - math.floor(smarts / 10)
					if roll <= 40 then
						state:ModifyStat("Smarts", 4)
						state.Flags = state.Flags or {}
						state.Flags.tech_savvy = true
						state:AddFeed("ğŸ’» Mastered it quickly! Now helping others learn!")
					elseif roll <= 70 then
						state:ModifyStat("Smarts", 2)
						state:AddFeed("ğŸ’» Getting the hang of it. Just takes practice.")
					else
						state:ModifyStat("Happiness", -3)
						state:AddFeed("ğŸ’» Struggling with it. Feeling left behind.")
					end
				end,
			},
			{
				text = "Resist the change",
				effects = {},
				feedText = "You complain to anyone who'll listen...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 30 then
						state:ModifyStat("Happiness", 3)
						state:AddFeed("ğŸ’» Found workarounds! Old ways still work!")
					else
						state:ModifyStat("Happiness", -4)
						state:AddFeed("ğŸ’» Forced to learn anyway. Wasted energy complaining.")
					end
				end,
			},
		},
	},
	{
		id = "office_team_building",
		title = "Team Building Event",
		emoji = "ğŸ¯",
		textVariants = {
			"HR organized a team building activity!",
			"Mandatory fun! Team building day!",
			"Your department is doing a team bonding event!",
		},
		text = "HR organized a team building activity!",
		question = "How do you approach it?",
		minAge = 18, maxAge = 70,
		baseChance = 0.4,
		cooldown = 4,
		category = "career_office",
		requiresJob = true,
		eligibility = hasOfficeJob, -- CRITICAL FIX: Use proper eligibility check
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Participate enthusiastically",
				effects = {},
				feedText = "You give it your all...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", 6)
						state.Flags = state.Flags or {}
						state.Flags.team_player = true
						state:AddFeed("ğŸ¯ Actually fun! Made some real connections!")
					elseif roll <= 80 then
						state:ModifyStat("Happiness", 3)
						state:AddFeed("ğŸ¯ Not bad! Free food at least!")
					else
						state:ModifyStat("Happiness", -2)
						state:AddFeed("ğŸ¯ Awkward activities. Would rather be working.")
					end
				end,
			},
			{
				text = "Find an excuse to skip",
				effects = {},
				feedText = "You claim to have a meeting...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:ModifyStat("Happiness", 4)
						state:AddFeed("ğŸ¯ Escaped! Productive day instead!")
					else
						state:ModifyStat("Happiness", -3)
						state:AddFeed("ğŸ¯ Got caught. Now labeled as 'not a team player'.")
					end
				end,
			},
		},
	},
	{
		id = "office_promotion_opportunity",
		title = "Promotion Opportunity",
		emoji = "ğŸ“ˆ",
		textVariants = {
			"A senior position just opened up!",
			"Your manager is leaving - will you apply for their role?",
			"There's a chance to move up in the company!",
		},
		text = "A senior position just opened up! Should you apply?",
		question = "What do you do?",
		minAge = 22, maxAge = 60,
		baseChance = 0.2,
		cooldown = 5,
		category = "career_office",
		requiresJob = true,
		eligibility = hasOfficeJob, -- CRITICAL FIX: Use proper eligibility check
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Apply with confidence",
				effects = {},
				feedText = "You submit your application...",
				onResolve = function(state)
					local smarts = (state.Stats and state.Stats.Smarts) or 50
					local roll = math.random(1, 100) - math.floor(smarts / 10)
					if roll <= 35 then
						state:ModifyStat("Happiness", 15)
						state.Money = (state.Money or 0) + math.random(5000, 15000)
						state.Flags = state.Flags or {}
						state.Flags.promoted = true
						state:AddFeed("ğŸ“ˆ YOU GOT IT! Promoted! Big raise incoming!")
					elseif roll <= 70 then
						state:ModifyStat("Happiness", 3)
						state:AddFeed("ğŸ“ˆ Didn't get it, but impressed leadership. Next time!")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ“ˆ Rejected. That hurt. Someone less experienced got it.")
					end
				end,
			},
			{
				text = "Wait for the right moment",
				effects = {},
				feedText = "You decide to bide your time...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 30 then
						state:ModifyStat("Happiness", 4)
						state:AddFeed("ğŸ“ˆ Smart choice. Better opportunity came later.")
					else
						state:ModifyStat("Happiness", -2)
						state:AddFeed("ğŸ“ˆ Missed your shot. The position was filled.")
					end
				end,
			},
		},
	},
}

return OfficeCareerEvents
