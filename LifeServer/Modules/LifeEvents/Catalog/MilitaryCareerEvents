--[[
	Military Career Events
	AAA-quality events with random BitLife-style outcomes
	User CANNOT control outcomes - everything is randomized
	
	Careers covered:
	- Enlisted Soldier
	- Sergeant
	- Officer
	- Captain
	- Colonel
	- General
]]

local MilitaryCareerEvents = {}

local function hasMilitaryJob(state)
	if not state.CurrentJob then return false end
	local jobId = (state.CurrentJob.id or ""):lower()
	local category = (state.CurrentJob.category or ""):lower()
	
	-- CRITICAL FIX: Check category first - most reliable indicator
	if category == "military" then return true end
	
	-- CRITICAL FIX: More specific military job detection
	-- The old check used "officer" which matched Loan Officer, Parole Officer, etc.
	-- Now we use more specific patterns for military ranks/roles
	local militaryPatterns = {
		"enlisted",        -- Enlisted Soldier
		"sergeant",        -- Sergeant
		"army_officer",    -- Military officer (specific)
		"military_officer",
		"navy_officer",
		"air_force_officer",
		"marines_officer",
		"captain_military", -- Military Captain (not boat captain)
		"colonel",         -- Colonel
		"general",         -- General
		"military",        -- Generic military
		"army",            -- Army
		"navy",            -- Navy  
		"marines",         -- Marines
		"air_force",       -- Air Force
		"coast_guard",     -- Coast Guard
		"soldier",         -- Soldier
		"private_",        -- Private (rank)
		"corporal",        -- Corporal
		"lieutenant",      -- Lieutenant
		"major_",          -- Major (rank, not major like "major client")
		"warrant_officer", -- Warrant Officer (military specific)
	}
	
	for _, pattern in ipairs(militaryPatterns) do
		if jobId:find(pattern) then
			return true
		end
	end
	
	return false
end

local function isOfficer(state)
	if not state.CurrentJob then return false end
	local jobId = (state.CurrentJob.id or ""):lower()
	return jobId:find("officer") or jobId:find("captain") or jobId:find("colonel") or jobId:find("general")
end

MilitaryCareerEvents.events = {
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- BASIC TRAINING / EARLY MILITARY
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "mil_deployment",
		title = "Deployment Orders",
		emoji = "âœˆï¸",
		text = "You've received deployment orders. You're being sent overseas to an active conflict zone.",
		category = "career_military",
		weight = 18,
		minAge = 18, maxAge = 45,
		baseChance = 0.5,
		cooldown = 4,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Ship out with your unit",
				effects = { Health = -5 },
				feedText = "Reporting for duty...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 65 then
						state.Money = (state.Money or 0) + math.random(15000, 40000)
						state:ModifyStat("Happiness", 10)
						state.Flags = state.Flags or {}
						state.Flags.combat_veteran = true
						state.Flags.deployed = true
						state:AddFeed("âœˆï¸ Deployment complete. Combat pay banked. Experiences you'll never forget.")
					elseif roll <= 90 then
						state:ModifyStat("Health", -15)
						state:ModifyStat("Happiness", -10)
						state.Flags = state.Flags or {}
						state.Flags.combat_veteran = true
						state.Flags.wounded_in_action = true
						state:AddFeed("âœˆï¸ Wounded in action. Purple Heart. Physical scars, mental ones too.")
					else
						state:ModifyStat("Happiness", -30)
						state:ModifyStat("Health", -30)
						state.Flags = state.Flags or {}
						state.Flags.severely_wounded = true
						state:AddFeed("âœˆï¸ Serious injuries. Medical evacuation. Long recovery ahead.")
					end
				end,
			},
			{
				text = "Request deferment (family reasons)",
				effects = { Smarts = 2 },
				feedText = "Submitting paperwork...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:ModifyStat("Happiness", 5)
						state:AddFeed("âœˆï¸ Deferment approved. Staying stateside for now.")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("âœˆï¸ Deferment denied. Orders are orders. Pack your bags.")
					end
				end,
			},
		},
	},
	
	{
		id = "mil_combat_situation",
		title = "Under Fire",
		emoji = "ğŸ’¥",
		text = "Your patrol came under enemy fire! Split-second decisions will determine who lives and dies.",
		category = "career_military",
		weight = 14,
		minAge = 18, maxAge = 50,
		baseChance = 0.45,
		cooldown = 4, -- CRITICAL FIX: Increased from 2 to reduce spam
		requiresJob = true,
		eligibility = hasMilitaryJob,
		requiresFlags = { deployed = true },
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Return fire and advance",
				effects = { Health = -5 },
				feedText = "Suppressing fire!",
				triggerMinigame = "combat",
				minigameOptions = { context = "military_combat", difficulty = "hard" },
				onResolve = function(state, minigameResult)
					local won = minigameResult and (minigameResult.won or minigameResult.success)
					if won then
						state:ModifyStat("Happiness", 15)
						state.Flags = state.Flags or {}
						state.Flags.combat_hero = true
						state:AddFeed("ğŸ’¥ Your leadership saved lives! Commendation incoming!")
					else
						state:ModifyStat("Happiness", -15)
						state:ModifyStat("Health", -15)
						state:AddFeed("ğŸ’¥ Took casualties. You survived but the weight is heavy.")
					end
				end,
			},
			{
				text = "Call for air support",
				effects = {},
				feedText = "Requesting fire mission!",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 55 then
						state:ModifyStat("Happiness", 10)
						state:AddFeed("ğŸ’¥ Air support arrived! Enemy neutralized! Smart call.")
					elseif roll <= 85 then
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ’¥ Air support was delayed but eventually helped. Close call.")
					else
						state:ModifyStat("Happiness", -15)
						state:AddFeed("ğŸ’¥ Friendly fire incident. Investigation pending. Nightmare.")
					end
				end,
			},
			{
				text = "Defensive position - hold ground",
				effects = {},
				feedText = "Dig in!",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 70 then
						state:ModifyStat("Happiness", 8)
						state:AddFeed("ğŸ’¥ Held the line until reinforcements arrived. Good soldiering.")
					else
						state:ModifyStat("Health", -10)
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ’¥ Position was overrun. Fighting retreat. Survived barely.")
					end
				end,
			},
		},
	},
	
	{
		id = "mil_promotion_board",
		title = "Promotion Board",
		emoji = "ğŸ–ï¸",
		text = "You're up for promotion. The board will evaluate your service record, fitness, and leadership.",
		category = "career_military",
		weight = 15,
		minAge = 20, maxAge = 55,
		baseChance = 0.5,
		cooldown = 3,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Present your best case",
				effects = { Smarts = 2 },
				feedText = "Standing before the board...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					local performance = (state.CareerInfo and state.CareerInfo.performance) or 60
					local bonus = (performance - 50) / 3
					
					if roll + bonus <= 55 then
						state.Money = (state.Money or 0) + math.random(5000, 15000)
						state:ModifyStat("Happiness", 20)
						state.Flags = state.Flags or {}
						state.Flags.military_promoted = true
						state:AddFeed("ğŸ–ï¸ PROMOTED! New rank, new pay grade, new responsibilities!")
					else
						state:ModifyStat("Happiness", -8)
						state:AddFeed("ğŸ–ï¸ Passed over this time. 'Keep working on leadership skills.'")
					end
				end,
			},
		},
	},
	
	{
		id = "mil_brotherhood",
		title = "Band of Brothers",
		emoji = "ğŸ¤",
		text = "Your unit has become like family. The bonds formed in service are unbreakable.",
		category = "career_military",
		weight = 12,
		minAge = 18, maxAge = 60,
		baseChance = 0.45,
		cooldown = 4,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "These bonds last forever",
				effects = { Happiness = 15 },
				setFlags = { military_brotherhood = true },
				feedText = "ğŸ¤ Friends for life. They'll be at your wedding, your kids' births, your funeral. Brothers and sisters in arms.",
			},
		},
	},
	
	{
		id = "mil_ceremony",
		title = "Military Ceremony",
		emoji = "ğŸ—ï¸",
		text = "You're being recognized for your service at a formal military ceremony!",
		category = "career_military",
		weight = 12,
		minAge = 20, maxAge = 65,
		baseChance = 0.4,
		cooldown = 4,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Receive the medal",
				effects = { Happiness = 18 },
				feedText = "Standing at attention...",
				onResolve = function(state)
					local medals = { "Army Achievement Medal", "Meritorious Service Medal", "Bronze Star", "Legion of Merit" }
					local medal = medals[math.random(1, #medals)]
					state.Flags = state.Flags or {}
				state.Flags.decorated_soldier = true
				state.Fame = math.min(100, (state.Fame or 0) + 10) -- CRITICAL FIX: Cap fame at 100
				state:AddFeed(string.format("ğŸ—ï¸ Awarded the %s! Your service is recognized!", medal))
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- OFFICER-SPECIFIC EVENTS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	{
		id = "mil_command_decision",
		title = "Command Decision",
		emoji = "âš”ï¸",
		text = "As commanding officer, you face a difficult decision. Your choice will affect many lives.",
		category = "career_military",
		weight = 14,
		minAge = 25, maxAge = 55,
		baseChance = 0.5,
		cooldown = 3,
		requiresJob = true,
		eligibility = isOfficer,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Prioritize the mission",
				effects = {},
				feedText = "Mission comes first...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", 10)
						state.Flags = state.Flags or {}
						state.Flags.mission_focused_commander = true
						state:AddFeed("âš”ï¸ Mission accomplished. Acceptable casualties. War is tough.")
					else
						state:ModifyStat("Happiness", -15)
						state:AddFeed("âš”ï¸ Mission failed AND took casualties. Heavy burden to carry.")
					end
				end,
			},
			{
				text = "Prioritize troop safety",
				effects = {},
				feedText = "Protect the unit...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Happiness", 12)
						state.Flags = state.Flags or {}
						state.Flags.troops_first_commander = true
						state:AddFeed("âš”ï¸ Everyone came home. Mission adapted. Your troops respect you.")
					else
						state:ModifyStat("Happiness", -8)
						state:AddFeed("âš”ï¸ Command was unhappy with 'risk averse' approach. Politics.")
					end
				end,
			},
		},
	},
	
	{
		id = "mil_court_martial",
		title = "Court Martial",
		emoji = "âš–ï¸",
		text = "You're facing a military court. The charges could end your career or worse.",
		category = "career_military",
		weight = 8,
		minAge = 20, maxAge = 60,
		baseChance = 0.35,
		cooldown = 10,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Fight the charges",
				effects = { Smarts = 3 },
				feedText = "Getting JAG counsel...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", 20)
						state:AddFeed("âš–ï¸ ACQUITTED! Name cleared! Can continue your career!")
					elseif roll <= 80 then
						state:ModifyStat("Happiness", -15)
						state:AddFeed("âš–ï¸ Reduced in rank. Career damaged but not over.")
					else
						state:ModifyStat("Happiness", -30)
						state.CurrentJob = nil
						state.Flags = state.Flags or {}
						state.Flags.discharged = true
						state:AddFeed("âš–ï¸ Found guilty. Dishonorable discharge. Military career over.")
					end
				end,
			},
			{
				text = "Accept a plea",
				effects = { Happiness = -10 },
				feedText = "Limiting the damage...",
				onResolve = function(state)
					state:ModifyStat("Happiness", -5)
					state:AddFeed("âš–ï¸ Accepted non-judicial punishment. Career continues, reputation damaged.")
				end,
			},
		},
	},
	
	{
		id = "mil_retirement",
		title = "Military Retirement",
		emoji = "ğŸ–ï¸",
		text = "After years of service, you're eligible for military retirement. Full benefits and pension await.",
		category = "career_military",
		weight = 10,
		minAge = 38, maxAge = 65,
		baseChance = 0.4,
		cooldown = 10,
		oneTime = true,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true, retired = true },
		
		choices = {
			{
				text = "Retire with full honors",
				effects = { Happiness = 20 },
				feedText = "Thank you for your service...",
				onResolve = function(state)
					local pension = math.random(40000, 80000)
					state.Money = (state.Money or 0) + pension
					state.Flags = state.Flags or {}
					state.Flags.retired = true
					state.Flags.military_retired = true
					state.Flags.pension_amount = pension
					state.CurrentJob = nil
					state:AddFeed(string.format("ğŸ–ï¸ Retired with full military honors! Pension: $%d/year! Thank you for your service!", pension))
				end,
			},
			{
				text = "Stay in - not ready yet",
				effects = { Happiness = 5 },
				feedText = "The uniform is part of who you are...",
			},
		},
	},
	
	{
		id = "mil_ptsd",
		title = "Coming Home",
		emoji = "ğŸ˜”",
		text = "The transition back to civilian life after deployment is harder than expected. The nightmares won't stop.",
		category = "career_military",
		weight = 12,
		minAge = 20, maxAge = 60,
		baseChance = 0.4,
		cooldown = 4,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		requiresFlags = { combat_veteran = true },
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Seek help through VA",
				effects = { Smarts = 3 },
				feedText = "Reaching out for support...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Happiness", 12)
						state:ModifyStat("Health", 5)
						state.Flags = state.Flags or {}
						state.Flags.getting_help = true
						state:AddFeed("ğŸ˜” VA counseling is helping. One day at a time. Getting better.")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ˜” VA waitlist is months long. System is failing veterans.")
					end
				end,
			},
			{
				text = "Talk to unit buddies",
				effects = { Happiness = 5 },
				feedText = "They understand...",
				onResolve = function(state)
					state:ModifyStat("Happiness", 8)
					state:AddFeed("ğŸ˜” Fellow vets get it. The brotherhood helps. Not alone.")
				end,
			},
			{
				text = "Push through alone",
				effects = { Happiness = -10, Health = -5 },
				feedText = "Soldiers don't ask for help...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 30 then
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ˜” Found your own coping mechanisms. Getting by.")
					else
						state:ModifyStat("Happiness", -15)
						state.Flags = state.Flags or {}
						state.Flags.struggling_vet = true
						state:AddFeed("ğŸ˜” It's getting worse. Need to ask for help eventually.")
					end
				end,
			},
		},
	},
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- MASSIVE EXPANSION: MORE MILITARY EVENTS FOR VARIETY
	-- User complaint: "EVERY LIFE IS THE SAME MY GODDDDDDD"
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	{
		id = "mil_fitness_test",
		title = "Physical Fitness Test",
		emoji = "ğŸ’ª",
		text = "It's PT test day. You've been training but the standards are tough. Pushups, situps, and a two-mile run.",
		category = "career_military",
		weight = 16,
		minAge = 18, maxAge = 50,
		baseChance = 0.6,
		cooldown = 4, -- CRITICAL FIX: Increased from 2 to reduce spam
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Give it everything - max score attempt",
				effects = {},
				feedText = "Pushing to the limit...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					local health = (state.Stats and state.Stats.Health) or 50
					local bonus = health > 70 and 15 or 0
					if roll + bonus <= 55 then
						state:ModifyStat("Health", 8)
						state:ModifyStat("Happiness", 10)
						state.Flags = state.Flags or {}
						state.Flags.pt_stud = true
						state:AddFeed("ğŸ’ª MAXED the PT test! Perfect scores across the board! Commanders noticed.")
					elseif roll + bonus <= 85 then
						state:ModifyStat("Health", 3)
						state:AddFeed("ğŸ’ª Passed! Solid score. Nothing exceptional but you're good to go.")
					else
						state:ModifyStat("Happiness", -10)
						state:ModifyStat("Health", -3)
						state:AddFeed("ğŸ’ª Failed the run by 30 seconds. Remedial PT program for you.")
					end
				end,
			},
			{
				text = "Pace yourself - just need to pass",
				effects = { Health = 2 },
				feedText = "Smart approach...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 80 then
						state:ModifyStat("Happiness", 3)
						state:AddFeed("ğŸ’ª Passed comfortably. Not impressive but passing is passing.")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ’ª Barely scraped by. Need to train harder next time.")
					end
				end,
			},
			{
				text = "Claim minor injury - get medical waiver",
				effects = {},
				feedText = "Playing it safe...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:AddFeed("ğŸ’ª Got a waiver. Have to test next cycle though.")
					else
						state:ModifyStat("Happiness", -8)
						state.Flags = state.Flags or {}
						state.Flags.suspected_malingerer = true
						state:AddFeed("ğŸ’ª Doc didn't buy it. Now you're flagged AND have to test. Bad move.")
					end
				end,
			},
		},
	},
	
	{
		id = "mil_secret_clearance",
		title = "Security Clearance Investigation",
		emoji = "ğŸ”’",
		text = "You've been selected for a position requiring Top Secret clearance. Investigators are digging into your entire life.",
		category = "career_military",
		weight = 14,
		minAge = 19, maxAge = 55,
		baseChance = 0.35,
		cooldown = 5,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true, criminal_record = true },
		
		choices = {
			{
				text = "Be completely honest about everything",
				effects = { Smarts = 2 },
				feedText = "Full transparency...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 75 then
						state:ModifyStat("Happiness", 15)
						state.Money = (state.Money or 0) + 8000
						state.Flags = state.Flags or {}
						state.Flags.top_secret_clearance = true
						state:AddFeed("ğŸ”’ Clearance GRANTED! Access to classified information. Career doors opening.")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ”’ Investigation ongoing. Some friends/family said weird stuff. Delayed.")
					end
				end,
			},
			{
				text = "Hide that one thing from your past",
				effects = {},
				feedText = "They probably won't find out...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 30 then
						state:ModifyStat("Happiness", 10)
						state.Flags = state.Flags or {}
						state.Flags.top_secret_clearance = true
						state:AddFeed("ğŸ”’ Clearance granted! They didn't dig that deep. Lucky.")
					else
						state:ModifyStat("Happiness", -20)
						state.Flags = state.Flags or {}
						state.Flags.clearance_denied = true
						state:AddFeed("ğŸ”’ DENIED. They found out you lied. Now you're flagged for dishonesty. Career damaged.")
					end
				end,
			},
		},
	},
	
	{
		id = "mil_drill_sergeant",
		title = "Drill Instructor Opportunity",
		emoji = "ğŸ–ï¸",
		text = "You've been offered the chance to become a drill instructor. It's prestigious but incredibly demanding.",
		category = "career_military",
		weight = 12,
		minAge = 25, maxAge = 45,
		baseChance = 0.3,
		cooldown = 6,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Accept - shape the next generation",
				effects = { Health = -5 },
				feedText = "Time to make soldiers...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 65 then
						state:ModifyStat("Happiness", 10)
						state:ModifyStat("Smarts", 5)
						state.Flags = state.Flags or {}
						state.Flags.drill_instructor = true
						state:AddFeed("ğŸ–ï¸ You're a natural! Tough but fair. Recruits respect you.")
					else
						state:ModifyStat("Happiness", -10)
						state:ModifyStat("Health", -5)
						state:AddFeed("ğŸ–ï¸ It's breaking you. 4am wake-ups, constant yelling. Requested transfer.")
					end
				end,
			},
			{
				text = "Decline - stay operational",
				effects = { Happiness = 3 },
				feedText = "ğŸ–ï¸ Training command isn't for everyone. Back to regular duties.",
			},
		},
	},
	
	{
		id = "mil_special_forces_selection",
		title = "Special Forces Assessment",
		emoji = "âš”ï¸",
		text = "You've been tapped for Special Forces selection. The washout rate is 70%. This will be the hardest thing you've ever done.",
		category = "career_military",
		weight = 10,
		minAge = 21, maxAge = 35,
		baseChance = 0.25,
		cooldown = 8,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true, wounded_in_action = true },
		
		choices = {
			{
				text = "Send it - I'm ready for this",
				effects = { Health = -15 },
				feedText = "Into the crucible...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					local health = (state.Stats and state.Stats.Health) or 50
					local bonus = health > 80 and 15 or 0
					if roll + bonus <= 35 then
						state:ModifyStat("Happiness", 25)
						state:ModifyStat("Health", 10)
						state.Money = (state.Money or 0) + 25000
						state.Flags = state.Flags or {}
						state.Flags.special_forces = true
						state.Flags.elite_soldier = true
						state:AddFeed("âš”ï¸ YOU MADE IT! One of the few. Green Beret/Ranger tab earned. Elite warrior status.")
					elseif roll + bonus <= 70 then
						state:ModifyStat("Happiness", -15)
						state:ModifyStat("Health", -10)
						state:AddFeed("âš”ï¸ Washed out at week 3. Honorable release - this isn't failure. Most can't even try.")
					else
						state:ModifyStat("Health", -25)
						state.Flags = state.Flags or {}
						state.Flags.injured = true
						state:AddFeed("âš”ï¸ Training injury. Stress fractures in both legs. Medical discharge from selection.")
					end
				end,
			},
			{
				text = "Not yet - need more preparation",
				effects = { Smarts = 3 },
				feedText = "âš”ï¸ Smart call. You'll get another shot when you're truly ready.",
			},
		},
	},
	
	{
		id = "mil_friendly_fire_incident",
		title = "Friendly Fire Incident",
		emoji = "ğŸ’¥",
		text = "During a night exercise, shots were fired and someone got hurt. The investigation is pointing fingers at your unit.",
		category = "career_military",
		weight = 8,
		minAge = 18, maxAge = 50,
		baseChance = 0.2,
		cooldown = 6,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Take responsibility if it was my team",
				effects = { Smarts = 3 },
				feedText = "Officers own their mistakes...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ’¥ Letter of reprimand but integrity noted. Command respects accountability.")
					else
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸ’¥ Investigation cleared you. Your honesty was appreciated.")
					end
				end,
			},
			{
				text = "Deflect blame to another unit",
				effects = {},
				feedText = "Self-preservation...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:AddFeed("ğŸ’¥ Someone else took the fall. You're in the clear. But you know the truth.")
					else
						state:ModifyStat("Happiness", -20)
						state.Flags = state.Flags or {}
						state.Flags.dishonorable_conduct = true
						state:AddFeed("ğŸ’¥ Evidence surfaced. You lied AND threw someone under the bus. Career over.")
					end
				end,
			},
			{
				text = "Cooperate fully with investigation",
				effects = { Happiness = -5 },
				feedText = "ğŸ’¥ Investigation ongoing. Stressful waiting game.",
			},
		},
	},
	
	{
		id = "mil_military_ball",
		title = "Military Ball",
		emoji = "ğŸ©",
		text = "The annual military ball is coming up. It's formal, full of traditions, and a chance to network with brass.",
		category = "career_military",
		weight = 14,
		minAge = 18, maxAge = 60,
		baseChance = 0.5,
		cooldown = 3,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Attend in full dress uniform",
				effects = { Happiness = 5 },
				feedText = "Looking sharp...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Happiness", 10)
						state:AddFeed("ğŸ© Great night! Met some important people. Traditions honored.")
					else
						state:ModifyStat("Happiness", 3)
						state:AddFeed("ğŸ© Good time. Food was mediocre but the camaraderie was real.")
					end
				end,
			},
			{
				text = "Bring a date to impress",
				effects = {},
				feedText = "Plus one time...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", 12)
						state:AddFeed("ğŸ© Date was impressed! Power couple of the evening. Photos went viral.")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ© Date was bored by military talk. Awkward car ride home.")
					end
				end,
			},
			{
				text = "Skip it - not into formal events",
				effects = { Happiness = -3 },
				feedText = "ğŸ© Skipped. CO noticed your absence. Might affect OER.",
			},
		},
	},
	
	{
		id = "mil_hazing_incident",
		title = "Hazing Witness",
		emoji = "âš ï¸",
		text = "You witness senior members 'initiating' a new recruit. It's crossing lines. The recruit looks terrified.",
		category = "career_military",
		weight = 10,
		minAge = 18, maxAge = 40,
		baseChance = 0.3,
		cooldown = 5,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Report it to command",
				effects = { Smarts = 5 },
				feedText = "Doing the right thing...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Happiness", 10)
						state.Flags = state.Flags or {}
						state.Flags.integrity_commendation = true
						state:AddFeed("âš ï¸ Investigation launched. You're protected as a whistleblower. Respect earned.")
					else
						state:ModifyStat("Happiness", -10)
						state.Flags = state.Flags or {}
						state.Flags.unit_outcast = true
						state:AddFeed("âš ï¸ Labeled a snitch. Unit icing you out. Did the right thing but paying the price.")
					end
				end,
			},
			{
				text = "Intervene directly - stop it now",
				effects = { Health = -3 },
				feedText = "Stepping in...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", 8)
						state:AddFeed("âš ï¸ They backed off. Recruit thanked you. Senior guys are mad but know they were wrong.")
					else
						state:ModifyStat("Happiness", -5)
						state:ModifyStat("Health", -5)
						state:AddFeed("âš ï¸ It escalated. Now you're in a fight. Everyone getting NJP (Non-Judicial Punishment).")
					end
				end,
			},
			{
				text = "Stay quiet - not your business",
				effects = { Happiness = -10 },
				feedText = "âš ï¸ You did nothing. The guilt is eating at you. That recruit's eyes haunt you.",
			},
		},
	},
	
	{
		-- CRITICAL FIX: Renamed from "mil_promotion_board" to avoid duplicate ID
		id = "mil_promotion_review",
		title = "Promotion Board",
		emoji = "â­",
		text = "You're up for promotion! The board will review your record and interview you. Big day.",
		category = "career_military",
		weight = 15,
		minAge = 20, maxAge = 55,
		baseChance = 0.45,
		cooldown = 3,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true, dishonorable_conduct = true },
		
		choices = {
			{
				text = "Prepare extensively - know everything",
				effects = { Smarts = 3 },
				feedText = "Studying hard...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 70 then
						state:ModifyStat("Happiness", 15)
						state.Money = (state.Money or 0) + 5000
						state.Flags = state.Flags or {}
						state.Flags.promoted = true
						state:AddFeed("â­ PROMOTED! New rank, new responsibilities, better pay. Hard work paid off!")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("â­ Passed over this time. 'Consider again next cycle.' Frustrating but keep going.")
					end
				end,
			},
			{
				text = "Wing it - experience speaks for itself",
				effects = {},
				feedText = "Confidence time...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 45 then
						state:ModifyStat("Happiness", 12)
						state.Money = (state.Money or 0) + 5000
						state.Flags = state.Flags or {}
						state.Flags.promoted = true
						state:AddFeed("â­ Promoted! Natural leadership came through. Didn't need to study!")
					else
						state:ModifyStat("Happiness", -10)
						state:AddFeed("â­ Board noted gaps in knowledge. Should have prepared. Not this time.")
					end
				end,
			},
		},
	},
	
	{
		id = "mil_dangerous_mission",
		title = "High-Risk Mission",
		emoji = "ğŸ¯",
		text = "A high-value target has been located. Your unit is tasked with the raid. Intel says heavy resistance expected.",
		category = "career_military",
		weight = 10,
		minAge = 20, maxAge = 45,
		baseChance = 0.25,
		cooldown = 5,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Lead from the front",
				effects = { Health = -10 },
				feedText = "First one through the door...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 50 then
						state:ModifyStat("Happiness", 20)
						state.Money = (state.Money or 0) + 15000
						state.Flags = state.Flags or {}
						state.Flags.decorated_hero = true
						state:AddFeed("ğŸ¯ Mission success! HVT captured. You're getting a commendation medal!")
					elseif roll <= 80 then
						state:ModifyStat("Health", -15)
						state:ModifyStat("Happiness", 5)
						state.Flags = state.Flags or {}
						state.Flags.wounded_in_action = true
						state:AddFeed("ğŸ¯ Mission complete but you took shrapnel. Purple Heart incoming.")
					else
						state:ModifyStat("Health", -30)
						state:ModifyStat("Happiness", -20)
						state.Flags = state.Flags or {}
						state.Flags.severely_wounded = true
						state:AddFeed("ğŸ¯ Ambush. Lost teammates. You barely made it out. Medevac.")
					end
				end,
			},
			{
				text = "Support from a tactical position",
				effects = {},
				feedText = "Providing cover...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 75 then
						state:ModifyStat("Happiness", 10)
						state:AddFeed("ğŸ¯ Mission accomplished. Good support work. Team came back safe.")
					else
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ¯ Mission failed. Target escaped. Debrief is going to be rough.")
					end
				end,
			},
		},
	},
	
	{
		id = "mil_family_separation",
		title = "Extended Deployment",
		emoji = "âœˆï¸",
		text = "New orders: 12-month deployment. Your family is devastated. Kids are crying. Spouse is struggling to cope.",
		category = "career_military",
		weight = 12,
		minAge = 22, maxAge = 50,
		baseChance = 0.4,
		cooldown = 4,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		requiresFlags = { has_partner = true },
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Mission first - family understands",
				effects = { Happiness = -10 },
				feedText = "Duty calls...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 60 then
						state:ModifyStat("Happiness", 5)
						state.Money = (state.Money or 0) + 20000
						state:AddFeed("âœˆï¸ Deployment complete. Family stayed strong. Reunion was emotional.")
					else
						state:ModifyStat("Happiness", -15)
						state.Flags = state.Flags or {}
						state.Flags.marriage_strained = true
						state:AddFeed("âœˆï¸ Came home to a cold house. Spouse is distant. Kids barely know you.")
					end
				end,
			},
			{
				text = "Request reassignment - need to be closer",
				effects = {},
				feedText = "Trying to stay home...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 30 then
						state:ModifyStat("Happiness", 8)
						state:AddFeed("âœˆï¸ Request approved! Reassigned to nearby base. Family is relieved.")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("âœˆï¸ Request denied. Needs of the service. Pack your bags.")
					end
				end,
			},
		},
	},
	
	{
		id = "mil_honor_guard",
		title = "Honor Guard Detail",
		emoji = "ğŸ–ï¸",
		text = "You've been selected for funeral honor guard duty. You'll be folding flags and presenting them to grieving families.",
		category = "career_military",
		weight = 12,
		minAge = 19, maxAge = 45,
		baseChance = 0.35,
		cooldown = 4,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Accept with honor",
				effects = { Happiness = -5 },
				feedText = "Bearing witness...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					state:ModifyStat("Smarts", 3)
					if roll <= 70 then
						state:ModifyStat("Happiness", 8)
						state:AddFeed("ğŸ–ï¸ Heavy duty but meaningful. A widow thanked you for your dignity. Never forget these moments.")
					else
						state:ModifyStat("Happiness", -10)
						state:AddFeed("ğŸ–ï¸ It's taking a toll. So much death. Need to talk to chaplain.")
					end
				end,
			},
			{
				text = "Request different assignment",
				effects = {},
				feedText = "ğŸ–ï¸ Declined. Someone else will carry the duty.",
			},
		},
	},
	
	{
		id = "mil_base_lockdown",
		title = "Base Emergency",
		emoji = "ğŸš¨",
		text = "Base is on lockdown! Active threat reported. You're ordered to shelter in place but hear gunshots nearby.",
		category = "career_military",
		weight = 8,
		minAge = 18, maxAge = 55,
		baseChance = 0.2,
		cooldown = 6,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Grab weapon and respond",
				effects = { Health = -5 },
				feedText = "Running toward danger...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:ModifyStat("Happiness", 20)
						state.Flags = state.Flags or {}
						state.Flags.hero_commendation = true
						state:AddFeed("ğŸš¨ You helped neutralize the threat! Lives saved. Hero of the day.")
					elseif roll <= 80 then
						state:ModifyStat("Happiness", 5)
						state:AddFeed("ğŸš¨ Arrived as MPs secured the situation. All clear. Heart still pounding.")
					else
						state:ModifyStat("Health", -15)
						state:AddFeed("ğŸš¨ Caught in crossfire. Wounded but ok. Could have been worse.")
					end
				end,
			},
			{
				text = "Follow orders - shelter in place",
				effects = { Happiness = -3 },
				feedText = "ğŸš¨ Waited anxiously. All clear given after 2 hours. False alarm, thankfully.",
			},
			{
				text = "Help evacuate others nearby",
				effects = { Smarts = 3 },
				feedText = "ğŸš¨ Got people to safety. Smart, measured response. Noted in report.",
			},
		},
	},
	
	{
		id = "mil_veteran_mentor",
		title = "Mentoring a Rookie",
		emoji = "ğŸ¤",
		text = "A fresh-out-of-boot-camp soldier has been assigned to you for mentorship. They're nervous and making mistakes.",
		category = "career_military",
		weight = 14,
		minAge = 22, maxAge = 50,
		baseChance = 0.45,
		cooldown = 3,
		requiresJob = true,
		eligibility = hasMilitaryJob,
		blockedByFlags = { in_prison = true },
		
		choices = {
			{
				text = "Be tough - build resilience",
				effects = {},
				feedText = "Hard love approach...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 55 then
						state:ModifyStat("Happiness", 8)
						state:ModifyStat("Smarts", 3)
						state:AddFeed("ğŸ¤ The recruit toughened up! Now one of your best. They thank you later.")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ¤ Too hard. Recruit requested transfer. Feel bad about it.")
					end
				end,
			},
			{
				text = "Be patient - everyone starts somewhere",
				effects = { Happiness = 3, Smarts = 2 },
				feedText = "ğŸ¤ Good mentorship style. Recruit is improving steadily. Building trust.",
			},
			{
				text = "Let them figure it out themselves",
				effects = {},
				feedText = "Sink or swim...",
				onResolve = function(state)
					local roll = math.random(1, 100)
					if roll <= 40 then
						state:AddFeed("ğŸ¤ Recruit became self-sufficient. Independent soldier. Maybe your style worked.")
					else
						state:ModifyStat("Happiness", -5)
						state:AddFeed("ğŸ¤ Recruit failed and blamed you for lack of guidance. Fair point.")
					end
				end,
			},
		},
	},
}

return MilitaryCareerEvents
